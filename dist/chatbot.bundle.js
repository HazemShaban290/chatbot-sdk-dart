!function(){"use strict";function e(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(e){console.warn("Chatbot SDK: localStorage write error:",e)}}function t(e){try{const t=localStorage.getItem(e);return t?JSON.parse(t):null}catch(e){return console.warn("Chatbot SDK: localStorage read error:",e),null}}!function(e,t){void 0===t&&(t={});var n=t.insertAt;if(e&&"undefined"!=typeof document){var i=document.head||document.getElementsByTagName("head")[0],o=document.createElement("style");o.type="text/css","top"===n&&i.firstChild?i.insertBefore(o,i.firstChild):i.appendChild(o),o.styleSheet?o.styleSheet.cssText=e:o.appendChild(document.createTextNode(e))}}('#chatbot-widget-container{bottom:20px;font-family:Inter,-apple-system,BlinkMacSystemFont,sans-serif;position:fixed;right:20px;z-index:1000}.chatbot-intro-card{animation:fadeInFromBottom .5s forwards;background-color:#fff;border-radius:15px;bottom:20px;box-shadow:0 8px 20px rgba(0,0,0,.2);cursor:pointer;display:flex;flex-direction:column;opacity:0;overflow:hidden;padding-top:50px;position:absolute;right:20px;transform:translateY(20px);width:280px;z-index:1000}.chatbot-intro-card .card-header-content{align-items:center;background-color:#3b5998;border-top-left-radius:15px;border-top-right-radius:15px;display:flex;flex-direction:column;height:90px;justify-content:flex-end;left:0;padding-bottom:10px;position:absolute;right:0;top:0}.chatbot-intro-card .card-bubble{animation:none;background-color:#f0f2f5;border:3px solid #fff;box-shadow:0 4px 10px rgba(0,0,0,.2);height:70px;position:absolute;top:-30px;width:70px}.chatbot-intro-card .card-bubble svg{fill:#3b5998;height:50%;width:50%}.chatbot-intro-card .bot-name{color:#fff;font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;font-size:18px;font-weight:700;margin-top:10px}.chatbot-intro-card .card-body{background-color:#fff;border-bottom-left-radius:15px;border-bottom-right-radius:15px;color:#333;padding:20px;text-align:center}.chatbot-intro-card .card-body p{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;font-size:15px;line-height:1.4;margin:5px 0}.chatbot-intro-card .card-bubble:after{animation:loading-spin 10s linear forwards;border:4px solid transparent;border-radius:50%;border-top-color:#f0f2f5;bottom:-5px;content:"";left:-5px;position:absolute;right:-5px;top:-5px}@keyframes loading-spin{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.chatbot-intro-card.transition-out{animation:fadeOutAndShrink .5s forwards}@keyframes fadeInFromBottom{to{opacity:1;transform:translateY(0)}}@keyframes fadeOutAndShrink{0%{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(.5)}}.chatbot-bubble{align-items:center;animation:chatbot-pulse 2s cubic-bezier(.66,0,0,1) infinite;background-color:var(--chatbot-theme-color,#1261a0);border-radius:50%;box-shadow:0 4px 10px rgba(0,0,0,.2);color:#fff;cursor:pointer;display:flex;height:60px;justify-content:center;overflow:hidden;position:relative;transition:transform .2s ease-in-out,box-shadow .2s ease-in-out;width:60px}.chatbot-bubble:hover{box-shadow:0 6px 12px rgba(0,0,0,.25);transform:scale(1.05)}.chatbot-bubble:after{border-left:10px solid transparent;border-right:10px solid transparent;border-top:10px solid var(--chatbot-theme-color,#1261a0);bottom:-10px;content:"";height:0;position:absolute;right:15px;width:0}.chatbot-position-bottom-left .chatbot-bubble:after{left:15px;right:auto}@keyframes chatbot-pulse{0%{box-shadow:0 0 0 0 var(--chatbot-theme-color-faded,rgba(18,97,160,.7))}to{box-shadow:0 0 0 20px var(--chatbot-theme-color-faded,rgba(18,97,160,0))}}.chatbot-bubble.hidden{display:none}.chatbot-window{background-color:#fff;border-radius:12px;bottom:90px;box-shadow:0 10px 25px rgba(0,0,0,.15);display:flex;flex-direction:column;height:85vh;max-width:500px;min-width:400px;opacity:0;overflow:hidden;pointer-events:none;position:fixed;right:20px;transform:translateY(100%) scale(.9);transition:transform .3s ease,opacity .3s ease;width:25vw}@media (max-width:768px){.chatbot-window{border-radius:0;bottom:0;height:100vh;left:0;max-width:unset;min-width:unset;position:fixed;right:0;top:0;transform:translateY(100%);width:100vw}.chatbot-window.open{transform:translateY(0) scale(1)}#chatbot-widget-container{bottom:20px;right:20px}}.chatbot-window.open{opacity:1;pointer-events:auto;transform:translateY(0) scale(1)}.chatbot-header{background-color:var(--chatbot-theme-color,#667eea);color:#fff;display:flex;flex-direction:column;flex-shrink:0;padding:0}.chatbot-header-top{align-items:center;display:flex;font-size:1.1em;font-weight:600;justify-content:space-between;padding:12px 16px}.chatbot-header-close{background:none;border:none;color:#fff;cursor:pointer;font-size:1.5em;line-height:1;padding:4px}.chatbot-tabs{backdrop-filter:blur(10px);background:hsla(0,0%,100%,.1);border:1px solid hsla(0,0%,100%,.18);border-radius:20px;box-shadow:0 4px 20px 0 rgba(0,0,0,.37);display:flex;margin-bottom:1em;padding:3px}.chatbot-tab{background:transparent;border:none;border-radius:18px;color:#000;cursor:pointer;flex:1;font-size:.8em;font-weight:600;letter-spacing:.5px;overflow:hidden;padding:10px 18px;position:relative;text-transform:uppercase;transition:all .4s cubic-bezier(.25,.8,.25,1)}.chatbot-tab:hover{background:hsla(0,0%,100%,.2);box-shadow:0 4px 15px rgba(0,0,0,.15);color:#000;transform:translateY(-2px) scale(1.01)}.chatbot-tab:before{background:linear-gradient(120deg,transparent,hsla(0,0%,100%,.3),transparent);content:"";height:100%;left:-100%;position:absolute;top:0;transition:left .6s ease;width:100%}.chatbot-tab:hover:before{left:100%}.chatbot-tab.active{background:hsla(0,0%,100%,.4);border:1px solid hsla(0,0%,100%,.3);box-shadow:0 6px 20px rgba(0,0,0,.2);color:#000;font-weight:700;transform:translateY(-2px) scale(1.01)}.chatbot-tab.active:after{animation:tabGlowPulse 2s ease-in-out infinite;background:#000;border-radius:2px;bottom:0;content:"";height:3px;left:50%;position:absolute;transform:translateX(-50%);width:60%}@keyframes tabGlowPulse{0%,to{box-shadow:0 0 10px rgba(0,0,0,.6);opacity:.9;transform:translateX(-50%) scaleX(1)}50%{box-shadow:0 0 20px rgba(0,0,0,.8);opacity:1;transform:translateX(-50%) scaleX(1.1)}}.chatbot-content{display:flex}.chatbot-content,.chatbot-tab-content{flex-direction:column;flex-grow:1;overflow:hidden}.chatbot-tab-content{display:none}.chatbot-tab-content.active{display:flex}.chatbot-home-content{background:linear-gradient(135deg,#f8f9fa,#e9ecef);overflow-y:auto;padding:20px}.chatbot-home-welcome{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.1);margin-bottom:30px;padding:20px;text-align:center}.chatbot-home-welcome h2{color:var(--chatbot-theme-color,#667eea);font-size:1.4em;margin:0 0 10px}.chatbot-home-welcome p{color:#666;font-size:.9em;margin:0}.chatbot-actions-grid{display:grid;gap:15px;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));margin-bottom:20px}.chatbot-action-card{background:#fff;border:2px solid transparent;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1);cursor:pointer;padding:20px 15px;text-align:center;transition:all .3s ease}.chatbot-action-card:hover{border-color:var(--chatbot-theme-color,#667eea);box-shadow:0 4px 15px rgba(0,0,0,.15);transform:translateY(-2px)}.chatbot-action-icon{display:block;font-size:2em;margin-bottom:10px}.chatbot-action-title{color:#333;font-size:.9em;font-weight:600;margin-bottom:5px}.chatbot-action-desc{color:#666;font-size:.75em;line-height:1.4}.chatbot-user-actions{margin-top:20px}.chatbot-user-actions h3{color:var(--chatbot-theme-color,#667eea);font-size:1.1em;margin:0 0 15px;text-align:center}.chatbot-notification-card{animation:slideInRight .5s ease;background:#fff;border-left:4px solid var(--chatbot-theme-color,#667eea);border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1);margin-bottom:10px;padding:15px}@keyframes slideInRight{0%{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}.chatbot-notification-text{color:#333;font-size:.9em;line-height:1.4;margin-bottom:10px}.chatbot-notification-button{background:var(--chatbot-theme-color,#667eea);border:none;border-radius:6px;color:#fff;cursor:pointer;font-size:.8em;margin-bottom:8px;margin-right:8px;padding:8px 16px;transition:background-color .3s}.chatbot-notification-button:hover{background:var(--chatbot-theme-color-hover,#5a6fd1)}.chatbot-chat-content{display:flex;flex-direction:column;flex-grow:1;overflow:hidden}.chatbot-terms-overlay{align-items:center;animation:fadeInScale .3s ease;backdrop-filter:blur(8px);background:linear-gradient(135deg,hsla(0,0%,100%,.98),rgba(248,250,252,.95));bottom:0;display:flex;flex-direction:column;justify-content:center;left:0;padding:5px;position:absolute;right:0;top:0;z-index:10}@keyframes fadeInScale{0%{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}.chatbot-terms-content{background:#fff;border:1px solid rgba(0,0,0,.05);border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.15),0 8px 16px rgba(0,0,0,.1),inset 0 1px 0 hsla(0,0%,100%,.9);max-height:85%;max-width:90%;overflow-y:auto;padding:30px 25px;position:relative}.chatbot-terms-content:before{background:linear-gradient(90deg,var(--chatbot-theme-color),#9013fe,#ff4081);border-radius:16px 16px 0 0;content:"";height:4px;left:0;position:absolute;right:0;top:0}.chatbot-terms-title{color:var(--chatbot-theme-color,#667eea);font-size:1.3em;font-weight:700;margin-bottom:24px;position:relative;text-align:center}.chatbot-terms-title:after{background:linear-gradient(90deg,var(--chatbot-theme-color),#9013fe);border-radius:1px;bottom:-8px;content:"";height:2px;left:50%;position:absolute;transform:translateX(-50%);width:40px}.chatbot-terms-text{background:linear-gradient(135deg,#f8fafc,#f1f5f9);border-left:4px solid #fbbf24;border-radius:10px;color:#4a5568;font-size:.6em;line-height:1.7;margin-bottom:18px;padding:16px 18px;position:relative;transition:all .3s ease}.chatbot-terms-text:before{content:"âš ï¸";font-size:1.1em;left:12px;opacity:.8;position:absolute;top:12px}.chatbot-terms-text{padding-left:42px}.chatbot-terms-text:hover{background:linear-gradient(135deg,#f1f5f9,#e2e8f0);transform:translateY(-1px)}.chatbot-terms-buttons{display:flex;gap:16px;justify-content:center;margin-top:28px}.chatbot-terms-accept,.chatbot-terms-decline{border:none;border-radius:10px;cursor:pointer;font-size:.9em;font-weight:600;letter-spacing:.5px;overflow:hidden;padding:14px 28px;position:relative;text-transform:uppercase;transition:all .3s cubic-bezier(.4,0,.2,1)}.chatbot-terms-accept{background:var(--chatbot-theme-color);box-shadow:0 4px 12px rgba(102,126,234,.3);color:#fff}.chatbot-terms-accept:before{background:linear-gradient(90deg,transparent,hsla(0,0%,100%,.2),transparent);content:"";height:100%;left:-100%;position:absolute;top:0;transition:left .5s ease;width:100%}.chatbot-terms-accept:hover:before{left:100%}.chatbot-terms-accept:hover{box-shadow:0 6px 20px rgba(102,126,234,.4);transform:translateY(-2px)}.chatbot-terms-decline{background:linear-gradient(135deg,#64748b,#475569);box-shadow:0 4px 12px rgba(100,116,139,.3);color:#fff}.chatbot-terms-decline:hover{background:linear-gradient(135deg,#475569,#334155);box-shadow:0 6px 20px rgba(100,116,139,.4);transform:translateY(-2px)}.chatbot-messages{background-color:#f8f9fa;display:flex;flex-direction:column;flex-grow:1;gap:8px;overflow-y:auto;padding:12px}.chatbot-announcements-content{background:linear-gradient(135deg,#f8f9fa,#e9ecef);overflow-y:auto;padding:15px}.chatbot-announcements-list{display:flex;flex-direction:column;gap:15px}.chatbot-announcement-card{animation:fadeInUp .5s ease forwards;background:#fff;border-radius:12px;box-shadow:0 3px 12px rgba(0,0,0,.1);opacity:0;overflow:hidden;transform:translateY(20px);transition:all .3s ease}.chatbot-announcement-card:hover{box-shadow:0 6px 20px rgba(0,0,0,.15);transform:translateY(-2px)}@keyframes fadeInUp{to{opacity:1;transform:translateY(0)}}.chatbot-announcement-image{align-items:center;background-color:var(--chatbot-theme-color,#667eea);background-position:50%;background-size:cover;color:#fff;display:flex;font-size:2em;height:120px;justify-content:center;position:relative;width:100%}.chatbot-announcement-content{padding:15px}.chatbot-announcement-title{color:#333;font-size:1em;font-weight:600;line-height:1.4;margin-bottom:8px}.chatbot-announcement-description{color:#666;font-size:.85em;line-height:1.5;margin-bottom:10px}.chatbot-announcement-date{align-items:center;color:#999;display:flex;font-size:.75em;font-weight:500;gap:5px}.chatbot-announcement-date:before{content:"ðŸ“…";font-size:.9em}.chatbot-announcements-empty{color:#666;padding:40px 20px;text-align:center}.chatbot-announcements-empty-icon{font-size:3em;margin-bottom:15px;opacity:.5}.chatbot-input-area{background-color:#fff;border-top:1px solid #e2e8f0;display:flex;flex-shrink:0;padding:12px}.chatbot-input-area input{border:1px solid #e2e8f0;border-radius:20px;flex-grow:1;font-size:.9em;margin-right:8px;outline:none;padding:10px 16px;transition:border-color .3s}.chatbot-input-area input:focus{border-color:var(--chatbot-theme-color,#667eea)}.chatbot-input-area button{background-color:var(--chatbot-theme-color,#667eea);border:none;border-radius:20px;color:#fff;cursor:pointer;font-size:.9em;font-weight:500;padding:10px 16px;transition:background-color .3s}.chatbot-input-area button:hover{background-color:var(--chatbot-theme-color-hover,#5a6fd1)}.chatbot-message{word-wrap:break-word;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);font-size:.95em;line-height:1.4;margin-bottom:8px;max-width:80%;padding:10px 14px}.chatbot-message.user{background-color:var(--chatbot-theme-color,#667eea);border-bottom-right-radius:4px;color:#fff;margin-left:auto}.chatbot-message.bot{background-color:#fff;border:1px solid #e2e8f0;border-bottom-left-radius:4px;color:#333;margin-right:auto}.chatbot-message a{color:var(--chatbot-theme-color,#667eea);text-decoration:underline}.chatbot-message.user a{color:#fff;text-decoration:underline}.chatbot-button-container{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}.chatbot-button-container button{background-color:var(--chatbot-theme-color,#667eea);border:none;border-radius:20px;color:#fff;cursor:pointer;flex-grow:1;font-size:.85em;padding:8px 12px;transition:all .2s}.chatbot-button-container button:hover{background-color:var(--chatbot-theme-color-hover,#5a6fd1);transform:translateY(-1px)}.chatbot-image{border:1px solid #e2e8f0;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.06);cursor:zoom-in;height:auto;margin-top:10px;max-width:100%;transition:transform .25s ease,box-shadow .25s ease}.chatbot-image:hover{box-shadow:0 6px 16px rgba(0,0,0,.12);transform:scale(1.02)}.chatbot-video{background-color:#000;border:1px solid #d9e0e8;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.08);height:auto;margin-top:10px;max-height:240px;overflow:hidden;transition:transform .25s ease,box-shadow .25s ease;width:100%}.chatbot-video:hover{box-shadow:0 6px 16px rgba(0,0,0,.15);transform:scale(1.015)}.chatbot-video:after{color:hsla(0,0%,100%,.8);content:"â–¶";font-size:2rem;left:50%;opacity:0;pointer-events:none;position:absolute;top:50%;transform:translate(-50%,-50%);transition:opacity .25s ease}.chatbot-video:hover:after{opacity:1}.chatbot-carousel-container{display:flex;gap:12px;margin-top:8px;overflow-x:auto;padding:8px 0;scrollbar-width:none}.chatbot-carousel-container::-webkit-scrollbar{display:none}.chatbot-carousel-card{background-color:#fff;border:1px solid #e2e8f0;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);display:flex;flex:0 0 220px;flex-direction:column;overflow:hidden}.chatbot-carousel-card-image{height:120px;object-fit:cover;width:100%}.chatbot-carousel-card-content{display:flex;flex-direction:column;flex-grow:1;padding:12px}.chatbot-carousel-card-title{font-size:.95em;font-weight:600;margin-bottom:4px}.chatbot-carousel-card-subtitle{color:#666;font-size:.85em;margin-bottom:8px}.chatbot-faq-list-container{margin-top:8px}.chatbot-faq-item{border:1px solid #e2e8f0;border-radius:8px;margin-bottom:8px;overflow:hidden}.chatbot-faq-question{align-items:center;background-color:#f8f9fa;cursor:pointer;display:flex;font-size:.9em;font-weight:500;justify-content:space-between;padding:10px 12px}.chatbot-faq-question:after{content:"+";font-size:1.1em}.chatbot-faq-item.expanded .chatbot-faq-question:after{content:"-"}.chatbot-faq-answer{background-color:#fff;border-top:1px solid #e2e8f0;display:none;font-size:.85em;line-height:1.5;padding:10px 12px}.chatbot-faq-item.expanded .chatbot-faq-answer{display:block}.chatbot-table-container{background-color:#fff;border:1px solid #e2e8f0;border-radius:8px;margin-top:8px;overflow-x:auto}.chatbot-table{border-collapse:collapse;font-size:.85em;width:100%}.chatbot-table td,.chatbot-table th{border:1px solid #e2e8f0;padding:8px 12px;text-align:left}.chatbot-table th{background-color:#f8f9fa;font-weight:600}.chatbot-rating-container{background-color:#fff;border:1px solid #e2e8f0;border-radius:8px;margin-top:12px;padding:8px;text-align:center}.chatbot-rating-title{font-size:.9em;font-weight:500;margin-bottom:8px}.chatbot-stars{direction:rtl;display:inline-block;unicode-bidi:bidi-override}.chatbot-stars>span{color:#e2e8f0;cursor:pointer;display:inline-block;font-size:1.8em;position:relative;transition:color .2s;width:1.1em}.chatbot-stars>span.selected,.chatbot-stars>span.selected~span,.chatbot-stars>span:hover,.chatbot-stars>span:hover~span{color:#ffc107}.chatbot-form-container{background-color:#fff;border:1px solid #e2e8f0;border-radius:8px;margin-top:8px;padding:12px}.chatbot-form-title{font-size:.95em;font-weight:500;margin-bottom:12px}.chatbot-form-field{margin-bottom:12px}.chatbot-form-field label{display:block;font-size:.85em;font-weight:500;margin-bottom:4px}.chatbot-form-field input[type=email],.chatbot-form-field input[type=text],.chatbot-form-field select{border:1px solid #e2e8f0;border-radius:6px;font-size:.9em;padding:8px 12px;transition:border-color .3s;width:100%}.chatbot-form-field input[type=email]:focus,.chatbot-form-field input[type=text]:focus,.chatbot-form-field select:focus{border-color:var(--chatbot-theme-color,#667eea);outline:none}.chatbot-form-submit-button{background-color:var(--chatbot-theme-color,#667eea);border:none;border-radius:6px;color:#fff;cursor:pointer;font-size:.9em;font-weight:500;margin-top:8px;padding:10px;transition:background-color .3s;width:100%}.chatbot-form-submit-button:hover{background-color:var(--chatbot-theme-color-hover,#5a6fd1)}.chatbot-location-cards{display:grid;gap:16px;grid-template-columns:1fr;margin-top:12px}@media (min-width:600px){.chatbot-location-cards{grid-template-columns:repeat(auto-fill,minmax(250px,1fr))}}.chatbot-location-card{background-color:#fff;border:1px solid #e2e8f0;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.06);display:flex;flex-direction:column;overflow:hidden;transition:transform .2s ease,box-shadow .2s ease}.chatbot-location-card:hover{box-shadow:0 6px 14px rgba(0,0,0,.1);transform:translateY(-2px)}.chatbot-location-map{background-color:#f8f9fa;height:140px;object-fit:cover;width:100%}.chatbot-location-body{padding:14px}.chatbot-location-title{color:#222;font-size:1em;font-weight:600;margin-bottom:6px}.chatbot-location-address{color:#555;font-size:.85em;line-height:1.5;margin-bottom:10px}.chatbot-location-button{background:rgba(102,126,234,.08);border-radius:6px;color:var(--chatbot-theme-color,#667eea);cursor:pointer;display:inline-block;font-size:.85em;font-weight:600;padding:6px 12px;text-decoration:none;transition:all .25s ease}.chatbot-location-button:hover{background:rgba(102,126,234,.15);box-shadow:0 2px 6px rgba(0,0,0,.1);color:var(--chatbot-theme-color-hover,#5a6fd1);text-decoration:none;transform:translateY(-1px)}.chatbot-location-button:active{box-shadow:0 1px 3px rgba(0,0,0,.08);transform:translateY(0)}.chatbot-location-card img{display:block;height:auto;max-width:100%}.chatbot-messages::-webkit-scrollbar{width:6px}.chatbot-messages::-webkit-scrollbar-track{background:#f1f1f1;border-radius:3px}.chatbot-messages::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:3px}.chatbot-messages::-webkit-scrollbar-thumb:hover{background:#a8a8a8}.chatbot-typing-indicator{align-items:center;background-color:#fff;border:1px solid #e2e8f0;border-radius:12px;display:flex;margin-bottom:8px;padding:8px 12px;width:fit-content}.chatbot-typing-dot{animation:chatbot-typing 1.4s ease-in-out infinite;background-color:#a0aec0;border-radius:50%;height:6px;margin:0 2px;width:6px}.chatbot-typing-dot:first-child{animation-delay:0s}.chatbot-typing-dot:nth-child(2){animation-delay:.2s}.chatbot-typing-dot:nth-child(3){animation-delay:.4s}@keyframes chatbot-typing{0%,60%,to{transform:translateY(0)}30%{transform:translateY(-5px)}}.chatbot-header{background-color:var(--chatbot-header-bg);color:var(--chatbot-header-text)}.chatbot-bubble{background-color:var(--chatbot-bubble-color);height:var(--chatbot-bubble-size);width:var(--chatbot-bubble-size)}.chatbot-message.user{background-color:var(--chatbot-user-bubble)}.chatbot-message.bot{background-color:var(--chatbot-bot-bubble)}.chatbot-message{font-size:var(--chatbot-text-size)}.chatbot-refresh-btn{background:none;border:none;color:inherit;cursor:pointer;font-size:1em;margin-left:auto;margin-right:10px;opacity:.7;transition:opacity .2s}.chatbot-refresh-btn:hover{opacity:1}.chatbot-announcements-content::-webkit-scrollbar,.chatbot-home-content::-webkit-scrollbar,.chatbot-messages::-webkit-scrollbar{width:6px}.chatbot-announcements-content::-webkit-scrollbar-track,.chatbot-home-content::-webkit-scrollbar-track,.chatbot-messages::-webkit-scrollbar-track{background:#f1f1f1;border-radius:3px}.chatbot-announcements-content::-webkit-scrollbar-thumb,.chatbot-home-content::-webkit-scrollbar-thumb,.chatbot-messages::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:3px}.chatbot-announcements-content::-webkit-scrollbar-thumb:hover,.chatbot-home-content::-webkit-scrollbar-thumb:hover,.chatbot-messages::-webkit-scrollbar-thumb:hover{background:#a8a8a8}.chatbot-position-bottom-right{bottom:20px;right:20px}.chatbot-position-bottom-left{bottom:20px;left:20px}.chatbot-position-top-right{right:20px;top:20px}.chatbot-position-top-left{left:20px;top:20px}:root{--chatbot-theme-color:#667eea;--chatbot-theme-color-hover:#5a6fd1;--chatbot-header-bg:var(--chatbot-theme-color);--chatbot-header-text:#fff;--chatbot-bubble-size:60px;--chatbot-bubble-color:var(--chatbot-theme-color);--chatbot-user-bubble:var(--chatbot-theme-color);--chatbot-bot-bubble:#f0f2f5;--chatbot-text-size:0.95em}.chatbot-voice-button{align-items:center;background:var(--chatbot-theme-color,#4a90e2);border:none;border-radius:50%;color:#fff;cursor:pointer;display:flex;font-size:18px;height:38px;justify-content:center;margin-left:8px;transition:background .3s;width:38px}.chatbot-voice-button.active{animation:pulse 1s infinite;background:#e74c3c}@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(231,76,60,.4)}70%{box-shadow:0 0 0 10px rgba(231,76,60,0)}to{box-shadow:0 0 0 0 rgba(231,76,60,0)}}.chatbot-language-switch{align-items:center;border-top:1px solid hsla(0,0%,100%,.2);display:flex;gap:8px;justify-content:center;margin-top:12px;padding-top:12px}.chatbot-language-switch span{font-size:11px;font-weight:500;opacity:.9}.lang-btn{border:2px solid transparent;border-radius:12px;color:rgba(0,0,0,.7);cursor:pointer;font-size:11px;font-weight:600;padding:4px 12px;transition:all .3s ease}.lang-btn:hover{background:rgba(0,0,0,.3)!important;transform:scale(1.05)}.lang-btn.active{background:var(--chatbot-theme-color)!important;border:2px solid var(--chatbot-theme-color)!important;color:#f9f1f1!important}');const n=()=>window.ChatbotSDK||{config:{}};function i(e,t,i,s={}){const a=n(),r=a.config.style?.components?.[t]?.[i]||{},c={...o(t,i,a.config.style?.messages||{}),...r,...s};Object.entries(c).forEach(([t,n])=>{null!=n&&(t.startsWith("--")?e.style.setProperty(t,n):e.style[t]=n)})}function o(e,t,n){const i={};switch(e){case"buttons":"button"===t&&(i.backgroundColor=n.buttonColor,i.color=n.buttonTextColor);break;case"carousel":"card"===t&&(i.backgroundColor=n.botBubbleColor),"cardTitle"!==t&&"cardSubtitle"!==t||(i.color=n.botTextColor);break;case"faq":"question"===t&&(i.color=n.botTextColor);break;case"rating":"star"===t&&(i.color=n.buttonColor)}return i}function s(e,t,n=null){switch(t){case"buttons":return r(e.buttons,n,e.style);case"image":return function(e,t={}){if(!e)return null;const n=document.createElement("img");return n.src=e,n.className="chatbot-image",i(n,"image","image",t),n}(e.image,e.style);case"video":return c(e.video,e.style);case"carousel":return function(e,t,n={}){if(!e||0===e.length)return null;const o=document.createElement("div");return o.className="chatbot-carousel-container",i(o,"carousel","container",n.container),e.forEach(e=>{const s=document.createElement("div");if(s.className="chatbot-carousel-card",i(s,"carousel","card",n.card),e.image_url){const t=document.createElement("img");t.src=e.image_url,t.className="chatbot-carousel-card-image",i(t,"carousel","cardImage",n.cardImage),s.appendChild(t)}const a=document.createElement("div");a.className="chatbot-carousel-card-content",i(a,"carousel","cardContent",n.content);const c=document.createElement("h3");if(c.className="chatbot-carousel-card-title",c.textContent=e.title,i(c,"carousel","cardTitle",n.title),a.appendChild(c),e.subtitle){const t=document.createElement("p");t.className="chatbot-carousel-card-subtitle",t.textContent=e.subtitle,i(t,"carousel","cardSubtitle",n.subtitle),a.appendChild(t)}if(e.buttons?.length>0){const i=r(e.buttons,t,{...n,button:{...e.button_style||{}}});i&&a.appendChild(i)}s.appendChild(a),o.appendChild(s)}),o}(e.carousel,n,e.style);default:return null}}function a(e,t=null){if(!e)return null;const o=document.createElement("div");if(o.classList.add("chatbot-custom-payload"),i(o,"custom","container",e.style),e.locations){const t=function(e,t={}){if(!e||0===e.length)return null;const o=document.createElement("div");return o.className="chatbot-location-cards",i(o,"locations","container",t.container),e.forEach(e=>{const s=`https://www.google.com/maps?q=${e.lat},${e.lng}`,a=`https://maps.googleapis.com/maps/api/staticmap?center=${e.lat},${e.lng}&zoom=14&size=400x200&markers=color:red%7C${e.lat},${e.lng}&key=AIzaSyCYVHw1tnbSZsihFfewNPwvuKc0iXx0ymw`,r=document.createElement("div");r.className="chatbot-location-card",i(r,"locations","card",t.card);const c=document.createElement("img");c.src=a,c.alt=`${e.name} map`,c.className="chatbot-location-map",i(c,"locations","map",t.map),r.appendChild(c);const d=document.createElement("div");d.className="chatbot-location-body",i(d,"locations","body",t.body);const l=document.createElement("div");if(l.className="chatbot-location-title",l.textContent=e.name,i(l,"locations","title",t.title),d.appendChild(l),e.address){const n=document.createElement("div");n.className="chatbot-location-address",n.textContent=e.address,i(n,"locations","address",t.address),d.appendChild(n)}const u=document.createElement("a");u.href=s,u.target="_blank",u.className="chatbot-location-button",u.textContent="View on Map",i(u,"locations","button",{backgroundColor:n().config.style?.messages?.buttonColor,color:n().config.style?.messages?.buttonTextColor,...t.button}),d.appendChild(u),r.appendChild(d),o.appendChild(r)}),o}(e.locations,e.style);t&&o.appendChild(t)}if(e.faq_list){const t=function(e,t={}){if(!e||0===e.length)return null;const n=document.createElement("div");return n.className="chatbot-faq-list-container",i(n,"faq","container",t.container),e.forEach((e,o)=>{const s=document.createElement("div");s.className="chatbot-faq-item",i(s,"faq","item",t.item);const a=document.createElement("div");a.className="chatbot-faq-question",a.textContent=e.question,i(a,"faq","question",t.question),s.appendChild(a);const r=document.createElement("div");r.className="chatbot-faq-answer",r.innerHTML=e.answer,i(r,"faq","answer",t.answer),s.appendChild(r),a.addEventListener("click",()=>{s.classList.toggle("expanded"),s.classList.contains("expanded")?i(r,"faq","expandedAnswer",t.expandedAnswer):i(r,"faq","answer",t.answer)}),n.appendChild(s)}),n}(e.faq_list,e.style);t&&o.appendChild(t)}if(e.table){const t=function(e,t={}){if(!e||!e.headers||!e.rows)return null;const o=document.createElement("div");o.className="chatbot-table-container",i(o,"table","container",t.container);const s=document.createElement("table");s.className="chatbot-table",i(s,"table","table",t.table);const a=document.createElement("thead"),r=document.createElement("tr");e.headers.forEach(e=>{const o=document.createElement("th");o.textContent=e,i(o,"table","header",{backgroundColor:n().config.style?.messages?.buttonColor,color:n().config.style?.messages?.buttonTextColor,...t.header}),r.appendChild(o)}),a.appendChild(r),s.appendChild(a);const c=document.createElement("tbody");return e.rows.forEach(e=>{const n=document.createElement("tr");e.forEach(e=>{const o=document.createElement("td");o.textContent=e,i(o,"table","cell",t.cell),n.appendChild(o)}),c.appendChild(n)}),s.appendChild(c),o.appendChild(s),o}(e.table,e.style);t&&o.appendChild(t)}if(e.rating){const s=function(e,t,o={}){if(!e||!e.scale)return null;const s=document.createElement("div");s.className="chatbot-rating-container",i(s,"rating","container",o.container);const a=document.createElement("div");a.className="chatbot-rating-title",a.textContent=e.title||"Please rate:",i(a,"rating","title",o.title),s.appendChild(a);const r=document.createElement("div");r.className="chatbot-stars",i(r,"rating","starsContainer",o.starsContainer);let c=0;for(let s=e.scale;s>=1;s--){const e=document.createElement("span");e.innerHTML="&#9733;",e.dataset.value=s,i(e,"rating","star",{color:n().config.style?.messages?.buttonColor,...o.star}),e.addEventListener("mouseover",()=>{r.querySelectorAll("span").forEach(e=>{parseInt(e.dataset.value)>=s&&(e.classList.add("hover"),i(e,"rating","starHover",{color:n().config.style?.themeColor,...o.starHover}))})}),e.addEventListener("mouseout",()=>{r.querySelectorAll("span").forEach(e=>{e.classList.remove("hover"),i(e,"rating","star",{color:n().config.style?.messages?.buttonColor,...o.star})})}),e.addEventListener("click",()=>{c=s,r.querySelectorAll("span").forEach(e=>{parseInt(e.dataset.value)<=c?(e.classList.add("selected"),i(e,"rating","starSelected",{color:n().config.style?.themeColor,...o.starSelected})):(e.classList.remove("selected"),i(e,"rating","star",{color:n().config.style?.messages?.buttonColor,...o.star}))}),t&&t(`Rated ${c} stars`,`/rate_service{"rating":${c}}`)}),r.appendChild(e)}return s.appendChild(r),s}(e.rating,t,e.style);s&&o.appendChild(s)}if(e.forms){const s=function(e,t,o={}){if(!e||!Array.isArray(e.fields)||0===e.fields.length||!e.submit_payload)return null;const s=document.createElement("div");if(s.className="chatbot-form-container",i(s,"form","container",o.container),e.title){const t=document.createElement("div");t.className="chatbot-form-title",t.textContent=e.title,i(t,"form","title",o.title),s.appendChild(t)}const a=document.createElement("form");a.className="chatbot-form",i(a,"form","form",o.form),e.fields.forEach(e=>{const t=document.createElement("div");if(t.className="chatbot-form-field",i(t,"form","field",o.field),e.label){const n=document.createElement("label");n.textContent=e.label,n.htmlFor=`chatbot-form-${e.field_name}`,i(n,"form","label",o.label),t.appendChild(n)}let s;"select"===e.type&&Array.isArray(e.options)?(s=document.createElement("select"),s.name=e.field_name,s.id=`chatbot-form-${e.field_name}`,e.options.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,s.appendChild(t)})):"textarea"===e.type?(s=document.createElement("textarea"),s.name=e.field_name,s.id=`chatbot-form-${e.field_name}`,s.placeholder=e.placeholder||"",s.required=!!e.required):(s=document.createElement("input"),s.type=e.type||"text",s.name=e.field_name,s.id=`chatbot-form-${e.field_name}`,s.placeholder=e.placeholder||"",s.required=!!e.required),i(s,"form","input",{backgroundColor:n().config.style?.messages?.inputBackground,color:n().config.style?.messages?.inputTextColor,borderColor:n().config.style?.messages?.inputBorderColor,...o.input}),t.appendChild(s),a.appendChild(t)});const r=document.createElement("button");return r.type="submit",r.className="chatbot-form-submit-button",r.textContent=e.submit_button_text||"Submit",i(r,"form","submitButton",{backgroundColor:n().config.style?.messages?.buttonColor,color:n().config.style?.messages?.buttonTextColor,...o.submitButton}),a.appendChild(r),a.addEventListener("submit",n=>{n.preventDefault();const i={};if(e.fields.forEach(e=>{const t=a.querySelector(`[name="${e.field_name}"]`);t&&(i[e.field_name]=t.value)}),t){const n=`Submitted form: ${Object.entries(i).map(([e,t])=>`${e}: ${t}`).join(", ")}`,o=`${e.submit_payload}${JSON.stringify(i)}`;t(n,o)}a.querySelectorAll("input, select, textarea, button").forEach(e=>e.disabled=!0)}),s.appendChild(a),s}(e.forms,t,e.style);s&&o.appendChild(s)}if(e.video){const t=c(e.video,e.style);t&&o.appendChild(t)}return o.children.length>0?o:null}function r(e,t,n={}){if(!e||0===e.length)return null;const o=document.createElement("div");return o.className="chatbot-button-container",i(o,"buttons","container",n.container),e.forEach(e=>{const s=document.createElement("button");s.textContent=e.title,s.className="chatbot-button",i(s,"buttons","button",{...e.button_color&&{backgroundColor:e.button_color},...e.button_color&&{color:"white"},...e.button_color&&{borderColor:e.button_color},...n.button}),e.payload?s.addEventListener("click",()=>{o.querySelectorAll("button").forEach(e=>e.disabled=!0),t&&t(e.title,e.payload)}):e.url?s.addEventListener("click",()=>window.open(e.url,"_blank")):e.question&&s.addEventListener("click",()=>{o.querySelectorAll("button").forEach(e=>e.disabled=!0),t&&t(e.title,e.question)}),o.appendChild(s)}),o}function c(e,t={}){if(!e.url)return null;if(e.url.includes("youtube.com/watch")||e.url.includes("youtu.be")){let t;t=e.url.includes("youtu.be")?e.url.split("/").pop().split("?")[0]:e.url.split("v=")[1].split("&")[0];const n=document.createElement("iframe");return n.src=`https://www.youtube.com/embed/${t}?autoplay=0`,n.width="250",n.height="140",n.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",n.allowFullscreen=!0,n}{const n=document.createElement("video");return n.src=e.url,n.controls=!0,n.className="chatbot-video",n.style.maxWidth=t.maxWidth||"250px",n.style.borderRadius=t.borderRadius||"8px",n.style.marginTop=t.marginTop||"8px",e.autoplay&&(n.muted=!0,n.autoplay=!0,n.addEventListener("canplay",()=>{n.play().catch(e=>console.log("Autoplay blocked",e))})),n}}const d="https://finovax.duckdns.org:8000",l={chatbot:{chat:`${d}/api/v1/dart/chatbot/chat`,config:`${d}/api/v1/dart/chatbot/config`,config_key:`${d}/api/v1/dart/chatbot/chatbot/config`,news:`${d}/api/v1/dart/chatbot/news`,start:`${d}/api/v1/dart/chatbot/start`,stt:`${d}/api/v1/vcb/sendAudioToSTT`,tts:`${d}/api/v1/vcb/playTTS`,start_agent:`${d}/api/v1/vcb/dart/start_agent`,voice_agent_token:`${d}/api/v1/vcb/dart/token`,voice_chat:`${d}/api/v1/vcb/dart/chat`}};function u(e,t){return t.forEach(function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach(function(n){if("default"!==n&&!(n in e)){var i=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,i.get?i:{enumerable:!0,get:function(){return t[n]}})}})}),Object.freeze(e)}var h=Object.defineProperty,p=(e,t,n)=>((e,t,n)=>t in e?h(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n)(e,"symbol"!=typeof t?t+"":t,n);class m{constructor(){p(this,"_locking"),p(this,"_locks"),this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){let e;this._locks+=1;const t=new Promise(t=>e=()=>{this._locks-=1,t()}),n=this._locking.then(()=>e);return this._locking=this._locking.then(()=>t),n}}function g(e,t){if(!e)throw new Error(t)}function f(e){if("number"!=typeof e)throw new Error("invalid int 32: "+typeof e);if(!Number.isInteger(e)||e>2147483647||e<-2147483648)throw new Error("invalid int 32: "+e)}function v(e){if("number"!=typeof e)throw new Error("invalid uint 32: "+typeof e);if(!Number.isInteger(e)||e>4294967295||e<0)throw new Error("invalid uint 32: "+e)}function b(e){if("number"!=typeof e)throw new Error("invalid float 32: "+typeof e);if(Number.isFinite(e)&&(e>34028234663852886e22||e<-34028234663852886e22))throw new Error("invalid float 32: "+e)}const y=Symbol("@bufbuild/protobuf/enum-type");function k(e){const t=e[y];return g(t,"missing enum type on enum object"),t}function T(e,t,n,i){e[y]=C(t,n.map(t=>({no:t.no,name:t.name,localName:e[t.no]})))}function C(e,t,n){const i=Object.create(null),o=Object.create(null),s=[];for(const e of t){const t=w(e);s.push(t),i[e.name]=t,o[e.no]=t}return{typeName:e,values:s,findName:e=>i[e],findNumber:e=>o[e]}}function S(e,t,n){const i={};for(const e of t){const t=w(e);i[t.localName]=t.no,i[t.no]=t.localName}return T(i,e,t),i}function w(e){return"localName"in e?e:Object.assign(Object.assign({},e),{localName:e.name})}class E{equals(e){return this.getType().runtime.util.equals(this.getType(),this,e)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(e,t){const n=this.getType().runtime.bin,i=n.makeReadOptions(t);return n.readMessage(this,i.readerFactory(e),e.byteLength,i),this}fromJson(e,t){const n=this.getType(),i=n.runtime.json,o=i.makeReadOptions(t);return i.readMessage(n,e,o,this),this}fromJsonString(e,t){let n;try{n=JSON.parse(e)}catch(e){throw new Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(e instanceof Error?e.message:String(e)))}return this.fromJson(n,t)}toBinary(e){const t=this.getType().runtime.bin,n=t.makeWriteOptions(e),i=n.writerFactory();return t.writeMessage(this,i,n),i.finish()}toJson(e){const t=this.getType().runtime.json,n=t.makeWriteOptions(e);return t.writeMessage(this,n)}toJsonString(e){var t;const n=this.toJson(e);return JSON.stringify(n,null,null!==(t=null==e?void 0:e.prettySpaces)&&void 0!==t?t:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}}function x(){let e=0,t=0;for(let n=0;n<28;n+=7){let i=this.buf[this.pos++];if(e|=(127&i)<<n,!(128&i))return this.assertBounds(),[e,t]}let n=this.buf[this.pos++];if(e|=(15&n)<<28,t=(112&n)>>4,!(128&n))return this.assertBounds(),[e,t];for(let n=3;n<=31;n+=7){let i=this.buf[this.pos++];if(t|=(127&i)<<n,!(128&i))return this.assertBounds(),[e,t]}throw new Error("invalid varint")}function P(e,t,n){for(let i=0;i<28;i+=7){const o=e>>>i,s=!(o>>>7==0&&0==t),a=255&(s?128|o:o);if(n.push(a),!s)return}const i=e>>>28&15|(7&t)<<4,o=!!(t>>3);if(n.push(255&(o?128|i:i)),o){for(let e=3;e<31;e+=7){const i=t>>>e,o=!(i>>>7==0),s=255&(o?128|i:i);if(n.push(s),!o)return}n.push(t>>>31&1)}}const R=4294967296;function I(e){const t="-"===e[0];t&&(e=e.slice(1));const n=1e6;let i=0,o=0;function s(t,s){const a=Number(e.slice(t,s));o*=n,i=i*n+a,i>=R&&(o+=i/R|0,i%=R)}return s(-24,-18),s(-18,-12),s(-12,-6),s(-6),t?D(i,o):_(i,o)}function O(e,t){if(({lo:e,hi:t}=function(e,t){return{lo:e>>>0,hi:t>>>0}}(e,t)),t<=2097151)return String(R*t+e);const n=16777215&(e>>>24|t<<8),i=t>>16&65535;let o=(16777215&e)+6777216*n+6710656*i,s=n+8147497*i,a=2*i;const r=1e7;return o>=r&&(s+=Math.floor(o/r),o%=r),s>=r&&(a+=Math.floor(s/r),s%=r),a.toString()+M(s)+M(o)}function _(e,t){return{lo:0|e,hi:0|t}}function D(e,t){return t=~t,e?e=1+~e:t+=1,_(e,t)}const M=e=>{const t=String(e);return"0000000".slice(t.length)+t};function A(e,t){if(e>=0){for(;e>127;)t.push(127&e|128),e>>>=7;t.push(e)}else{for(let n=0;n<9;n++)t.push(127&e|128),e>>=7;t.push(1)}}function N(){let e=this.buf[this.pos++],t=127&e;if(!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<7,!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<14,!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<21,!(128&e))return this.assertBounds(),t;e=this.buf[this.pos++],t|=(15&e)<<28;for(let t=5;128&e&&t<10;t++)e=this.buf[this.pos++];if(128&e)throw new Error("invalid varint");return this.assertBounds(),t>>>0}const L=function(){const e=new DataView(new ArrayBuffer(8));if("function"==typeof BigInt&&"function"==typeof e.getBigInt64&&"function"==typeof e.getBigUint64&&"function"==typeof e.setBigInt64&&"function"==typeof e.setBigUint64&&("object"!=typeof process||"object"!=typeof process.env||"1"!==process.env.BUF_BIGINT_DISABLE)){const t=BigInt("-9223372036854775808"),n=BigInt("9223372036854775807"),i=BigInt("0"),o=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(e){const i="bigint"==typeof e?e:BigInt(e);if(i>n||i<t)throw new Error("int64 invalid: ".concat(e));return i},uParse(e){const t="bigint"==typeof e?e:BigInt(e);if(t>o||t<i)throw new Error("uint64 invalid: ".concat(e));return t},enc(t){return e.setBigInt64(0,this.parse(t),!0),{lo:e.getInt32(0,!0),hi:e.getInt32(4,!0)}},uEnc(t){return e.setBigInt64(0,this.uParse(t),!0),{lo:e.getInt32(0,!0),hi:e.getInt32(4,!0)}},dec:(t,n)=>(e.setInt32(0,t,!0),e.setInt32(4,n,!0),e.getBigInt64(0,!0)),uDec:(t,n)=>(e.setInt32(0,t,!0),e.setInt32(4,n,!0),e.getBigUint64(0,!0))}}const t=e=>g(/^-?[0-9]+$/.test(e),"int64 invalid: ".concat(e)),n=e=>g(/^[0-9]+$/.test(e),"uint64 invalid: ".concat(e));return{zero:"0",supported:!1,parse:e=>("string"!=typeof e&&(e=e.toString()),t(e),e),uParse:e=>("string"!=typeof e&&(e=e.toString()),n(e),e),enc:e=>("string"!=typeof e&&(e=e.toString()),t(e),I(e)),uEnc:e=>("string"!=typeof e&&(e=e.toString()),n(e),I(e)),dec:(e,t)=>function(e,t){let n=_(e,t);const i=2147483648&n.hi;i&&(n=D(n.lo,n.hi));const o=O(n.lo,n.hi);return i?"-"+o:o}(e,t),uDec:(e,t)=>O(e,t)}}();var U,j,F;function B(e,t,n){if(t===n)return!0;if(e==U.BYTES){if(!(t instanceof Uint8Array&&n instanceof Uint8Array))return!1;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e]!==n[e])return!1;return!0}switch(e){case U.UINT64:case U.FIXED64:case U.INT64:case U.SFIXED64:case U.SINT64:return t==n}return!1}function q(e,t){switch(e){case U.BOOL:return!1;case U.UINT64:case U.FIXED64:case U.INT64:case U.SFIXED64:case U.SINT64:return 0==t?L.zero:"0";case U.DOUBLE:case U.FLOAT:return 0;case U.BYTES:return new Uint8Array(0);case U.STRING:return"";default:return 0}}function V(e,t){switch(e){case U.BOOL:return!1===t;case U.STRING:return""===t;case U.BYTES:return t instanceof Uint8Array&&!t.byteLength;default:return 0==t}}!function(e){e[e.DOUBLE=1]="DOUBLE",e[e.FLOAT=2]="FLOAT",e[e.INT64=3]="INT64",e[e.UINT64=4]="UINT64",e[e.INT32=5]="INT32",e[e.FIXED64=6]="FIXED64",e[e.FIXED32=7]="FIXED32",e[e.BOOL=8]="BOOL",e[e.STRING=9]="STRING",e[e.BYTES=12]="BYTES",e[e.UINT32=13]="UINT32",e[e.SFIXED32=15]="SFIXED32",e[e.SFIXED64=16]="SFIXED64",e[e.SINT32=17]="SINT32",e[e.SINT64=18]="SINT64"}(U||(U={})),function(e){e[e.BIGINT=0]="BIGINT",e[e.STRING=1]="STRING"}(j||(j={})),function(e){e[e.Varint=0]="Varint",e[e.Bit64=1]="Bit64",e[e.LengthDelimited=2]="LengthDelimited",e[e.StartGroup=3]="StartGroup",e[e.EndGroup=4]="EndGroup",e[e.Bit32=5]="Bit32"}(F||(F={}));class z{constructor(e){this.stack=[],this.textEncoder=null!=e?e:new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let e=0;for(let t=0;t<this.chunks.length;t++)e+=this.chunks[t].length;let t=new Uint8Array(e),n=0;for(let e=0;e<this.chunks.length;e++)t.set(this.chunks[e],n),n+=this.chunks[e].length;return this.chunks=[],t}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let e=this.finish(),t=this.stack.pop();if(!t)throw new Error("invalid state, fork stack empty");return this.chunks=t.chunks,this.buf=t.buf,this.uint32(e.byteLength),this.raw(e)}tag(e,t){return this.uint32((e<<3|t)>>>0)}raw(e){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(e),this}uint32(e){for(v(e);e>127;)this.buf.push(127&e|128),e>>>=7;return this.buf.push(e),this}int32(e){return f(e),A(e,this.buf),this}bool(e){return this.buf.push(e?1:0),this}bytes(e){return this.uint32(e.byteLength),this.raw(e)}string(e){let t=this.textEncoder.encode(e);return this.uint32(t.byteLength),this.raw(t)}float(e){b(e);let t=new Uint8Array(4);return new DataView(t.buffer).setFloat32(0,e,!0),this.raw(t)}double(e){let t=new Uint8Array(8);return new DataView(t.buffer).setFloat64(0,e,!0),this.raw(t)}fixed32(e){v(e);let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!0),this.raw(t)}sfixed32(e){f(e);let t=new Uint8Array(4);return new DataView(t.buffer).setInt32(0,e,!0),this.raw(t)}sint32(e){return f(e),A(e=(e<<1^e>>31)>>>0,this.buf),this}sfixed64(e){let t=new Uint8Array(8),n=new DataView(t.buffer),i=L.enc(e);return n.setInt32(0,i.lo,!0),n.setInt32(4,i.hi,!0),this.raw(t)}fixed64(e){let t=new Uint8Array(8),n=new DataView(t.buffer),i=L.uEnc(e);return n.setInt32(0,i.lo,!0),n.setInt32(4,i.hi,!0),this.raw(t)}int64(e){let t=L.enc(e);return P(t.lo,t.hi,this.buf),this}sint64(e){let t=L.enc(e),n=t.hi>>31;return P(t.lo<<1^n,(t.hi<<1|t.lo>>>31)^n,this.buf),this}uint64(e){let t=L.uEnc(e);return P(t.lo,t.hi,this.buf),this}}class H{constructor(e,t){this.varint64=x,this.uint32=N,this.buf=e,this.len=e.length,this.pos=0,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.textDecoder=null!=t?t:new TextDecoder}tag(){let e=this.uint32(),t=e>>>3,n=7&e;if(t<=0||n<0||n>5)throw new Error("illegal tag: field no "+t+" wire type "+n);return[t,n]}skip(e,t){let n=this.pos;switch(e){case F.Varint:for(;128&this.buf[this.pos++];);break;case F.Bit64:this.pos+=4;case F.Bit32:this.pos+=4;break;case F.LengthDelimited:let n=this.uint32();this.pos+=n;break;case F.StartGroup:for(;;){const[e,n]=this.tag();if(n===F.EndGroup){if(void 0!==t&&e!==t)throw new Error("invalid end group tag");break}this.skip(n,e)}break;default:throw new Error("cant skip wire type "+e)}return this.assertBounds(),this.buf.subarray(n,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return 0|this.uint32()}sint32(){let e=this.uint32();return e>>>1^-(1&e)}int64(){return L.dec(...this.varint64())}uint64(){return L.uDec(...this.varint64())}sint64(){let[e,t]=this.varint64(),n=-(1&e);return e=(e>>>1|(1&t)<<31)^n,t=t>>>1^n,L.dec(e,t)}bool(){let[e,t]=this.varint64();return 0!==e||0!==t}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return L.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return L.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let e=this.uint32(),t=this.pos;return this.pos+=e,this.assertBounds(),this.buf.subarray(t,t+e)}string(){return this.textDecoder.decode(this.bytes())}}function W(e){const t=e.field.localName,n=Object.create(null);return n[t]=function(e){const t=e.field;if(t.repeated)return[];if(void 0!==t.default)return t.default;switch(t.kind){case"enum":return t.T.values[0].no;case"scalar":return q(t.T,t.L);case"message":const e=t.T,n=new e;return e.fieldWrapper?e.fieldWrapper.unwrapField(n):n;case"map":throw"map fields are not allowed to be extensions"}}(e),[n,()=>n[t]]}let G="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),K=[];for(let e=0;e<G.length;e++)K[G[e].charCodeAt(0)]=e;K["-".charCodeAt(0)]=G.indexOf("+"),K["_".charCodeAt(0)]=G.indexOf("/");const J={dec(e){let t=3*e.length/4;"="==e[e.length-2]?t-=2:"="==e[e.length-1]&&(t-=1);let n,i=new Uint8Array(t),o=0,s=0,a=0;for(let t=0;t<e.length;t++){if(n=K[e.charCodeAt(t)],void 0===n)switch(e[t]){case"=":s=0;case"\n":case"\r":case"\t":case" ":continue;default:throw Error("invalid base64 string.")}switch(s){case 0:a=n,s=1;break;case 1:i[o++]=a<<2|(48&n)>>4,a=n,s=2;break;case 2:i[o++]=(15&a)<<4|(60&n)>>2,a=n,s=3;break;case 3:i[o++]=(3&a)<<6|n,s=0}}if(1==s)throw Error("invalid base64 string.");return i.subarray(0,o)},enc(e){let t,n="",i=0,o=0;for(let s=0;s<e.length;s++)switch(t=e[s],i){case 0:n+=G[t>>2],o=(3&t)<<4,i=1;break;case 1:n+=G[o|t>>4],o=(15&t)<<2,i=2;break;case 2:n+=G[o|t>>6],n+=G[63&t],i=0}return i&&(n+=G[o],n+="=",1==i&&(n+="=")),n}};function Y(e,t,n){X(t,e);const i=t.runtime.bin.makeReadOptions(n),o=function(e,t){if(!t.repeated&&("enum"==t.kind||"scalar"==t.kind)){for(let n=e.length-1;n>=0;--n)if(e[n].no==t.no)return[e[n]];return[]}return e.filter(e=>e.no===t.no)}(e.getType().runtime.bin.listUnknownFields(e),t.field),[s,a]=W(t);for(const e of o)t.runtime.bin.readField(s,i.readerFactory(e.data),t.field,e.wireType,i);return a()}function $(e,t,n,i){X(t,e);const o=t.runtime.bin.makeReadOptions(i),s=t.runtime.bin.makeWriteOptions(i);if(Q(e,t)){const n=e.getType().runtime.bin.listUnknownFields(e).filter(e=>e.no!=t.field.no);e.getType().runtime.bin.discardUnknownFields(e);for(const t of n)e.getType().runtime.bin.onUnknownField(e,t.no,t.wireType,t.data)}const a=s.writerFactory();let r=t.field;r.opt||r.repeated||"enum"!=r.kind&&"scalar"!=r.kind||(r=Object.assign(Object.assign({},t.field),{opt:!0})),t.runtime.bin.writeField(r,n,a,s);const c=o.readerFactory(a.finish());for(;c.pos<c.len;){const[t,n]=c.tag(),i=c.skip(n,t);e.getType().runtime.bin.onUnknownField(e,t,n,i)}}function Q(e,t){const n=e.getType();return t.extendee.typeName===n.typeName&&!!n.runtime.bin.listUnknownFields(e).find(e=>e.no==t.field.no)}function X(e,t){g(e.extendee.typeName==t.getType().typeName,"extension ".concat(e.typeName," can only be applied to message ").concat(e.extendee.typeName))}function Z(e,t){const n=e.localName;if(e.repeated)return t[n].length>0;if(e.oneof)return t[e.oneof.localName].case===n;switch(e.kind){case"enum":case"scalar":return e.opt||e.req?void 0!==t[n]:"enum"==e.kind?t[n]!==e.T.values[0].no:!V(e.T,t[n]);case"message":return void 0!==t[n];case"map":return Object.keys(t[n]).length>0}}function ee(e,t){const n=e.localName,i=!e.opt&&!e.req;if(e.repeated)t[n]=[];else if(e.oneof)t[e.oneof.localName]={case:void 0};else switch(e.kind){case"map":t[n]={};break;case"enum":t[n]=i?e.T.values[0].no:void 0;break;case"scalar":t[n]=i?q(e.T,e.L):void 0;break;case"message":t[n]=void 0}}function te(e,t){if(null===e||"object"!=typeof e)return!1;if(!Object.getOwnPropertyNames(E.prototype).every(t=>t in e&&"function"==typeof e[t]))return!1;const n=e.getType();return null!==n&&"function"==typeof n&&"typeName"in n&&"string"==typeof n.typeName&&(void 0===t||n.typeName==t.typeName)}function ne(e,t){return te(t)||!e.fieldWrapper?t:e.fieldWrapper.wrapField(t)}U.DOUBLE,U.FLOAT,U.INT64,U.UINT64,U.INT32,U.UINT32,U.BOOL,U.STRING,U.BYTES;const ie={ignoreUnknownFields:!1},oe={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0};function se(e){return e?Object.assign(Object.assign({},ie),e):ie}function ae(e){return e?Object.assign(Object.assign({},oe),e):oe}const re=Symbol(),ce=Symbol();function de(e){if(null===e)return"null";switch(typeof e){case"object":return Array.isArray(e)?"array":"object";case"string":return e.length>100?"string":'"'.concat(e.split('"').join('\\"'),'"');default:return String(e)}}function le(e,t,n,i,o){let s=n.localName;if(n.repeated){if(g("map"!=n.kind),null===t)return;if(!Array.isArray(t))throw new Error("cannot decode field ".concat(o.typeName,".").concat(n.name," from JSON: ").concat(de(t)));const a=e[s];for(const e of t){if(null===e)throw new Error("cannot decode field ".concat(o.typeName,".").concat(n.name," from JSON: ").concat(de(e)));switch(n.kind){case"message":a.push(n.T.fromJson(e,i));break;case"enum":const t=pe(n.T,e,i.ignoreUnknownFields,!0);t!==ce&&a.push(t);break;case"scalar":try{a.push(he(n.T,e,n.L,!0))}catch(t){let i="cannot decode field ".concat(o.typeName,".").concat(n.name," from JSON: ").concat(de(e));throw t instanceof Error&&t.message.length>0&&(i+=": ".concat(t.message)),new Error(i)}}}}else if("map"==n.kind){if(null===t)return;if("object"!=typeof t||Array.isArray(t))throw new Error("cannot decode field ".concat(o.typeName,".").concat(n.name," from JSON: ").concat(de(t)));const a=e[s];for(const[e,s]of Object.entries(t)){if(null===s)throw new Error("cannot decode field ".concat(o.typeName,".").concat(n.name," from JSON: map value null"));let r;try{r=ue(n.K,e)}catch(e){let i="cannot decode map key for field ".concat(o.typeName,".").concat(n.name," from JSON: ").concat(de(t));throw e instanceof Error&&e.message.length>0&&(i+=": ".concat(e.message)),new Error(i)}switch(n.V.kind){case"message":a[r]=n.V.T.fromJson(s,i);break;case"enum":const e=pe(n.V.T,s,i.ignoreUnknownFields,!0);e!==ce&&(a[r]=e);break;case"scalar":try{a[r]=he(n.V.T,s,j.BIGINT,!0)}catch(e){let i="cannot decode map value for field ".concat(o.typeName,".").concat(n.name," from JSON: ").concat(de(t));throw e instanceof Error&&e.message.length>0&&(i+=": ".concat(e.message)),new Error(i)}}}}else switch(n.oneof&&(e=e[n.oneof.localName]={case:s},s="value"),n.kind){case"message":const a=n.T;if(null===t&&"google.protobuf.Value"!=a.typeName)return;let r=e[s];te(r)?r.fromJson(t,i):(e[s]=r=a.fromJson(t,i),a.fieldWrapper&&!n.oneof&&(e[s]=a.fieldWrapper.unwrapField(r)));break;case"enum":const c=pe(n.T,t,i.ignoreUnknownFields,!1);switch(c){case re:ee(n,e);break;case ce:break;default:e[s]=c}break;case"scalar":try{const i=he(n.T,t,n.L,!1);if(i===re)ee(n,e);else e[s]=i}catch(e){let i="cannot decode field ".concat(o.typeName,".").concat(n.name," from JSON: ").concat(de(t));throw e instanceof Error&&e.message.length>0&&(i+=": ".concat(e.message)),new Error(i)}}}function ue(e,t){if(e===U.BOOL)switch(t){case"true":t=!0;break;case"false":t=!1}return he(e,t,j.BIGINT,!0).toString()}function he(e,t,n,i){if(null===t)return i?q(e,n):re;switch(e){case U.DOUBLE:case U.FLOAT:if("NaN"===t)return Number.NaN;if("Infinity"===t)return Number.POSITIVE_INFINITY;if("-Infinity"===t)return Number.NEGATIVE_INFINITY;if(""===t)break;if("string"==typeof t&&t.trim().length!==t.length)break;if("string"!=typeof t&&"number"!=typeof t)break;const i=Number(t);if(Number.isNaN(i))break;if(!Number.isFinite(i))break;return e==U.FLOAT&&b(i),i;case U.INT32:case U.FIXED32:case U.SFIXED32:case U.SINT32:case U.UINT32:let o;if("number"==typeof t?o=t:"string"==typeof t&&t.length>0&&t.trim().length===t.length&&(o=Number(t)),void 0===o)break;return e==U.UINT32||e==U.FIXED32?v(o):f(o),o;case U.INT64:case U.SFIXED64:case U.SINT64:if("number"!=typeof t&&"string"!=typeof t)break;const s=L.parse(t);return n?s.toString():s;case U.FIXED64:case U.UINT64:if("number"!=typeof t&&"string"!=typeof t)break;const a=L.uParse(t);return n?a.toString():a;case U.BOOL:if("boolean"!=typeof t)break;return t;case U.STRING:if("string"!=typeof t)break;try{encodeURIComponent(t)}catch(e){throw new Error("invalid UTF8")}return t;case U.BYTES:if(""===t)return new Uint8Array(0);if("string"!=typeof t)break;return J.dec(t)}throw new Error}function pe(e,t,n,i){if(null===t)return"google.protobuf.NullValue"==e.typeName?0:i?e.values[0].no:re;switch(typeof t){case"number":if(Number.isInteger(t))return t;break;case"string":const i=e.findName(t);if(void 0!==i)return i.no;if(n)return ce}throw new Error("cannot decode enum ".concat(e.typeName," from JSON: ").concat(de(t)))}function me(e){return!(!e.repeated&&"map"!=e.kind)||!e.oneof&&("message"!=e.kind&&(!e.opt&&!e.req))}function ge(e,t,n){if("map"==e.kind){g("object"==typeof t&&null!=t);const i={},o=Object.entries(t);switch(e.V.kind){case"scalar":for(const[t,n]of o)i[t.toString()]=ve(e.V.T,n);break;case"message":for(const[e,t]of o)i[e.toString()]=t.toJson(n);break;case"enum":const t=e.V.T;for(const[e,s]of o)i[e.toString()]=fe(t,s,n.enumAsInteger)}return n.emitDefaultValues||o.length>0?i:void 0}if(e.repeated){g(Array.isArray(t));const i=[];switch(e.kind){case"scalar":for(let n=0;n<t.length;n++)i.push(ve(e.T,t[n]));break;case"enum":for(let o=0;o<t.length;o++)i.push(fe(e.T,t[o],n.enumAsInteger));break;case"message":for(let e=0;e<t.length;e++)i.push(t[e].toJson(n))}return n.emitDefaultValues||i.length>0?i:void 0}switch(e.kind){case"scalar":return ve(e.T,t);case"enum":return fe(e.T,t,n.enumAsInteger);case"message":return ne(e.T,t).toJson(n)}}function fe(e,t,n){var i;if(g("number"==typeof t),"google.protobuf.NullValue"==e.typeName)return null;if(n)return t;const o=e.findNumber(t);return null!==(i=null==o?void 0:o.name)&&void 0!==i?i:t}function ve(e,t){switch(e){case U.INT32:case U.SFIXED32:case U.SINT32:case U.FIXED32:case U.UINT32:return g("number"==typeof t),t;case U.FLOAT:case U.DOUBLE:return g("number"==typeof t),Number.isNaN(t)?"NaN":t===Number.POSITIVE_INFINITY?"Infinity":t===Number.NEGATIVE_INFINITY?"-Infinity":t;case U.STRING:return g("string"==typeof t),t;case U.BOOL:return g("boolean"==typeof t),t;case U.UINT64:case U.FIXED64:case U.INT64:case U.SFIXED64:case U.SINT64:return g("bigint"==typeof t||"string"==typeof t||"number"==typeof t),t.toString();case U.BYTES:return g(t instanceof Uint8Array),J.enc(t)}}const be=Symbol("@bufbuild/protobuf/unknown-fields"),ye={readUnknownFields:!0,readerFactory:e=>new H(e)},ke={writeUnknownFields:!0,writerFactory:()=>new z};function Te(e){return e?Object.assign(Object.assign({},ye),e):ye}function Ce(e){return e?Object.assign(Object.assign({},ke),e):ke}function Se(e,t,n,i,o){let{repeated:s,localName:a}=n;switch(n.oneof&&((e=e[n.oneof.localName]).case!=a&&delete e.value,e.case=a,a="value"),n.kind){case"scalar":case"enum":const r="enum"==n.kind?U.INT32:n.T;let c=xe;if("scalar"==n.kind&&n.L>0&&(c=Ee),s){let n=e[a];if(i==F.LengthDelimited&&r!=U.STRING&&r!=U.BYTES){let e=t.uint32()+t.pos;for(;t.pos<e;)n.push(c(t,r))}else n.push(c(t,r))}else e[a]=c(t,r);break;case"message":const d=n.T;s?e[a].push(we(t,new d,o,n)):te(e[a])?we(t,e[a],o,n):(e[a]=we(t,new d,o,n),!d.fieldWrapper||n.oneof||n.repeated||(e[a]=d.fieldWrapper.unwrapField(e[a])));break;case"map":let[l,u]=function(e,t,n){const i=t.uint32(),o=t.pos+i;let s,a;for(;t.pos<o;){const[i]=t.tag();switch(i){case 1:s=xe(t,e.K);break;case 2:switch(e.V.kind){case"scalar":a=xe(t,e.V.T);break;case"enum":a=t.int32();break;case"message":a=we(t,new e.V.T,n,void 0)}}}void 0===s&&(s=q(e.K,j.BIGINT));"string"!=typeof s&&"number"!=typeof s&&(s=s.toString());if(void 0===a)switch(e.V.kind){case"scalar":a=q(e.V.T,j.BIGINT);break;case"enum":a=e.V.T.values[0].no;break;case"message":a=new e.V.T}return[s,a]}(n,t,o);e[a][l]=u}}function we(e,t,n,i){const o=t.getType().runtime.bin,s=null==i?void 0:i.delimited;return o.readMessage(t,e,s?i.no:e.uint32(),n,s),t}function Ee(e,t){const n=xe(e,t);return"bigint"==typeof n?n.toString():n}function xe(e,t){switch(t){case U.STRING:return e.string();case U.BOOL:return e.bool();case U.DOUBLE:return e.double();case U.FLOAT:return e.float();case U.INT32:return e.int32();case U.INT64:return e.int64();case U.UINT64:return e.uint64();case U.FIXED64:return e.fixed64();case U.BYTES:return e.bytes();case U.FIXED32:return e.fixed32();case U.SFIXED32:return e.sfixed32();case U.SFIXED64:return e.sfixed64();case U.SINT64:return e.sint64();case U.UINT32:return e.uint32();case U.SINT32:return e.sint32()}}function Pe(e,t,n,i){g(void 0!==t);const o=e.repeated;switch(e.kind){case"scalar":case"enum":let s="enum"==e.kind?U.INT32:e.T;if(o)if(g(Array.isArray(t)),e.packed)!function(e,t,n,i){if(!i.length)return;e.tag(n,F.LengthDelimited).fork();let[,o]=_e(t);for(let t=0;t<i.length;t++)e[o](i[t]);e.join()}(n,s,e.no,t);else for(const i of t)Oe(n,s,e.no,i);else Oe(n,s,e.no,t);break;case"message":if(o){g(Array.isArray(t));for(const o of t)Ie(n,i,e,o)}else Ie(n,i,e,t);break;case"map":g("object"==typeof t&&null!=t);for(const[o,s]of Object.entries(t))Re(n,i,e,o,s)}}function Re(e,t,n,i,o){e.tag(n.no,F.LengthDelimited),e.fork();let s=i;switch(n.K){case U.INT32:case U.FIXED32:case U.UINT32:case U.SFIXED32:case U.SINT32:s=Number.parseInt(i);break;case U.BOOL:g("true"==i||"false"==i),s="true"==i}switch(Oe(e,n.K,1,s),n.V.kind){case"scalar":Oe(e,n.V.T,2,o);break;case"enum":Oe(e,U.INT32,2,o);break;case"message":g(void 0!==o),e.tag(2,F.LengthDelimited).bytes(o.toBinary(t))}e.join()}function Ie(e,t,n,i){const o=ne(n.T,i);n.delimited?e.tag(n.no,F.StartGroup).raw(o.toBinary(t)).tag(n.no,F.EndGroup):e.tag(n.no,F.LengthDelimited).bytes(o.toBinary(t))}function Oe(e,t,n,i){g(void 0!==i);let[o,s]=_e(t);e.tag(n,o)[s](i)}function _e(e){let t=F.Varint;switch(e){case U.BYTES:case U.STRING:t=F.LengthDelimited;break;case U.DOUBLE:case U.FIXED64:case U.SFIXED64:t=F.Bit64;break;case U.FIXED32:case U.SFIXED32:case U.FLOAT:t=F.Bit32}return[t,U[e].toLowerCase()]}function De(e){if(void 0===e)return e;if(te(e))return e.clone();if(e instanceof Uint8Array){const t=new Uint8Array(e.byteLength);return t.set(e),t}return e}function Me(e){return e instanceof Uint8Array?e:new Uint8Array(e)}class Ae{constructor(e,t){this._fields=e,this._normalizer=t}findJsonName(e){if(!this.jsonNames){const e={};for(const t of this.list())e[t.jsonName]=e[t.name]=t;this.jsonNames=e}return this.jsonNames[e]}find(e){if(!this.numbers){const e={};for(const t of this.list())e[t.no]=t;this.numbers=e}return this.numbers[e]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort((e,t)=>e.no-t.no)),this.numbersAsc}byMember(){if(!this.members){this.members=[];const e=this.members;let t;for(const n of this.list())n.oneof?n.oneof!==t&&(t=n.oneof,e.push(t)):e.push(n)}return this.members}}function Ne(e,t){const n=Ue(e);return t?n:Ve(qe(n))}const Le=Ue;function Ue(e){let t=!1;const n=[];for(let i=0;i<e.length;i++){let o=e.charAt(i);switch(o){case"_":t=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":n.push(o),t=!1;break;default:t&&(t=!1,o=o.toUpperCase()),n.push(o)}}return n.join("")}const je=new Set(["constructor","toString","toJSON","valueOf"]),Fe=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),Be=e=>"".concat(e,"$"),qe=e=>Fe.has(e)?Be(e):e,Ve=e=>je.has(e)?Be(e):e;class ze{constructor(e){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.req=!1,this.default=void 0,this.fields=[],this.name=e,this.localName=Ne(e,!1)}addField(e){g(e.oneof===this,"field ".concat(e.name," not one of ").concat(this.name)),this.fields.push(e)}findField(e){if(!this._lookup){this._lookup=Object.create(null);for(let e=0;e<this.fields.length;e++)this._lookup[this.fields[e].localName]=this.fields[e]}return this._lookup[e]}}const He=(We=e=>new Ae(e,e=>function(e){var t,n,i,o,s,a;const r=[];let c;for(const d of"function"==typeof e?e():e){const e=d;if(e.localName=Ne(d.name,void 0!==d.oneof),e.jsonName=null!==(t=d.jsonName)&&void 0!==t?t:Le(d.name),e.repeated=null!==(n=d.repeated)&&void 0!==n&&n,"scalar"==d.kind&&(e.L=null!==(i=d.L)&&void 0!==i?i:j.BIGINT),e.delimited=null!==(o=d.delimited)&&void 0!==o&&o,e.req=null!==(s=d.req)&&void 0!==s&&s,e.opt=null!==(a=d.opt)&&void 0!==a&&a,void 0===d.packed&&(e.packed="enum"==d.kind||"scalar"==d.kind&&d.T!=U.BYTES&&d.T!=U.STRING),void 0!==d.oneof){const t="string"==typeof d.oneof?d.oneof:d.oneof.name;c&&c.name==t||(c=new ze(t)),e.oneof=c,c.addField(e)}r.push(e)}return r}(e)),Ge=e=>{for(const t of e.getType().fields.byMember()){if(t.opt)continue;const n=t.localName,i=e;if(t.repeated)i[n]=[];else switch(t.kind){case"oneof":i[n]={case:void 0};break;case"enum":i[n]=0;break;case"map":i[n]={};break;case"scalar":i[n]=q(t.T,t.L)}}},{syntax:"proto3",json:{makeReadOptions:se,makeWriteOptions:ae,readMessage(e,t,n,i){if(null==t||Array.isArray(t)||"object"!=typeof t)throw new Error("cannot decode message ".concat(e.typeName," from JSON: ").concat(de(t)));i=null!=i?i:new e;const o=new Map,s=n.typeRegistry;for(const[a,r]of Object.entries(t)){const t=e.fields.findJsonName(a);if(t){if(t.oneof){if(null===r&&"scalar"==t.kind)continue;const n=o.get(t.oneof);if(void 0!==n)throw new Error("cannot decode message ".concat(e.typeName,' from JSON: multiple keys for oneof "').concat(t.oneof.name,'" present: "').concat(n,'", "').concat(a,'"'));o.set(t.oneof,a)}le(i,r,t,n,e)}else{let t=!1;if((null==s?void 0:s.findExtension)&&a.startsWith("[")&&a.endsWith("]")){const o=s.findExtension(a.substring(1,a.length-1));if(o&&o.extendee.typeName==e.typeName){t=!0;const[e,s]=W(o);le(e,r,o.field,n,o),$(i,o,s(),n)}}if(!t&&!n.ignoreUnknownFields)throw new Error("cannot decode message ".concat(e.typeName,' from JSON: key "').concat(a,'" is unknown'))}}return i},writeMessage(e,t){const n=e.getType(),i={};let o;try{for(o of n.fields.byNumber()){if(!Z(o,e)){if(o.req)throw"required field not set";if(!t.emitDefaultValues)continue;if(!me(o))continue}const n=ge(o,o.oneof?e[o.oneof.localName].value:e[o.localName],t);void 0!==n&&(i[t.useProtoFieldName?o.name:o.jsonName]=n)}const s=t.typeRegistry;if(null==s?void 0:s.findExtensionFor)for(const o of n.runtime.bin.listUnknownFields(e)){const a=s.findExtensionFor(n.typeName,o.no);if(a&&Q(e,a)){const n=Y(e,a,t),o=ge(a.field,n,t);void 0!==o&&(i[a.field.jsonName]=o)}}}catch(e){const t=o?"cannot encode field ".concat(n.typeName,".").concat(o.name," to JSON"):"cannot encode message ".concat(n.typeName," to JSON"),i=e instanceof Error?e.message:String(e);throw new Error(t+(i.length>0?": ".concat(i):""))}return i},readScalar:(e,t,n)=>he(e,t,null!=n?n:j.BIGINT,!0),writeScalar(e,t,n){if(void 0!==t)return n||V(e,t)?ve(e,t):void 0},debug:de},bin:{makeReadOptions:Te,makeWriteOptions:Ce,listUnknownFields(e){var t;return null!==(t=e[be])&&void 0!==t?t:[]},discardUnknownFields(e){delete e[be]},writeUnknownFields(e,t){const n=e[be];if(n)for(const e of n)t.tag(e.no,e.wireType).raw(e.data)},onUnknownField(e,t,n,i){const o=e;Array.isArray(o[be])||(o[be]=[]),o[be].push({no:t,wireType:n,data:i})},readMessage(e,t,n,i,o){const s=e.getType(),a=o?t.len:t.pos+n;let r,c;for(;t.pos<a&&([r,c]=t.tag(),!0!==o||c!=F.EndGroup);){const n=s.fields.find(r);if(!n){const n=t.skip(c,r);i.readUnknownFields&&this.onUnknownField(e,r,c,n);continue}Se(e,t,n,c,i)}if(o&&(c!=F.EndGroup||r!==n))throw new Error("invalid end group tag")},readField:Se,writeMessage(e,t,n){const i=e.getType();for(const o of i.fields.byNumber())if(Z(o,e))Pe(o,o.oneof?e[o.oneof.localName].value:e[o.localName],t,n);else if(o.req)throw new Error("cannot encode field ".concat(i.typeName,".").concat(o.name," to binary: required field not set"));return n.writeUnknownFields&&this.writeUnknownFields(e,t),t},writeField(e,t,n,i){void 0!==t&&Pe(e,t,n,i)}},util:Object.assign(Object.assign({},{setEnumType:T,initPartial(e,t){if(void 0===e)return;const n=t.getType();for(const i of n.fields.byMember()){const n=i.localName,o=t,s=e;if(null!=s[n])switch(i.kind){case"oneof":const e=s[n].case;if(void 0===e)continue;const t=i.findField(e);let a=s[n].value;t&&"message"==t.kind&&!te(a,t.T)?a=new t.T(a):t&&"scalar"===t.kind&&t.T===U.BYTES&&(a=Me(a)),o[n]={case:e,value:a};break;case"scalar":case"enum":let r=s[n];i.T===U.BYTES&&(r=i.repeated?r.map(Me):Me(r)),o[n]=r;break;case"map":switch(i.V.kind){case"scalar":case"enum":if(i.V.T===U.BYTES)for(const[e,t]of Object.entries(s[n]))o[n][e]=Me(t);else Object.assign(o[n],s[n]);break;case"message":const e=i.V.T;for(const t of Object.keys(s[n])){let i=s[n][t];e.fieldWrapper||(i=new e(i)),o[n][t]=i}}break;case"message":const c=i.T;if(i.repeated)o[n]=s[n].map(e=>te(e,c)?e:new c(e));else{const e=s[n];c.fieldWrapper?"google.protobuf.BytesValue"===c.typeName?o[n]=Me(e):o[n]=e:o[n]=te(e,c)?e:new c(e)}}}},equals:(e,t,n)=>t===n||!(!t||!n)&&e.fields.byMember().every(e=>{const i=t[e.localName],o=n[e.localName];if(e.repeated){if(i.length!==o.length)return!1;switch(e.kind){case"message":return i.every((t,n)=>e.T.equals(t,o[n]));case"scalar":return i.every((t,n)=>B(e.T,t,o[n]));case"enum":return i.every((e,t)=>B(U.INT32,e,o[t]))}throw new Error("repeated cannot contain ".concat(e.kind))}switch(e.kind){case"message":let t=i,n=o;return e.T.fieldWrapper&&(void 0===t||te(t)||(t=e.T.fieldWrapper.wrapField(t)),void 0===n||te(n)||(n=e.T.fieldWrapper.wrapField(n))),e.T.equals(t,n);case"enum":return B(U.INT32,i,o);case"scalar":return B(e.T,i,o);case"oneof":if(i.case!==o.case)return!1;const s=e.findField(i.case);if(void 0===s)return!0;switch(s.kind){case"message":return s.T.equals(i.value,o.value);case"enum":return B(U.INT32,i.value,o.value);case"scalar":return B(s.T,i.value,o.value)}throw new Error("oneof cannot contain ".concat(s.kind));case"map":const a=Object.keys(i).concat(Object.keys(o));switch(e.V.kind){case"message":const t=e.V.T;return a.every(e=>t.equals(i[e],o[e]));case"enum":return a.every(e=>B(U.INT32,i[e],o[e]));case"scalar":const n=e.V.T;return a.every(e=>B(n,i[e],o[e]))}}}),clone(e){const t=e.getType(),n=new t,i=n;for(const n of t.fields.byMember()){const t=e[n.localName];let o;if(n.repeated)o=t.map(De);else if("map"==n.kind){o=i[n.localName];for(const[e,n]of Object.entries(t))o[e]=De(n)}else o="oneof"==n.kind?n.findField(t.case)?{case:t.case,value:De(t.value)}:{case:void 0}:De(t);i[n.localName]=o}for(const n of t.runtime.bin.listUnknownFields(e))t.runtime.bin.onUnknownField(i,n.no,n.wireType,n.data);return n}}),{newFieldList:We,initFields:Ge}),makeMessageType(e,t,n){return function(e,t,n,i){var o;const s=null!==(o=null==i?void 0:i.localName)&&void 0!==o?o:t.substring(t.lastIndexOf(".")+1),a={[s]:function(t){e.util.initFields(this),e.util.initPartial(t,this)}}[s];return Object.setPrototypeOf(a.prototype,new E),Object.assign(a,{runtime:e,typeName:t,fields:e.util.newFieldList(n),fromBinary:(e,t)=>(new a).fromBinary(e,t),fromJson:(e,t)=>(new a).fromJson(e,t),fromJsonString:(e,t)=>(new a).fromJsonString(e,t),equals:(t,n)=>e.util.equals(a,t,n)}),a}(this,e,t,n)},makeEnum:S,makeEnumType:C,getEnumType:k,makeExtension(e,t,n){return function(e,t,n,i){let o;return{typeName:t,extendee:n,get field(){if(!o){const n="function"==typeof i?i():i;n.name=t.split(".").pop(),n.jsonName="[".concat(t,"]"),o=e.util.newFieldList([n]).list()[0]}return o},runtime:e}}(this,e,t,n)}});var We,Ge;class Ke extends E{constructor(e){super(),this.seconds=L.zero,this.nanos=0,He.util.initPartial(e,this)}fromJson(e,t){if("string"!=typeof e)throw new Error("cannot decode google.protobuf.Timestamp from JSON: ".concat(He.json.debug(e)));const n=e.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!n)throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");const i=Date.parse(n[1]+"-"+n[2]+"-"+n[3]+"T"+n[4]+":"+n[5]+":"+n[6]+(n[8]?n[8]:"Z"));if(Number.isNaN(i))throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(i<Date.parse("0001-01-01T00:00:00Z")||i>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=L.parse(i/1e3),this.nanos=0,n[7]&&(this.nanos=parseInt("1"+n[7]+"0".repeat(9-n[7].length))-1e9),this}toJson(e){const t=1e3*Number(this.seconds);if(t<Date.parse("0001-01-01T00:00:00Z")||t>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let n="Z";if(this.nanos>0){const e=(this.nanos+1e9).toString().substring(1);n="000000"===e.substring(3)?"."+e.substring(0,3)+"Z":"000"===e.substring(6)?"."+e.substring(0,6)+"Z":"."+e+"Z"}return new Date(t).toISOString().replace(".000Z",n)}toDate(){return new Date(1e3*Number(this.seconds)+Math.ceil(this.nanos/1e6))}static now(){return Ke.fromDate(new Date)}static fromDate(e){const t=e.getTime();return new Ke({seconds:L.parse(Math.floor(t/1e3)),nanos:t%1e3*1e6})}static fromBinary(e,t){return(new Ke).fromBinary(e,t)}static fromJson(e,t){return(new Ke).fromJson(e,t)}static fromJsonString(e,t){return(new Ke).fromJsonString(e,t)}static equals(e,t){return He.util.equals(Ke,e,t)}}Ke.runtime=He,Ke.typeName="google.protobuf.Timestamp",Ke.fields=He.util.newFieldList(()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]);const Je=He.makeMessageType("livekit.MetricsBatch",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Ke},{no:3,name:"str_data",kind:"scalar",T:9,repeated:!0},{no:4,name:"time_series",kind:"message",T:Ye,repeated:!0},{no:5,name:"events",kind:"message",T:Qe,repeated:!0}]),Ye=He.makeMessageType("livekit.TimeSeriesMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"samples",kind:"message",T:$e,repeated:!0},{no:5,name:"rid",kind:"scalar",T:13}]),$e=He.makeMessageType("livekit.MetricSample",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Ke},{no:3,name:"value",kind:"scalar",T:2}]),Qe=He.makeMessageType("livekit.EventMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"start_timestamp_ms",kind:"scalar",T:3},{no:5,name:"end_timestamp_ms",kind:"scalar",T:3,opt:!0},{no:6,name:"normalized_start_timestamp",kind:"message",T:Ke},{no:7,name:"normalized_end_timestamp",kind:"message",T:Ke,opt:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"rid",kind:"scalar",T:13}]),Xe=He.makeEnum("livekit.BackupCodecPolicy",[{no:0,name:"PREFER_REGRESSION"},{no:1,name:"SIMULCAST"},{no:2,name:"REGRESSION"}]),Ze=He.makeEnum("livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]),et=He.makeEnum("livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]),tt=He.makeEnum("livekit.VideoQuality",[{no:0,name:"LOW"},{no:1,name:"MEDIUM"},{no:2,name:"HIGH"},{no:3,name:"OFF"}]),nt=He.makeEnum("livekit.ConnectionQuality",[{no:0,name:"POOR"},{no:1,name:"GOOD"},{no:2,name:"EXCELLENT"},{no:3,name:"LOST"}]),it=He.makeEnum("livekit.ClientConfigSetting",[{no:0,name:"UNSET"},{no:1,name:"DISABLED"},{no:2,name:"ENABLED"}]),ot=He.makeEnum("livekit.DisconnectReason",[{no:0,name:"UNKNOWN_REASON"},{no:1,name:"CLIENT_INITIATED"},{no:2,name:"DUPLICATE_IDENTITY"},{no:3,name:"SERVER_SHUTDOWN"},{no:4,name:"PARTICIPANT_REMOVED"},{no:5,name:"ROOM_DELETED"},{no:6,name:"STATE_MISMATCH"},{no:7,name:"JOIN_FAILURE"},{no:8,name:"MIGRATION"},{no:9,name:"SIGNAL_CLOSE"},{no:10,name:"ROOM_CLOSED"},{no:11,name:"USER_UNAVAILABLE"},{no:12,name:"USER_REJECTED"},{no:13,name:"SIP_TRUNK_FAILURE"},{no:14,name:"CONNECTION_TIMEOUT"},{no:15,name:"MEDIA_FAILURE"}]),st=He.makeEnum("livekit.ReconnectReason",[{no:0,name:"RR_UNKNOWN"},{no:1,name:"RR_SIGNAL_DISCONNECTED"},{no:2,name:"RR_PUBLISHER_FAILED"},{no:3,name:"RR_SUBSCRIBER_FAILED"},{no:4,name:"RR_SWITCH_CANDIDATE"}]),at=He.makeEnum("livekit.SubscriptionError",[{no:0,name:"SE_UNKNOWN"},{no:1,name:"SE_CODEC_UNSUPPORTED"},{no:2,name:"SE_TRACK_NOTFOUND"}]),rt=He.makeEnum("livekit.AudioTrackFeature",[{no:0,name:"TF_STEREO"},{no:1,name:"TF_NO_DTX"},{no:2,name:"TF_AUTO_GAIN_CONTROL"},{no:3,name:"TF_ECHO_CANCELLATION"},{no:4,name:"TF_NOISE_SUPPRESSION"},{no:5,name:"TF_ENHANCED_NOISE_CANCELLATION"},{no:6,name:"TF_PRECONNECT_BUFFER"}]),ct=He.makeMessageType("livekit.Room",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"empty_timeout",kind:"scalar",T:13},{no:14,name:"departure_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:5,name:"creation_time",kind:"scalar",T:3},{no:15,name:"creation_time_ms",kind:"scalar",T:3},{no:6,name:"turn_password",kind:"scalar",T:9},{no:7,name:"enabled_codecs",kind:"message",T:dt,repeated:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"num_participants",kind:"scalar",T:13},{no:11,name:"num_publishers",kind:"scalar",T:13},{no:10,name:"active_recording",kind:"scalar",T:8},{no:13,name:"version",kind:"message",T:zt}]),dt=He.makeMessageType("livekit.Codec",()=>[{no:1,name:"mime",kind:"scalar",T:9},{no:2,name:"fmtp_line",kind:"scalar",T:9}]),lt=He.makeMessageType("livekit.ParticipantPermission",()=>[{no:1,name:"can_subscribe",kind:"scalar",T:8},{no:2,name:"can_publish",kind:"scalar",T:8},{no:3,name:"can_publish_data",kind:"scalar",T:8},{no:9,name:"can_publish_sources",kind:"enum",T:He.getEnumType(et),repeated:!0},{no:7,name:"hidden",kind:"scalar",T:8},{no:8,name:"recorder",kind:"scalar",T:8},{no:10,name:"can_update_metadata",kind:"scalar",T:8},{no:11,name:"agent",kind:"scalar",T:8},{no:12,name:"can_subscribe_metrics",kind:"scalar",T:8}]),ut=He.makeMessageType("livekit.ParticipantInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"identity",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:He.getEnumType(ht)},{no:4,name:"tracks",kind:"message",T:vt,repeated:!0},{no:5,name:"metadata",kind:"scalar",T:9},{no:6,name:"joined_at",kind:"scalar",T:3},{no:17,name:"joined_at_ms",kind:"scalar",T:3},{no:9,name:"name",kind:"scalar",T:9},{no:10,name:"version",kind:"scalar",T:13},{no:11,name:"permission",kind:"message",T:lt},{no:12,name:"region",kind:"scalar",T:9},{no:13,name:"is_publisher",kind:"scalar",T:8},{no:14,name:"kind",kind:"enum",T:He.getEnumType(pt)},{no:15,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:16,name:"disconnect_reason",kind:"enum",T:He.getEnumType(ot)},{no:18,name:"kind_details",kind:"enum",T:He.getEnumType(mt),repeated:!0}]),ht=He.makeEnum("livekit.ParticipantInfo.State",[{no:0,name:"JOINING"},{no:1,name:"JOINED"},{no:2,name:"ACTIVE"},{no:3,name:"DISCONNECTED"}]),pt=He.makeEnum("livekit.ParticipantInfo.Kind",[{no:0,name:"STANDARD"},{no:1,name:"INGRESS"},{no:2,name:"EGRESS"},{no:3,name:"SIP"},{no:4,name:"AGENT"},{no:7,name:"CONNECTOR"}]),mt=He.makeEnum("livekit.ParticipantInfo.KindDetail",[{no:0,name:"CLOUD_AGENT"},{no:1,name:"FORWARDED"}]),gt=He.makeEnum("livekit.Encryption.Type",[{no:0,name:"NONE"},{no:1,name:"GCM"},{no:2,name:"CUSTOM"}]),ft=He.makeMessageType("livekit.SimulcastCodecInfo",()=>[{no:1,name:"mime_type",kind:"scalar",T:9},{no:2,name:"mid",kind:"scalar",T:9},{no:3,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:bt,repeated:!0},{no:5,name:"video_layer_mode",kind:"enum",T:He.getEnumType(yt)},{no:6,name:"sdp_cid",kind:"scalar",T:9}]),vt=He.makeMessageType("livekit.TrackInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"type",kind:"enum",T:He.getEnumType(Ze)},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"muted",kind:"scalar",T:8},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"simulcast",kind:"scalar",T:8},{no:8,name:"disable_dtx",kind:"scalar",T:8},{no:9,name:"source",kind:"enum",T:He.getEnumType(et)},{no:10,name:"layers",kind:"message",T:bt,repeated:!0},{no:11,name:"mime_type",kind:"scalar",T:9},{no:12,name:"mid",kind:"scalar",T:9},{no:13,name:"codecs",kind:"message",T:ft,repeated:!0},{no:14,name:"stereo",kind:"scalar",T:8},{no:15,name:"disable_red",kind:"scalar",T:8},{no:16,name:"encryption",kind:"enum",T:He.getEnumType(gt)},{no:17,name:"stream",kind:"scalar",T:9},{no:18,name:"version",kind:"message",T:zt},{no:19,name:"audio_features",kind:"enum",T:He.getEnumType(rt),repeated:!0},{no:20,name:"backup_codec_policy",kind:"enum",T:He.getEnumType(Xe)}]),bt=He.makeMessageType("livekit.VideoLayer",()=>[{no:1,name:"quality",kind:"enum",T:He.getEnumType(tt)},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"ssrc",kind:"scalar",T:13},{no:6,name:"spatial_layer",kind:"scalar",T:5},{no:7,name:"rid",kind:"scalar",T:9}]),yt=He.makeEnum("livekit.VideoLayer.Mode",[{no:0,name:"MODE_UNUSED"},{no:1,name:"ONE_SPATIAL_LAYER_PER_STREAM"},{no:2,name:"MULTIPLE_SPATIAL_LAYERS_PER_STREAM"},{no:3,name:"ONE_SPATIAL_LAYER_PER_STREAM_INCOMPLETE_RTCP_SR"}]),kt=He.makeMessageType("livekit.DataPacket",()=>[{no:1,name:"kind",kind:"enum",T:He.getEnumType(Tt)},{no:4,name:"participant_identity",kind:"scalar",T:9},{no:5,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:2,name:"user",kind:"message",T:xt,oneof:"value"},{no:3,name:"speaker",kind:"message",T:wt,oneof:"value"},{no:6,name:"sip_dtmf",kind:"message",T:Pt,oneof:"value"},{no:7,name:"transcription",kind:"message",T:Rt,oneof:"value"},{no:8,name:"metrics",kind:"message",T:Je,oneof:"value"},{no:9,name:"chat_message",kind:"message",T:Ot,oneof:"value"},{no:10,name:"rpc_request",kind:"message",T:_t,oneof:"value"},{no:11,name:"rpc_ack",kind:"message",T:Dt,oneof:"value"},{no:12,name:"rpc_response",kind:"message",T:Mt,oneof:"value"},{no:13,name:"stream_header",kind:"message",T:Kt,oneof:"value"},{no:14,name:"stream_chunk",kind:"message",T:Jt,oneof:"value"},{no:15,name:"stream_trailer",kind:"message",T:Yt,oneof:"value"},{no:18,name:"encrypted_packet",kind:"message",T:Ct,oneof:"value"},{no:16,name:"sequence",kind:"scalar",T:13},{no:17,name:"participant_sid",kind:"scalar",T:9}]),Tt=He.makeEnum("livekit.DataPacket.Kind",[{no:0,name:"RELIABLE"},{no:1,name:"LOSSY"}]),Ct=He.makeMessageType("livekit.EncryptedPacket",()=>[{no:1,name:"encryption_type",kind:"enum",T:He.getEnumType(gt)},{no:2,name:"iv",kind:"scalar",T:12},{no:3,name:"key_index",kind:"scalar",T:13},{no:4,name:"encrypted_value",kind:"scalar",T:12}]),St=He.makeMessageType("livekit.EncryptedPacketPayload",()=>[{no:1,name:"user",kind:"message",T:xt,oneof:"value"},{no:3,name:"chat_message",kind:"message",T:Ot,oneof:"value"},{no:4,name:"rpc_request",kind:"message",T:_t,oneof:"value"},{no:5,name:"rpc_ack",kind:"message",T:Dt,oneof:"value"},{no:6,name:"rpc_response",kind:"message",T:Mt,oneof:"value"},{no:7,name:"stream_header",kind:"message",T:Kt,oneof:"value"},{no:8,name:"stream_chunk",kind:"message",T:Jt,oneof:"value"},{no:9,name:"stream_trailer",kind:"message",T:Yt,oneof:"value"}]),wt=He.makeMessageType("livekit.ActiveSpeakerUpdate",()=>[{no:1,name:"speakers",kind:"message",T:Et,repeated:!0}]),Et=He.makeMessageType("livekit.SpeakerInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"level",kind:"scalar",T:2},{no:3,name:"active",kind:"scalar",T:8}]),xt=He.makeMessageType("livekit.UserPacket",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:5,name:"participant_identity",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"destination_sids",kind:"scalar",T:9,repeated:!0},{no:6,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:4,name:"topic",kind:"scalar",T:9,opt:!0},{no:8,name:"id",kind:"scalar",T:9,opt:!0},{no:9,name:"start_time",kind:"scalar",T:4,opt:!0},{no:10,name:"end_time",kind:"scalar",T:4,opt:!0},{no:11,name:"nonce",kind:"scalar",T:12}]),Pt=He.makeMessageType("livekit.SipDTMF",()=>[{no:3,name:"code",kind:"scalar",T:13},{no:4,name:"digit",kind:"scalar",T:9}]),Rt=He.makeMessageType("livekit.Transcription",()=>[{no:2,name:"transcribed_participant_identity",kind:"scalar",T:9},{no:3,name:"track_id",kind:"scalar",T:9},{no:4,name:"segments",kind:"message",T:It,repeated:!0}]),It=He.makeMessageType("livekit.TranscriptionSegment",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"text",kind:"scalar",T:9},{no:3,name:"start_time",kind:"scalar",T:4},{no:4,name:"end_time",kind:"scalar",T:4},{no:5,name:"final",kind:"scalar",T:8},{no:6,name:"language",kind:"scalar",T:9}]),Ot=He.makeMessageType("livekit.ChatMessage",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"edit_timestamp",kind:"scalar",T:3,opt:!0},{no:4,name:"message",kind:"scalar",T:9},{no:5,name:"deleted",kind:"scalar",T:8},{no:6,name:"generated",kind:"scalar",T:8}]),_t=He.makeMessageType("livekit.RpcRequest",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"method",kind:"scalar",T:9},{no:3,name:"payload",kind:"scalar",T:9},{no:4,name:"response_timeout_ms",kind:"scalar",T:13},{no:5,name:"version",kind:"scalar",T:13}]),Dt=He.makeMessageType("livekit.RpcAck",()=>[{no:1,name:"request_id",kind:"scalar",T:9}]),Mt=He.makeMessageType("livekit.RpcResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:9,oneof:"value"},{no:3,name:"error",kind:"message",T:At,oneof:"value"}]),At=He.makeMessageType("livekit.RpcError",()=>[{no:1,name:"code",kind:"scalar",T:13},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"data",kind:"scalar",T:9}]),Nt=He.makeMessageType("livekit.ParticipantTracks",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sids",kind:"scalar",T:9,repeated:!0}]),Lt=He.makeMessageType("livekit.ServerInfo",()=>[{no:1,name:"edition",kind:"enum",T:He.getEnumType(Ut)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"region",kind:"scalar",T:9},{no:5,name:"node_id",kind:"scalar",T:9},{no:6,name:"debug_info",kind:"scalar",T:9},{no:7,name:"agent_protocol",kind:"scalar",T:5}]),Ut=He.makeEnum("livekit.ServerInfo.Edition",[{no:0,name:"Standard"},{no:1,name:"Cloud"}]),jt=He.makeMessageType("livekit.ClientInfo",()=>[{no:1,name:"sdk",kind:"enum",T:He.getEnumType(Ft)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"os",kind:"scalar",T:9},{no:5,name:"os_version",kind:"scalar",T:9},{no:6,name:"device_model",kind:"scalar",T:9},{no:7,name:"browser",kind:"scalar",T:9},{no:8,name:"browser_version",kind:"scalar",T:9},{no:9,name:"address",kind:"scalar",T:9},{no:10,name:"network",kind:"scalar",T:9},{no:11,name:"other_sdks",kind:"scalar",T:9}]),Ft=He.makeEnum("livekit.ClientInfo.SDK",[{no:0,name:"UNKNOWN"},{no:1,name:"JS"},{no:2,name:"SWIFT"},{no:3,name:"ANDROID"},{no:4,name:"FLUTTER"},{no:5,name:"GO"},{no:6,name:"UNITY"},{no:7,name:"REACT_NATIVE"},{no:8,name:"RUST"},{no:9,name:"PYTHON"},{no:10,name:"CPP"},{no:11,name:"UNITY_WEB"},{no:12,name:"NODE"},{no:13,name:"UNREAL"},{no:14,name:"ESP32"}]),Bt=He.makeMessageType("livekit.ClientConfiguration",()=>[{no:1,name:"video",kind:"message",T:qt},{no:2,name:"screen",kind:"message",T:qt},{no:3,name:"resume_connection",kind:"enum",T:He.getEnumType(it)},{no:4,name:"disabled_codecs",kind:"message",T:Vt},{no:5,name:"force_relay",kind:"enum",T:He.getEnumType(it)}]),qt=He.makeMessageType("livekit.VideoConfiguration",()=>[{no:1,name:"hardware_encoder",kind:"enum",T:He.getEnumType(it)}]),Vt=He.makeMessageType("livekit.DisabledCodecs",()=>[{no:1,name:"codecs",kind:"message",T:dt,repeated:!0},{no:2,name:"publish",kind:"message",T:dt,repeated:!0}]),zt=He.makeMessageType("livekit.TimedVersion",()=>[{no:1,name:"unix_micro",kind:"scalar",T:3},{no:2,name:"ticks",kind:"scalar",T:5}]),Ht=He.makeEnum("livekit.DataStream.OperationType",[{no:0,name:"CREATE"},{no:1,name:"UPDATE"},{no:2,name:"DELETE"},{no:3,name:"REACTION"}]),Wt=He.makeMessageType("livekit.DataStream.TextHeader",()=>[{no:1,name:"operation_type",kind:"enum",T:He.getEnumType(Ht)},{no:2,name:"version",kind:"scalar",T:5},{no:3,name:"reply_to_stream_id",kind:"scalar",T:9},{no:4,name:"attached_stream_ids",kind:"scalar",T:9,repeated:!0},{no:5,name:"generated",kind:"scalar",T:8}],{localName:"DataStream_TextHeader"}),Gt=He.makeMessageType("livekit.DataStream.ByteHeader",()=>[{no:1,name:"name",kind:"scalar",T:9}],{localName:"DataStream_ByteHeader"}),Kt=He.makeMessageType("livekit.DataStream.Header",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"topic",kind:"scalar",T:9},{no:4,name:"mime_type",kind:"scalar",T:9},{no:5,name:"total_length",kind:"scalar",T:4,opt:!0},{no:7,name:"encryption_type",kind:"enum",T:He.getEnumType(gt)},{no:8,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:9,name:"text_header",kind:"message",T:Wt,oneof:"content_header"},{no:10,name:"byte_header",kind:"message",T:Gt,oneof:"content_header"}],{localName:"DataStream_Header"}),Jt=He.makeMessageType("livekit.DataStream.Chunk",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"chunk_index",kind:"scalar",T:4},{no:3,name:"content",kind:"scalar",T:12},{no:4,name:"version",kind:"scalar",T:5},{no:5,name:"iv",kind:"scalar",T:12,opt:!0}],{localName:"DataStream_Chunk"}),Yt=He.makeMessageType("livekit.DataStream.Trailer",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"reason",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}}],{localName:"DataStream_Trailer"}),$t=He.makeMessageType("livekit.SubscribedAudioCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"enabled",kind:"scalar",T:8}]),Qt=He.makeEnum("livekit.SignalTarget",[{no:0,name:"PUBLISHER"},{no:1,name:"SUBSCRIBER"}]),Xt=He.makeEnum("livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]),Zt=He.makeEnum("livekit.CandidateProtocol",[{no:0,name:"UDP"},{no:1,name:"TCP"},{no:2,name:"TLS"}]),en=He.makeMessageType("livekit.SignalRequest",()=>[{no:1,name:"offer",kind:"message",T:un,oneof:"message"},{no:2,name:"answer",kind:"message",T:un,oneof:"message"},{no:3,name:"trickle",kind:"message",T:sn,oneof:"message"},{no:4,name:"add_track",kind:"message",T:on,oneof:"message"},{no:5,name:"mute",kind:"message",T:an,oneof:"message"},{no:6,name:"subscription",kind:"message",T:pn,oneof:"message"},{no:7,name:"track_setting",kind:"message",T:mn,oneof:"message"},{no:8,name:"leave",kind:"message",T:vn,oneof:"message"},{no:10,name:"update_layers",kind:"message",T:yn,oneof:"message"},{no:11,name:"subscription_permission",kind:"message",T:Mn,oneof:"message"},{no:12,name:"sync_state",kind:"message",T:Ln,oneof:"message"},{no:13,name:"simulate",kind:"message",T:Fn,oneof:"message"},{no:14,name:"ping",kind:"scalar",T:3,oneof:"message"},{no:15,name:"update_metadata",kind:"message",T:kn,oneof:"message"},{no:16,name:"ping_req",kind:"message",T:Bn,oneof:"message"},{no:17,name:"update_audio_track",kind:"message",T:gn,oneof:"message"},{no:18,name:"update_video_track",kind:"message",T:fn,oneof:"message"}]),tn=He.makeMessageType("livekit.SignalResponse",()=>[{no:1,name:"join",kind:"message",T:rn,oneof:"message"},{no:2,name:"answer",kind:"message",T:un,oneof:"message"},{no:3,name:"offer",kind:"message",T:un,oneof:"message"},{no:4,name:"trickle",kind:"message",T:sn,oneof:"message"},{no:5,name:"update",kind:"message",T:hn,oneof:"message"},{no:6,name:"track_published",kind:"message",T:dn,oneof:"message"},{no:8,name:"leave",kind:"message",T:vn,oneof:"message"},{no:9,name:"mute",kind:"message",T:an,oneof:"message"},{no:10,name:"speakers_changed",kind:"message",T:Cn,oneof:"message"},{no:11,name:"room_update",kind:"message",T:Sn,oneof:"message"},{no:12,name:"connection_quality",kind:"message",T:En,oneof:"message"},{no:13,name:"stream_state_update",kind:"message",T:Pn,oneof:"message"},{no:14,name:"subscribed_quality_update",kind:"message",T:On,oneof:"message"},{no:15,name:"subscription_permission_update",kind:"message",T:An,oneof:"message"},{no:16,name:"refresh_token",kind:"scalar",T:9,oneof:"message"},{no:17,name:"track_unpublished",kind:"message",T:ln,oneof:"message"},{no:18,name:"pong",kind:"scalar",T:3,oneof:"message"},{no:19,name:"reconnect",kind:"message",T:cn,oneof:"message"},{no:20,name:"pong_resp",kind:"message",T:qn,oneof:"message"},{no:21,name:"subscription_response",kind:"message",T:Hn,oneof:"message"},{no:22,name:"request_response",kind:"message",T:Wn,oneof:"message"},{no:23,name:"track_subscribed",kind:"message",T:Kn,oneof:"message"},{no:24,name:"room_moved",kind:"message",T:Nn,oneof:"message"},{no:25,name:"media_sections_requirement",kind:"message",T:Xn,oneof:"message"},{no:26,name:"subscribed_audio_codec_update",kind:"message",T:_n,oneof:"message"}]),nn=He.makeMessageType("livekit.SimulcastCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:bt,repeated:!0},{no:5,name:"video_layer_mode",kind:"enum",T:He.getEnumType(yt)}]),on=He.makeMessageType("livekit.AddTrackRequest",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:He.getEnumType(Ze)},{no:4,name:"width",kind:"scalar",T:13},{no:5,name:"height",kind:"scalar",T:13},{no:6,name:"muted",kind:"scalar",T:8},{no:7,name:"disable_dtx",kind:"scalar",T:8},{no:8,name:"source",kind:"enum",T:He.getEnumType(et)},{no:9,name:"layers",kind:"message",T:bt,repeated:!0},{no:10,name:"simulcast_codecs",kind:"message",T:nn,repeated:!0},{no:11,name:"sid",kind:"scalar",T:9},{no:12,name:"stereo",kind:"scalar",T:8},{no:13,name:"disable_red",kind:"scalar",T:8},{no:14,name:"encryption",kind:"enum",T:He.getEnumType(gt)},{no:15,name:"stream",kind:"scalar",T:9},{no:16,name:"backup_codec_policy",kind:"enum",T:He.getEnumType(Xe)},{no:17,name:"audio_features",kind:"enum",T:He.getEnumType(rt),repeated:!0}]),sn=He.makeMessageType("livekit.TrickleRequest",()=>[{no:1,name:"candidateInit",kind:"scalar",T:9},{no:2,name:"target",kind:"enum",T:He.getEnumType(Qt)},{no:3,name:"final",kind:"scalar",T:8}]),an=He.makeMessageType("livekit.MuteTrackRequest",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"muted",kind:"scalar",T:8}]),rn=He.makeMessageType("livekit.JoinResponse",()=>[{no:1,name:"room",kind:"message",T:ct},{no:2,name:"participant",kind:"message",T:ut},{no:3,name:"other_participants",kind:"message",T:ut,repeated:!0},{no:4,name:"server_version",kind:"scalar",T:9},{no:5,name:"ice_servers",kind:"message",T:Tn,repeated:!0},{no:6,name:"subscriber_primary",kind:"scalar",T:8},{no:7,name:"alternative_url",kind:"scalar",T:9},{no:8,name:"client_configuration",kind:"message",T:Bt},{no:9,name:"server_region",kind:"scalar",T:9},{no:10,name:"ping_timeout",kind:"scalar",T:5},{no:11,name:"ping_interval",kind:"scalar",T:5},{no:12,name:"server_info",kind:"message",T:Lt},{no:13,name:"sif_trailer",kind:"scalar",T:12},{no:14,name:"enabled_publish_codecs",kind:"message",T:dt,repeated:!0},{no:15,name:"fast_publish",kind:"scalar",T:8}]),cn=He.makeMessageType("livekit.ReconnectResponse",()=>[{no:1,name:"ice_servers",kind:"message",T:Tn,repeated:!0},{no:2,name:"client_configuration",kind:"message",T:Bt},{no:3,name:"server_info",kind:"message",T:Lt},{no:4,name:"last_message_seq",kind:"scalar",T:13}]),dn=He.makeMessageType("livekit.TrackPublishedResponse",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"track",kind:"message",T:vt}]),ln=He.makeMessageType("livekit.TrackUnpublishedResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),un=He.makeMessageType("livekit.SessionDescription",()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"sdp",kind:"scalar",T:9},{no:3,name:"id",kind:"scalar",T:13},{no:4,name:"mid_to_track_id",kind:"map",K:9,V:{kind:"scalar",T:9}}]),hn=He.makeMessageType("livekit.ParticipantUpdate",()=>[{no:1,name:"participants",kind:"message",T:ut,repeated:!0}]),pn=He.makeMessageType("livekit.UpdateSubscription",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:2,name:"subscribe",kind:"scalar",T:8},{no:3,name:"participant_tracks",kind:"message",T:Nt,repeated:!0}]),mn=He.makeMessageType("livekit.UpdateTrackSettings",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:3,name:"disabled",kind:"scalar",T:8},{no:4,name:"quality",kind:"enum",T:He.getEnumType(tt)},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"fps",kind:"scalar",T:13},{no:8,name:"priority",kind:"scalar",T:13}]),gn=He.makeMessageType("livekit.UpdateLocalAudioTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"features",kind:"enum",T:He.getEnumType(rt),repeated:!0}]),fn=He.makeMessageType("livekit.UpdateLocalVideoTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13}]),vn=He.makeMessageType("livekit.LeaveRequest",()=>[{no:1,name:"can_reconnect",kind:"scalar",T:8},{no:2,name:"reason",kind:"enum",T:He.getEnumType(ot)},{no:3,name:"action",kind:"enum",T:He.getEnumType(bn)},{no:4,name:"regions",kind:"message",T:Vn}]),bn=He.makeEnum("livekit.LeaveRequest.Action",[{no:0,name:"DISCONNECT"},{no:1,name:"RESUME"},{no:2,name:"RECONNECT"}]),yn=He.makeMessageType("livekit.UpdateVideoLayers",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"layers",kind:"message",T:bt,repeated:!0}]),kn=He.makeMessageType("livekit.UpdateParticipantMetadata",()=>[{no:1,name:"metadata",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:4,name:"request_id",kind:"scalar",T:13}]),Tn=He.makeMessageType("livekit.ICEServer",()=>[{no:1,name:"urls",kind:"scalar",T:9,repeated:!0},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"credential",kind:"scalar",T:9}]),Cn=He.makeMessageType("livekit.SpeakersChanged",()=>[{no:1,name:"speakers",kind:"message",T:Et,repeated:!0}]),Sn=He.makeMessageType("livekit.RoomUpdate",()=>[{no:1,name:"room",kind:"message",T:ct}]),wn=He.makeMessageType("livekit.ConnectionQualityInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"quality",kind:"enum",T:He.getEnumType(nt)},{no:3,name:"score",kind:"scalar",T:2}]),En=He.makeMessageType("livekit.ConnectionQualityUpdate",()=>[{no:1,name:"updates",kind:"message",T:wn,repeated:!0}]),xn=He.makeMessageType("livekit.StreamStateInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:He.getEnumType(Xt)}]),Pn=He.makeMessageType("livekit.StreamStateUpdate",()=>[{no:1,name:"stream_states",kind:"message",T:xn,repeated:!0}]),Rn=He.makeMessageType("livekit.SubscribedQuality",()=>[{no:1,name:"quality",kind:"enum",T:He.getEnumType(tt)},{no:2,name:"enabled",kind:"scalar",T:8}]),In=He.makeMessageType("livekit.SubscribedCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"qualities",kind:"message",T:Rn,repeated:!0}]),On=He.makeMessageType("livekit.SubscribedQualityUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_qualities",kind:"message",T:Rn,repeated:!0},{no:3,name:"subscribed_codecs",kind:"message",T:In,repeated:!0}]),_n=He.makeMessageType("livekit.SubscribedAudioCodecUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_audio_codecs",kind:"message",T:$t,repeated:!0}]),Dn=He.makeMessageType("livekit.TrackPermission",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"all_tracks",kind:"scalar",T:8},{no:3,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:4,name:"participant_identity",kind:"scalar",T:9}]),Mn=He.makeMessageType("livekit.SubscriptionPermission",()=>[{no:1,name:"all_participants",kind:"scalar",T:8},{no:2,name:"track_permissions",kind:"message",T:Dn,repeated:!0}]),An=He.makeMessageType("livekit.SubscriptionPermissionUpdate",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"allowed",kind:"scalar",T:8}]),Nn=He.makeMessageType("livekit.RoomMovedResponse",()=>[{no:1,name:"room",kind:"message",T:ct},{no:2,name:"token",kind:"scalar",T:9},{no:3,name:"participant",kind:"message",T:ut},{no:4,name:"other_participants",kind:"message",T:ut,repeated:!0}]),Ln=He.makeMessageType("livekit.SyncState",()=>[{no:1,name:"answer",kind:"message",T:un},{no:2,name:"subscription",kind:"message",T:pn},{no:3,name:"publish_tracks",kind:"message",T:dn,repeated:!0},{no:4,name:"data_channels",kind:"message",T:jn,repeated:!0},{no:5,name:"offer",kind:"message",T:un},{no:6,name:"track_sids_disabled",kind:"scalar",T:9,repeated:!0},{no:7,name:"datachannel_receive_states",kind:"message",T:Un,repeated:!0}]),Un=He.makeMessageType("livekit.DataChannelReceiveState",()=>[{no:1,name:"publisher_sid",kind:"scalar",T:9},{no:2,name:"last_seq",kind:"scalar",T:13}]),jn=He.makeMessageType("livekit.DataChannelInfo",()=>[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:13},{no:3,name:"target",kind:"enum",T:He.getEnumType(Qt)}]),Fn=He.makeMessageType("livekit.SimulateScenario",()=>[{no:1,name:"speaker_update",kind:"scalar",T:5,oneof:"scenario"},{no:2,name:"node_failure",kind:"scalar",T:8,oneof:"scenario"},{no:3,name:"migration",kind:"scalar",T:8,oneof:"scenario"},{no:4,name:"server_leave",kind:"scalar",T:8,oneof:"scenario"},{no:5,name:"switch_candidate_protocol",kind:"enum",T:He.getEnumType(Zt),oneof:"scenario"},{no:6,name:"subscriber_bandwidth",kind:"scalar",T:3,oneof:"scenario"},{no:7,name:"disconnect_signal_on_resume",kind:"scalar",T:8,oneof:"scenario"},{no:8,name:"disconnect_signal_on_resume_no_messages",kind:"scalar",T:8,oneof:"scenario"},{no:9,name:"leave_request_full_reconnect",kind:"scalar",T:8,oneof:"scenario"}]),Bn=He.makeMessageType("livekit.Ping",()=>[{no:1,name:"timestamp",kind:"scalar",T:3},{no:2,name:"rtt",kind:"scalar",T:3}]),qn=He.makeMessageType("livekit.Pong",()=>[{no:1,name:"last_ping_timestamp",kind:"scalar",T:3},{no:2,name:"timestamp",kind:"scalar",T:3}]),Vn=He.makeMessageType("livekit.RegionSettings",()=>[{no:1,name:"regions",kind:"message",T:zn,repeated:!0}]),zn=He.makeMessageType("livekit.RegionInfo",()=>[{no:1,name:"region",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9},{no:3,name:"distance",kind:"scalar",T:3}]),Hn=He.makeMessageType("livekit.SubscriptionResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"err",kind:"enum",T:He.getEnumType(at)}]),Wn=He.makeMessageType("livekit.RequestResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:13},{no:2,name:"reason",kind:"enum",T:He.getEnumType(Gn)},{no:3,name:"message",kind:"scalar",T:9},{no:4,name:"trickle",kind:"message",T:sn,oneof:"request"},{no:5,name:"add_track",kind:"message",T:on,oneof:"request"},{no:6,name:"mute",kind:"message",T:an,oneof:"request"},{no:7,name:"update_metadata",kind:"message",T:kn,oneof:"request"},{no:8,name:"update_audio_track",kind:"message",T:gn,oneof:"request"},{no:9,name:"update_video_track",kind:"message",T:fn,oneof:"request"}]),Gn=He.makeEnum("livekit.RequestResponse.Reason",[{no:0,name:"OK"},{no:1,name:"NOT_FOUND"},{no:2,name:"NOT_ALLOWED"},{no:3,name:"LIMIT_EXCEEDED"},{no:4,name:"QUEUED"},{no:5,name:"UNSUPPORTED_TYPE"},{no:6,name:"UNCLASSIFIED_ERROR"}]),Kn=He.makeMessageType("livekit.TrackSubscribed",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),Jn=He.makeMessageType("livekit.ConnectionSettings",()=>[{no:1,name:"auto_subscribe",kind:"scalar",T:8},{no:2,name:"adaptive_stream",kind:"scalar",T:8},{no:3,name:"subscriber_allow_pause",kind:"scalar",T:8,opt:!0},{no:4,name:"disable_ice_lite",kind:"scalar",T:8}]),Yn=He.makeMessageType("livekit.JoinRequest",()=>[{no:1,name:"client_info",kind:"message",T:jt},{no:2,name:"connection_settings",kind:"message",T:Jn},{no:3,name:"metadata",kind:"scalar",T:9},{no:4,name:"participant_attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:5,name:"add_track_requests",kind:"message",T:on,repeated:!0},{no:6,name:"publisher_offer",kind:"message",T:un},{no:7,name:"reconnect",kind:"scalar",T:8},{no:8,name:"reconnect_reason",kind:"enum",T:He.getEnumType(st)},{no:9,name:"participant_sid",kind:"scalar",T:9},{no:10,name:"sync_state",kind:"message",T:Ln}]),$n=He.makeMessageType("livekit.WrappedJoinRequest",()=>[{no:1,name:"compression",kind:"enum",T:He.getEnumType(Qn)},{no:2,name:"join_request",kind:"scalar",T:12}]),Qn=He.makeEnum("livekit.WrappedJoinRequest.Compression",[{no:0,name:"NONE"},{no:1,name:"GZIP"}]),Xn=He.makeMessageType("livekit.MediaSectionsRequirement",()=>[{no:1,name:"num_audios",kind:"scalar",T:13},{no:2,name:"num_videos",kind:"scalar",T:13}]);function Zn(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var ei,ti={exports:{}};var ni,ii,oi,si,ai,ri=(ei||(ei=1,ii=ti.exports,oi=function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),i=["trace","debug","info","warn","error"],o={},s=null;function a(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(t){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function r(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function c(){for(var n=this.getLevel(),o=0;o<i.length;o++){var s=i[o];this[s]=o<n?e:this.methodFactory(s,n,this.name)}if(this.log=this.debug,typeof console===t&&n<this.levels.SILENT)return"No console available for logging"}function d(e){return function(){typeof console!==t&&(c.call(this),this[e].apply(this,arguments))}}function l(i,o,s){return function(i){return"debug"===i&&(i="log"),typeof console!==t&&("trace"===i&&n?r:void 0!==console[i]?a(console,i):void 0!==console.log?a(console,"log"):e)}(i)||d.apply(this,arguments)}function u(e,n){var a,r,d,u=this,h="loglevel";function p(){var e;if(typeof window!==t&&h){try{e=window.localStorage[h]}catch(e){}if(typeof e===t)try{var n=window.document.cookie,i=encodeURIComponent(h),o=n.indexOf(i+"=");-1!==o&&(e=/^([^;]+)/.exec(n.slice(o+i.length+1))[1])}catch(e){}return void 0===u.levels[e]&&(e=void 0),e}}function m(e){var t=e;if("string"==typeof t&&void 0!==u.levels[t.toUpperCase()]&&(t=u.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=u.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?h+=":"+e:"symbol"==typeof e&&(h=void 0),u.name=e,u.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},u.methodFactory=n||l,u.getLevel=function(){return null!=d?d:null!=r?r:a},u.setLevel=function(e,n){return d=m(e),!1!==n&&function(e){var n=(i[e]||"silent").toUpperCase();if(typeof window!==t&&h){try{return void(window.localStorage[h]=n)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"="+n+";"}catch(e){}}}(d),c.call(u)},u.setDefaultLevel=function(e){r=m(e),p()||u.setLevel(e,!1)},u.resetLevel=function(){d=null,function(){if(typeof window!==t&&h){try{window.localStorage.removeItem(h)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}(),c.call(u)},u.enableAll=function(e){u.setLevel(u.levels.TRACE,e)},u.disableAll=function(e){u.setLevel(u.levels.SILENT,e)},u.rebuild=function(){if(s!==u&&(a=m(s.getLevel())),c.call(u),s===u)for(var e in o)o[e].rebuild()},a=m(s?s.getLevel():"WARN");var g=p();null!=g&&(d=m(g)),c.call(u)}(s=new u).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=o[e];return t||(t=o[e]=new u(e,s.methodFactory)),t};var h=typeof window!==t?window.log:void 0;return s.noConflict=function(){return typeof window!==t&&window.log===s&&(window.log=h),s},s.getLoggers=function(){return o},s.default=s,s},(ni=ti).exports?ni.exports=oi():ii.log=oi()),ti.exports);!function(e){e[e.trace=0]="trace",e[e.debug=1]="debug",e[e.info=2]="info",e[e.warn=3]="warn",e[e.error=4]="error",e[e.silent=5]="silent"}(si||(si={})),function(e){e.Default="livekit",e.Room="livekit-room",e.TokenSource="livekit-token-source",e.Participant="livekit-participant",e.Track="livekit-track",e.Publication="livekit-track-publication",e.Engine="livekit-engine",e.Signal="livekit-signal",e.PCManager="livekit-pc-manager",e.PCTransport="livekit-pc-transport",e.E2EE="lk-e2ee"}(ai||(ai={}));let ci=ri.getLogger("livekit");function di(e){const t=ri.getLogger(e);return t.setDefaultLevel(ci.getLevel()),t}Object.values(ai).map(e=>ri.getLogger(e)),ci.setDefaultLevel(si.info);const li=ri.getLogger("lk-e2ee"),ui=7e3,hi=[0,300,1200,2700,4800,ui,ui,ui,ui,ui];function pi(e,t,n,i){return new(n||(n=Promise))(function(o,s){function a(e){try{c(i.next(e))}catch(e){s(e)}}function r(e){try{c(i.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,r)}c((i=i.apply(e,t||[])).next())})}function mi(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],i=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function gi(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e=mi(e),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(n){t[n]=e[n]&&function(t){return new Promise(function(i,o){(function(e,t,n,i){Promise.resolve(i).then(function(t){e({value:t,done:n})},t)})(i,o,(t=e[n](t)).done,t.value)})}}}"function"==typeof SuppressedError&&SuppressedError;var fi,vi={exports:{}};var bi=function(){if(fi)return vi.exports;fi=1;var e,t="object"==typeof Reflect?Reflect:null,n=t&&"function"==typeof t.apply?t.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};e=t&&"function"==typeof t.ownKeys?t.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var i=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}vi.exports=o,vi.exports.once=function(e,t){return new Promise(function(n,i){function o(n){e.removeListener(t,s),i(n)}function s(){"function"==typeof e.removeListener&&e.removeListener("error",o),n([].slice.call(arguments))}m(e,t,s,{once:!0}),"error"!==t&&function(e,t,n){"function"==typeof e.on&&m(e,"error",t,n)}(e,o,{once:!0})})},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var s=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function r(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function c(e,t,n,i){var o,s,c,d;if(a(n),void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),s=e._events),c=s[t]),void 0===c)c=s[t]=n,++e._eventsCount;else if("function"==typeof c?c=s[t]=i?[n,c]:[c,n]:i?c.unshift(n):c.push(n),(o=r(e))>0&&c.length>o&&!c.warned){c.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+c.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=c.length,d=l,console&&console.warn&&console.warn(d)}return e}function d(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function l(e,t,n){var i={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},o=d.bind(i);return o.listener=n,i.wrapFn=o,o}function u(e,t,n){var i=e._events;if(void 0===i)return[];var o=i[t];return void 0===o?[]:"function"==typeof o?n?[o.listener||o]:[o]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(o):p(o,o.length)}function h(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function p(e,t){for(var n=new Array(t),i=0;i<t;++i)n[i]=e[i];return n}function m(e,t,n,i){if("function"==typeof e.on)i.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,function o(s){i.once&&e.removeEventListener(t,o),n(s)})}}return Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return s},set:function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");s=e}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return r(this)},o.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var o="error"===e,s=this._events;if(void 0!==s)o=o&&void 0===s.error;else if(!o)return!1;if(o){var a;if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var r=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw r.context=a,r}var c=s[e];if(void 0===c)return!1;if("function"==typeof c)n(c,this,t);else{var d=c.length,l=p(c,d);for(i=0;i<d;++i)n(l[i],this,t)}return!0},o.prototype.addListener=function(e,t){return c(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return c(this,e,t,!0)},o.prototype.once=function(e,t){return a(t),this.on(e,l(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,l(this,e,t)),this},o.prototype.removeListener=function(e,t){var n,i,o,s,r;if(a(t),void 0===(i=this._events))return this;if(void 0===(n=i[e]))return this;if(n===t||n.listener===t)0===--this._eventsCount?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(o=-1,s=n.length-1;s>=0;s--)if(n[s]===t||n[s].listener===t){r=n[s].listener,o=s;break}if(o<0)return this;0===o?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,o),1===n.length&&(i[e]=n[0]),void 0!==i.removeListener&&this.emit("removeListener",e,r||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,n,i;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0===--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var o,s=Object.keys(n);for(i=0;i<s.length;++i)"removeListener"!==(o=s[i])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},o.prototype.listeners=function(e){return u(this,e,!0)},o.prototype.rawListeners=function(e){return u(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):h.call(e,t)},o.prototype.listenerCount=h,o.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]},vi.exports}();let yi=!0,ki=!0;function Ti(e,t,n){const i=e.match(t);return i&&i.length>=n&&parseFloat(i[n],10)}function Ci(e,t,n){if(!e.RTCPeerConnection)return;const i=e.RTCPeerConnection.prototype,o=i.addEventListener;i.addEventListener=function(e,i){if(e!==t)return o.apply(this,arguments);const s=e=>{const t=n(e);t&&(i.handleEvent?i.handleEvent(t):i(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(i,s),o.apply(this,[e,s])};const s=i.removeEventListener;i.removeEventListener=function(e,n){if(e!==t||!this._eventMap||!this._eventMap[t])return s.apply(this,arguments);if(!this._eventMap[t].has(n))return s.apply(this,arguments);const i=this._eventMap[t].get(n);return this._eventMap[t].delete(n),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,s.apply(this,[e,i])},Object.defineProperty(i,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function Si(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(yi=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function wi(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(ki=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function Ei(){if("object"==typeof window){if(yi)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function xi(e,t){ki&&console.warn(e+" is deprecated, please use "+t+" instead.")}function Pi(e){return"[object Object]"===Object.prototype.toString.call(e)}function Ri(e){return Pi(e)?Object.keys(e).reduce(function(t,n){const i=Pi(e[n]),o=i?Ri(e[n]):e[n],s=i&&!Object.keys(o).length;return void 0===o||s?t:Object.assign(t,{[n]:o})},{}):e}function Ii(e,t,n){t&&!n.has(t.id)&&(n.set(t.id,t),Object.keys(t).forEach(i=>{i.endsWith("Id")?Ii(e,e.get(t[i]),n):i.endsWith("Ids")&&t[i].forEach(t=>{Ii(e,e.get(t),n)})}))}function Oi(e,t,n){const i=n?"outbound-rtp":"inbound-rtp",o=new Map;if(null===t)return o;const s=[];return e.forEach(e=>{"track"===e.type&&e.trackIdentifier===t.id&&s.push(e)}),s.forEach(t=>{e.forEach(n=>{n.type===i&&n.trackId===t.id&&Ii(e,n,o)})}),o}const _i=Ei;function Di(e,t){const n=e&&e.navigator;if(!n.mediaDevices)return;const i=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach(n=>{if("require"===n||"advanced"===n||"mediaSource"===n)return;const i="object"==typeof e[n]?e[n]:{ideal:e[n]};void 0!==i.exact&&"number"==typeof i.exact&&(i.min=i.max=i.exact);const o=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==i.ideal){t.optional=t.optional||[];let e={};"number"==typeof i.ideal?(e[o("min",n)]=i.ideal,t.optional.push(e),e={},e[o("max",n)]=i.ideal,t.optional.push(e)):(e[o("",n)]=i.ideal,t.optional.push(e))}void 0!==i.exact&&"number"!=typeof i.exact?(t.mandatory=t.mandatory||{},t.mandatory[o("",n)]=i.exact):["min","max"].forEach(e=>{void 0!==i[e]&&(t.mandatory=t.mandatory||{},t.mandatory[o(e,n)]=i[e])})}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},o=function(e,o){if(t.version>=61)return o(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=i(e.audio)}if(e&&"object"==typeof e.video){let s=e.video.facingMode;s=s&&("object"==typeof s?s:{ideal:s});const a=t.version<66;if(s&&("user"===s.exact||"environment"===s.exact||"user"===s.ideal||"environment"===s.ideal)&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||a)){let t;if(delete e.video.facingMode,"environment"===s.exact||"environment"===s.ideal?t=["back","rear"]:"user"!==s.exact&&"user"!==s.ideal||(t=["front"]),t)return n.mediaDevices.enumerateDevices().then(n=>{let a=(n=n.filter(e=>"videoinput"===e.kind)).find(e=>t.some(t=>e.label.toLowerCase().includes(t)));return!a&&n.length&&t.includes("back")&&(a=n[n.length-1]),a&&(e.video.deviceId=s.exact?{exact:a.deviceId}:{ideal:a.deviceId}),e.video=i(e.video),_i("chrome: "+JSON.stringify(e)),o(e)})}e.video=i(e.video)}return _i("chrome: "+JSON.stringify(e)),o(e)},s=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(n.getUserMedia=function(e,t,i){o(e,e=>{n.webkitGetUserMedia(e,t,e=>{i&&i(s(e))})})}.bind(n),n.mediaDevices.getUserMedia){const e=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(t){return o(t,t=>e(t).then(e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach(e=>{e.stop()}),new DOMException("","NotFoundError");return e},e=>Promise.reject(s(e))))}}}function Mi(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function Ai(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",n=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===n.track.id):{track:n.track};const o=new Event("track");o.track=n.track,o.receiver=i,o.transceiver={receiver:i},o.streams=[t.stream],this.dispatchEvent(o)}),t.stream.getTracks().forEach(n=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===n.id):{track:n};const o=new Event("track");o.track=n,o.receiver=i,o.transceiver={receiver:i},o.streams=[t.stream],this.dispatchEvent(o)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else Ci(e,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function Ni(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const n=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){let o=n.apply(this,arguments);return o||(o=t(this,e),this._senders.push(o)),o};const i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){i.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach(e=>{this._senders.push(t(this,e))})};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach(e=>{const t=this._senders.find(t=>t.track===e);t&&this._senders.splice(this._senders.indexOf(t),1)})}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Li(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>Oi(t,e.track,!0))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),Ci(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>Oi(t,e.track,!1))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,n,i;return this.getSenders().forEach(n=>{n.track===e&&(t?i=!0:t=n)}),this.getReceivers().forEach(t=>(t.track===e&&(n?i=!0:n=t),t.track===e)),i||t&&n?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():n?n.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function Ui(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(e=>this._shimmedLocalStreams[e][0])};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){if(!n)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const i=t.apply(this,arguments);return this._shimmedLocalStreams[n.id]?-1===this._shimmedLocalStreams[n.id].indexOf(i)&&this._shimmedLocalStreams[n.id].push(i):this._shimmedLocalStreams[n.id]=[n,i],i};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")});const t=this.getSenders();n.apply(this,arguments);const i=this.getSenders().filter(e=>-1===t.indexOf(e));this._shimmedLocalStreams[e.id]=[e].concat(i)};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],i.apply(this,arguments)};const o=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach(t=>{const n=this._shimmedLocalStreams[t].indexOf(e);-1!==n&&this._shimmedLocalStreams[t].splice(n,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]}),o.apply(this,arguments)}}function ji(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return Ui(e);const n=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=n.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map(e=>this._reverseStreams[e.id])};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[t.id]){const n=new e.MediaStream(t.getTracks());this._streams[t.id]=n,this._reverseStreams[n.id]=t,t=n}i.apply(this,[t])};const o=e.RTCPeerConnection.prototype.removeStream;function s(e,t){let n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const i=e._reverseStreams[t],o=e._streams[i.id];n=n.replace(new RegExp(o.id,"g"),i.id)}),new RTCSessionDescription({type:t.type,sdp:n})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},o.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,n){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find(e=>e===t))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(e=>e.track===t))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const o=this._streams[n.id];if(o)o.addTrack(t),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const i=new e.MediaStream([t]);this._streams[n.id]=i,this._reverseStreams[i.id]=n,this.addStream(i)}return this.getSenders().find(e=>e.track===t)},["createOffer","createAnswer"].forEach(function(t){const n=e.RTCPeerConnection.prototype[t],i={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?n.apply(this,[t=>{const n=s(this,t);e[0].apply(null,[n])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):n.apply(this,arguments).then(e=>s(this,e))}};e.RTCPeerConnection.prototype[t]=i[t]});const a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){let n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const i=e._reverseStreams[t],o=e._streams[i.id];n=n.replace(new RegExp(i.id,"g"),o.id)}),new RTCSessionDescription({type:t.type,sdp:n})}(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const r=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=r.get.apply(this);return""===e.type?e:s(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach(n=>{this._streams[n].getTracks().find(t=>e.track===t)&&(t=this._streams[n])}),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Fi(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){const n=e.RTCPeerConnection.prototype[t],i={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=i[t]})}function Bi(e,t){Ci(e,"negotiationneeded",e=>{const n=e.target;if(!(t.version<72||n.getConfiguration&&"plan-b"===n.getConfiguration().sdpSemantics)||"stable"===n.signalingState)return e})}var qi=Object.freeze({__proto__:null,fixNegotiationNeeded:Bi,shimAddTrackRemoveTrack:ji,shimAddTrackRemoveTrackWithNative:Ui,shimGetSendersWithDtmf:Ni,shimGetUserMedia:Di,shimMediaStream:Mi,shimOnTrack:Ai,shimPeerConnection:Fi,shimSenderReceiverGetStats:Li});function Vi(e,t){const n=e&&e.navigator,i=e&&e.MediaStreamTrack;if(n.getUserMedia=function(e,t,i){xi("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(e).then(t,i)},!(t.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){const e=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])},t=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(n){return"object"==typeof n&&"object"==typeof n.audio&&(n=JSON.parse(JSON.stringify(n)),e(n.audio,"autoGainControl","mozAutoGainControl"),e(n.audio,"noiseSuppression","mozNoiseSuppression")),t(n)},i&&i.prototype.getSettings){const t=i.prototype.getSettings;i.prototype.getSettings=function(){const n=t.apply(this,arguments);return e(n,"mozAutoGainControl","autoGainControl"),e(n,"mozNoiseSuppression","noiseSuppression"),n}}if(i&&i.prototype.applyConstraints){const t=i.prototype.applyConstraints;i.prototype.applyConstraints=function(n){return"audio"===this.kind&&"object"==typeof n&&(n=JSON.parse(JSON.stringify(n)),e(n,"autoGainControl","mozAutoGainControl"),e(n,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[n])}}}}function zi(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Hi(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){const n=e.RTCPeerConnection.prototype[t],i={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=i[t]});const n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,o,s]=arguments;return i.apply(this,[e||null]).then(e=>{if(t.version<53&&!o)try{e.forEach(e=>{e.type=n[e.type]||e.type})}catch(t){if("TypeError"!==t.name)throw t;e.forEach((t,i)=>{e.set(i,Object.assign({},t,{type:n[t.type]||t.type}))})}return e}).then(o,s)}}function Wi(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function Gi(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),Ci(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Ki(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){xi("removeStream","removeTrack"),this.getSenders().forEach(t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)})})}function Ji(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function Yi(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let e=arguments[1]&&arguments[1].sendEncodings;void 0===e&&(e=[]),e=[...e];const n=e.length>0;n&&e.forEach(e=>{if("rid"in e){if(!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const i=t.apply(this,arguments);if(n){const{sender:t}=i,n=t.getParameters();(!("encodings"in n)||1===n.encodings.length&&0===Object.keys(n.encodings[0]).length)&&(n.encodings=e,t.sendEncodings=e,this.setParametersPromises.push(t.setParameters(n).then(()=>{delete t.sendEncodings}).catch(()=>{delete t.sendEncodings})))}return i})}function $i(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function Qi(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function Xi(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}var Zi=Object.freeze({__proto__:null,shimAddTransceiver:Yi,shimCreateAnswer:Xi,shimCreateOffer:Qi,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===n.video?n.video={mediaSource:t}:n.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(n)})},shimGetParameters:$i,shimGetUserMedia:Vi,shimOnTrack:zi,shimPeerConnection:Hi,shimRTCDataChannel:Ji,shimReceiverGetStats:Gi,shimRemoveStream:Ki,shimSenderGetStats:Wi});function eo(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach(n=>t.call(this,n,e)),e.getVideoTracks().forEach(n=>t.call(this,n,e))},e.RTCPeerConnection.prototype.addTrack=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];return i&&i.forEach(e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]}),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const n=e.getTracks();this.getSenders().forEach(e=>{n.includes(e.track)&&this.removeTrack(e)})})}}function to(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach(e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)})})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach(t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const n=new Event("addstream");n.stream=t,e.dispatchEvent(n)})}),t.apply(e,arguments)}}}function no(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,n=t.createOffer,i=t.createAnswer,o=t.setLocalDescription,s=t.setRemoteDescription,a=t.addIceCandidate;t.createOffer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],o=n.apply(this,[i]);return t?(o.then(e,t),Promise.resolve()):o},t.createAnswer=function(e,t){const n=arguments.length>=2?arguments[2]:arguments[0],o=i.apply(this,[n]);return t?(o.then(e,t),Promise.resolve()):o};let r=function(e,t,n){const i=o.apply(this,[e]);return n?(i.then(t,n),Promise.resolve()):i};t.setLocalDescription=r,r=function(e,t,n){const i=s.apply(this,[e]);return n?(i.then(t,n),Promise.resolve()):i},t.setRemoteDescription=r,r=function(e,t,n){const i=a.apply(this,[e]);return n?(i.then(t,n),Promise.resolve()):i},t.addIceCandidate=r}function io(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,n=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>n(oo(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,n,i){t.mediaDevices.getUserMedia(e).then(n,i)}.bind(t))}function oo(e){return e&&void 0!==e.video?Object.assign({},e,{video:Ri(e.video)}):e}function so(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,n){if(e&&e.iceServers){const t=[];for(let n=0;n<e.iceServers.length;n++){let i=e.iceServers[n];void 0===i.urls&&i.url?(xi("RTCIceServer.url","RTCIceServer.urls"),i=JSON.parse(JSON.stringify(i)),i.urls=i.url,delete i.url,t.push(i)):t.push(e.iceServers[n])}e.iceServers=t}return new t(e,n)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function ao(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function ro(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find(e=>"audio"===e.receiver.track.kind);!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const n=this.getTransceivers().find(e=>"video"===e.receiver.track.kind);!1===e.offerToReceiveVideo&&n?"sendrecv"===n.direction?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":"recvonly"===n.direction&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):!0!==e.offerToReceiveVideo||n||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function co(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var lo,uo=Object.freeze({__proto__:null,shimAudioContext:co,shimCallbacksAPI:no,shimConstraints:oo,shimCreateOfferLegacy:ro,shimGetUserMedia:io,shimLocalStreamsAPI:eo,shimRTCIceServerUrls:so,shimRemoteStreamsAPI:to,shimTrackEventTransceiver:ao}),ho={exports:{}};var po=(lo||(lo=1,function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map(e=>e.trim())},t.splitSections=function(e){return e.split("\nm=").map((e,t)=>(t>0?"m="+e:e).trim()+"\r\n")},t.getDescription=function(e){const n=t.splitSections(e);return n&&n[0]},t.getMediaSections=function(e){const n=t.splitSections(e);return n.shift(),n},t.matchPrefix=function(e,n){return t.splitLines(e).filter(e=>0===e.indexOf(n))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const n={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let e=8;e<t.length;e+=2)switch(t[e]){case"raddr":n.relatedAddress=t[e+1];break;case"rport":n.relatedPort=parseInt(t[e+1],10);break;case"tcptype":n.tcpType=t[e+1];break;case"ufrag":n.ufrag=t[e+1],n.usernameFragment=t[e+1];break;default:void 0===n[t[e]]&&(n[t[e]]=t[e+1])}return n},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const n=e.component;"rtp"===n?t.push(1):"rtcp"===n?t.push(2):t.push(n),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const i=e.type;return t.push("typ"),t.push(i),"host"!==i&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substring(14).split(" ")},t.parseRtpMap=function(e){let t=e.substring(9).split(" ");const n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.channels=3===t.length?parseInt(t[2],10):1,n.numChannels=n.channels,n},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const n=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==n?"/"+n:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substring(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1],attributes:t.slice(2).join(" ")}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+"\r\n"},t.parseFmtp=function(e){const t={};let n;const i=e.substring(e.indexOf(" ")+1).split(";");for(let e=0;e<i.length;e++)n=i[e].trim().split("="),t[n[0].trim()]=n[1];return t},t.writeFmtp=function(e){let t="",n=e.payloadType;if(void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const i=[];Object.keys(e.parameters).forEach(t=>{void 0!==e.parameters[t]?i.push(t+"="+e.parameters[t]):i.push(t)}),t+="a=fmtp:"+n+" "+i.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){const t=e.substring(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(e=>{t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),n={ssrc:parseInt(e.substring(7,t),10)},i=e.indexOf(":",t);return i>-1?(n.attribute=e.substring(t+1,i),n.value=e.substring(i+1)):n.attribute=e.substring(t+1),n},t.parseSsrcGroup=function(e){const t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t.map(e=>parseInt(e,10))}},t.getMid=function(e){const n=t.matchPrefix(e,"a=mid:")[0];if(n)return n.substring(6)},t.parseFingerprint=function(e){const t=e.substring(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,n){return{role:"auto",fingerprints:t.matchPrefix(e+n,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let n="a=setup:"+t+"\r\n";return e.fingerprints.forEach(e=>{n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),n},t.parseCryptoLine=function(e){const t=e.substring(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substring(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,n){return t.matchPrefix(e+n,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,n){const i=t.matchPrefix(e+n,"a=ice-ufrag:")[0],o=t.matchPrefix(e+n,"a=ice-pwd:")[0];return i&&o?{usernameFragment:i.substring(12),password:o.substring(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const n={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=t.splitLines(e)[0].split(" ");n.profile=i[2];for(let o=3;o<i.length;o++){const s=i[o],a=t.matchPrefix(e,"a=rtpmap:"+s+" ")[0];if(a){const i=t.parseRtpMap(a),o=t.matchPrefix(e,"a=fmtp:"+s+" ");switch(i.parameters=o.length?t.parseFmtp(o[0]):{},i.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+s+" ").map(t.parseRtcpFb),n.codecs.push(i),i.name.toUpperCase()){case"RED":case"ULPFEC":n.fecMechanisms.push(i.name.toUpperCase())}}}t.matchPrefix(e,"a=extmap:").forEach(e=>{n.headerExtensions.push(t.parseExtmap(e))});const o=t.matchPrefix(e,"a=rtcp-fb:* ").map(t.parseRtcpFb);return n.codecs.forEach(e=>{o.forEach(t=>{e.rtcpFeedback.find(e=>e.type===t.type&&e.parameter===t.parameter)||e.rtcpFeedback.push(t)})}),n},t.writeRtpDescription=function(e,n){let i="";i+="m="+e+" ",i+=n.codecs.length>0?"9":"0",i+=" "+(n.profile||"UDP/TLS/RTP/SAVPF")+" ",i+=n.codecs.map(e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",n.codecs.forEach(e=>{i+=t.writeRtpMap(e),i+=t.writeFmtp(e),i+=t.writeRtcpFb(e)});let o=0;return n.codecs.forEach(e=>{e.maxptime>o&&(o=e.maxptime)}),o>0&&(i+="a=maxptime:"+o+"\r\n"),n.headerExtensions&&n.headerExtensions.forEach(e=>{i+=t.writeExtmap(e)}),i},t.parseRtpEncodingParameters=function(e){const n=[],i=t.parseRtpParameters(e),o=-1!==i.fecMechanisms.indexOf("RED"),s=-1!==i.fecMechanisms.indexOf("ULPFEC"),a=t.matchPrefix(e,"a=ssrc:").map(e=>t.parseSsrcMedia(e)).filter(e=>"cname"===e.attribute),r=a.length>0&&a[0].ssrc;let c;const d=t.matchPrefix(e,"a=ssrc-group:FID").map(e=>e.substring(17).split(" ").map(e=>parseInt(e,10)));d.length>0&&d[0].length>1&&d[0][0]===r&&(c=d[0][1]),i.codecs.forEach(e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:r,codecPayloadType:parseInt(e.parameters.apt,10)};r&&c&&(t.rtx={ssrc:c}),n.push(t),o&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:r,mechanism:s?"red+ulpfec":"red"},n.push(t))}}),0===n.length&&r&&n.push({ssrc:r});let l=t.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substring(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substring(5),10)*.95-16e3:void 0,n.forEach(e=>{e.maxBitrate=l})),n},t.parseRtcpParameters=function(e){const n={},i=t.matchPrefix(e,"a=ssrc:").map(e=>t.parseSsrcMedia(e)).filter(e=>"cname"===e.attribute)[0];i&&(n.cname=i.value,n.ssrc=i.ssrc);const o=t.matchPrefix(e,"a=rtcp-rsize");n.reducedSize=o.length>0,n.compound=0===o.length;const s=t.matchPrefix(e,"a=rtcp-mux");return n.mux=s.length>0,n},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let n;const i=t.matchPrefix(e,"a=msid:");if(1===i.length)return n=i[0].substring(7).split(" "),{stream:n[0],track:n[1]};const o=t.matchPrefix(e,"a=ssrc:").map(e=>t.parseSsrcMedia(e)).filter(e=>"msid"===e.attribute);return o.length>0?(n=o[0].value.split(" "),{stream:n[0],track:n[1]}):void 0},t.parseSctpDescription=function(e){const n=t.parseMLine(e),i=t.matchPrefix(e,"a=max-message-size:");let o;i.length>0&&(o=parseInt(i[0].substring(19),10)),isNaN(o)&&(o=65536);const s=t.matchPrefix(e,"a=sctp-port:");if(s.length>0)return{port:parseInt(s[0].substring(12),10),protocol:n.fmt,maxMessageSize:o};const a=t.matchPrefix(e,"a=sctpmap:");if(a.length>0){const e=a[0].substring(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:o}}},t.writeSctpDescription=function(e,t){let n=[];return n="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&n.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),n.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(e,n,i){let o;const s=void 0!==n?n:2;return o=e||t.generateSessionId(),"v=0\r\no="+(i||"thisisadapterortc")+" "+o+" "+s+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,n){const i=t.splitLines(e);for(let e=0;e<i.length;e++)switch(i[e]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[e].substring(2)}return n?t.getDirection(n):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substring(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){const n=t.splitLines(e)[0].substring(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}},t.parseOLine=function(e){const n=t.matchPrefix(e,"o=")[0].substring(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;const n=t.splitLines(e);for(let e=0;e<n.length;e++)if(n[e].length<2||"="!==n[e].charAt(1))return!1;return!0},e.exports=t}(ho)),ho.exports),mo=Zn(po),go=u({__proto__:null,default:mo},[po]);function fo(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substring(2)),e.candidate&&e.candidate.length){const n=new t(e),i=mo.parseCandidate(e.candidate);for(const e in i)e in n||Object.defineProperty(n,e,{value:i[e]});return n.toJSON=function(){return{candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex,usernameFragment:n.usernameFragment}},n}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,Ci(e,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t))}function vo(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||Ci(e,"icecandidate",e=>{if(e.candidate){const t=mo.parseCandidate(e.candidate.candidate);"relay"===t.type&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e})}function bo(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const n=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(function(e){if(!e||!e.sdp)return!1;const t=mo.splitSections(e.sdp);return t.shift(),t.some(e=>{const t=mo.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})}(arguments[0])){const e=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const n=parseInt(t[1],10);return n!=n?-1:n}(arguments[0]),n=function(e){let n=65536;return"firefox"===t.browser&&(n=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),n}(e),i=function(e,n){let i=65536;"firefox"===t.browser&&57===t.version&&(i=65535);const o=mo.matchPrefix(e.sdp,"a=max-message-size:");return o.length>0?i=parseInt(o[0].substring(19),10):"firefox"===t.browser&&-1!==n&&(i=2147483637),i}(arguments[0],e);let o;o=0===n&&0===i?Number.POSITIVE_INFINITY:0===n||0===i?Math.max(n,i):Math.min(n,i);const s={};Object.defineProperty(s,"maxMessageSize",{get:()=>o}),this._sctp=s}return n.apply(this,arguments)}}function yo(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const n=e.send;e.send=function(){const i=arguments[0],o=i.length||i.size||i.byteLength;if("open"===e.readyState&&t.sctp&&o>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return n.apply(e,arguments)}}const n=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=n.apply(this,arguments);return t(e,this),e},Ci(e,"datachannel",e=>(t(e.channel,e.target),e))}function ko(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{const n=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const n=new Event("connectionstatechange",e);t.dispatchEvent(n)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),n.apply(this,arguments)}})}function To(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t._safariVersion>=13.1)return;const n=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const n=t.sdp.split("\n").filter(e=>"a=extmap-allow-mixed"!==e.trim()).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:n}):t.sdp=n}return n.apply(this,arguments)}}function Co(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const n=e.RTCPeerConnection.prototype.addIceCandidate;n&&0!==n.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function So(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const n=e.RTCPeerConnection.prototype.setLocalDescription;n&&0!==n.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let e=arguments[0]||{};if("object"!=typeof e||e.type&&e.sdp)return n.apply(this,arguments);if(e={type:e.type,sdp:e.sdp},!e.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer"}if(e.sdp||"offer"!==e.type&&"answer"!==e.type)return n.apply(this,[e]);return("offer"===e.type?this.createOffer:this.createAnswer).apply(this).then(e=>n.apply(this,[e]))})}var wo=Object.freeze({__proto__:null,removeExtmapAllowMixed:To,shimAddIceCandidateNullOrEmpty:Co,shimConnectionState:ko,shimMaxMessageSize:bo,shimParameterlessSetLocalDescription:So,shimRTCIceCandidate:fo,shimRTCIceCandidateRelayProtocol:vo,shimSendThrowTypeError:yo});!function(){let{window:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const n=Ei,i=function(e){const t={browser:null,version:null};if(void 0===e||!e.navigator||!e.navigator.userAgent)return t.browser="Not a browser.",t;const{navigator:n}=e;if(n.userAgentData&&n.userAgentData.brands){const e=n.userAgentData.brands.find(e=>"Chromium"===e.brand);if(e)return{browser:"chrome",version:parseInt(e.version,10)}}if(n.mozGetUserMedia)t.browser="firefox",t.version=parseInt(Ti(n.userAgent,/Firefox\/(\d+)\./,1));else if(n.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection)t.browser="chrome",t.version=parseInt(Ti(n.userAgent,/Chrom(e|ium)\/(\d+)\./,2));else{if(!e.RTCPeerConnection||!n.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=parseInt(Ti(n.userAgent,/AppleWebKit\/(\d+)\./,1)),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype,t._safariVersion=Ti(n.userAgent,/Version\/(\d+(\.?\d+))/,1)}return t}(e),o={browserDetails:i,commonShim:wo,extractVersion:Ti,disableLog:Si,disableWarnings:wi,sdp:go};switch(i.browser){case"chrome":if(!qi||!Fi||!t.shimChrome)return n("Chrome shim is not included in this adapter release."),o;if(null===i.version)return n("Chrome shim can not determine version, not shimming."),o;n("adapter.js shimming chrome."),o.browserShim=qi,Co(e,i),So(e),Di(e,i),Mi(e),Fi(e,i),Ai(e),ji(e,i),Ni(e),Li(e),Bi(e,i),fo(e),vo(e),ko(e),bo(e,i),yo(e),To(e,i);break;case"firefox":if(!Zi||!Hi||!t.shimFirefox)return n("Firefox shim is not included in this adapter release."),o;n("adapter.js shimming firefox."),o.browserShim=Zi,Co(e,i),So(e),Vi(e,i),Hi(e,i),zi(e),Ki(e),Wi(e),Gi(e),Ji(e),Yi(e),$i(e),Qi(e),Xi(e),fo(e),ko(e),bo(e,i),yo(e);break;case"safari":if(!uo||!t.shimSafari)return n("Safari shim is not included in this adapter release."),o;n("adapter.js shimming safari."),o.browserShim=uo,Co(e,i),So(e),so(e),ro(e),no(e),eo(e),to(e),ao(e),io(e),co(e),fo(e),vo(e),bo(e,i),yo(e),To(e,i);break;default:n("Unsupported browser!")}}({window:"undefined"==typeof window?void 0:window});const Eo="lk_e2ee";var xo,Po,Ro,Io,Oo,_o,Do,Mo,Ao,No,Lo,Uo;function jo(){return void 0!==window.RTCRtpSender&&void 0!==window.RTCRtpSender.prototype.createEncodedStreams||Fo()}function Fo(){return void 0!==window.RTCRtpScriptTransform}!function(e){e.SetKey="setKey",e.RatchetRequest="ratchetRequest",e.KeyRatcheted="keyRatcheted"}(xo||(xo={})),function(e){e.KeyRatcheted="keyRatcheted"}(Po||(Po={})),function(e){e.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",e.EncryptionError="encryptionError"}(Ro||(Ro={})),function(e){e.Error="cryptorError"}(Io||(Io={}));bi.EventEmitter;class Bo extends Error{constructor(e,t){super(t||"an error has occured"),this.name="LiveKitError",this.code=e}}!function(e){e[e.NotAllowed=0]="NotAllowed",e[e.ServerUnreachable=1]="ServerUnreachable",e[e.InternalError=2]="InternalError",e[e.Cancelled=3]="Cancelled",e[e.LeaveRequest=4]="LeaveRequest",e[e.Timeout=5]="Timeout"}(Oo||(Oo={}));class qo extends Bo{constructor(e,t,n,i){super(1,e),this.name="ConnectionError",this.status=n,this.reason=t,this.context=i,this.reasonName=Oo[t]}}class Vo extends Bo{constructor(e){super(21,null!=e?e:"device is unsupported"),this.name="DeviceUnsupportedError"}}class zo extends Bo{constructor(e){super(20,null!=e?e:"track is invalid"),this.name="TrackInvalidError"}}class Ho extends Bo{constructor(e){super(10,null!=e?e:"unsupported server"),this.name="UnsupportedServer"}}class Wo extends Bo{constructor(e){super(12,null!=e?e:"unexpected connection state"),this.name="UnexpectedConnectionState"}}class Go extends Bo{constructor(e){super(13,null!=e?e:"unable to negotiate"),this.name="NegotiationError"}}class Ko extends Bo{constructor(e,t){super(15,e),this.name="PublishTrackError",this.status=t}}class Jo extends Bo{constructor(e,t){super(15,e),this.reason=t,this.reasonName="string"==typeof t?t:Gn[t]}}!function(e){e[e.AlreadyOpened=0]="AlreadyOpened",e[e.AbnormalEnd=1]="AbnormalEnd",e[e.DecodeFailed=2]="DecodeFailed",e[e.LengthExceeded=3]="LengthExceeded",e[e.Incomplete=4]="Incomplete",e[e.HandlerAlreadyRegistered=7]="HandlerAlreadyRegistered",e[e.EncryptionTypeMismatch=8]="EncryptionTypeMismatch"}(_o||(_o={}));class Yo extends Bo{constructor(e,t){super(16,e),this.name="DataStreamError",this.reason=t,this.reasonName=_o[t]}}!function(e){e.PermissionDenied="PermissionDenied",e.NotFound="NotFound",e.DeviceInUse="DeviceInUse",e.Other="Other"}(Do||(Do={})),function(e){e.getFailure=function(t){if(t&&"name"in t)return"NotFoundError"===t.name||"DevicesNotFoundError"===t.name?e.NotFound:"NotAllowedError"===t.name||"PermissionDeniedError"===t.name?e.PermissionDenied:"NotReadableError"===t.name||"TrackStartError"===t.name?e.DeviceInUse:e.Other}}(Do||(Do={})),function(e){e[e.InvalidKey=0]="InvalidKey",e[e.MissingKey=1]="MissingKey",e[e.InternalError=2]="InternalError"}(Mo||(Mo={})),function(e){e.Connected="connected",e.Reconnecting="reconnecting",e.SignalReconnecting="signalReconnecting",e.Reconnected="reconnected",e.Disconnected="disconnected",e.ConnectionStateChanged="connectionStateChanged",e.Moved="moved",e.MediaDevicesChanged="mediaDevicesChanged",e.ParticipantConnected="participantConnected",e.ParticipantDisconnected="participantDisconnected",e.TrackPublished="trackPublished",e.TrackSubscribed="trackSubscribed",e.TrackSubscriptionFailed="trackSubscriptionFailed",e.TrackUnpublished="trackUnpublished",e.TrackUnsubscribed="trackUnsubscribed",e.TrackMuted="trackMuted",e.TrackUnmuted="trackUnmuted",e.LocalTrackPublished="localTrackPublished",e.LocalTrackUnpublished="localTrackUnpublished",e.LocalAudioSilenceDetected="localAudioSilenceDetected",e.ActiveSpeakersChanged="activeSpeakersChanged",e.ParticipantMetadataChanged="participantMetadataChanged",e.ParticipantNameChanged="participantNameChanged",e.ParticipantAttributesChanged="participantAttributesChanged",e.ParticipantActive="participantActive",e.RoomMetadataChanged="roomMetadataChanged",e.DataReceived="dataReceived",e.SipDTMFReceived="sipDTMFReceived",e.TranscriptionReceived="transcriptionReceived",e.ConnectionQualityChanged="connectionQualityChanged",e.TrackStreamStateChanged="trackStreamStateChanged",e.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",e.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",e.AudioPlaybackStatusChanged="audioPlaybackChanged",e.VideoPlaybackStatusChanged="videoPlaybackChanged",e.MediaDevicesError="mediaDevicesError",e.ParticipantPermissionsChanged="participantPermissionsChanged",e.SignalConnected="signalConnected",e.RecordingStatusChanged="recordingStatusChanged",e.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",e.EncryptionError="encryptionError",e.DCBufferStatusChanged="dcBufferStatusChanged",e.ActiveDeviceChanged="activeDeviceChanged",e.ChatMessage="chatMessage",e.LocalTrackSubscribed="localTrackSubscribed",e.MetricsReceived="metricsReceived"}(Ao||(Ao={})),function(e){e.TrackPublished="trackPublished",e.TrackSubscribed="trackSubscribed",e.TrackSubscriptionFailed="trackSubscriptionFailed",e.TrackUnpublished="trackUnpublished",e.TrackUnsubscribed="trackUnsubscribed",e.TrackMuted="trackMuted",e.TrackUnmuted="trackUnmuted",e.LocalTrackPublished="localTrackPublished",e.LocalTrackUnpublished="localTrackUnpublished",e.LocalTrackCpuConstrained="localTrackCpuConstrained",e.LocalSenderCreated="localSenderCreated",e.ParticipantMetadataChanged="participantMetadataChanged",e.ParticipantNameChanged="participantNameChanged",e.DataReceived="dataReceived",e.SipDTMFReceived="sipDTMFReceived",e.TranscriptionReceived="transcriptionReceived",e.IsSpeakingChanged="isSpeakingChanged",e.ConnectionQualityChanged="connectionQualityChanged",e.TrackStreamStateChanged="trackStreamStateChanged",e.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",e.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",e.TrackCpuConstrained="trackCpuConstrained",e.MediaDevicesError="mediaDevicesError",e.AudioStreamAcquired="audioStreamAcquired",e.ParticipantPermissionsChanged="participantPermissionsChanged",e.PCTrackAdded="pcTrackAdded",e.AttributesChanged="attributesChanged",e.LocalTrackSubscribed="localTrackSubscribed",e.ChatMessage="chatMessage",e.Active="active"}(No||(No={})),function(e){e.TransportsCreated="transportsCreated",e.Connected="connected",e.Disconnected="disconnected",e.Resuming="resuming",e.Resumed="resumed",e.Restarting="restarting",e.Restarted="restarted",e.SignalResumed="signalResumed",e.SignalRestarted="signalRestarted",e.Closing="closing",e.MediaTrackAdded="mediaTrackAdded",e.ActiveSpeakersUpdate="activeSpeakersUpdate",e.DataPacketReceived="dataPacketReceived",e.RTPVideoMapUpdate="rtpVideoMapUpdate",e.DCBufferStatusChanged="dcBufferStatusChanged",e.ParticipantUpdate="participantUpdate",e.RoomUpdate="roomUpdate",e.SpeakersChanged="speakersChanged",e.StreamStateChanged="streamStateChanged",e.ConnectionQualityUpdate="connectionQualityUpdate",e.SubscriptionError="subscriptionError",e.SubscriptionPermissionUpdate="subscriptionPermissionUpdate",e.RemoteMute="remoteMute",e.SubscribedQualityUpdate="subscribedQualityUpdate",e.LocalTrackUnpublished="localTrackUnpublished",e.LocalTrackSubscribed="localTrackSubscribed",e.Offline="offline",e.SignalRequestResponse="signalRequestResponse",e.SignalConnected="signalConnected",e.RoomMoved="roomMoved"}(Lo||(Lo={})),function(e){e.Message="message",e.Muted="muted",e.Unmuted="unmuted",e.Restarted="restarted",e.Ended="ended",e.Subscribed="subscribed",e.Unsubscribed="unsubscribed",e.CpuConstrained="cpuConstrained",e.UpdateSettings="updateSettings",e.UpdateSubscription="updateSubscription",e.AudioPlaybackStarted="audioPlaybackStarted",e.AudioPlaybackFailed="audioPlaybackFailed",e.AudioSilenceDetected="audioSilenceDetected",e.VisibilityChanged="visibilityChanged",e.VideoDimensionsChanged="videoDimensionsChanged",e.VideoPlaybackStarted="videoPlaybackStarted",e.VideoPlaybackFailed="videoPlaybackFailed",e.ElementAttached="elementAttached",e.ElementDetached="elementDetached",e.UpstreamPaused="upstreamPaused",e.UpstreamResumed="upstreamResumed",e.SubscriptionPermissionChanged="subscriptionPermissionChanged",e.SubscriptionStatusChanged="subscriptionStatusChanged",e.SubscriptionFailed="subscriptionFailed",e.TrackProcessorUpdate="trackProcessorUpdate",e.AudioTrackFeatureUpdate="audioTrackFeatureUpdate",e.TranscriptionReceived="transcriptionReceived",e.TimeSyncUpdate="timeSyncUpdate",e.PreConnectBufferFlushed="preConnectBufferFlushed"}(Uo||(Uo={}));const $o=/version\/(\d+(\.?_?\d+)+)/i;let Qo;function Xo(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(void 0===e&&"undefined"==typeof navigator)return;const n=(null!=e?e:navigator.userAgent).toLowerCase();if(void 0===Qo||t){const e=Zo.find(e=>{let{test:t}=e;return t.test(n)});Qo=null==e?void 0:e.describe(n)}return Qo}const Zo=[{test:/firefox|iceweasel|fxios/i,describe:e=>({name:"Firefox",version:es(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,e),os:e.toLowerCase().includes("fxios")?"iOS":void 0,osVersion:ts(e)})},{test:/chrom|crios|crmo/i,describe:e=>({name:"Chrome",version:es(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,e),os:e.toLowerCase().includes("crios")?"iOS":void 0,osVersion:ts(e)})},{test:/safari|applewebkit/i,describe:e=>({name:"Safari",version:es($o,e),os:e.includes("mobile/")?"iOS":"macOS",osVersion:ts(e)})}];function es(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;const i=t.match(e);return i&&i.length>=n&&i[n]||""}function ts(e){return e.includes("mac os")?es(/\(.+?(\d+_\d+(:?_\d+)?)/,e,1).replace(/_/g,"."):void 0}class ns{}ns.setTimeout=function(){return setTimeout(...arguments)},ns.setInterval=function(){return setInterval(...arguments)},ns.clearTimeout=function(){return clearTimeout(...arguments)},ns.clearInterval=function(){return clearInterval(...arguments)};const is=[];var os;!function(e){e[e.LOW=0]="LOW",e[e.MEDIUM=1]="MEDIUM",e[e.HIGH=2]="HIGH"}(os||(os={}));class ss extends bi.EventEmitter{get streamState(){return this._streamState}setStreamState(e){this._streamState=e}constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};var i;super(),this.attachedElements=[],this.isMuted=!1,this._streamState=ss.StreamState.Active,this.isInBackground=!1,this._currentBitrate=0,this.log=ci,this.appVisibilityChangedListener=()=>{this.backgroundTimeout&&clearTimeout(this.backgroundTimeout),"hidden"===document.visibilityState?this.backgroundTimeout=setTimeout(()=>this.handleAppVisibilityChanged(),5e3):this.handleAppVisibilityChanged()},this.log=di(null!==(i=n.loggerName)&&void 0!==i?i:ai.Track),this.loggerContextCb=n.loggerContextCb,this.setMaxListeners(100),this.kind=t,this._mediaStreamTrack=e,this._mediaStreamID=e.id,this.source=ss.Source.Unknown}get logContext(){var e;return Object.assign(Object.assign({},null===(e=this.loggerContextCb)||void 0===e?void 0:e.call(this)),pa(this))}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach(e){let t="audio";this.kind===ss.Kind.Video&&(t="video"),0===this.attachedElements.length&&this.kind===ss.Kind.Video&&this.addAppVisibilityListener(),e||("audio"===t&&(is.forEach(t=>{null!==t.parentElement||e||(e=t)}),e&&is.splice(is.indexOf(e),1)),e||(e=document.createElement(t))),this.attachedElements.includes(e)||this.attachedElements.push(e),as(this.mediaStreamTrack,e);const n=e.srcObject.getTracks(),i=n.some(e=>"audio"===e.kind);return e.play().then(()=>{this.emit(i?Uo.AudioPlaybackStarted:Uo.VideoPlaybackStarted)}).catch(t=>{"NotAllowedError"===t.name?this.emit(i?Uo.AudioPlaybackFailed:Uo.VideoPlaybackFailed,t):"AbortError"===t.name?ci.debug("".concat(i?"audio":"video"," playback aborted, likely due to new play request")):ci.warn("could not playback ".concat(i?"audio":"video"),t),i&&e&&n.some(e=>"video"===e.kind)&&"NotAllowedError"===t.name&&(e.muted=!0,e.play().catch(()=>{}))}),this.emit(Uo.ElementAttached,e),e}detach(e){try{if(e){rs(this.mediaStreamTrack,e);const t=this.attachedElements.indexOf(e);return t>=0&&(this.attachedElements.splice(t,1),this.recycleElement(e),this.emit(Uo.ElementDetached,e)),e}const t=[];return this.attachedElements.forEach(e=>{rs(this.mediaStreamTrack,e),t.push(e),this.recycleElement(e),this.emit(Uo.ElementDetached,e)}),this.attachedElements=[],t}finally{0===this.attachedElements.length&&this.removeAppVisibilityListener()}}stop(){this.stopMonitor(),this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=!0}disable(){this._mediaStreamTrack.enabled=!1}stopMonitor(){this.monitorInterval&&clearInterval(this.monitorInterval),this.timeSyncHandle&&cancelAnimationFrame(this.timeSyncHandle)}updateLoggerOptions(e){e.loggerName&&(this.log=di(e.loggerName)),e.loggerContextCb&&(this.loggerContextCb=e.loggerContextCb)}recycleElement(e){if(e instanceof HTMLAudioElement){let t=!0;e.pause(),is.forEach(e=>{e.parentElement||(t=!1)}),t&&is.push(e)}}handleAppVisibilityChanged(){return pi(this,void 0,void 0,function*(){this.isInBackground="hidden"===document.visibilityState,this.isInBackground||this.kind!==ss.Kind.Video||setTimeout(()=>this.attachedElements.forEach(e=>e.play().catch(()=>{})),0)})}addAppVisibilityListener(){Rs()?(this.isInBackground="hidden"===document.visibilityState,document.addEventListener("visibilitychange",this.appVisibilityChangedListener)):this.isInBackground=!1}removeAppVisibilityListener(){Rs()&&document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}}function as(e,t){let n,i;n=t.srcObject instanceof MediaStream?t.srcObject:new MediaStream,i="audio"===e.kind?n.getAudioTracks():n.getVideoTracks(),i.includes(e)||(i.forEach(e=>{n.removeTrack(e)}),n.addTrack(e)),Es()&&t instanceof HTMLVideoElement||(t.autoplay=!0),t.muted=0===n.getAudioTracks().length,t instanceof HTMLVideoElement&&(t.playsInline=!0),t.srcObject!==n&&(t.srcObject=n,(Es()||Ss())&&t instanceof HTMLVideoElement&&setTimeout(()=>{t.srcObject=n,t.play().catch(()=>{})},0))}function rs(e,t){if(t.srcObject instanceof MediaStream){const n=t.srcObject;n.removeTrack(e),n.getTracks().length>0?t.srcObject=n:t.srcObject=null}}!function(e){let t,n,i;!function(e){e.Audio="audio",e.Video="video",e.Unknown="unknown"}(t=e.Kind||(e.Kind={})),function(e){e.Camera="camera",e.Microphone="microphone",e.ScreenShare="screen_share",e.ScreenShareAudio="screen_share_audio",e.Unknown="unknown"}(n=e.Source||(e.Source={})),function(e){e.Active="active",e.Paused="paused",e.Unknown="unknown"}(i=e.StreamState||(e.StreamState={})),e.kindToProto=function(e){switch(e){case t.Audio:return Ze.AUDIO;case t.Video:return Ze.VIDEO;default:return Ze.DATA}},e.kindFromProto=function(e){switch(e){case Ze.AUDIO:return t.Audio;case Ze.VIDEO:return t.Video;default:return t.Unknown}},e.sourceToProto=function(e){switch(e){case n.Camera:return et.CAMERA;case n.Microphone:return et.MICROPHONE;case n.ScreenShare:return et.SCREEN_SHARE;case n.ScreenShareAudio:return et.SCREEN_SHARE_AUDIO;default:return et.UNKNOWN}},e.sourceFromProto=function(e){switch(e){case et.CAMERA:return n.Camera;case et.MICROPHONE:return n.Microphone;case et.SCREEN_SHARE:return n.ScreenShare;case et.SCREEN_SHARE_AUDIO:return n.ScreenShareAudio;default:return n.Unknown}},e.streamStateFromProto=function(e){switch(e){case Xt.ACTIVE:return i.Active;case Xt.PAUSED:return i.Paused;default:return i.Unknown}}}(ss||(ss={}));class cs{constructor(e,t,n,i,o){if("object"==typeof e)this.width=e.width,this.height=e.height,this.aspectRatio=e.aspectRatio,this.encoding={maxBitrate:e.maxBitrate,maxFramerate:e.maxFramerate,priority:e.priority};else{if(void 0===t||void 0===n)throw new TypeError("Unsupported options: provide at least width, height and maxBitrate");this.width=e,this.height=t,this.aspectRatio=e/t,this.encoding={maxBitrate:n,maxFramerate:i,priority:o}}}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.aspectRatio}}}const ds=["vp8","h264"],ls=["vp8","h264","vp9","av1","h265"];const us=function(e){return!!ds.find(t=>t===e)};var hs,ps;!function(e){e[e.PREFER_REGRESSION=0]="PREFER_REGRESSION",e[e.SIMULCAST=1]="SIMULCAST",e[e.REGRESSION=2]="REGRESSION"}(hs||(hs={})),function(e){e.telephone={maxBitrate:12e3},e.speech={maxBitrate:24e3},e.music={maxBitrate:48e3},e.musicStereo={maxBitrate:64e3},e.musicHighQuality={maxBitrate:96e3},e.musicHighQualityStereo={maxBitrate:128e3}}(ps||(ps={}));const ms={h90:new cs(160,90,9e4,20),h180:new cs(320,180,16e4,20),h216:new cs(384,216,18e4,20),h360:new cs(640,360,45e4,20),h540:new cs(960,540,8e5,25),h720:new cs(1280,720,17e5,30),h1080:new cs(1920,1080,3e6,30),h1440:new cs(2560,1440,5e6,30),h2160:new cs(3840,2160,8e6,30)},gs={h120:new cs(160,120,7e4,20),h180:new cs(240,180,125e3,20),h240:new cs(320,240,14e4,20),h360:new cs(480,360,33e4,20),h480:new cs(640,480,5e5,20),h540:new cs(720,540,6e5,25),h720:new cs(960,720,13e5,30),h1080:new cs(1440,1080,23e5,30),h1440:new cs(1920,1440,38e5,30)},fs={h360fps3:new cs(640,360,2e5,3,"medium"),h360fps15:new cs(640,360,4e5,15,"medium"),h720fps5:new cs(1280,720,8e5,5,"medium"),h720fps15:new cs(1280,720,15e5,15,"medium"),h720fps30:new cs(1280,720,2e6,30,"medium"),h1080fps15:new cs(1920,1080,25e5,15,"medium"),h1080fps30:new cs(1920,1080,5e6,30,"medium"),original:new cs(0,0,7e6,30,"medium")},vs="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension";function bs(e){return pi(this,void 0,void 0,function*(){return new Promise(t=>ns.setTimeout(t,e))})}function ys(){return"addTransceiver"in RTCPeerConnection.prototype}function ks(){return"addTrack"in RTCPeerConnection.prototype}function Ts(e){return"av1"===e||"vp9"===e}function Cs(e){return!(!document||xs())&&(e||(e=document.createElement("audio")),"setSinkId"in e)}function Ss(){var e;return"Firefox"===(null===(e=Xo())||void 0===e?void 0:e.name)}function ws(){const e=Xo();return!!e&&"Chrome"===e.name&&"iOS"!==e.os}function Es(){var e;return"Safari"===(null===(e=Xo())||void 0===e?void 0:e.name)}function xs(){const e=Xo();return"Safari"===(null==e?void 0:e.name)||"iOS"===(null==e?void 0:e.os)}function Ps(){var e,t;return!!Rs()&&(null!==(t=null===(e=navigator.userAgentData)||void 0===e?void 0:e.mobile)&&void 0!==t?t:/Tablet|iPad|Mobile|Android|BlackBerry/.test(navigator.userAgent))}function Rs(){return"undefined"!=typeof document}function Is(){return"ReactNative"==navigator.product}function Os(e){return e.hostname.endsWith(".livekit.cloud")||e.hostname.endsWith(".livekit.run")}function _s(){if(global&&global.LiveKitReactNativeGlobal)return global.LiveKitReactNativeGlobal}function Ds(){if(!Is())return;let e=_s();return e?e.platform:void 0}function Ms(){if(Rs())return window.devicePixelRatio;if(Is()){let e=_s();if(e)return e.devicePixelRatio}return 1}function As(e,t){const n=e.split("."),i=t.split("."),o=Math.min(n.length,i.length);for(let e=0;e<o;++e){const t=parseInt(n[e],10),s=parseInt(i[e],10);if(t>s)return 1;if(t<s)return-1;if(e===o-1&&t===s)return 0}return""===e&&""!==t?-1:""===t?1:n.length==i.length?0:n.length<i.length?-1:1}function Ns(e){for(const t of e)t.target.handleResize(t)}function Ls(e){for(const t of e)t.target.handleVisibilityChanged(t)}let Us=null;const js=()=>(Us||(Us=new ResizeObserver(Ns)),Us);let Fs=null;const Bs=()=>(Fs||(Fs=new IntersectionObserver(Ls,{root:null,rootMargin:"0px"})),Fs);function qs(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const o=document.createElement("canvas");o.width=e,o.height=t;const s=o.getContext("2d");null==s||s.fillRect(0,0,o.width,o.height),i&&s&&(s.beginPath(),s.arc(e/2,t/2,50,0,2*Math.PI,!0),s.closePath(),s.fillStyle="grey",s.fill());const a=o.captureStream(),[r]=a.getTracks();if(!r)throw Error("Could not get empty media stream video track");return r.enabled=n,r}let Vs;function zs(){if(!Vs){const e=new AudioContext,t=e.createOscillator(),n=e.createGain();n.gain.setValueAtTime(0,0);const i=e.createMediaStreamDestination();if(t.connect(n),n.connect(i),t.start(),[Vs]=i.stream.getAudioTracks(),!Vs)throw Error("Could not get empty media stream audio track");Vs.enabled=!1}return Vs.clone()}class Hs{get isResolved(){return this._isResolved}constructor(e,t){this._isResolved=!1,this.onFinally=t,this.promise=new Promise((t,n)=>pi(this,void 0,void 0,function*(){this.resolve=t,this.reject=n,e&&(yield e(t,n))})).finally(()=>{var e;this._isResolved=!0,null===(e=this.onFinally)||void 0===e||e.call(this)})}}function Ws(e){if("string"==typeof e||"number"==typeof e)return e;if(Array.isArray(e))return e[0];if(void 0!==e.exact)return Array.isArray(e.exact)?e.exact[0]:e.exact;if(void 0!==e.ideal)return Array.isArray(e.ideal)?e.ideal[0]:e.ideal;throw Error("could not unwrap constraint")}function Gs(e){return e.startsWith("ws")?e.replace(/^(ws)/,"http"):e}function Ks(e){switch(e.reason){case Oo.LeaveRequest:return e.context;case Oo.Cancelled:return ot.CLIENT_INITIATED;case Oo.NotAllowed:return ot.USER_REJECTED;case Oo.ServerUnreachable:return ot.JOIN_FAILURE;default:return ot.UNKNOWN_REASON}}function Js(e){return void 0!==e?Number(e):void 0}function Ys(e){return void 0!==e?BigInt(e):void 0}function $s(e){return!!e&&!(e instanceof MediaStreamTrack)&&e.isLocal}function Qs(e){return!!e&&e.kind==ss.Kind.Audio}function Xs(e){return!!e&&e.kind==ss.Kind.Video}function Zs(e){return $s(e)&&Xs(e)}function ea(e){return $s(e)&&Qs(e)}function ta(e){return!!e&&!e.isLocal}function na(e){return!!e&&!e.isLocal}function ia(e){return ta(e)&&Xs(e)}function oa(e,t,n){var i,o,s,a;const{optionsWithoutProcessor:r,audioProcessor:c,videoProcessor:d}=ma(null!=e?e:{}),l=null==t?void 0:t.processor,u=null==n?void 0:n.processor,h=null!=r?r:{};return!0===h.audio&&(h.audio={}),!0===h.video&&(h.video={}),h.audio&&(sa(h.audio,t),null!==(i=(s=h.audio).deviceId)&&void 0!==i||(s.deviceId={ideal:"default"}),(c||l)&&(h.audio.processor=null!=c?c:l)),h.video&&(sa(h.video,n),null!==(o=(a=h.video).deviceId)&&void 0!==o||(a.deviceId={ideal:"default"}),(d||u)&&(h.video.processor=null!=d?d:u)),h}function sa(e,t){return Object.keys(t).forEach(n=>{void 0===e[n]&&(e[n]=t[n])}),e}function aa(e){var t,n,i,o;const s={};if(e.video)if("object"==typeof e.video){const n={},o=n,a=e.video;Object.keys(a).forEach(e=>{if("resolution"===e)sa(o,a.resolution);else o[e]=a[e]}),s.video=n,null!==(t=(i=s.video).deviceId)&&void 0!==t||(i.deviceId={ideal:"default"})}else s.video=!!e.video&&{deviceId:{ideal:"default"}};else s.video=!1;return e.audio?"object"==typeof e.audio?(s.audio=e.audio,null!==(n=(o=s.audio).deviceId)&&void 0!==n||(o.deviceId={ideal:"default"})):s.audio={deviceId:{ideal:"default"}}:s.audio=!1,s}function ra(e){return pi(this,arguments,void 0,function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:200;return function*(){const n=ca();if(n){const i=n.createAnalyser();i.fftSize=2048;const o=i.frequencyBinCount,s=new Uint8Array(o);n.createMediaStreamSource(new MediaStream([e.mediaStreamTrack])).connect(i),yield bs(t),i.getByteTimeDomainData(s);const a=s.some(e=>128!==e&&0!==e);return n.close(),!a}return!1}()})}function ca(){var e;const t="undefined"!=typeof window&&(window.AudioContext||window.webkitAudioContext);if(t){const n=new t({latencyHint:"interactive"});if("suspended"===n.state&&"undefined"!=typeof window&&(null===(e=window.document)||void 0===e?void 0:e.body)){const e=()=>pi(this,void 0,void 0,function*(){var t;try{"suspended"===n.state&&(yield n.resume())}catch(e){console.warn("Error trying to auto-resume audio context",e)}finally{null===(t=window.document.body)||void 0===t||t.removeEventListener("click",e)}});n.addEventListener("statechange",()=>{var t;"closed"===n.state&&(null===(t=window.document.body)||void 0===t||t.removeEventListener("click",e))}),window.document.body.addEventListener("click",e)}return n}}function da(e){return"audioinput"===e?ss.Source.Microphone:"videoinput"===e?ss.Source.Camera:ss.Source.Unknown}function la(e){return e===ss.Source.Microphone?"audioinput":e===ss.Source.Camera?"videoinput":void 0}function ua(e){return e.split("/")[1].toLowerCase()}function ha(e){const t=[];return e.forEach(e=>{void 0!==e.track&&t.push(new dn({cid:e.track.mediaStreamID,track:e.trackInfo}))}),t}function pa(e){return"mediaStreamTrack"in e?{trackID:e.sid,source:e.source,muted:e.isMuted,enabled:e.mediaStreamTrack.enabled,kind:e.kind,streamID:e.mediaStreamID,streamTrackID:e.mediaStreamTrack.id}:{trackID:e.trackSid,enabled:e.isEnabled,muted:e.isMuted,trackInfo:Object.assign({mimeType:e.mimeType,name:e.trackName,encrypted:e.isEncrypted,kind:e.kind,source:e.source},e.track?pa(e.track):{})}}function ma(e){const t=Object.assign({},e);let n,i;return"object"==typeof t.audio&&t.audio.processor&&(n=t.audio.processor,t.audio=Object.assign(Object.assign({},t.audio),{processor:void 0})),"object"==typeof t.video&&t.video.processor&&(i=t.video.processor,t.video=Object.assign(Object.assign({},t.video),{processor:void 0})),{audioProcessor:n,videoProcessor:i,optionsWithoutProcessor:(o=t,void 0===o?o:"function"==typeof structuredClone?"object"==typeof o&&null!==o?structuredClone(Object.assign({},o)):structuredClone(o):JSON.parse(JSON.stringify(o)))};var o}function ga(e,t){return e.width*e.height<t.width*t.height}class fa extends bi.EventEmitter{constructor(e,t){super(),this.decryptDataRequests=new Map,this.encryptDataRequests=new Map,this.onWorkerMessage=e=>{var t,n;const{kind:i,data:o}=e.data;switch(i){case"error":ci.error(o.error.message),this.emit(Ro.EncryptionError,o.error);break;case"initAck":o.enabled&&this.keyProvider.getKeys().forEach(e=>{this.postKey(e)});break;case"enable":if(o.enabled&&this.keyProvider.getKeys().forEach(e=>{this.postKey(e)}),this.encryptionEnabled!==o.enabled&&o.participantIdentity===(null===(t=this.room)||void 0===t?void 0:t.localParticipant.identity))this.emit(Ro.ParticipantEncryptionStatusChanged,o.enabled,this.room.localParticipant),this.encryptionEnabled=o.enabled;else if(o.participantIdentity){const e=null===(n=this.room)||void 0===n?void 0:n.getParticipantByIdentity(o.participantIdentity);if(!e)throw TypeError("couldn't set encryption status, participant not found".concat(o.participantIdentity));this.emit(Ro.ParticipantEncryptionStatusChanged,o.enabled,e)}break;case"ratchetKey":this.keyProvider.emit(xo.KeyRatcheted,o.ratchetResult,o.participantIdentity,o.keyIndex);break;case"decryptDataResponse":const e=this.decryptDataRequests.get(o.uuid);(null==e?void 0:e.resolve)&&e.resolve(o);break;case"encryptDataResponse":const i=this.encryptDataRequests.get(o.uuid);(null==i?void 0:i.resolve)&&i.resolve(o)}},this.onWorkerError=e=>{ci.error("e2ee worker encountered an error:",{error:e.error}),this.emit(Ro.EncryptionError,e.error)},this.keyProvider=e.keyProvider,this.worker=e.worker,this.encryptionEnabled=!1,this.dataChannelEncryptionEnabled=t}get isEnabled(){return this.encryptionEnabled}get isDataChannelEncryptionEnabled(){return this.isEnabled&&this.dataChannelEncryptionEnabled}setup(e){if(!jo())throw new Vo("tried to setup end-to-end encryption on an unsupported browser");if(ci.info("setting up e2ee"),e!==this.room){this.room=e,this.setupEventListeners(e,this.keyProvider);const t={kind:"init",data:{keyProviderOptions:this.keyProvider.getOptions(),loglevel:li.getLevel()}};this.worker&&(ci.info("initializing worker",{worker:this.worker}),this.worker.onmessage=this.onWorkerMessage,this.worker.onerror=this.onWorkerError,this.worker.postMessage(t))}}setParticipantCryptorEnabled(e,t){ci.debug("set e2ee to ".concat(e," for participant ").concat(t)),this.postEnable(e,t)}setSifTrailer(e){e&&0!==e.length?this.postSifTrailer(e):ci.warn("ignoring server sent trailer as it's empty")}setupEngine(e){e.on(Lo.RTPVideoMapUpdate,e=>{this.postRTPMap(e)})}setupEventListeners(e,t){e.on(Ao.TrackPublished,(e,t)=>this.setParticipantCryptorEnabled(e.trackInfo.encryption!==gt.NONE,t.identity)),e.on(Ao.ConnectionStateChanged,t=>{t===nc.Connected&&e.remoteParticipants.forEach(e=>{e.trackPublications.forEach(t=>{this.setParticipantCryptorEnabled(t.trackInfo.encryption!==gt.NONE,e.identity)})})}).on(Ao.TrackUnsubscribed,(e,t,n)=>{var i;const o={kind:"removeTransform",data:{participantIdentity:n.identity,trackId:e.mediaStreamID}};null===(i=this.worker)||void 0===i||i.postMessage(o)}).on(Ao.TrackSubscribed,(e,t,n)=>{this.setupE2EEReceiver(e,n.identity,t.trackInfo)}).on(Ao.SignalConnected,()=>{if(!this.room)throw new TypeError("expected room to be present on signal connect");t.getKeys().forEach(e=>{this.postKey(e)}),this.setParticipantCryptorEnabled(this.room.localParticipant.isE2EEEnabled,this.room.localParticipant.identity)}),e.localParticipant.on(No.LocalSenderCreated,(e,t)=>pi(this,void 0,void 0,function*(){this.setupE2EESender(t,e)})),e.localParticipant.on(No.LocalTrackPublished,e=>{if(!Xs(e.track)||!xs())return;const t={kind:"updateCodec",data:{trackId:e.track.mediaStreamID,codec:ua(e.trackInfo.codecs[0].mimeType),participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(t)}),t.on(xo.SetKey,e=>this.postKey(e)).on(xo.RatchetRequest,(e,t)=>this.postRatchetRequest(e,t))}encryptData(e){return pi(this,void 0,void 0,function*(){if(!this.worker)throw Error("could not encrypt data, worker is missing");const t=crypto.randomUUID(),n={kind:"encryptDataRequest",data:{uuid:t,payload:e,participantIdentity:this.room.localParticipant.identity}},i=new Hs;return i.onFinally=()=>{this.encryptDataRequests.delete(t)},this.encryptDataRequests.set(t,i),this.worker.postMessage(n),i.promise})}handleEncryptedData(e,t,n,i){if(!this.worker)throw Error("could not handle encrypted data, worker is missing");const o=crypto.randomUUID(),s={kind:"decryptDataRequest",data:{uuid:o,payload:e,iv:t,participantIdentity:n,keyIndex:i}},a=new Hs;return a.onFinally=()=>{this.decryptDataRequests.delete(o)},this.decryptDataRequests.set(o,a),this.worker.postMessage(s),a.promise}postRatchetRequest(e,t){if(!this.worker)throw Error("could not ratchet key, worker is missing");const n={kind:"ratchetRequest",data:{participantIdentity:e,keyIndex:t}};this.worker.postMessage(n)}postKey(e){let{key:t,participantIdentity:n,keyIndex:i}=e;var o;if(!this.worker)throw Error("could not set key, worker is missing");const s={kind:"setKey",data:{participantIdentity:n,isPublisher:n===(null===(o=this.room)||void 0===o?void 0:o.localParticipant.identity),key:t,keyIndex:i}};this.worker.postMessage(s)}postEnable(e,t){if(!this.worker)throw new ReferenceError("failed to enable e2ee, worker is not ready");{const n={kind:"enable",data:{enabled:e,participantIdentity:t}};this.worker.postMessage(n)}}postRTPMap(e){var t;if(!this.worker)throw TypeError("could not post rtp map, worker is missing");if(!(null===(t=this.room)||void 0===t?void 0:t.localParticipant.identity))throw TypeError("could not post rtp map, local participant identity is missing");const n={kind:"setRTPMap",data:{map:e,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(n)}postSifTrailer(e){if(!this.worker)throw Error("could not post SIF trailer, worker is missing");const t={kind:"setSifTrailer",data:{trailer:e}};this.worker.postMessage(t)}setupE2EEReceiver(e,t,n){if(e.receiver){if(!(null==n?void 0:n.mimeType)||""===n.mimeType)throw new TypeError("MimeType missing from trackInfo, cannot set up E2EE cryptor");this.handleReceiver(e.receiver,e.mediaStreamID,t,"video"===e.kind?ua(n.mimeType):void 0)}}setupE2EESender(e,t){$s(e)&&t?this.handleSender(t,e.mediaStreamID,void 0):t||ci.warn("early return because sender is not ready")}handleReceiver(e,t,n,i){return pi(this,void 0,void 0,function*(){if(this.worker){if(Fo()&&!ws()){const o={kind:"decode",participantIdentity:n,trackId:t,codec:i};e.transform=new RTCRtpScriptTransform(this.worker,o)}else{if(Eo in e&&i){const e={kind:"updateCodec",data:{trackId:t,codec:i,participantIdentity:n}};return void this.worker.postMessage(e)}let o=e.writableStream,s=e.readableStream;if(!o||!s){const t=e.createEncodedStreams();e.writableStream=t.writable,o=t.writable,e.readableStream=t.readable,s=t.readable}const a={kind:"decode",data:{readableStream:s,writableStream:o,trackId:t,codec:i,participantIdentity:n,isReuse:Eo in e}};this.worker.postMessage(a,[s,o])}e[Eo]=!0}})}handleSender(e,t,n){var i;if(!(Eo in e)&&this.worker){if(!(null===(i=this.room)||void 0===i?void 0:i.localParticipant.identity)||""===this.room.localParticipant.identity)throw TypeError("local identity needs to be known in order to set up encrypted sender");if(Fo()&&!ws()){ci.info("initialize script transform");const i={kind:"encode",participantIdentity:this.room.localParticipant.identity,trackId:t,codec:n};e.transform=new RTCRtpScriptTransform(this.worker,i)}else{ci.info("initialize encoded streams");const i=e.createEncodedStreams(),o={kind:"encode",data:{readableStream:i.readable,writableStream:i.writable,codec:n,trackId:t,participantIdentity:this.room.localParticipant.identity,isReuse:!1}};this.worker.postMessage(o,[i.readable,i.writable])}e[Eo]=!0}}}const va="default";class ba{constructor(){this._previousDevices=[]}static getInstance(){return void 0===this.instance&&(this.instance=new ba),this.instance}get previousDevices(){return this._previousDevices}getDevices(e){return pi(this,arguments,void 0,function(e){var t=this;let n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return function*(){var i;if((null===(i=ba.userMediaPromiseMap)||void 0===i?void 0:i.size)>0){ci.debug("awaiting getUserMedia promise");try{e?yield ba.userMediaPromiseMap.get(e):yield Promise.all(ba.userMediaPromiseMap.values())}catch(e){ci.warn("error waiting for media permissons")}}let o=yield navigator.mediaDevices.enumerateDevices();if(n&&(!Es()||!t.hasDeviceInUse(e))){if(0===o.filter(t=>t.kind===e).length||o.some(t=>{const n=""===t.label,i=!e||t.kind===e;return n&&i})){const t={video:"audioinput"!==e&&"audiooutput"!==e,audio:"videoinput"!==e&&{deviceId:{ideal:"default"}}},n=yield navigator.mediaDevices.getUserMedia(t);o=yield navigator.mediaDevices.enumerateDevices(),n.getTracks().forEach(e=>{e.stop()})}}return t._previousDevices=o,e&&(o=o.filter(t=>t.kind===e)),o}()})}normalizeDeviceId(e,t,n){return pi(this,void 0,void 0,function*(){if(t!==va)return t;const i=yield this.getDevices(e),o=i.find(e=>e.deviceId===va);if(!o)return void ci.warn("could not reliably determine default device");const s=i.find(e=>e.deviceId!==va&&e.groupId===(null!=n?n:o.groupId));if(s)return null==s?void 0:s.deviceId;ci.warn("could not reliably determine default device")})}hasDeviceInUse(e){return e?ba.userMediaPromiseMap.has(e):ba.userMediaPromiseMap.size>0}}var ya;ba.mediaDeviceKinds=["audioinput","audiooutput","videoinput"],ba.userMediaPromiseMap=new Map,function(e){e[e.WAITING=0]="WAITING",e[e.RUNNING=1]="RUNNING",e[e.COMPLETED=2]="COMPLETED"}(ya||(ya={}));class ka{constructor(){this.pendingTasks=new Map,this.taskMutex=new m,this.nextTaskIndex=0}run(e){return pi(this,void 0,void 0,function*(){const t={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:ya.WAITING};this.pendingTasks.set(t.id,t);const n=yield this.taskMutex.lock();try{return t.executedAt=Date.now(),t.status=ya.RUNNING,yield e()}finally{t.status=ya.COMPLETED,this.pendingTasks.delete(t.id),n()}})}flush(){return pi(this,void 0,void 0,function*(){return this.run(()=>pi(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}}class Ta{get readyState(){return this.ws.readyState}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var n,i;if(null===(n=t.signal)||void 0===n?void 0:n.aborted)throw new DOMException("This operation was aborted","AbortError");this.url=e;const o=new WebSocket(e,null!==(i=t.protocols)&&void 0!==i?i:[]);o.binaryType="arraybuffer",this.ws=o;const s=function(){let{closeCode:e,reason:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return o.close(e,t)};this.opened=new Promise((e,t)=>{o.onopen=()=>{e({readable:new ReadableStream({start(e){o.onmessage=t=>{let{data:n}=t;return e.enqueue(n)},o.onerror=t=>e.error(t)},cancel:s}),writable:new WritableStream({write(e){o.send(e)},abort(){o.close()},close:s}),protocol:o.protocol,extensions:o.extensions}),o.removeEventListener("error",t)},o.addEventListener("error",t)}),this.closed=new Promise((e,t)=>{const n=()=>pi(this,void 0,void 0,function*(){const n=new Promise(e=>{o.readyState!==WebSocket.CLOSED&&o.addEventListener("close",t=>{e(t)},{once:!0})}),i=yield Promise.race([bs(250),n]);i?e(i):t(new Error("Encountered unspecified websocket error without a timely close event"))});o.onclose=t=>{let{code:i,reason:s}=t;e({closeCode:i,reason:s}),o.removeEventListener("error",n)},o.addEventListener("error",n)}),t.signal&&(t.signal.onabort=()=>o.close()),this.close=s}}function Ca(e,t){return e.pathname="".concat(function(e){return e.endsWith("/")?e:"".concat(e,"/")}(e.pathname)).concat(t),e.toString()}function Sa(e){if("string"==typeof e)return tn.fromJson(JSON.parse(e),{ignoreUnknownFields:!0});if(e instanceof ArrayBuffer)return tn.fromBinary(new Uint8Array(e));throw new Error("could not decode websocket message: ".concat(typeof e))}const wa=["syncState","trickle","offer","answer","simulate","leave"];var Ea;!function(e){e[e.CONNECTING=0]="CONNECTING",e[e.CONNECTED=1]="CONNECTED",e[e.RECONNECTING=2]="RECONNECTING",e[e.DISCONNECTING=3]="DISCONNECTING",e[e.DISCONNECTED=4]="DISCONNECTED"}(Ea||(Ea={}));class xa{get currentState(){return this.state}get isDisconnected(){return this.state===Ea.DISCONNECTING||this.state===Ea.DISCONNECTED}get isEstablishingConnection(){return this.state===Ea.CONNECTING||this.state===Ea.RECONNECTING}getNextRequestId(){return this._requestId+=1,this._requestId}constructor(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var n;this.rtt=0,this.state=Ea.DISCONNECTED,this.log=ci,this._requestId=0,this.resetCallbacks=()=>{this.onAnswer=void 0,this.onLeave=void 0,this.onLocalTrackPublished=void 0,this.onLocalTrackUnpublished=void 0,this.onNegotiateRequested=void 0,this.onOffer=void 0,this.onRemoteMuteChanged=void 0,this.onSubscribedQualityUpdate=void 0,this.onTokenRefresh=void 0,this.onTrickle=void 0,this.onClose=void 0,this.onMediaSectionsRequirement=void 0},this.log=di(null!==(n=t.loggerName)&&void 0!==n?n:ai.Signal),this.loggerContextCb=t.loggerContextCb,this.useJSON=e,this.requestQueue=new ka,this.queuedRequests=[],this.closingLock=new m,this.connectionLock=new m,this.state=Ea.DISCONNECTED}get logContext(){var e,t;return null!==(t=null===(e=this.loggerContextCb)||void 0===e?void 0:e.call(this))&&void 0!==t?t:{}}join(e,t,n,i){return pi(this,void 0,void 0,function*(){this.state=Ea.CONNECTING,this.options=n;return yield this.connect(e,t,n,i)})}reconnect(e,t,n,i){return pi(this,void 0,void 0,function*(){if(!this.options)return void this.log.warn("attempted to reconnect without signal options being set, ignoring",this.logContext);this.state=Ea.RECONNECTING,this.clearPingInterval();return yield this.connect(e,t,Object.assign(Object.assign({},this.options),{reconnect:!0,sid:n,reconnectReason:i}))})}connect(e,t,n,i){return pi(this,void 0,void 0,function*(){const o=yield this.connectionLock.lock();this.connectOptions=n;const s=function(){var e;const t=new jt({sdk:Ft.JS,protocol:16,version:"2.15.13"});return Is()&&(t.os=null!==(e=Ds())&&void 0!==e?e:""),t}(),a=n.singlePeerConnection?function(e,t,n){const i=new URLSearchParams;i.set("access_token",e);const o=new Yn({clientInfo:t,connectionSettings:new Jn({autoSubscribe:!!n.autoSubscribe,adaptiveStream:!!n.adaptiveStream}),reconnect:!!n.reconnect,participantSid:n.sid?n.sid:void 0});n.reconnectReason&&(o.reconnectReason=n.reconnectReason);const s=new $n({joinRequest:o.toBinary()});return i.set("join_request",btoa(new TextDecoder("utf-8").decode(s.toBinary()))),i}(t,s,n):function(e,t,n){var i;const o=new URLSearchParams;o.set("access_token",e),n.reconnect&&(o.set("reconnect","1"),n.sid&&o.set("sid",n.sid));o.set("auto_subscribe",n.autoSubscribe?"1":"0"),o.set("sdk",Is()?"reactnative":"js"),o.set("version",t.version),o.set("protocol",t.protocol.toString()),t.deviceModel&&o.set("device_model",t.deviceModel);t.os&&o.set("os",t.os);t.osVersion&&o.set("os_version",t.osVersion);t.browser&&o.set("browser",t.browser);t.browserVersion&&o.set("browser_version",t.browserVersion);n.adaptiveStream&&o.set("adaptive_stream","1");n.reconnectReason&&o.set("reconnect_reason",n.reconnectReason.toString());(null===(i=navigator.connection)||void 0===i?void 0:i.type)&&o.set("network",navigator.connection.type);return o}(t,s,n),r=function(e,t){const n=new URL(function(e){return e.startsWith("http")?e.replace(/^(http)/,"ws"):e}(e));return t.forEach((e,t)=>{n.searchParams.set(t,e)}),Ca(n,"rtc")}(e,a),c=Ca(new URL(Gs(r)),"validate");return new Promise((e,t)=>pi(this,void 0,void 0,function*(){var s,a;try{let o=!1;const d=e=>pi(this,void 0,void 0,function*(){if(o)return;o=!0;const n=e instanceof Event?e.currentTarget:e,i=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Unknown reason";if(!(e instanceof AbortSignal))return t;const n=e.reason;switch(typeof n){case"string":return n;case"object":return n instanceof Error?n.message:t;default:return"toString"in n?n.toString():t}}(n,"Abort handler called");this.streamWriter&&!this.isDisconnected?this.sendLeave().then(()=>this.close(i)).catch(e=>{this.log.error(e),this.close()}):this.close(),l(),t(n instanceof AbortSignal?n.reason:n)});null==i||i.addEventListener("abort",d);const l=()=>{clearTimeout(u),null==i||i.removeEventListener("abort",d)},u=setTimeout(()=>{d(new qo("room connection has timed out (signal)",Oo.ServerUnreachable))},n.websocketTimeout),h=(e,t)=>{this.handleSignalConnected(e,u,t)},p=new URL(r);p.searchParams.has("access_token")&&p.searchParams.set("access_token","<redacted>"),this.log.debug("connecting to ".concat(p),Object.assign({reconnect:n.reconnect,reconnectReason:n.reconnectReason},this.logContext)),this.ws&&(yield this.close(!1)),this.ws=new Ta(r);try{this.ws.closed.then(e=>{this.isEstablishingConnection&&t(new qo("Websocket got closed during a (re)connection attempt: ".concat(e.reason),Oo.InternalError)),1e3!==e.closeCode&&this.log.warn("websocket closed",Object.assign(Object.assign({},this.logContext),{reason:e.reason,code:e.closeCode,wasClean:1e3===e.closeCode,state:this.state}))}).catch(e=>{this.isEstablishingConnection&&t(new qo("Websocket error during a (re)connection attempt: ".concat(e),Oo.InternalError))});const i=yield this.ws.opened.catch(e=>pi(this,void 0,void 0,function*(){if(this.state!==Ea.CONNECTED){this.state=Ea.DISCONNECTED,clearTimeout(u);const n=yield this.handleConnectionError(e,c);return void t(n)}this.handleWSError(e),t(e)}));if(clearTimeout(u),!i)return;const o=i.readable.getReader();this.streamWriter=i.writable.getWriter();const r=yield o.read();if(o.releaseLock(),!r.value)throw new qo("no message received as first message",Oo.InternalError);const d=Sa(r.value),l=this.validateFirstMessage(d,null!==(s=n.reconnect)&&void 0!==s&&s);if(!l.isValid)return void t(l.error);"join"===(null===(a=d.message)||void 0===a?void 0:a.case)&&(this.pingTimeoutDuration=d.message.value.pingTimeout,this.pingIntervalDuration=d.message.value.pingInterval,this.pingTimeoutDuration&&this.pingTimeoutDuration>0&&this.log.debug("ping config",Object.assign(Object.assign({},this.logContext),{timeout:this.pingTimeoutDuration,interval:this.pingIntervalDuration})));h(i,l.shouldProcessFirstMessage?d:void 0),e(l.response)}catch(e){t(e)}finally{l()}}finally{o()}}))})}startReadingLoop(e,t){return pi(this,void 0,void 0,function*(){for(t&&this.handleSignalResponse(t);;){this.signalLatency&&(yield bs(this.signalLatency));const{done:t,value:n}=yield e.read();if(t)break;const i=Sa(n);this.handleSignalResponse(i)}})}close(){return pi(this,arguments,void 0,function(){var e=this;let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Close method called on signal client";return function*(){const i=yield e.closingLock.lock();try{if(e.clearPingInterval(),t&&(e.state=Ea.DISCONNECTING),e.ws){e.ws.close({closeCode:1e3,reason:n});const t=e.ws.closed;e.ws=void 0,e.streamWriter=void 0,yield Promise.race([t,bs(250)])}}catch(t){e.log.debug("websocket error while closing",Object.assign(Object.assign({},e.logContext),{error:t}))}finally{t&&(e.state=Ea.DISCONNECTED),i()}}()})}sendOffer(e,t){this.log.debug("sending offer",Object.assign(Object.assign({},this.logContext),{offerSdp:e.sdp})),this.sendRequest({case:"offer",value:Ra(e,t)})}sendAnswer(e,t){return this.log.debug("sending answer",Object.assign(Object.assign({},this.logContext),{answerSdp:e.sdp})),this.sendRequest({case:"answer",value:Ra(e,t)})}sendIceCandidate(e,t){return this.log.debug("sending ice candidate",Object.assign(Object.assign({},this.logContext),{candidate:e})),this.sendRequest({case:"trickle",value:new sn({candidateInit:JSON.stringify(e),target:t})})}sendMuteTrack(e,t){return this.sendRequest({case:"mute",value:new an({sid:e,muted:t})})}sendAddTrack(e){return this.sendRequest({case:"addTrack",value:e})}sendUpdateLocalMetadata(e,t){return pi(this,arguments,void 0,function(e,t){var n=this;let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return function*(){const o=n.getNextRequestId();return yield n.sendRequest({case:"updateMetadata",value:new kn({requestId:o,metadata:e,name:t,attributes:i})}),o}()})}sendUpdateTrackSettings(e){this.sendRequest({case:"trackSetting",value:e})}sendUpdateSubscription(e){return this.sendRequest({case:"subscription",value:e})}sendSyncState(e){return this.sendRequest({case:"syncState",value:e})}sendUpdateVideoLayers(e,t){return this.sendRequest({case:"updateLayers",value:new yn({trackSid:e,layers:t})})}sendUpdateSubscriptionPermissions(e,t){return this.sendRequest({case:"subscriptionPermission",value:new Mn({allParticipants:e,trackPermissions:t})})}sendSimulateScenario(e){return this.sendRequest({case:"simulate",value:e})}sendPing(){return Promise.all([this.sendRequest({case:"ping",value:L.parse(Date.now())}),this.sendRequest({case:"pingReq",value:new Bn({timestamp:L.parse(Date.now()),rtt:L.parse(this.rtt)})})])}sendUpdateLocalAudioTrack(e,t){return this.sendRequest({case:"updateAudioTrack",value:new gn({trackSid:e,features:t})})}sendLeave(){return this.sendRequest({case:"leave",value:new vn({reason:ot.CLIENT_INITIATED,action:bn.DISCONNECT})})}sendRequest(e){return pi(this,arguments,void 0,function(e){var t=this;let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return function*(){const i=!n&&!function(e){const t=wa.indexOf(e.case)>=0;return ci.trace("request allowed to bypass queue:",{canPass:t,req:e}),t}(e);if(i&&t.state===Ea.RECONNECTING)return void t.queuedRequests.push(()=>pi(t,void 0,void 0,function*(){yield this.sendRequest(e,!0)}));if(n||(yield t.requestQueue.flush()),t.signalLatency&&(yield bs(t.signalLatency)),t.isDisconnected)return void t.log.debug("skipping signal request (type: ".concat(e.case,") - SignalClient disconnected"));if(!t.streamWriter)return void t.log.error("cannot send signal request before connected, type: ".concat(null==e?void 0:e.case),t.logContext);const o=new en({message:e});try{t.useJSON?yield t.streamWriter.write(o.toJsonString()):yield t.streamWriter.write(o.toBinary())}catch(e){t.log.error("error sending signal message",Object.assign(Object.assign({},t.logContext),{error:e}))}}()})}handleSignalResponse(e){var t,n;const i=e.message;if(null==i)return void this.log.debug("received unsupported message",this.logContext);let o=!1;if("answer"===i.case){const e=Pa(i.value);this.onAnswer&&this.onAnswer(e,i.value.id,i.value.midToTrackId)}else if("offer"===i.case){const e=Pa(i.value);this.onOffer&&this.onOffer(e,i.value.id,i.value.midToTrackId)}else if("trickle"===i.case){const e=JSON.parse(i.value.candidateInit);this.onTrickle&&this.onTrickle(e,i.value.target)}else"update"===i.case?this.onParticipantUpdate&&this.onParticipantUpdate(null!==(t=i.value.participants)&&void 0!==t?t:[]):"trackPublished"===i.case?this.onLocalTrackPublished&&this.onLocalTrackPublished(i.value):"speakersChanged"===i.case?this.onSpeakersChanged&&this.onSpeakersChanged(null!==(n=i.value.speakers)&&void 0!==n?n:[]):"leave"===i.case?this.onLeave&&this.onLeave(i.value):"mute"===i.case?this.onRemoteMuteChanged&&this.onRemoteMuteChanged(i.value.sid,i.value.muted):"roomUpdate"===i.case?this.onRoomUpdate&&i.value.room&&this.onRoomUpdate(i.value.room):"connectionQuality"===i.case?this.onConnectionQuality&&this.onConnectionQuality(i.value):"streamStateUpdate"===i.case?this.onStreamStateUpdate&&this.onStreamStateUpdate(i.value):"subscribedQualityUpdate"===i.case?this.onSubscribedQualityUpdate&&this.onSubscribedQualityUpdate(i.value):"subscriptionPermissionUpdate"===i.case?this.onSubscriptionPermissionUpdate&&this.onSubscriptionPermissionUpdate(i.value):"refreshToken"===i.case?this.onTokenRefresh&&this.onTokenRefresh(i.value):"trackUnpublished"===i.case?this.onLocalTrackUnpublished&&this.onLocalTrackUnpublished(i.value):"subscriptionResponse"===i.case?this.onSubscriptionError&&this.onSubscriptionError(i.value):"pong"===i.case||("pongResp"===i.case?(this.rtt=Date.now()-Number.parseInt(i.value.lastPingTimestamp.toString()),this.resetPingTimeout(),o=!0):"requestResponse"===i.case?this.onRequestResponse&&this.onRequestResponse(i.value):"trackSubscribed"===i.case?this.onLocalTrackSubscribed&&this.onLocalTrackSubscribed(i.value.trackSid):"roomMoved"===i.case?(this.onTokenRefresh&&this.onTokenRefresh(i.value.token),this.onRoomMoved&&this.onRoomMoved(i.value)):"mediaSectionsRequirement"===i.case?this.onMediaSectionsRequirement&&this.onMediaSectionsRequirement(i.value):this.log.debug("unsupported message",Object.assign(Object.assign({},this.logContext),{msgCase:i.case})));o||this.resetPingTimeout()}setReconnected(){for(;this.queuedRequests.length>0;){const e=this.queuedRequests.shift();e&&this.requestQueue.run(e)}}handleOnClose(e){return pi(this,void 0,void 0,function*(){if(this.state===Ea.DISCONNECTED)return;const t=this.onClose;yield this.close(void 0,e),this.log.debug("websocket connection closed: ".concat(e),Object.assign(Object.assign({},this.logContext),{reason:e})),t&&t(e)})}handleWSError(e){this.log.error("websocket error",Object.assign(Object.assign({},this.logContext),{error:e}))}resetPingTimeout(){this.clearPingTimeout(),this.pingTimeoutDuration?this.pingTimeout=ns.setTimeout(()=>{this.log.warn("ping timeout triggered. last pong received at: ".concat(new Date(Date.now()-1e3*this.pingTimeoutDuration).toUTCString()),this.logContext),this.handleOnClose("ping timeout")},1e3*this.pingTimeoutDuration):this.log.warn("ping timeout duration not set",this.logContext)}clearPingTimeout(){this.pingTimeout&&ns.clearTimeout(this.pingTimeout)}startPingInterval(){this.clearPingInterval(),this.resetPingTimeout(),this.pingIntervalDuration?(this.log.debug("start ping interval",this.logContext),this.pingInterval=ns.setInterval(()=>{this.sendPing()},1e3*this.pingIntervalDuration)):this.log.warn("ping interval duration not set",this.logContext)}clearPingInterval(){this.log.debug("clearing ping interval",this.logContext),this.clearPingTimeout(),this.pingInterval&&ns.clearInterval(this.pingInterval)}handleSignalConnected(e,t,n){this.state=Ea.CONNECTED,clearTimeout(t),this.startPingInterval(),this.startReadingLoop(e.readable.getReader(),n)}validateFirstMessage(e,t){var n,i,o,s,a;return"join"===(null===(n=e.message)||void 0===n?void 0:n.case)?{isValid:!0,response:e.message.value}:this.state===Ea.RECONNECTING&&"leave"!==(null===(i=e.message)||void 0===i?void 0:i.case)?"reconnect"===(null===(o=e.message)||void 0===o?void 0:o.case)?{isValid:!0,response:e.message.value}:(this.log.debug("declaring signal reconnected without reconnect response received",this.logContext),{isValid:!0,response:void 0,shouldProcessFirstMessage:!0}):this.isEstablishingConnection&&"leave"===(null===(s=e.message)||void 0===s?void 0:s.case)?{isValid:!1,error:new qo("Received leave request while trying to (re)connect",Oo.LeaveRequest,void 0,e.message.value.reason)}:t?{isValid:!1,error:new qo("Unexpected first message",Oo.InternalError)}:{isValid:!1,error:new qo("did not receive join response, got ".concat(null===(a=e.message)||void 0===a?void 0:a.case," instead"),Oo.InternalError)}}handleConnectionError(e,t){return pi(this,void 0,void 0,function*(){try{const n=yield fetch(t);if(n.status.toFixed(0).startsWith("4")){const e=yield n.text();return new qo(e,Oo.NotAllowed,n.status)}return e instanceof qo?e:new qo("Encountered unknown websocket error during connection: ".concat(e),Oo.InternalError,n.status)}catch(e){return e instanceof qo?e:new qo(e instanceof Error?e.message:"server was not reachable",Oo.ServerUnreachable)}})}}function Pa(e){const t={type:"offer",sdp:e.sdp};switch(e.type){case"answer":case"offer":case"pranswer":case"rollback":t.type=e.type}return t}function Ra(e,t){return new un({sdp:e.sdp,type:e.type,id:t})}class Ia{constructor(){this.buffer=[],this._totalSize=0}push(e){this.buffer.push(e),this._totalSize+=e.data.byteLength}pop(){const e=this.buffer.shift();return e&&(this._totalSize-=e.data.byteLength),e}getAll(){return this.buffer.slice()}popToSequence(e){for(;this.buffer.length>0;){if(!(this.buffer[0].sequence<=e))break;this.pop()}}alignBufferedAmount(e){for(;this.buffer.length>0;){const t=this.buffer[0];if(this._totalSize-t.data.byteLength<=e)break;this.pop()}}get length(){return this.buffer.length}}class Oa{constructor(e){this._map=new Map,this._lastCleanup=0,this.ttl=e}set(e,t){const n=Date.now();n-this._lastCleanup>this.ttl/2&&this.cleanup();const i=n+this.ttl;return this._map.set(e,{value:t,expiresAt:i}),this}get(e){const t=this._map.get(e);if(t){if(!(t.expiresAt<Date.now()))return t.value;this._map.delete(e)}}has(e){const t=this._map.get(e);return!!t&&(!(t.expiresAt<Date.now())||(this._map.delete(e),!1))}delete(e){return this._map.delete(e)}clear(){this._map.clear()}cleanup(){const e=Date.now();for(const[t,n]of this._map.entries())n.expiresAt<e&&this._map.delete(t);this._lastCleanup=e}get size(){return this.cleanup(),this._map.size}forEach(e){this.cleanup();for(const[t,n]of this._map.entries())n.expiresAt>=Date.now()&&e(n.value,t,this.asValueMap())}map(e){this.cleanup();const t=[],n=this.asValueMap();for(const[i,o]of n.entries())t.push(e(o,i,n));return t}asValueMap(){const e=new Map;for(const[t,n]of this._map.entries())n.expiresAt>=Date.now()&&e.set(t,n.value);return e}}var _a,Da,Ma,Aa,Na,La={},Ua={},ja={exports:{}};function Fa(){if(_a)return ja.exports;_a=1;var e=ja.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(e).forEach(function(t){e[t].forEach(function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")})}),ja.exports}function Ba(){return Da||(Da=1,function(e){var t=function(e){return String(Number(e))===e?Number(e):e},n=function(e,n,i){var o=e.name&&e.names;e.push&&!n[e.push]?n[e.push]=[]:o&&!n[e.name]&&(n[e.name]={});var s=e.push?{}:o?n[e.name]:n;!function(e,n,i,o){if(o&&!i)n[o]=t(e[1]);else for(var s=0;s<i.length;s+=1)null!=e[s+1]&&(n[i[s]]=t(e[s+1]))}(i.match(e.reg),s,e.names,e.name),e.push&&n[e.push].push(s)},i=Fa(),o=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(e){var t={},s=[],a=t;return e.split(/(\r\n|\r|\n)/).filter(o).forEach(function(e){var t=e[0],o=e.slice(2);"m"===t&&(s.push({rtp:[],fmtp:[]}),a=s[s.length-1]);for(var r=0;r<(i[t]||[]).length;r+=1){var c=i[t][r];if(c.reg.test(o))return n(c,a,o)}}),t.media=s,t};var s=function(e,n){var i=n.split(/=(.+)/,2);return 2===i.length?e[i[0]]=t(i[1]):1===i.length&&n.length>1&&(e[i[0]]=void 0),e};e.parseParams=function(e){return e.split(/;\s?/).reduce(s,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(e){return e.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(e){for(var n=[],i=e.split(" ").map(t),o=0;o<i.length;o+=3)n.push({component:i[o],ip:i[o+1],port:i[o+2]});return n},e.parseImageAttributes=function(e){return e.split(" ").map(function(e){return e.substring(1,e.length-1).split(",").reduce(s,{})})},e.parseSimulcastStreamList=function(e){return e.split(";").map(function(e){return e.split(",").map(function(e){var n,i=!1;return"~"!==e[0]?n=t(e):(n=t(e.substring(1,e.length)),i=!0),{scid:n,paused:i}})})}}(Ua)),Ua}function qa(){if(Aa)return Ma;Aa=1;var e=Fa(),t=/%[sdv%]/g,n=function(e){var n=1,i=arguments,o=i.length;return e.replace(t,function(e){if(n>=o)return e;var t=i[n];switch(n+=1,e){case"%%":return"%";case"%s":return String(t);case"%d":return Number(t);case"%v":return""}})},i=function(e,t,i){var o=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var s=0;s<t.names.length;s+=1){var a=t.names[s];t.name?o.push(i[t.name][a]):o.push(i[t.names[s]])}else o.push(i[t.name]);return n.apply(null,o)},o=["v","o","s","i","u","e","p","c","b","t","r","z","a"],s=["i","c","b","a"];return Ma=function(t,n){n=n||{},null==t.version&&(t.version=0),null==t.name&&(t.name=" "),t.media.forEach(function(e){null==e.payloads&&(e.payloads="")});var a=n.outerOrder||o,r=n.innerOrder||s,c=[];return a.forEach(function(n){e[n].forEach(function(e){e.name in t&&null!=t[e.name]?c.push(i(n,e,t)):e.push in t&&null!=t[e.push]&&t[e.push].forEach(function(t){c.push(i(n,e,t))})})}),t.media.forEach(function(t){c.push(i("m",e.m[0],t)),r.forEach(function(n){e[n].forEach(function(e){e.name in t&&null!=t[e.name]?c.push(i(n,e,t)):e.push in t&&null!=t[e.push]&&t[e.push].forEach(function(t){c.push(i(n,e,t))})})})}),c.join("\r\n")+"\r\n"},Ma}var Va=function(){if(Na)return La;Na=1;var e=Ba(),t=qa(),n=Fa();return La.grammar=n,La.write=t,La.parse=e.parse,La.parseParams=e.parseParams,La.parseFmtpConfig=e.parseFmtpConfig,La.parsePayloads=e.parsePayloads,La.parseRemoteCandidates=e.parseRemoteCandidates,La.parseImageAttributes=e.parseImageAttributes,La.parseSimulcastStreamList=e.parseSimulcastStreamList,La}();function za(e,t,n){var i,o,s;void 0===t&&(t=50),void 0===n&&(n={});var a=null!=(i=n.isImmediate)&&i,r=null!=(o=n.callback)&&o,c=n.maxWait,d=Date.now(),l=[];function u(){if(void 0!==c){var e=Date.now()-d;if(e+t>=c)return c-e}return t}var h=function(){var t=[].slice.call(arguments),n=this;return new Promise(function(i,o){var c=a&&void 0===s;if(void 0!==s&&clearTimeout(s),s=setTimeout(function(){if(s=void 0,d=Date.now(),!a){var i=e.apply(n,t);r&&r(i),l.forEach(function(e){return(0,e.resolve)(i)}),l=[]}},u()),c){var h=e.apply(n,t);return r&&r(h),i(h)}l.push({resolve:i,reject:o})})};return h.cancel=function(e){void 0!==s&&clearTimeout(s),l.forEach(function(t){return(0,t.reject)(e)}),l=[]},h}const Ha="negotiationStarted",Wa="negotiationComplete",Ga="rtpVideoPayloadTypes";class Ka extends bi.EventEmitter{get pc(){return this._pc||(this._pc=this.createPC()),this._pc}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var n;super(),this.log=ci,this.ddExtID=0,this.latestOfferId=0,this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate=!1,this.trackBitrates=[],this.remoteStereoMids=[],this.remoteNackMids=[],this.negotiate=za(e=>pi(this,void 0,void 0,function*(){this.emit(Ha);try{yield this.createAndSendOffer()}catch(t){if(!e)throw t;e(t)}}),20),this.close=()=>{this._pc&&(this._pc.close(),this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.ondatachannel=null,this._pc.onnegotiationneeded=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null,this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc=null)},this.log=di(null!==(n=t.loggerName)&&void 0!==n?n:ai.PCTransport),this.loggerOptions=t,this.config=e,this._pc=this.createPC(),this.offerLock=new m}createPC(){const e=new RTCPeerConnection(this.config);return e.onicecandidate=e=>{var t;e.candidate&&(null===(t=this.onIceCandidate)||void 0===t||t.call(this,e.candidate))},e.onicecandidateerror=e=>{var t;null===(t=this.onIceCandidateError)||void 0===t||t.call(this,e)},e.oniceconnectionstatechange=()=>{var t;null===(t=this.onIceConnectionStateChange)||void 0===t||t.call(this,e.iceConnectionState)},e.onsignalingstatechange=()=>{var t;null===(t=this.onSignalingStatechange)||void 0===t||t.call(this,e.signalingState)},e.onconnectionstatechange=()=>{var t;null===(t=this.onConnectionStateChange)||void 0===t||t.call(this,e.connectionState)},e.ondatachannel=e=>{var t;null===(t=this.onDataChannel)||void 0===t||t.call(this,e)},e.ontrack=e=>{var t;null===(t=this.onTrack)||void 0===t||t.call(this,e)},e}get logContext(){var e,t;return Object.assign({},null===(t=(e=this.loggerOptions).loggerContextCb)||void 0===t?void 0:t.call(e))}get isICEConnected(){return null!==this._pc&&("connected"===this.pc.iceConnectionState||"completed"===this.pc.iceConnectionState)}addIceCandidate(e){return pi(this,void 0,void 0,function*(){if(this.pc.remoteDescription&&!this.restartingIce)return this.pc.addIceCandidate(e);this.pendingCandidates.push(e)})}setRemoteDescription(e,t){return pi(this,void 0,void 0,function*(){var n;if("answer"===e.type&&this.latestOfferId>0&&t>0&&t!==this.latestOfferId)return this.log.warn("ignoring answer for old offer",Object.assign(Object.assign({},this.logContext),{offerId:t,latestOfferId:this.latestOfferId})),!1;let i;if("offer"===e.type){let{stereoMids:t,nackMids:n}=function(e){var t;const n=[],i=[],o=Va.parse(null!==(t=e.sdp)&&void 0!==t?t:"");let s=0;return o.media.forEach(e=>{var t;const o=$a(e.mid);"audio"===e.type&&(e.rtp.some(e=>"opus"===e.codec&&(s=e.payload,!0)),(null===(t=e.rtcpFb)||void 0===t?void 0:t.some(e=>e.payload===s&&"nack"===e.type))&&i.push(o),e.fmtp.some(e=>e.payload===s&&(e.config.includes("sprop-stereo=1")&&n.push(o),!0)))}),{stereoMids:n,nackMids:i}}(e);this.remoteStereoMids=t,this.remoteNackMids=n}else if("answer"===e.type){const t=Va.parse(null!==(n=e.sdp)&&void 0!==n?n:"");t.media.forEach(e=>{const t=$a(e.mid);"audio"===e.type&&this.trackBitrates.some(n=>{if(!n.transceiver||t!=n.transceiver.mid)return!1;let i=0;if(e.rtp.some(e=>e.codec.toUpperCase()===n.codec.toUpperCase()&&(i=e.payload,!0)),0===i)return!0;let o=!1;for(const t of e.fmtp)if(t.payload===i){t.config=t.config.split(";").filter(e=>!e.includes("maxaveragebitrate")).join(";"),n.maxbr>0&&(t.config+=";maxaveragebitrate=".concat(1e3*n.maxbr)),o=!0;break}return o||n.maxbr>0&&e.fmtp.push({payload:i,config:"maxaveragebitrate=".concat(1e3*n.maxbr)}),!0})}),i=Va.write(t)}if(yield this.setMungedSDP(e,i,!0),this.pendingCandidates.forEach(e=>{this.pc.addIceCandidate(e)}),this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate)this.renegotiate=!1,yield this.createAndSendOffer();else if("answer"===e.type&&(this.emit(Wa),e.sdp)){Va.parse(e.sdp).media.forEach(e=>{"video"===e.type&&this.emit(Ga,e.rtp)})}return!0})}createAndSendOffer(e){return pi(this,void 0,void 0,function*(){var t;const n=yield this.offerLock.lock();try{if(void 0===this.onOffer)return;if((null==e?void 0:e.iceRestart)&&(this.log.debug("restarting ICE",this.logContext),this.restartingIce=!0),this._pc&&"have-local-offer"===this._pc.signalingState){const t=this._pc.remoteDescription;if(!(null==e?void 0:e.iceRestart)||!t)return void(this.renegotiate=!0);yield this._pc.setRemoteDescription(t)}else if(!this._pc||"closed"===this._pc.signalingState)return void this.log.warn("could not createOffer with closed peer connection",this.logContext);this.log.debug("starting to negotiate",this.logContext);const n=this.latestOfferId+1;this.latestOfferId=n;const i=yield this.pc.createOffer(e);this.log.debug("original offer",Object.assign({sdp:i.sdp},this.logContext));const o=Va.parse(null!==(t=i.sdp)&&void 0!==t?t:"");if(o.media.forEach(e=>{Ya(e),"audio"===e.type?Ja(e,["all"],[]):"video"===e.type&&this.trackBitrates.some(t=>{if(!e.msid||!t.cid||!e.msid.includes(t.cid))return!1;let n=0;if(e.rtp.some(e=>e.codec.toUpperCase()===t.codec.toUpperCase()&&(n=e.payload,!0)),0===n)return!0;if(Ts(t.codec)&&!Es()&&this.ensureVideoDDExtensionForSVC(e,o),"av1"!==t.codec)return!0;const i=Math.round(.7*t.maxbr);for(const t of e.fmtp)if(t.payload===n){t.config.includes("x-google-start-bitrate")||(t.config+=";x-google-start-bitrate=".concat(i));break}return!0})}),this.latestOfferId>n)return void this.log.warn("latestOfferId mismatch",Object.assign(Object.assign({},this.logContext),{latestOfferId:this.latestOfferId,offerId:n}));yield this.setMungedSDP(i,Va.write(o)),this.onOffer(i,this.latestOfferId)}finally{n()}})}createAndSetAnswer(){return pi(this,void 0,void 0,function*(){var e;const t=yield this.pc.createAnswer(),n=Va.parse(null!==(e=t.sdp)&&void 0!==e?e:"");return n.media.forEach(e=>{Ya(e),"audio"===e.type&&Ja(e,this.remoteStereoMids,this.remoteNackMids)}),yield this.setMungedSDP(t,Va.write(n)),t})}createDataChannel(e,t){return this.pc.createDataChannel(e,t)}addTransceiver(e,t){return this.pc.addTransceiver(e,t)}addTransceiverOfKind(e,t){return this.pc.addTransceiver(e,t)}addTrack(e){if(!this._pc)throw new Wo("PC closed, cannot add track");return this._pc.addTrack(e)}setTrackCodecBitrate(e){this.trackBitrates.push(e)}setConfiguration(e){var t;if(!this._pc)throw new Wo("PC closed, cannot configure");return null===(t=this._pc)||void 0===t?void 0:t.setConfiguration(e)}canRemoveTrack(){var e;return!!(null===(e=this._pc)||void 0===e?void 0:e.removeTrack)}removeTrack(e){var t;return null===(t=this._pc)||void 0===t?void 0:t.removeTrack(e)}getConnectionState(){var e,t;return null!==(t=null===(e=this._pc)||void 0===e?void 0:e.connectionState)&&void 0!==t?t:"closed"}getICEConnectionState(){var e,t;return null!==(t=null===(e=this._pc)||void 0===e?void 0:e.iceConnectionState)&&void 0!==t?t:"closed"}getSignallingState(){var e,t;return null!==(t=null===(e=this._pc)||void 0===e?void 0:e.signalingState)&&void 0!==t?t:"closed"}getTransceivers(){var e,t;return null!==(t=null===(e=this._pc)||void 0===e?void 0:e.getTransceivers())&&void 0!==t?t:[]}getSenders(){var e,t;return null!==(t=null===(e=this._pc)||void 0===e?void 0:e.getSenders())&&void 0!==t?t:[]}getLocalDescription(){var e;return null===(e=this._pc)||void 0===e?void 0:e.localDescription}getRemoteDescription(){var e;return null===(e=this.pc)||void 0===e?void 0:e.remoteDescription}getStats(){return this.pc.getStats()}getConnectedAddress(){return pi(this,void 0,void 0,function*(){var e;if(!this._pc)return;let t="";const n=new Map,i=new Map;if((yield this._pc.getStats()).forEach(e=>{switch(e.type){case"transport":t=e.selectedCandidatePairId;break;case"candidate-pair":""===t&&e.selected&&(t=e.id),n.set(e.id,e);break;case"remote-candidate":i.set(e.id,"".concat(e.address,":").concat(e.port))}}),""===t)return;const o=null===(e=n.get(t))||void 0===e?void 0:e.remoteCandidateId;return void 0!==o?i.get(o):void 0})}setMungedSDP(e,t,n){return pi(this,void 0,void 0,function*(){if(t){const i=e.sdp;e.sdp=t;try{return this.log.debug("setting munged ".concat(n?"remote":"local"," description"),this.logContext),void(n?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e))}catch(n){this.log.warn("not able to set ".concat(e.type,", falling back to unmodified sdp"),Object.assign(Object.assign({},this.logContext),{error:n,sdp:t})),e.sdp=i}}try{n?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e)}catch(t){let i="unknown error";t instanceof Error?i=t.message:"string"==typeof t&&(i=t);const o={error:i,sdp:e.sdp};throw!n&&this.pc.remoteDescription&&(o.remoteSdp=this.pc.remoteDescription),this.log.error("unable to set ".concat(e.type),Object.assign(Object.assign({},this.logContext),{fields:o})),new Go(i)}})}ensureVideoDDExtensionForSVC(e,t){var n,i;if(!(null===(n=e.ext)||void 0===n?void 0:n.some(e=>e.uri===vs))){if(0===this.ddExtID){let e=0;t.media.forEach(t=>{var n;"video"===t.type&&(null===(n=t.ext)||void 0===n||n.forEach(t=>{t.value>e&&(e=t.value)}))}),this.ddExtID=e+1}null===(i=e.ext)||void 0===i||i.push({value:this.ddExtID,uri:vs})}}}function Ja(e,t,n){const i=$a(e.mid);let o=0;e.rtp.some(e=>"opus"===e.codec&&(o=e.payload,!0)),o>0&&(e.rtcpFb||(e.rtcpFb=[]),n.includes(i)&&!e.rtcpFb.some(e=>e.payload===o&&"nack"===e.type)&&e.rtcpFb.push({payload:o,type:"nack"}),(t.includes(i)||1===t.length&&"all"===t[0])&&e.fmtp.some(e=>e.payload===o&&(e.config.includes("stereo=1")||(e.config+=";stereo=1"),!0)))}function Ya(e){if(e.connection){const t=e.connection.ip.indexOf(":")>=0;(4===e.connection.version&&t||6===e.connection.version&&!t)&&(e.connection.ip="0.0.0.0",e.connection.version=4)}}function $a(e){return"number"==typeof e?e.toFixed(0):e}const Qa="vp8",Xa={audioPreset:ps.music,dtx:!0,red:!0,forceStereo:!1,simulcast:!0,screenShareEncoding:fs.h1080fps15.encoding,stopMicTrackOnMute:!1,videoCodec:Qa,backupCodec:!0,preConnectBuffer:!1},Za={deviceId:{ideal:"default"},autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,voiceIsolation:!0},er={deviceId:{ideal:"default"},resolution:ms.h720.resolution},tr={adaptiveStream:!1,dynacast:!1,stopLocalTrackOnUnpublish:!0,reconnectPolicy:new class{constructor(e){this._retryDelays=void 0!==e?[...e]:hi}nextRetryDelayInMs(e){if(e.retryCount>=this._retryDelays.length)return null;const t=this._retryDelays[e.retryCount];return e.retryCount<=1?t:t+1e3*Math.random()}},disconnectOnPageLeave:!0,webAudioMix:!1,singlePeerConnection:!1},nr={autoSubscribe:!0,maxRetries:1,peerConnectionTimeout:15e3,websocketTimeout:15e3};var ir;!function(e){e[e.NEW=0]="NEW",e[e.CONNECTING=1]="CONNECTING",e[e.CONNECTED=2]="CONNECTED",e[e.FAILED=3]="FAILED",e[e.CLOSING=4]="CLOSING",e[e.CLOSED=5]="CLOSED"}(ir||(ir={}));class or{get needsPublisher(){return this.isPublisherConnectionRequired}get needsSubscriber(){return this.isSubscriberConnectionRequired}get currentState(){return this.state}constructor(e,t,n){var i;this.peerConnectionTimeout=nr.peerConnectionTimeout,this.log=ci,this.updateState=()=>{var e,t;const n=this.state,i=this.requiredTransports.map(e=>e.getConnectionState());i.every(e=>"connected"===e)?this.state=ir.CONNECTED:i.some(e=>"failed"===e)?this.state=ir.FAILED:i.some(e=>"connecting"===e)?this.state=ir.CONNECTING:i.every(e=>"closed"===e)?this.state=ir.CLOSED:i.some(e=>"closed"===e)?this.state=ir.CLOSING:i.every(e=>"new"===e)&&(this.state=ir.NEW),n!==this.state&&(this.log.debug("pc state change: from ".concat(ir[n]," to ").concat(ir[this.state]),this.logContext),null===(e=this.onStateChange)||void 0===e||e.call(this,this.state,this.publisher.getConnectionState(),null===(t=this.subscriber)||void 0===t?void 0:t.getConnectionState()))},this.log=di(null!==(i=n.loggerName)&&void 0!==i?i:ai.PCManager),this.loggerOptions=n,this.isPublisherConnectionRequired="subscriber-primary"!==t,this.isSubscriberConnectionRequired="subscriber-primary"===t,this.publisher=new Ka(e,n),"publisher-only"!==t&&(this.subscriber=new Ka(e,n),this.subscriber.onConnectionStateChange=this.updateState,this.subscriber.onIceConnectionStateChange=this.updateState,this.subscriber.onSignalingStatechange=this.updateState,this.subscriber.onIceCandidate=e=>{var t;null===(t=this.onIceCandidate)||void 0===t||t.call(this,e,Qt.SUBSCRIBER)},this.subscriber.onDataChannel=e=>{var t;null===(t=this.onDataChannel)||void 0===t||t.call(this,e)},this.subscriber.onTrack=e=>{var t;null===(t=this.onTrack)||void 0===t||t.call(this,e)}),this.publisher.onConnectionStateChange=this.updateState,this.publisher.onIceConnectionStateChange=this.updateState,this.publisher.onSignalingStatechange=this.updateState,this.publisher.onIceCandidate=e=>{var t;null===(t=this.onIceCandidate)||void 0===t||t.call(this,e,Qt.PUBLISHER)},this.publisher.onTrack=e=>{var t;null===(t=this.onTrack)||void 0===t||t.call(this,e)},this.publisher.onOffer=(e,t)=>{var n;null===(n=this.onPublisherOffer)||void 0===n||n.call(this,e,t)},this.state=ir.NEW,this.connectionLock=new m,this.remoteOfferLock=new m}get logContext(){var e,t;return Object.assign({},null===(t=(e=this.loggerOptions).loggerContextCb)||void 0===t?void 0:t.call(e))}requirePublisher(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.isPublisherConnectionRequired=e,this.updateState()}createAndSendPublisherOffer(e){return this.publisher.createAndSendOffer(e)}setPublisherAnswer(e,t){return this.publisher.setRemoteDescription(e,t)}removeTrack(e){return this.publisher.removeTrack(e)}close(){return pi(this,void 0,void 0,function*(){var e;if(this.publisher&&"closed"!==this.publisher.getSignallingState()){const e=this.publisher;for(const t of e.getSenders())try{e.canRemoveTrack()&&e.removeTrack(t)}catch(e){this.log.warn("could not removeTrack",Object.assign(Object.assign({},this.logContext),{error:e}))}}yield Promise.all([this.publisher.close(),null===(e=this.subscriber)||void 0===e?void 0:e.close()]),this.updateState()})}triggerIceRestart(){return pi(this,void 0,void 0,function*(){this.subscriber&&(this.subscriber.restartingIce=!0),this.needsPublisher&&(yield this.createAndSendPublisherOffer({iceRestart:!0}))})}addIceCandidate(e,t){return pi(this,void 0,void 0,function*(){var n;t===Qt.PUBLISHER?yield this.publisher.addIceCandidate(e):yield null===(n=this.subscriber)||void 0===n?void 0:n.addIceCandidate(e)})}createSubscriberAnswerFromOffer(e,t){return pi(this,void 0,void 0,function*(){var n,i,o;this.log.debug("received server offer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type,sdp:e.sdp,signalingState:null===(n=this.subscriber)||void 0===n?void 0:n.getSignallingState().toString()}));const s=yield this.remoteOfferLock.lock();try{if(!(yield null===(i=this.subscriber)||void 0===i?void 0:i.setRemoteDescription(e,t)))return;return yield null===(o=this.subscriber)||void 0===o?void 0:o.createAndSetAnswer()}finally{s()}})}updateConfiguration(e,t){var n;this.publisher.setConfiguration(e),null===(n=this.subscriber)||void 0===n||n.setConfiguration(e),t&&this.triggerIceRestart()}ensurePCTransportConnection(e,t){return pi(this,void 0,void 0,function*(){var n;const i=yield this.connectionLock.lock();try{this.isPublisherConnectionRequired&&"connected"!==this.publisher.getConnectionState()&&"connecting"!==this.publisher.getConnectionState()&&(this.log.debug("negotiation required, start negotiating",this.logContext),this.publisher.negotiate()),yield Promise.all(null===(n=this.requiredTransports)||void 0===n?void 0:n.map(n=>this.ensureTransportConnected(n,e,t)))}finally{i()}})}negotiate(e){return pi(this,void 0,void 0,function*(){return new Promise((t,n)=>pi(this,void 0,void 0,function*(){const i=setTimeout(()=>{n("negotiation timed out")},this.peerConnectionTimeout);e.signal.addEventListener("abort",()=>{clearTimeout(i),n("negotiation aborted")}),this.publisher.once(Ha,()=>{e.signal.aborted||this.publisher.once(Wa,()=>{clearTimeout(i),t()})}),yield this.publisher.negotiate(e=>{clearTimeout(i),n(e)})}))})}addPublisherTransceiver(e,t){return this.publisher.addTransceiver(e,t)}addPublisherTransceiverOfKind(e,t){return this.publisher.addTransceiverOfKind(e,t)}getMidForReceiver(e){const t=(this.subscriber?this.subscriber.getTransceivers():this.publisher.getTransceivers()).find(t=>t.receiver===e);return null==t?void 0:t.mid}addPublisherTrack(e){return this.publisher.addTrack(e)}createPublisherDataChannel(e,t){return this.publisher.createDataChannel(e,t)}getConnectedAddress(e){return e===Qt.PUBLISHER||e===Qt.SUBSCRIBER?this.publisher.getConnectedAddress():this.requiredTransports[0].getConnectedAddress()}get requiredTransports(){const e=[];return this.isPublisherConnectionRequired&&e.push(this.publisher),this.isSubscriberConnectionRequired&&this.subscriber&&e.push(this.subscriber),e}ensureTransportConnected(e,t){return pi(this,arguments,void 0,function(e,t){var n=this;let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.peerConnectionTimeout;return function*(){if("connected"!==e.getConnectionState())return new Promise((e,o)=>pi(n,void 0,void 0,function*(){const n=()=>{this.log.warn("abort transport connection",this.logContext),ns.clearTimeout(s),o(new qo("room connection has been cancelled",Oo.Cancelled))};(null==t?void 0:t.signal.aborted)&&n(),null==t||t.signal.addEventListener("abort",n);const s=ns.setTimeout(()=>{null==t||t.signal.removeEventListener("abort",n),o(new qo("could not establish pc connection",Oo.InternalError))},i);for(;this.state!==ir.CONNECTED;)if(yield bs(50),null==t?void 0:t.signal.aborted)return void o(new qo("room connection has been cancelled",Oo.Cancelled));ns.clearTimeout(s),null==t||t.signal.removeEventListener("abort",n),e()}))}()})}}class sr extends Error{constructor(e,t,n){super(t),this.code=e,this.message=rr(t,sr.MAX_MESSAGE_BYTES),this.data=n?rr(n,sr.MAX_DATA_BYTES):void 0}static fromProto(e){return new sr(e.code,e.message,e.data)}toProto(){return new At({code:this.code,message:this.message,data:this.data})}static builtIn(e,t){return new sr(sr.ErrorCode[e],sr.ErrorMessage[e],t)}}sr.MAX_MESSAGE_BYTES=256,sr.MAX_DATA_BYTES=15360,sr.ErrorCode={APPLICATION_ERROR:1500,CONNECTION_TIMEOUT:1501,RESPONSE_TIMEOUT:1502,RECIPIENT_DISCONNECTED:1503,RESPONSE_PAYLOAD_TOO_LARGE:1504,SEND_FAILED:1505,UNSUPPORTED_METHOD:1400,RECIPIENT_NOT_FOUND:1401,REQUEST_PAYLOAD_TOO_LARGE:1402,UNSUPPORTED_SERVER:1403,UNSUPPORTED_VERSION:1404},sr.ErrorMessage={APPLICATION_ERROR:"Application error in method handler",CONNECTION_TIMEOUT:"Connection timeout",RESPONSE_TIMEOUT:"Response timeout",RECIPIENT_DISCONNECTED:"Recipient disconnected",RESPONSE_PAYLOAD_TOO_LARGE:"Response payload too large",SEND_FAILED:"Failed to send",UNSUPPORTED_METHOD:"Method not supported at destination",RECIPIENT_NOT_FOUND:"Recipient not found",REQUEST_PAYLOAD_TOO_LARGE:"Request payload too large",UNSUPPORTED_SERVER:"RPC not supported by server",UNSUPPORTED_VERSION:"Unsupported RPC version"};function ar(e){return(new TextEncoder).encode(e).length}function rr(e,t){if(ar(e)<=t)return e;let n=0,i=e.length;const o=new TextEncoder;for(;n<i;){const s=Math.floor((n+i+1)/2);o.encode(e.slice(0,s)).length<=t?n=s:i=s-1}return e.slice(0,n)}const cr=2e3;function dr(e,t){if(!t)return 0;let n,i;return"bytesReceived"in e?(n=e.bytesReceived,i=t.bytesReceived):"bytesSent"in e&&(n=e.bytesSent,i=t.bytesSent),void 0===n||void 0===i||void 0===e.timestamp||void 0===t.timestamp?0:8*(n-i)*1e3/(e.timestamp-t.timestamp)}const lr="undefined"!=typeof MediaRecorder;const ur=lr?MediaRecorder:class{constructor(){throw new Error("MediaRecorder is not available in this environment")}};class hr extends ur{constructor(e,t){if(!lr)throw new Error("MediaRecorder is not available in this environment");let n,i;super(new MediaStream([e.mediaStreamTrack]),t);const o=()=>{this.removeEventListener("dataavailable",n),this.removeEventListener("stop",o),this.removeEventListener("error",s),null==i||i.close(),i=void 0},s=e=>{null==i||i.error(e),this.removeEventListener("dataavailable",n),this.removeEventListener("stop",o),this.removeEventListener("error",s),i=void 0};this.byteStream=new ReadableStream({start:e=>{i=e,n=t=>pi(this,void 0,void 0,function*(){let n;if(t.data.arrayBuffer){const e=yield t.data.arrayBuffer();n=new Uint8Array(e)}else{if(!t.data.byteArray)throw new Error("no data available!");n=t.data.byteArray}void 0!==i&&e.enqueue(n)}),this.addEventListener("dataavailable",n)},cancel:()=>{o()}}),this.addEventListener("stop",o),this.addEventListener("error",s)}}class pr extends ss{get sender(){return this._sender}set sender(e){this._sender=e}get constraints(){return this._constraints}get hasPreConnectBuffer(){return!!this.localTrackRecorder}constructor(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];super(e,t,arguments.length>4?arguments[4]:void 0),this.manuallyStopped=!1,this._isUpstreamPaused=!1,this.handleTrackMuteEvent=()=>this.debouncedTrackMuteHandler().catch(()=>this.log.debug("track mute bounce got cancelled by an unmute event",this.logContext)),this.debouncedTrackMuteHandler=za(()=>pi(this,void 0,void 0,function*(){yield this.pauseUpstream()}),5e3),this.handleTrackUnmuteEvent=()=>pi(this,void 0,void 0,function*(){this.debouncedTrackMuteHandler.cancel("unmute"),yield this.resumeUpstream()}),this.handleEnded=()=>{this.isInBackground&&(this.reacquireTrack=!0),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),this.emit(Uo.Ended,this)},this.reacquireTrack=!1,this.providedByUser=i,this.muteLock=new m,this.pauseUpstreamLock=new m,this.trackChangeLock=new m,this.trackChangeLock.lock().then(t=>pi(this,void 0,void 0,function*(){try{yield this.setMediaStreamTrack(e,!0)}finally{t()}})),this._constraints=e.getConstraints(),n&&(this._constraints=n)}get id(){return this._mediaStreamTrack.id}get dimensions(){if(this.kind!==ss.Kind.Video)return;const{width:e,height:t}=this._mediaStreamTrack.getSettings();return e&&t?{width:e,height:t}:void 0}get isUpstreamPaused(){return this._isUpstreamPaused}get isUserProvided(){return this.providedByUser}get mediaStreamTrack(){var e,t;return null!==(t=null===(e=this.processor)||void 0===e?void 0:e.processedTrack)&&void 0!==t?t:this._mediaStreamTrack}get isLocal(){return!0}getSourceTrackSettings(){return this._mediaStreamTrack.getSettings()}setMediaStreamTrack(e,t){return pi(this,void 0,void 0,function*(){var n;if(e===this._mediaStreamTrack&&!t)return;let i;if(this._mediaStreamTrack&&(this.attachedElements.forEach(e=>{rs(this._mediaStreamTrack,e)}),this.debouncedTrackMuteHandler.cancel("new-track"),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent)),this.mediaStream=new MediaStream([e]),e&&(e.addEventListener("ended",this.handleEnded),e.addEventListener("mute",this.handleTrackMuteEvent),e.addEventListener("unmute",this.handleTrackUnmuteEvent),this._constraints=e.getConstraints()),this.processor&&e){if(this.log.debug("restarting processor",this.logContext),"unknown"===this.kind)throw TypeError("cannot set processor on track of unknown kind");this.processorElement&&(as(e,this.processorElement),this.processorElement.muted=!0),yield this.processor.restart({track:e,kind:this.kind,element:this.processorElement}),i=this.processor.processedTrack}this.sender&&"closed"!==(null===(n=this.sender.transport)||void 0===n?void 0:n.state)&&(yield this.sender.replaceTrack(null!=i?i:e)),this.providedByUser||this._mediaStreamTrack===e||this._mediaStreamTrack.stop(),this._mediaStreamTrack=e,e&&(this._mediaStreamTrack.enabled=!this.isMuted,yield this.resumeUpstream(),this.attachedElements.forEach(t=>{as(null!=i?i:e,t)}))})}waitForDimensions(){return pi(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;return function*(){var n;if(e.kind===ss.Kind.Audio)throw new Error("cannot get dimensions for audio tracks");"iOS"===(null===(n=Xo())||void 0===n?void 0:n.os)&&(yield bs(10));const i=Date.now();for(;Date.now()-i<t;){const t=e.dimensions;if(t)return t;yield bs(50)}throw new zo("unable to get track dimensions after timeout")}()})}setDeviceId(e){return pi(this,void 0,void 0,function*(){return this._constraints.deviceId===e&&this._mediaStreamTrack.getSettings().deviceId===Ws(e)||(this._constraints.deviceId=e,!!this.isMuted||(yield this.restartTrack(),Ws(e)===this._mediaStreamTrack.getSettings().deviceId))})}getDeviceId(){return pi(this,arguments,void 0,function(){var e=this;let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return function*(){if(e.source===ss.Source.ScreenShare)return;const{deviceId:n,groupId:i}=e._mediaStreamTrack.getSettings(),o=e.kind===ss.Kind.Audio?"audioinput":"videoinput";return t?ba.getInstance().normalizeDeviceId(o,n,i):n}()})}mute(){return pi(this,void 0,void 0,function*(){return this.setTrackMuted(!0),this})}unmute(){return pi(this,void 0,void 0,function*(){return this.setTrackMuted(!1),this})}replaceTrack(e,t){return pi(this,void 0,void 0,function*(){const n=yield this.trackChangeLock.lock();try{if(!this.sender)throw new zo("unable to replace an unpublished track");let n,i;return"boolean"==typeof t?n=t:void 0!==t&&(n=t.userProvidedTrack,i=t.stopProcessor),this.providedByUser=null==n||n,this.log.debug("replace MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(e),i&&this.processor&&(yield this.internalStopProcessor()),this}finally{n()}})}restart(e){return pi(this,void 0,void 0,function*(){this.manuallyStopped=!1;const t=yield this.trackChangeLock.lock();try{e||(e=this._constraints);const{deviceId:t,facingMode:n}=e,i=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(i=Object.getOwnPropertySymbols(e);o<i.length;o++)t.indexOf(i[o])<0&&Object.prototype.propertyIsEnumerable.call(e,i[o])&&(n[i[o]]=e[i[o]])}return n}(e,["deviceId","facingMode"]);this.log.debug("restarting track with constraints",Object.assign(Object.assign({},this.logContext),{constraints:e}));const o={audio:!1,video:!1};this.kind===ss.Kind.Video?o.video=!t&&!n||{deviceId:t,facingMode:n}:o.audio=!t||Object.assign({deviceId:t},i),this.attachedElements.forEach(e=>{rs(this.mediaStreamTrack,e)}),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.stop();const s=(yield navigator.mediaDevices.getUserMedia(o)).getTracks()[0];return this.kind===ss.Kind.Video&&(yield s.applyConstraints(i)),s.addEventListener("ended",this.handleEnded),this.log.debug("re-acquired MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(s),this._constraints=e,this.emit(Uo.Restarted,this),this.manuallyStopped&&(this.log.warn("track was stopped during a restart, stopping restarted track",this.logContext),this.stop()),this}finally{t()}})}setTrackMuted(e){this.log.debug("setting ".concat(this.kind," track ").concat(e?"muted":"unmuted"),this.logContext),this.isMuted===e&&this._mediaStreamTrack.enabled!==e||(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?Uo.Muted:Uo.Unmuted,this))}get needsReAcquisition(){return"live"!==this._mediaStreamTrack.readyState||this._mediaStreamTrack.muted||!this._mediaStreamTrack.enabled||this.reacquireTrack}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return pi(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),Ps()&&(this.log.debug("visibility changed, is in Background: ".concat(this.isInBackground),this.logContext),this.isInBackground||!this.needsReAcquisition||this.isUserProvided||this.isMuted||(this.log.debug("track needs to be reacquired, restarting ".concat(this.source),this.logContext),yield this.restart(),this.reacquireTrack=!1))})}stop(){var e;this.manuallyStopped=!0,super.stop(),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),null===(e=this.processor)||void 0===e||e.destroy(),this.processor=void 0}pauseUpstream(){return pi(this,void 0,void 0,function*(){var e;const t=yield this.pauseUpstreamLock.lock();try{if(!0===this._isUpstreamPaused)return;if(!this.sender)return void this.log.warn("unable to pause upstream for an unpublished track",this.logContext);this._isUpstreamPaused=!0,this.emit(Uo.UpstreamPaused,this);const t=Xo();if("Safari"===(null==t?void 0:t.name)&&As(t.version,"12.0")<0)throw new Vo("pauseUpstream is not supported on Safari < 12.");"closed"!==(null===(e=this.sender.transport)||void 0===e?void 0:e.state)&&(yield this.sender.replaceTrack(null))}finally{t()}})}resumeUpstream(){return pi(this,void 0,void 0,function*(){var e;const t=yield this.pauseUpstreamLock.lock();try{if(!1===this._isUpstreamPaused)return;if(!this.sender)return void this.log.warn("unable to resume upstream for an unpublished track",this.logContext);this._isUpstreamPaused=!1,this.emit(Uo.UpstreamResumed,this),"closed"!==(null===(e=this.sender.transport)||void 0===e?void 0:e.state)&&(yield this.sender.replaceTrack(this.mediaStreamTrack))}finally{t()}})}getRTCStatsReport(){return pi(this,void 0,void 0,function*(){var e;if(!(null===(e=this.sender)||void 0===e?void 0:e.getStats))return;return yield this.sender.getStats()})}setProcessor(e){return pi(this,arguments,void 0,function(e){var t=this;let n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return function*(){var i;const o=yield t.trackChangeLock.lock();try{t.log.debug("setting up processor",t.logContext);const o=document.createElement(t.kind),s={kind:t.kind,track:t._mediaStreamTrack,element:o,audioContext:t.audioContext};if(yield e.init(s),t.log.debug("processor initialized",t.logContext),t.processor&&(yield t.internalStopProcessor()),"unknown"===t.kind)throw TypeError("cannot set processor on track of unknown kind");if(as(t._mediaStreamTrack,o),o.muted=!0,o.play().catch(e=>{e instanceof DOMException&&"AbortError"===e.name?(t.log.warn("failed to play processor element, retrying",Object.assign(Object.assign({},t.logContext),{error:e})),setTimeout(()=>{o.play().catch(e=>{t.log.error("failed to play processor element",Object.assign(Object.assign({},t.logContext),{err:e}))})},100)):t.log.error("failed to play processor element",Object.assign(Object.assign({},t.logContext),{error:e}))}),t.processor=e,t.processorElement=o,t.processor.processedTrack){for(const e of t.attachedElements)e!==t.processorElement&&n&&(rs(t._mediaStreamTrack,e),as(t.processor.processedTrack,e));yield null===(i=t.sender)||void 0===i?void 0:i.replaceTrack(t.processor.processedTrack)}t.emit(Uo.TrackProcessorUpdate,t.processor)}finally{o()}}()})}getProcessor(){return this.processor}stopProcessor(){return pi(this,arguments,void 0,function(){var e=this;let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return function*(){const n=yield e.trackChangeLock.lock();try{yield e.internalStopProcessor(t)}finally{n()}}()})}internalStopProcessor(){return pi(this,arguments,void 0,function(){var e=this;let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return function*(){var n,i;e.processor&&(e.log.debug("stopping processor",e.logContext),null===(n=e.processor.processedTrack)||void 0===n||n.stop(),yield e.processor.destroy(),e.processor=void 0,t||(null===(i=e.processorElement)||void 0===i||i.remove(),e.processorElement=void 0),yield e._mediaStreamTrack.applyConstraints(e._constraints),yield e.setMediaStreamTrack(e._mediaStreamTrack,!0),e.emit(Uo.TrackProcessorUpdate))}()})}startPreConnectBuffer(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100;if(lr)if(this.localTrackRecorder)this.log.warn("preconnect buffer already started");else{{let e="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(e)||(e="video/mp4"),this.localTrackRecorder=new hr(this,{mimeType:e})}this.localTrackRecorder.start(e),this.autoStopPreConnectBuffer=setTimeout(()=>{this.log.warn("preconnect buffer timed out, stopping recording automatically",this.logContext),this.stopPreConnectBuffer()},1e4)}else this.log.warn("MediaRecorder is not available, cannot start preconnect buffer",this.logContext)}stopPreConnectBuffer(){clearTimeout(this.autoStopPreConnectBuffer),this.localTrackRecorder&&(this.localTrackRecorder.stop(),this.localTrackRecorder=void 0)}getPreConnectBuffer(){var e;return null===(e=this.localTrackRecorder)||void 0===e?void 0:e.byteStream}getPreConnectBufferMimeType(){var e;return null===(e=this.localTrackRecorder)||void 0===e?void 0:e.mimeType}}class mr extends pr{get enhancedNoiseCancellation(){return this.isKrispNoiseFilterEnabled}constructor(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0;super(e,ss.Kind.Audio,t,n,o),this.stopOnMute=!1,this.isKrispNoiseFilterEnabled=!1,this.monitorSender=()=>pi(this,void 0,void 0,function*(){if(!this.sender)return void(this._currentBitrate=0);let e;try{e=yield this.getSenderStats()}catch(e){return void this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:e}))}e&&this.prevStats&&(this._currentBitrate=dr(e,this.prevStats)),this.prevStats=e}),this.handleKrispNoiseFilterEnable=()=>{this.isKrispNoiseFilterEnabled=!0,this.log.debug("Krisp noise filter enabled",this.logContext),this.emit(Uo.AudioTrackFeatureUpdate,this,rt.TF_ENHANCED_NOISE_CANCELLATION,!0)},this.handleKrispNoiseFilterDisable=()=>{this.isKrispNoiseFilterEnabled=!1,this.log.debug("Krisp noise filter disabled",this.logContext),this.emit(Uo.AudioTrackFeatureUpdate,this,rt.TF_ENHANCED_NOISE_CANCELLATION,!1)},this.audioContext=i,this.checkForSilence()}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return pi(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===ss.Source.Microphone&&this.stopOnMute&&!this.isUserProvided&&(this.log.debug("stopping mic track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{t()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return pi(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{if(!this.isMuted)return this.log.debug("Track already unmuted",this.logContext),this;const t=this._constraints.deviceId&&this._mediaStreamTrack.getSettings().deviceId!==Ws(this._constraints.deviceId);return this.source!==ss.Source.Microphone||!this.stopOnMute&&"ended"!==this._mediaStreamTrack.readyState&&!t||this.isUserProvided||(this.log.debug("reacquiring mic track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this}finally{t()}})}restartTrack(e){return pi(this,void 0,void 0,function*(){let t;if(e){const n=aa({audio:e});"boolean"!=typeof n.audio&&(t=n.audio)}yield this.restart(t)})}restart(e){const t=Object.create(null,{restart:{get:()=>super.restart}});return pi(this,void 0,void 0,function*(){const n=yield t.restart.call(this,e);return this.checkForSilence(),n})}startMonitor(){Rs()&&(this.monitorInterval||(this.monitorInterval=setInterval(()=>{this.monitorSender()},cr)))}setProcessor(e){return pi(this,void 0,void 0,function*(){var t;const n=yield this.trackChangeLock.lock();try{if(!Is()&&!this.audioContext)throw Error("Audio context needs to be set on LocalAudioTrack in order to enable processors");this.processor&&(yield this.internalStopProcessor());const n={kind:this.kind,track:this._mediaStreamTrack,audioContext:this.audioContext};this.log.debug("setting up audio processor ".concat(e.name),this.logContext),yield e.init(n),this.processor=e,this.processor.processedTrack&&(yield null===(t=this.sender)||void 0===t?void 0:t.replaceTrack(this.processor.processedTrack),this.processor.processedTrack.addEventListener("enable-lk-krisp-noise-filter",this.handleKrispNoiseFilterEnable),this.processor.processedTrack.addEventListener("disable-lk-krisp-noise-filter",this.handleKrispNoiseFilterDisable)),this.emit(Uo.TrackProcessorUpdate,this.processor)}finally{n()}})}setAudioContext(e){this.audioContext=e}getSenderStats(){return pi(this,void 0,void 0,function*(){var e;if(!(null===(e=this.sender)||void 0===e?void 0:e.getStats))return;let t;return(yield this.sender.getStats()).forEach(e=>{"outbound-rtp"===e.type&&(t={type:"audio",streamId:e.id,packetsSent:e.packetsSent,packetsLost:e.packetsLost,bytesSent:e.bytesSent,timestamp:e.timestamp,roundTripTime:e.roundTripTime,jitter:e.jitter})}),t})}checkForSilence(){return pi(this,void 0,void 0,function*(){const e=yield ra(this);return e&&(this.isMuted||this.log.debug("silence detected on local audio track",this.logContext),this.emit(Uo.AudioSilenceDetected)),e})}}const gr=Object.values(ms),fr=Object.values(gs),vr=Object.values(fs),br=[ms.h180,ms.h360],yr=[gs.h180,gs.h360],kr=["q","h","f"];function Tr(e,t,n,i){var o,s;let a=null==i?void 0:i.videoEncoding;e&&(a=null==i?void 0:i.screenShareEncoding);const r=null==i?void 0:i.simulcast,c=null==i?void 0:i.scalabilityMode,d=null==i?void 0:i.videoCodec;if(!a&&!r&&!c||!t||!n)return[{}];a||(a=function(e,t,n,i){const o=function(e,t,n){if(e)return vr;const i=t>n?t/n:n/t;if(Math.abs(i-16/9)<Math.abs(i-4/3))return gr;return fr}(e,t,n);let{encoding:s}=o[0];const a=Math.max(t,n);for(let e=0;e<o.length;e+=1){const t=o[e];if(s=t.encoding,t.width>=a)break}if(i)switch(i){case"av1":case"h265":s=Object.assign({},s),s.maxBitrate=.7*s.maxBitrate;break;case"vp9":s=Object.assign({},s),s.maxBitrate=.85*s.maxBitrate}return s}(e,t,n,d),ci.debug("using video encoding",a));const l=a.maxFramerate,u=new cs(t,n,a.maxBitrate,a.maxFramerate,a.priority);if(c&&Ts(d)){const e=new Er(c),t=[];if(e.spatial>3)throw new Error("unsupported scalabilityMode: ".concat(c));const n=Xo();if(xs()||Is()||"Chrome"===(null==n?void 0:n.name)&&As(null==n?void 0:n.version,"113")<0){const i="h"==e.suffix?2:3,o=function(e){return e||(e=Xo()),"Safari"===(null==e?void 0:e.name)&&As(e.version,"18.3")>0||"iOS"===(null==e?void 0:e.os)&&!!(null==e?void 0:e.osVersion)&&As(e.osVersion,"18.3")>0}(n);for(let n=0;n<e.spatial;n+=1)t.push({rid:kr[2-n],maxBitrate:a.maxBitrate/Math.pow(i,n),maxFramerate:u.encoding.maxFramerate,scaleResolutionDownBy:o?Math.pow(2,n):void 0});t[0].scalabilityMode=c}else t.push({maxBitrate:a.maxBitrate,maxFramerate:u.encoding.maxFramerate,scalabilityMode:c});return u.encoding.priority&&(t[0].priority=u.encoding.priority,t[0].networkPriority=u.encoding.priority),ci.debug("using svc encoding",{encodings:t}),t}if(!r)return[a];let h,p=[];if(p=e?null!==(o=wr(null==i?void 0:i.screenShareSimulcastLayers))&&void 0!==o?o:Cr(e,u):null!==(s=wr(null==i?void 0:i.videoSimulcastLayers))&&void 0!==s?s:Cr(e,u),p.length>0){const e=p[0];p.length>1&&([,h]=p);const i=Math.max(t,n);if(i>=960&&h)return Sr(t,n,[e,h,u],l);if(i>=480)return Sr(t,n,[e,u],l)}return Sr(t,n,[u])}function Cr(e,t){if(e)return[{scaleResolutionDownBy:2,fps:(n=t).encoding.maxFramerate}].map(e=>{var t,i;return new cs(Math.floor(n.width/e.scaleResolutionDownBy),Math.floor(n.height/e.scaleResolutionDownBy),Math.max(15e4,Math.floor(n.encoding.maxBitrate/(Math.pow(e.scaleResolutionDownBy,2)*((null!==(t=n.encoding.maxFramerate)&&void 0!==t?t:30)/(null!==(i=e.fps)&&void 0!==i?i:30))))),e.fps,n.encoding.priority)});var n;const{width:i,height:o}=t,s=i>o?i/o:o/i;return Math.abs(s-16/9)<Math.abs(s-4/3)?br:yr}function Sr(e,t,n,i){const o=[];if(n.forEach((n,s)=>{if(s>=kr.length)return;const a=Math.min(e,t),r={rid:kr[s],scaleResolutionDownBy:Math.max(1,a/Math.min(n.width,n.height)),maxBitrate:n.encoding.maxBitrate},c=i&&n.encoding.maxFramerate?Math.min(i,n.encoding.maxFramerate):n.encoding.maxFramerate;c&&(r.maxFramerate=c);const d=Ss()||0===s;n.encoding.priority&&d&&(r.priority=n.encoding.priority,r.networkPriority=n.encoding.priority),o.push(r)}),Is()&&"ios"===Ds()){let e;o.forEach(t=>{e?t.maxFramerate&&t.maxFramerate>e&&(e=t.maxFramerate):e=t.maxFramerate});let t=!0;o.forEach(n=>{var i;n.maxFramerate!=e&&(t&&(t=!1,ci.info("Simulcast on iOS React-Native requires all encodings to share the same framerate.")),ci.info('Setting framerate of encoding "'.concat(null!==(i=n.rid)&&void 0!==i?i:"",'" to ').concat(e)),n.maxFramerate=e)})}return o}function wr(e){if(e)return e.sort((e,t)=>{const{encoding:n}=e,{encoding:i}=t;return n.maxBitrate>i.maxBitrate?1:n.maxBitrate<i.maxBitrate?-1:n.maxBitrate===i.maxBitrate&&n.maxFramerate&&i.maxFramerate?n.maxFramerate>i.maxFramerate?1:-1:0})}class Er{constructor(e){const t=e.match(/^L(\d)T(\d)(h|_KEY|_KEY_SHIFT){0,1}$/);if(!t)throw new Error("invalid scalability mode");if(this.spatial=parseInt(t[1]),this.temporal=parseInt(t[2]),t.length>3)switch(t[3]){case"h":case"_KEY":case"_KEY_SHIFT":this.suffix=t[3]}}toString(){var e;return"L".concat(this.spatial,"T").concat(this.temporal).concat(null!==(e=this.suffix)&&void 0!==e?e:"")}}class xr extends pr{get sender(){return this._sender}set sender(e){this._sender=e,this.degradationPreference&&this.setDegradationPreference(this.degradationPreference)}constructor(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3?arguments[3]:void 0;super(e,ss.Kind.Video,t,n,i),this.simulcastCodecs=new Map,this.degradationPreference="balanced",this.isCpuConstrained=!1,this.optimizeForPerformance=!1,this.monitorSender=()=>pi(this,void 0,void 0,function*(){if(!this.sender)return void(this._currentBitrate=0);let e;try{e=yield this.getSenderStats()}catch(e){return void this.log.error("could not get video sender stats",Object.assign(Object.assign({},this.logContext),{error:e}))}const t=new Map(e.map(e=>[e.rid,e])),n=e.some(e=>"cpu"===e.qualityLimitationReason);if(n!==this.isCpuConstrained&&(this.isCpuConstrained=n,this.isCpuConstrained&&this.emit(Uo.CpuConstrained)),this.prevStats){let e=0;t.forEach((t,n)=>{var i;const o=null===(i=this.prevStats)||void 0===i?void 0:i.get(n);e+=dr(t,o)}),this._currentBitrate=e}this.prevStats=t}),this.senderLock=new m}get isSimulcast(){return!!(this.sender&&this.sender.getParameters().encodings.length>1)}startMonitor(e){var t;if(this.signalClient=e,!Rs())return;const n=null===(t=this.sender)||void 0===t?void 0:t.getParameters();n&&(this.encodings=n.encodings),this.monitorInterval||(this.monitorInterval=setInterval(()=>{this.monitorSender()},cr))}stop(){this._mediaStreamTrack.getConstraints(),this.simulcastCodecs.forEach(e=>{e.mediaStreamTrack.stop()}),super.stop()}pauseUpstream(){const e=Object.create(null,{pauseUpstream:{get:()=>super.pauseUpstream}});return pi(this,void 0,void 0,function*(){var t,n,i,o,s;yield e.pauseUpstream.call(this);try{for(var a,r=!0,c=gi(this.simulcastCodecs.values());!(t=(a=yield c.next()).done);r=!0){o=a.value,r=!1;const e=o;yield null===(s=e.sender)||void 0===s?void 0:s.replaceTrack(null)}}catch(e){n={error:e}}finally{try{r||t||!(i=c.return)||(yield i.call(c))}finally{if(n)throw n.error}}})}resumeUpstream(){const e=Object.create(null,{resumeUpstream:{get:()=>super.resumeUpstream}});return pi(this,void 0,void 0,function*(){var t,n,i,o,s;yield e.resumeUpstream.call(this);try{for(var a,r=!0,c=gi(this.simulcastCodecs.values());!(t=(a=yield c.next()).done);r=!0){o=a.value,r=!1;const e=o;yield null===(s=e.sender)||void 0===s?void 0:s.replaceTrack(e.mediaStreamTrack)}}catch(e){n={error:e}}finally{try{r||t||!(i=c.return)||(yield i.call(c))}finally{if(n)throw n.error}}})}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return pi(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source!==ss.Source.Camera||this.isUserProvided||(this.log.debug("stopping camera track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{t()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return pi(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.source!==ss.Source.Camera||this.isUserProvided||(this.log.debug("reacquiring camera track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this):(this.log.debug("Track already unmuted",this.logContext),this)}finally{t()}})}setTrackMuted(e){super.setTrackMuted(e);for(const t of this.simulcastCodecs.values())t.mediaStreamTrack.enabled=!e}getSenderStats(){return pi(this,void 0,void 0,function*(){var e;if(!(null===(e=this.sender)||void 0===e?void 0:e.getStats))return[];const t=[],n=yield this.sender.getStats();return n.forEach(e=>{var i;if("outbound-rtp"===e.type){const o={type:"video",streamId:e.id,frameHeight:e.frameHeight,frameWidth:e.frameWidth,framesPerSecond:e.framesPerSecond,framesSent:e.framesSent,firCount:e.firCount,pliCount:e.pliCount,nackCount:e.nackCount,packetsSent:e.packetsSent,bytesSent:e.bytesSent,qualityLimitationReason:e.qualityLimitationReason,qualityLimitationDurations:e.qualityLimitationDurations,qualityLimitationResolutionChanges:e.qualityLimitationResolutionChanges,rid:null!==(i=e.rid)&&void 0!==i?i:e.id,retransmittedPacketsSent:e.retransmittedPacketsSent,targetBitrate:e.targetBitrate,timestamp:e.timestamp},s=n.get(e.remoteId);s&&(o.jitter=s.jitter,o.packetsLost=s.packetsLost,o.roundTripTime=s.roundTripTime),t.push(o)}}),t.sort((e,t)=>{var n,i;return(null!==(n=t.frameWidth)&&void 0!==n?n:0)-(null!==(i=e.frameWidth)&&void 0!==i?i:0)}),t})}setPublishingQuality(e){const t=[];for(let n=os.LOW;n<=os.HIGH;n+=1)t.push(new Rn({quality:n,enabled:n<=e}));this.log.debug("setting publishing quality. max quality ".concat(e),this.logContext),this.setPublishingLayers(Ts(this.codec),t)}restartTrack(e){return pi(this,void 0,void 0,function*(){var t,n,i,o,s;let a;if(e){const t=aa({video:e});"boolean"!=typeof t.video&&(a=t.video)}yield this.restart(a),this.isCpuConstrained=!1;try{for(var r,c=!0,d=gi(this.simulcastCodecs.values());!(t=(r=yield d.next()).done);c=!0){o=r.value,c=!1;const e=o;e.sender&&"closed"!==(null===(s=e.sender.transport)||void 0===s?void 0:s.state)&&(e.mediaStreamTrack=this.mediaStreamTrack.clone(),yield e.sender.replaceTrack(e.mediaStreamTrack))}}catch(e){n={error:e}}finally{try{c||t||!(i=d.return)||(yield i.call(d))}finally{if(n)throw n.error}}})}setProcessor(e){const t=Object.create(null,{setProcessor:{get:()=>super.setProcessor}});return pi(this,arguments,void 0,function(e){var n=this;let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return function*(){var o,s,a,r,c,d;if(yield t.setProcessor.call(n,e,i),null===(c=n.processor)||void 0===c?void 0:c.processedTrack)try{for(var l,u=!0,h=gi(n.simulcastCodecs.values());!(o=(l=yield h.next()).done);u=!0){r=l.value,u=!1;const e=r;yield null===(d=e.sender)||void 0===d?void 0:d.replaceTrack(n.processor.processedTrack)}}catch(e){s={error:e}}finally{try{u||o||!(a=h.return)||(yield a.call(h))}finally{if(s)throw s.error}}}()})}setDegradationPreference(e){return pi(this,void 0,void 0,function*(){if(this.degradationPreference=e,this.sender)try{this.log.debug("setting degradationPreference to ".concat(e),this.logContext);const t=this.sender.getParameters();t.degradationPreference=e,this.sender.setParameters(t)}catch(e){this.log.warn("failed to set degradationPreference",Object.assign({error:e},this.logContext))}})}addSimulcastTrack(e,t){if(this.simulcastCodecs.has(e))return void this.log.error("".concat(e," already added, skipping adding simulcast codec"),this.logContext);const n={codec:e,mediaStreamTrack:this.mediaStreamTrack.clone(),sender:void 0,encodings:t};return this.simulcastCodecs.set(e,n),n}setSimulcastTrackSender(e,t){const n=this.simulcastCodecs.get(e);n&&(n.sender=t,setTimeout(()=>{this.subscribedCodecs&&this.setPublishingCodecs(this.subscribedCodecs)},5e3))}setPublishingCodecs(e){return pi(this,void 0,void 0,function*(){var t,n,i,o,s,a,r;if(this.log.debug("setting publishing codecs",Object.assign(Object.assign({},this.logContext),{codecs:e,currentCodec:this.codec})),!this.codec&&e.length>0)return yield this.setPublishingLayers(Ts(e[0].codec),e[0].qualities),[];this.subscribedCodecs=e;const c=[];try{for(t=!0,n=gi(e);!(o=(i=yield n.next()).done);t=!0){r=i.value,t=!1;const e=r;if(this.codec&&this.codec!==e.codec){const t=this.simulcastCodecs.get(e.codec);if(this.log.debug("try setPublishingCodec for ".concat(e.codec),Object.assign(Object.assign({},this.logContext),{simulcastCodecInfo:t})),t&&t.sender)t.encodings&&(this.log.debug("try setPublishingLayersForSender ".concat(e.codec),this.logContext),yield Pr(t.sender,t.encodings,e.qualities,this.senderLock,Ts(e.codec),this.log,this.logContext));else for(const t of e.qualities)if(t.enabled){c.push(e.codec);break}}else yield this.setPublishingLayers(Ts(e.codec),e.qualities)}}catch(e){s={error:e}}finally{try{t||o||!(a=n.return)||(yield a.call(n))}finally{if(s)throw s.error}}return c})}setPublishingLayers(e,t){return pi(this,void 0,void 0,function*(){this.optimizeForPerformance?this.log.info("skipping setPublishingLayers due to optimized publishing performance",Object.assign(Object.assign({},this.logContext),{qualities:t})):(this.log.debug("setting publishing layers",Object.assign(Object.assign({},this.logContext),{qualities:t})),this.sender&&this.encodings&&(yield Pr(this.sender,this.encodings,t,this.senderLock,e,this.log,this.logContext)))})}prioritizePerformance(){return pi(this,void 0,void 0,function*(){if(!this.sender)throw new Error("sender not found");const e=yield this.senderLock.lock();try{this.optimizeForPerformance=!0;const e=this.sender.getParameters();e.encodings=e.encodings.map((e,t)=>{var n;return Object.assign(Object.assign({},e),{active:0===t,scaleResolutionDownBy:Math.max(1,Math.ceil((null!==(n=this.mediaStreamTrack.getSettings().height)&&void 0!==n?n:360)/360)),scalabilityMode:0===t&&Ts(this.codec)?"L1T3":void 0,maxFramerate:0===t?15:0,maxBitrate:0===t?e.maxBitrate:0})}),this.log.debug("setting performance optimised encodings",Object.assign(Object.assign({},this.logContext),{encodings:e.encodings})),this.encodings=e.encodings,yield this.sender.setParameters(e)}catch(e){this.log.error("failed to set performance optimised encodings",Object.assign(Object.assign({},this.logContext),{error:e})),this.optimizeForPerformance=!1}finally{e()}})}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return pi(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),Ps()&&this.isInBackground&&this.source===ss.Source.Camera&&(this._mediaStreamTrack.enabled=!1)})}}function Pr(e,t,n,i,o,s,a){return pi(this,void 0,void 0,function*(){const r=yield i.lock();s.debug("setPublishingLayersForSender",Object.assign(Object.assign({},a),{sender:e,qualities:n,senderEncodings:t}));try{const i=e.getParameters(),{encodings:r}=i;if(!r)return;if(r.length!==t.length)return void s.warn("cannot set publishing layers, encodings mismatch",Object.assign(Object.assign({},a),{encodings:r,senderEncodings:t}));let c=!1;if(!1&&r[0].scalabilityMode);else{if(o){n.some(e=>e.enabled)&&n.forEach(e=>e.enabled=!0)}r.forEach((e,i)=>{var o;let r=null!==(o=e.rid)&&void 0!==o?o:"";""===r&&(r="q");const d=Rr(r),l=n.find(e=>e.quality===d);l&&e.active!==l.enabled&&(c=!0,e.active=l.enabled,s.debug("setting layer ".concat(l.quality," to ").concat(e.active?"enabled":"disabled"),a),Ss()&&(l.enabled?(e.scaleResolutionDownBy=t[i].scaleResolutionDownBy,e.maxBitrate=t[i].maxBitrate,e.maxFrameRate=t[i].maxFrameRate):(e.scaleResolutionDownBy=4,e.maxBitrate=10,e.maxFrameRate=2)))})}c&&(i.encodings=r,s.debug("setting encodings",Object.assign(Object.assign({},a),{encodings:i.encodings})),yield e.setParameters(i))}finally{r()}})}function Rr(e){switch(e){case"f":default:return os.HIGH;case"h":return os.MEDIUM;case"q":return os.LOW}}function Ir(e,t,n,i){if(!n)return[new bt({quality:os.HIGH,width:e,height:t,bitrate:0,ssrc:0})];if(i){const i=n[0].scalabilityMode,o=new Er(i),s=[],a="h"==o.suffix?1.5:2,r="h"==o.suffix?2:3;for(let i=0;i<o.spatial;i+=1)s.push(new bt({quality:Math.min(os.HIGH,o.spatial-1)-i,width:Math.ceil(e/Math.pow(a,i)),height:Math.ceil(t/Math.pow(a,i)),bitrate:n[0].maxBitrate?Math.ceil(n[0].maxBitrate/Math.pow(r,i)):0,ssrc:0}));return s}return n.map(n=>{var i,o,s;const a=null!==(i=n.scaleResolutionDownBy)&&void 0!==i?i:1;let r=Rr(null!==(o=n.rid)&&void 0!==o?o:"");return new bt({quality:r,width:Math.ceil(e/a),height:Math.ceil(t/a),bitrate:null!==(s=n.maxBitrate)&&void 0!==s?s:0,ssrc:0})})}const Or="_lossy",_r="_reliable",Dr="leave-reconnect";var Mr;!function(e){e[e.New=0]="New",e[e.Connected=1]="Connected",e[e.Disconnected=2]="Disconnected",e[e.Reconnecting=3]="Reconnecting",e[e.Closed=4]="Closed"}(Mr||(Mr={}));class Ar extends bi.EventEmitter{get isClosed(){return this._isClosed}get pendingReconnect(){return!!this.reconnectTimeout}constructor(e){var t;super(),this.options=e,this.rtcConfig={},this.peerConnectionTimeout=nr.peerConnectionTimeout,this.fullReconnectOnNext=!1,this.latestRemoteOfferId=0,this.subscriberPrimary=!1,this.pcState=Mr.New,this._isClosed=!0,this.pendingTrackResolvers={},this.reconnectAttempts=0,this.reconnectStart=0,this.attemptingReconnect=!1,this.joinAttempts=0,this.maxJoinAttempts=1,this.shouldFailNext=!1,this.log=ci,this.reliableDataSequence=1,this.reliableMessageBuffer=new Ia,this.reliableReceivedState=new Oa(3e4),this.midToTrackId={},this.handleDataChannel=e=>pi(this,[e],void 0,function(e){var t=this;let{channel:n}=e;return function*(){if(n){if(n.label===_r)t.reliableDCSub=n;else{if(n.label!==Or)return;t.lossyDCSub=n}t.log.debug("on data channel ".concat(n.id,", ").concat(n.label),t.logContext),n.onmessage=t.handleDataMessage}}()}),this.handleDataMessage=e=>pi(this,void 0,void 0,function*(){var t,n,i,o,s;const a=yield this.dataProcessLock.lock();try{let a;if(e.data instanceof ArrayBuffer)a=e.data;else{if(!(e.data instanceof Blob))return void this.log.error("unsupported data type",Object.assign(Object.assign({},this.logContext),{data:e.data}));a=yield e.data.arrayBuffer()}const r=kt.fromBinary(new Uint8Array(a));if(r.sequence>0&&""!==r.participantSid){const e=this.reliableReceivedState.get(r.participantSid);if(e&&r.sequence<=e)return;this.reliableReceivedState.set(r.participantSid,r.sequence)}if("speaker"===(null===(t=r.value)||void 0===t?void 0:t.case))this.emit(Lo.ActiveSpeakersUpdate,r.value.value.speakers);else if("encryptedPacket"===(null===(n=r.value)||void 0===n?void 0:n.case)){if(!this.e2eeManager)return void this.log.error("Received encrypted packet but E2EE not set up",this.logContext);const e=yield null===(i=this.e2eeManager)||void 0===i?void 0:i.handleEncryptedData(r.value.value.encryptedValue,r.value.value.iv,r.participantIdentity,r.value.value.keyIndex),t=St.fromBinary(e.payload),n=new kt({value:t.value,participantIdentity:r.participantIdentity,participantSid:r.participantSid});"user"===(null===(o=n.value)||void 0===o?void 0:o.case)&&Lr(n,n.value.value),this.emit(Lo.DataPacketReceived,n,r.value.value.encryptionType)}else"user"===(null===(s=r.value)||void 0===s?void 0:s.case)&&Lr(r,r.value.value),this.emit(Lo.DataPacketReceived,r,gt.NONE)}finally{a()}}),this.handleDataError=e=>{const t=0===e.currentTarget.maxRetransmits?"lossy":"reliable";if(e instanceof ErrorEvent&&e.error){const{error:n}=e.error;this.log.error("DataChannel error on ".concat(t,": ").concat(e.message),Object.assign(Object.assign({},this.logContext),{error:n}))}else this.log.error("Unknown DataChannel error on ".concat(t),Object.assign(Object.assign({},this.logContext),{event:e}))},this.handleBufferedAmountLow=e=>{const t=0===e.currentTarget.maxRetransmits?Tt.LOSSY:Tt.RELIABLE;this.updateAndEmitDCBufferStatus(t)},this.handleDisconnect=(e,t)=>{if(this._isClosed)return;this.log.warn("".concat(e," disconnected"),this.logContext),0===this.reconnectAttempts&&(this.reconnectStart=Date.now());const n=e=>{this.log.warn("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(e,"ms. giving up"),this.logContext),this.emit(Lo.Disconnected),this.close()},i=Date.now()-this.reconnectStart;let o=this.getNextRetryDelay({elapsedMs:i,retryCount:this.reconnectAttempts});null!==o?(e===Dr&&(o=0),this.log.debug("reconnecting in ".concat(o,"ms"),this.logContext),this.clearReconnectTimeout(),this.token&&this.regionUrlProvider&&this.regionUrlProvider.updateToken(this.token),this.reconnectTimeout=ns.setTimeout(()=>this.attemptReconnect(t).finally(()=>this.reconnectTimeout=void 0),o)):n(i)},this.waitForRestarted=()=>new Promise((e,t)=>{this.pcState===Mr.Connected&&e();const n=()=>{this.off(Lo.Disconnected,i),e()},i=()=>{this.off(Lo.Restarted,n),t()};this.once(Lo.Restarted,n),this.once(Lo.Disconnected,i)}),this.updateAndEmitDCBufferStatus=e=>{const t=this.isBufferStatusLow(e);void 0!==t&&t!==this.dcBufferStatus.get(e)&&(this.dcBufferStatus.set(e,t),this.emit(Lo.DCBufferStatusChanged,t,e))},this.isBufferStatusLow=e=>{const t=this.dataChannelForKind(e);if(t)return e===Tt.RELIABLE&&this.reliableMessageBuffer.alignBufferedAmount(t.bufferedAmount),t.bufferedAmount<=t.bufferedAmountLowThreshold},this.handleBrowserOnLine=()=>{this.client.currentState===Ea.RECONNECTING&&(this.clearReconnectTimeout(),this.attemptReconnect(st.RR_SIGNAL_DISCONNECTED))},this.log=di(null!==(t=e.loggerName)&&void 0!==t?t:ai.Engine),this.loggerOptions={loggerName:e.loggerName,loggerContextCb:()=>this.logContext},this.client=new xa(void 0,this.loggerOptions),this.client.signalLatency=this.options.expSignalLatency,this.reconnectPolicy=this.options.reconnectPolicy,this.closingLock=new m,this.dataProcessLock=new m,this.dcBufferStatus=new Map([[Tt.LOSSY,!0],[Tt.RELIABLE,!0]]),this.client.onParticipantUpdate=e=>this.emit(Lo.ParticipantUpdate,e),this.client.onConnectionQuality=e=>this.emit(Lo.ConnectionQualityUpdate,e),this.client.onRoomUpdate=e=>this.emit(Lo.RoomUpdate,e),this.client.onSubscriptionError=e=>this.emit(Lo.SubscriptionError,e),this.client.onSubscriptionPermissionUpdate=e=>this.emit(Lo.SubscriptionPermissionUpdate,e),this.client.onSpeakersChanged=e=>this.emit(Lo.SpeakersChanged,e),this.client.onStreamStateUpdate=e=>this.emit(Lo.StreamStateChanged,e),this.client.onRequestResponse=e=>this.emit(Lo.SignalRequestResponse,e)}get logContext(){var e,t,n,i,o,s;return{room:null===(t=null===(e=this.latestJoinResponse)||void 0===e?void 0:e.room)||void 0===t?void 0:t.name,roomID:null===(i=null===(n=this.latestJoinResponse)||void 0===n?void 0:n.room)||void 0===i?void 0:i.sid,participant:null===(s=null===(o=this.latestJoinResponse)||void 0===o?void 0:o.participant)||void 0===s?void 0:s.identity,pID:this.participantSid}}join(e,t,n,i){return pi(this,void 0,void 0,function*(){this.url=e,this.token=t,this.signalOpts=n,this.maxJoinAttempts=n.maxRetries;try{this.joinAttempts+=1,this.setupSignalClientCallbacks();const o=yield this.client.join(e,t,n,i);return this._isClosed=!1,this.latestJoinResponse=o,this.subscriberPrimary=o.subscriberPrimary,this.pcManager||(yield this.configure(o)),this.subscriberPrimary&&!o.fastPublish||this.negotiate().catch(e=>{ci.error(e,this.logContext)}),this.registerOnLineListener(),this.clientConfiguration=o.clientConfiguration,this.emit(Lo.SignalConnected,o),o}catch(o){if(o instanceof qo&&o.reason===Oo.ServerUnreachable&&(this.log.warn("Couldn't connect to server, attempt ".concat(this.joinAttempts," of ").concat(this.maxJoinAttempts),this.logContext),this.joinAttempts<this.maxJoinAttempts))return this.join(e,t,n,i);throw o}})}close(){return pi(this,void 0,void 0,function*(){const e=yield this.closingLock.lock();if(this.isClosed)e();else try{this._isClosed=!0,this.joinAttempts=0,this.emit(Lo.Closing),this.removeAllListeners(),this.deregisterOnLineListener(),this.clearPendingReconnect(),yield this.cleanupPeerConnections(),yield this.cleanupClient()}finally{e()}})}cleanupPeerConnections(){return pi(this,void 0,void 0,function*(){var e;yield null===(e=this.pcManager)||void 0===e?void 0:e.close(),this.pcManager=void 0;const t=e=>{e&&(e.close(),e.onbufferedamountlow=null,e.onclose=null,e.onclosing=null,e.onerror=null,e.onmessage=null,e.onopen=null)};t(this.lossyDC),t(this.lossyDCSub),t(this.reliableDC),t(this.reliableDCSub),this.lossyDC=void 0,this.lossyDCSub=void 0,this.reliableDC=void 0,this.reliableDCSub=void 0,this.reliableMessageBuffer=new Ia,this.reliableDataSequence=1,this.reliableReceivedState.clear()})}cleanupClient(){return pi(this,void 0,void 0,function*(){yield this.client.close(),this.client.resetCallbacks()})}addTrack(e){if(this.pendingTrackResolvers[e.cid])throw new zo("a track with the same ID has already been published");return new Promise((t,n)=>{const i=setTimeout(()=>{delete this.pendingTrackResolvers[e.cid],n(new qo("publication of local track timed out, no response from server",Oo.Timeout))},1e4);this.pendingTrackResolvers[e.cid]={resolve:e=>{clearTimeout(i),t(e)},reject:()=>{clearTimeout(i),n(new Error("Cancelled publication by calling unpublish"))}},this.client.sendAddTrack(e)})}removeTrack(e){if(e.track&&this.pendingTrackResolvers[e.track.id]){const{reject:t}=this.pendingTrackResolvers[e.track.id];t&&t(),delete this.pendingTrackResolvers[e.track.id]}try{return this.pcManager.removeTrack(e),!0}catch(e){this.log.warn("failed to remove track",Object.assign(Object.assign({},this.logContext),{error:e}))}return!1}updateMuteStatus(e,t){this.client.sendMuteTrack(e,t)}get dataSubscriberReadyState(){var e;return null===(e=this.reliableDCSub)||void 0===e?void 0:e.readyState}getConnectedServerAddress(){return pi(this,void 0,void 0,function*(){var e;return null===(e=this.pcManager)||void 0===e?void 0:e.getConnectedAddress()})}setRegionUrlProvider(e){this.regionUrlProvider=e}configure(e){return pi(this,void 0,void 0,function*(){var t,n;if(this.pcManager&&this.pcManager.currentState!==ir.NEW)return;this.participantSid=null===(t=e.participant)||void 0===t?void 0:t.sid;const i=this.makeRTCConfiguration(e);var o;this.pcManager=new or(i,this.options.singlePeerConnection?"publisher-only":e.subscriberPrimary?"subscriber-primary":"publisher-primary",this.loggerOptions),this.emit(Lo.TransportsCreated,this.pcManager.publisher,this.pcManager.subscriber),this.pcManager.onIceCandidate=(e,t)=>{this.client.sendIceCandidate(e,t)},this.pcManager.onPublisherOffer=(e,t)=>{this.client.sendOffer(e,t)},this.pcManager.onDataChannel=this.handleDataChannel,this.pcManager.onStateChange=(t,n,i)=>pi(this,void 0,void 0,function*(){if(this.log.debug("primary PC state changed ".concat(t),this.logContext),["closed","disconnected","failed"].includes(n)&&(this.publisherConnectionPromise=void 0),t===ir.CONNECTED){const t=this.pcState===Mr.New;this.pcState=Mr.Connected,t&&this.emit(Lo.Connected,e)}else t===ir.FAILED&&(this.pcState!==Mr.Connected&&this.pcState!==Mr.Reconnecting||(this.pcState=Mr.Disconnected,this.handleDisconnect("peerconnection failed","failed"===i?st.RR_SUBSCRIBER_FAILED:st.RR_PUBLISHER_FAILED)));const o=this.client.isDisconnected||this.client.currentState===Ea.RECONNECTING,s=[ir.FAILED,ir.CLOSING,ir.CLOSED].includes(t);o&&s&&!this._isClosed&&this.emit(Lo.Offline)}),this.pcManager.onTrack=e=>{0!==e.streams.length&&this.emit(Lo.MediaTrackAdded,e.track,e.streams[0],e.receiver)},void 0!==(o=null===(n=e.serverInfo)||void 0===n?void 0:n.protocol)&&o>13||this.createDataChannels()})}setupSignalClientCallbacks(){this.client.onAnswer=(e,t,n)=>pi(this,void 0,void 0,function*(){this.pcManager&&(this.log.debug("received server answer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type,sdp:e.sdp,midToTrackId:n})),this.midToTrackId=n,yield this.pcManager.setPublisherAnswer(e,t))}),this.client.onTrickle=(e,t)=>{this.pcManager&&(this.log.debug("got ICE candidate from peer",Object.assign(Object.assign({},this.logContext),{candidate:e,target:t})),this.pcManager.addIceCandidate(e,t))},this.client.onOffer=(e,t,n)=>pi(this,void 0,void 0,function*(){if(this.latestRemoteOfferId=t,!this.pcManager)return;this.midToTrackId=n;const i=yield this.pcManager.createSubscriberAnswerFromOffer(e,t);i&&this.client.sendAnswer(i,t)}),this.client.onLocalTrackPublished=e=>{var t;if(this.log.debug("received trackPublishedResponse",Object.assign(Object.assign({},this.logContext),{cid:e.cid,track:null===(t=e.track)||void 0===t?void 0:t.sid})),!this.pendingTrackResolvers[e.cid])return void this.log.error("missing track resolver for ".concat(e.cid),Object.assign(Object.assign({},this.logContext),{cid:e.cid}));const{resolve:n}=this.pendingTrackResolvers[e.cid];delete this.pendingTrackResolvers[e.cid],n(e.track)},this.client.onLocalTrackUnpublished=e=>{this.emit(Lo.LocalTrackUnpublished,e)},this.client.onLocalTrackSubscribed=e=>{this.emit(Lo.LocalTrackSubscribed,e)},this.client.onTokenRefresh=e=>{this.token=e},this.client.onRemoteMuteChanged=(e,t)=>{this.emit(Lo.RemoteMute,e,t)},this.client.onSubscribedQualityUpdate=e=>{this.emit(Lo.SubscribedQualityUpdate,e)},this.client.onRoomMoved=e=>{var t;this.participantSid=null===(t=e.participant)||void 0===t?void 0:t.sid,this.latestJoinResponse&&(this.latestJoinResponse.room=e.room),this.emit(Lo.RoomMoved,e)},this.client.onMediaSectionsRequirement=e=>{var t,n;const i={direction:"recvonly"};for(let n=0;n<e.numAudios;n++)null===(t=this.pcManager)||void 0===t||t.addPublisherTransceiverOfKind("audio",i);for(let t=0;t<e.numVideos;t++)null===(n=this.pcManager)||void 0===n||n.addPublisherTransceiverOfKind("video",i);this.negotiate()},this.client.onClose=()=>{this.handleDisconnect("signal",st.RR_SIGNAL_DISCONNECTED)},this.client.onLeave=e=>{switch(this.log.debug("client leave request",Object.assign(Object.assign({},this.logContext),{reason:null==e?void 0:e.reason})),e.regions&&this.regionUrlProvider&&(this.log.debug("updating regions",this.logContext),this.regionUrlProvider.setServerReportedRegions(e.regions)),e.action){case bn.DISCONNECT:this.emit(Lo.Disconnected,null==e?void 0:e.reason),this.close();break;case bn.RECONNECT:this.fullReconnectOnNext=!0,this.handleDisconnect(Dr);break;case bn.RESUME:this.handleDisconnect(Dr)}}}makeRTCConfiguration(e){var t;const n=Object.assign({},this.rtcConfig);if((null===(t=this.signalOpts)||void 0===t?void 0:t.e2eeEnabled)&&(this.log.debug("E2EE - setting up transports with insertable streams",this.logContext),n.encodedInsertableStreams=!0),e.iceServers&&!n.iceServers){const t=[];e.iceServers.forEach(e=>{const n={urls:e.urls};e.username&&(n.username=e.username),e.credential&&(n.credential=e.credential),t.push(n)}),n.iceServers=t}return e.clientConfiguration&&e.clientConfiguration.forceRelay===it.ENABLED&&(n.iceTransportPolicy="relay"),n.sdpSemantics="unified-plan",n.continualGatheringPolicy="gather_continually",n}createDataChannels(){this.pcManager&&(this.lossyDC&&(this.lossyDC.onmessage=null,this.lossyDC.onerror=null),this.reliableDC&&(this.reliableDC.onmessage=null,this.reliableDC.onerror=null),this.lossyDC=this.pcManager.createPublisherDataChannel(Or,{ordered:!1,maxRetransmits:0}),this.reliableDC=this.pcManager.createPublisherDataChannel(_r,{ordered:!0}),this.lossyDC.onmessage=this.handleDataMessage,this.reliableDC.onmessage=this.handleDataMessage,this.lossyDC.onerror=this.handleDataError,this.reliableDC.onerror=this.handleDataError,this.lossyDC.bufferedAmountLowThreshold=65535,this.reliableDC.bufferedAmountLowThreshold=65535,this.lossyDC.onbufferedamountlow=this.handleBufferedAmountLow,this.reliableDC.onbufferedamountlow=this.handleBufferedAmountLow)}createSender(e,t,n){return pi(this,void 0,void 0,function*(){if(ys()){return yield this.createTransceiverRTCRtpSender(e,t,n)}if(ks()){this.log.warn("using add-track fallback",this.logContext);return yield this.createRTCRtpSender(e.mediaStreamTrack)}throw new Wo("Required webRTC APIs not supported on this device")})}createSimulcastSender(e,t,n,i){return pi(this,void 0,void 0,function*(){if(ys())return this.createSimulcastTransceiverSender(e,t,n,i);if(ks())return this.log.debug("using add-track fallback",this.logContext),this.createRTCRtpSender(e.mediaStreamTrack);throw new Wo("Cannot stream on this device")})}createTransceiverRTCRtpSender(e,t,n){return pi(this,void 0,void 0,function*(){if(!this.pcManager)throw new Wo("publisher is closed");const i=[];e.mediaStream&&i.push(e.mediaStream),Xs(e)&&(e.codec=t.videoCodec);const o={direction:"sendonly",streams:i};n&&(o.sendEncodings=n);return(yield this.pcManager.addPublisherTransceiver(e.mediaStreamTrack,o)).sender})}createSimulcastTransceiverSender(e,t,n,i){return pi(this,void 0,void 0,function*(){if(!this.pcManager)throw new Wo("publisher is closed");const o={direction:"sendonly"};i&&(o.sendEncodings=i);const s=yield this.pcManager.addPublisherTransceiver(t.mediaStreamTrack,o);if(n.videoCodec)return e.setSimulcastTrackSender(n.videoCodec,s.sender),s.sender})}createRTCRtpSender(e){return pi(this,void 0,void 0,function*(){if(!this.pcManager)throw new Wo("publisher is closed");return this.pcManager.addPublisherTrack(e)})}attemptReconnect(e){return pi(this,void 0,void 0,function*(){var t,n,i;if(!this._isClosed)if(this.attemptingReconnect)ci.warn("already attempting reconnect, returning early",this.logContext);else{(null===(t=this.clientConfiguration)||void 0===t?void 0:t.resumeConnection)!==it.DISABLED&&(null!==(i=null===(n=this.pcManager)||void 0===n?void 0:n.currentState)&&void 0!==i?i:ir.NEW)!==ir.NEW||(this.fullReconnectOnNext=!0);try{this.attemptingReconnect=!0,this.fullReconnectOnNext?yield this.restartConnection():yield this.resumeConnection(e),this.clearPendingReconnect(),this.fullReconnectOnNext=!1}catch(e){this.reconnectAttempts+=1;let t=!0;e instanceof Wo?(this.log.debug("received unrecoverable error",Object.assign(Object.assign({},this.logContext),{error:e})),t=!1):e instanceof Nr||(this.fullReconnectOnNext=!0),t?this.handleDisconnect("reconnect",st.RR_UNKNOWN):(this.log.info("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(Date.now()-this.reconnectStart,"ms. giving up"),this.logContext),this.emit(Lo.Disconnected),yield this.close())}finally{this.attemptingReconnect=!1}}})}getNextRetryDelay(e){try{return this.reconnectPolicy.nextRetryDelayInMs(e)}catch(e){this.log.warn("encountered error in reconnect policy",Object.assign(Object.assign({},this.logContext),{error:e}))}return null}restartConnection(e){return pi(this,void 0,void 0,function*(){var t,n,i;try{if(!this.url||!this.token)throw new Wo("could not reconnect, url or token not saved");let n;this.log.info("reconnecting, attempt: ".concat(this.reconnectAttempts),this.logContext),this.emit(Lo.Restarting),this.client.isDisconnected||(yield this.client.sendLeave()),yield this.cleanupPeerConnections(),yield this.cleanupClient();try{if(!this.signalOpts)throw this.log.warn("attempted connection restart, without signal options present",this.logContext),new Nr;n=yield this.join(null!=e?e:this.url,this.token,this.signalOpts)}catch(e){if(e instanceof qo&&e.reason===Oo.NotAllowed)throw new Wo("could not reconnect, token might be expired");throw new Nr}if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(this.client.setReconnected(),this.emit(Lo.SignalRestarted,n),yield this.waitForPCReconnected(),this.client.currentState!==Ea.CONNECTED)throw new Nr("Signal connection got severed during reconnect");null===(t=this.regionUrlProvider)||void 0===t||t.resetAttempts(),this.emit(Lo.Restarted)}catch(e){const t=yield null===(n=this.regionUrlProvider)||void 0===n?void 0:n.getNextBestRegionUrl();if(t)return void(yield this.restartConnection(t));throw null===(i=this.regionUrlProvider)||void 0===i||i.resetAttempts(),e}})}resumeConnection(e){return pi(this,void 0,void 0,function*(){var t;if(!this.url||!this.token)throw new Wo("could not reconnect, url or token not saved");if(!this.pcManager)throw new Wo("publisher and subscriber connections unset");let n;this.log.info("resuming signal connection, attempt ".concat(this.reconnectAttempts),this.logContext),this.emit(Lo.Resuming);try{this.setupSignalClientCallbacks(),n=yield this.client.reconnect(this.url,this.token,this.participantSid,e)}catch(e){let t="";if(e instanceof Error&&(t=e.message,this.log.error(e.message,Object.assign(Object.assign({},this.logContext),{error:e}))),e instanceof qo&&e.reason===Oo.NotAllowed)throw new Wo("could not reconnect, token might be expired");if(e instanceof qo&&e.reason===Oo.LeaveRequest)throw e;throw new Nr(t)}if(this.emit(Lo.SignalResumed),n){const e=this.makeRTCConfiguration(n);this.pcManager.updateConfiguration(e),this.latestJoinResponse&&(this.latestJoinResponse.serverInfo=n.serverInfo)}else this.log.warn("Did not receive reconnect response",this.logContext);if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(yield this.pcManager.triggerIceRestart(),yield this.waitForPCReconnected(),this.client.currentState!==Ea.CONNECTED)throw new Nr("Signal connection got severed during reconnect");this.client.setReconnected(),"open"===(null===(t=this.reliableDC)||void 0===t?void 0:t.readyState)&&null===this.reliableDC.id&&this.createDataChannels(),(null==n?void 0:n.lastMessageSeq)&&this.resendReliableMessagesForResume(n.lastMessageSeq),this.emit(Lo.Resumed)})}waitForPCInitialConnection(e,t){return pi(this,void 0,void 0,function*(){if(!this.pcManager)throw new Wo("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(t,e)})}waitForPCReconnected(){return pi(this,void 0,void 0,function*(){this.pcState=Mr.Reconnecting,this.log.debug("waiting for peer connection to reconnect",this.logContext);try{if(yield bs(2e3),!this.pcManager)throw new Wo("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(void 0,this.peerConnectionTimeout),this.pcState=Mr.Connected}catch(e){throw this.pcState=Mr.Disconnected,new qo("could not establish PC connection, ".concat(e.message),Oo.InternalError)}})}publishRpcResponse(e,t,n,i){return pi(this,void 0,void 0,function*(){const o=new kt({destinationIdentities:[e],kind:Tt.RELIABLE,value:{case:"rpcResponse",value:new Mt({requestId:t,value:i?{case:"error",value:i.toProto()}:{case:"payload",value:null!=n?n:""}})}});yield this.sendDataPacket(o,Tt.RELIABLE)})}publishRpcAck(e,t){return pi(this,void 0,void 0,function*(){const n=new kt({destinationIdentities:[e],kind:Tt.RELIABLE,value:{case:"rpcAck",value:new Dt({requestId:t})}});yield this.sendDataPacket(n,Tt.RELIABLE)})}sendDataPacket(e,t){return pi(this,void 0,void 0,function*(){if(yield this.ensurePublisherConnected(t),this.e2eeManager&&this.e2eeManager.isDataChannelEncryptionEnabled){const t=function(e){var t,n,i,o,s;if("sipDtmf"!==(null===(t=e.value)||void 0===t?void 0:t.case)&&"metrics"!==(null===(n=e.value)||void 0===n?void 0:n.case)&&"speaker"!==(null===(i=e.value)||void 0===i?void 0:i.case)&&"transcription"!==(null===(o=e.value)||void 0===o?void 0:o.case)&&"encryptedPacket"!==(null===(s=e.value)||void 0===s?void 0:s.case))return new St({value:e.value})}(e);if(t){const n=yield this.e2eeManager.encryptData(t.toBinary());e.value={case:"encryptedPacket",value:new Ct({encryptedValue:n.payload,iv:n.iv,keyIndex:n.keyIndex})}}}t===Tt.RELIABLE&&(e.sequence=this.reliableDataSequence,this.reliableDataSequence+=1);const n=e.toBinary(),i=this.dataChannelForKind(t);if(i){if(t===Tt.RELIABLE&&this.reliableMessageBuffer.push({data:n,sequence:e.sequence}),this.attemptingReconnect)return;i.send(n)}this.updateAndEmitDCBufferStatus(t)})}resendReliableMessagesForResume(e){return pi(this,void 0,void 0,function*(){yield this.ensurePublisherConnected(Tt.RELIABLE);const t=this.dataChannelForKind(Tt.RELIABLE);t&&(this.reliableMessageBuffer.popToSequence(e),this.reliableMessageBuffer.getAll().forEach(e=>{t.send(e.data)})),this.updateAndEmitDCBufferStatus(Tt.RELIABLE)})}waitForBufferStatusLow(e){return new Promise((t,n)=>pi(this,void 0,void 0,function*(){if(this.isBufferStatusLow(e))t();else{const i=()=>n("Engine closed");for(this.once(Lo.Closing,i);!this.dcBufferStatus.get(e);)yield bs(10);this.off(Lo.Closing,i),t()}}))}ensureDataTransportConnected(e){return pi(this,arguments,void 0,function(e){var t=this;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.subscriberPrimary;return function*(){var i;if(!t.pcManager)throw new Wo("PC manager is closed");const o=n?t.pcManager.subscriber:t.pcManager.publisher,s=n?"Subscriber":"Publisher";if(!o)throw new qo("".concat(s," connection not set"),Oo.InternalError);let a=!1;n||t.dataChannelForKind(e,n)||(t.createDataChannels(),a=!0),a||n||t.pcManager.publisher.isICEConnected||"checking"===t.pcManager.publisher.getICEConnectionState()||(a=!0),a&&t.negotiate().catch(e=>{ci.error(e,t.logContext)});const r=t.dataChannelForKind(e,n);if("open"===(null==r?void 0:r.readyState))return;const c=(new Date).getTime()+t.peerConnectionTimeout;for(;(new Date).getTime()<c;){if(o.isICEConnected&&"open"===(null===(i=t.dataChannelForKind(e,n))||void 0===i?void 0:i.readyState))return;yield bs(50)}throw new qo("could not establish ".concat(s," connection, state: ").concat(o.getICEConnectionState()),Oo.InternalError)}()})}ensurePublisherConnected(e){return pi(this,void 0,void 0,function*(){this.publisherConnectionPromise||(this.publisherConnectionPromise=this.ensureDataTransportConnected(e,!1)),yield this.publisherConnectionPromise})}verifyTransport(){return!!this.pcManager&&(this.pcManager.currentState===ir.CONNECTED&&!(!this.client.ws||this.client.ws.readyState===WebSocket.CLOSED))}negotiate(){return pi(this,void 0,void 0,function*(){return new Promise((e,t)=>pi(this,void 0,void 0,function*(){if(!this.pcManager)return void t(new Go("PC manager is closed"));this.pcManager.requirePublisher(),0!=this.pcManager.publisher.getTransceivers().length||this.lossyDC||this.reliableDC||this.createDataChannels();const n=new AbortController,i=()=>{n.abort(),this.log.debug("engine disconnected while negotiation was ongoing",this.logContext),e()};this.isClosed&&t("cannot negotiate on closed engine"),this.on(Lo.Closing,i),this.pcManager.publisher.once(Ga,e=>{const t=new Map;e.forEach(e=>{const n=e.codec.toLowerCase();var i;i=n,ls.includes(i)&&t.set(e.payload,n)}),this.emit(Lo.RTPVideoMapUpdate,t)});try{yield this.pcManager.negotiate(n),e()}catch(e){e instanceof Go&&(this.fullReconnectOnNext=!0),this.handleDisconnect("negotiation",st.RR_UNKNOWN),t(e)}finally{this.off(Lo.Closing,i)}}))})}dataChannelForKind(e,t){if(t){if(e===Tt.LOSSY)return this.lossyDCSub;if(e===Tt.RELIABLE)return this.reliableDCSub}else{if(e===Tt.LOSSY)return this.lossyDC;if(e===Tt.RELIABLE)return this.reliableDC}}sendSyncState(e,t){var n,i,o,s;if(!this.pcManager)return void this.log.warn("sync state cannot be sent without peer connection setup",this.logContext);const a=this.pcManager.publisher.getLocalDescription(),r=this.pcManager.publisher.getRemoteDescription(),c=null===(n=this.pcManager.subscriber)||void 0===n?void 0:n.getRemoteDescription(),d=null===(i=this.pcManager.subscriber)||void 0===i?void 0:i.getLocalDescription(),l=null===(s=null===(o=this.signalOpts)||void 0===o?void 0:o.autoSubscribe)||void 0===s||s,u=new Array,h=new Array;e.forEach(e=>{e.isDesired!==l&&u.push(e.trackSid),e.isEnabled||h.push(e.trackSid)}),this.client.sendSyncState(new Ln({answer:this.options.singlePeerConnection?r?Ra({sdp:r.sdp,type:r.type}):void 0:d?Ra({sdp:d.sdp,type:d.type}):void 0,offer:this.options.singlePeerConnection?a?Ra({sdp:a.sdp,type:a.type}):void 0:c?Ra({sdp:c.sdp,type:c.type}):void 0,subscription:new pn({trackSids:u,subscribe:!l,participantTracks:[]}),publishTracks:ha(t),dataChannels:this.dataChannelsInfo(),trackSidsDisabled:h,datachannelReceiveStates:this.reliableReceivedState.map((e,t)=>new Un({publisherSid:t,lastSeq:e}))}))}failNext(){this.shouldFailNext=!0}dataChannelsInfo(){const e=[],t=(t,n)=>{void 0!==(null==t?void 0:t.id)&&null!==t.id&&e.push(new jn({label:t.label,id:t.id,target:n}))};return t(this.dataChannelForKind(Tt.LOSSY),Qt.PUBLISHER),t(this.dataChannelForKind(Tt.RELIABLE),Qt.PUBLISHER),t(this.dataChannelForKind(Tt.LOSSY,!0),Qt.SUBSCRIBER),t(this.dataChannelForKind(Tt.RELIABLE,!0),Qt.SUBSCRIBER),e}clearReconnectTimeout(){this.reconnectTimeout&&ns.clearTimeout(this.reconnectTimeout)}clearPendingReconnect(){this.clearReconnectTimeout(),this.reconnectAttempts=0}registerOnLineListener(){Rs()&&window.addEventListener("online",this.handleBrowserOnLine)}deregisterOnLineListener(){Rs()&&window.removeEventListener("online",this.handleBrowserOnLine)}getTrackIdForReceiver(e){var t;const n=null===(t=this.pcManager)||void 0===t?void 0:t.getMidForReceiver(e);if(n){const e=Object.entries(this.midToTrackId).find(e=>{let[t]=e;return t===n});if(e)return e[1]}}}class Nr extends Error{}function Lr(e,t){const n=e.participantIdentity?e.participantIdentity:t.participantIdentity;e.participantIdentity=n,t.participantIdentity=n;const i=0!==e.destinationIdentities.length?e.destinationIdentities:t.destinationIdentities;e.destinationIdentities=i,t.destinationIdentities=i}class Ur{constructor(e,t){this.lastUpdateAt=0,this.settingsCacheTime=3e3,this.attemptedRegions=[],this.serverUrl=new URL(e),this.token=t}updateToken(e){this.token=e}isCloud(){return Os(this.serverUrl)}getServerUrl(){return this.serverUrl}getNextBestRegionUrl(e){return pi(this,void 0,void 0,function*(){if(!this.isCloud())throw Error("region availability is only supported for LiveKit Cloud domains");(!this.regionSettings||Date.now()-this.lastUpdateAt>this.settingsCacheTime)&&(this.regionSettings=yield this.fetchRegionSettings(e));const t=this.regionSettings.regions.filter(e=>!this.attemptedRegions.find(t=>t.url===e.url));if(t.length>0){const e=t[0];return this.attemptedRegions.push(e),ci.debug("next region: ".concat(e.region)),e.url}return null})}resetAttempts(){this.attemptedRegions=[]}fetchRegionSettings(e){return pi(this,void 0,void 0,function*(){const t=yield fetch("".concat((n=this.serverUrl,"".concat(n.protocol.replace("ws","http"),"//").concat(n.host,"/settings")),"/regions"),{headers:{authorization:"Bearer ".concat(this.token)},signal:e});var n;if(t.ok){const e=yield t.json();return this.lastUpdateAt=Date.now(),e}throw new qo("Could not fetch region settings: ".concat(t.statusText),401===t.status?Oo.NotAllowed:Oo.InternalError,t.status)})}setServerReportedRegions(e){this.regionSettings=e,this.lastUpdateAt=Date.now()}}class jr{get info(){return this._info}validateBytesReceived(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if("number"==typeof this.totalByteSize&&0!==this.totalByteSize){if(e&&this.bytesReceived<this.totalByteSize)throw new Yo("Not enough chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, only received ").concat(this.bytesReceived," bytes"),_o.Incomplete);if(this.bytesReceived>this.totalByteSize)throw new Yo("Extra chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, received ").concat(this.bytesReceived," bytes"),_o.LengthExceeded)}}constructor(e,t,n,i){this.reader=t,this.totalByteSize=n,this._info=e,this.bytesReceived=0,this.outOfBandFailureRejectingFuture=i}}class Fr extends jr{handleChunkReceived(e){var t;this.bytesReceived+=e.content.byteLength,this.validateBytesReceived();const n=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;null===(t=this.onProgress)||void 0===t||t.call(this,n)}[Symbol.asyncIterator](){const e=this.reader.getReader();let t=new Hs,n=null,i=null;if(this.signal){const e=this.signal;i=()=>{var n;null===(n=t.reject)||void 0===n||n.call(t,e.reason)},e.addEventListener("abort",i),n=e}const o=()=>{e.releaseLock(),n&&i&&n.removeEventListener("abort",i),this.signal=void 0};return{next:()=>pi(this,void 0,void 0,function*(){var n,i;try{const{done:o,value:s}=yield Promise.race([e.read(),t.promise,null!==(i=null===(n=this.outOfBandFailureRejectingFuture)||void 0===n?void 0:n.promise)&&void 0!==i?i:new Promise(()=>{})]);return o?(this.validateBytesReceived(!0),{done:!0,value:void 0}):(this.handleChunkReceived(s),{done:!1,value:s.content})}catch(e){throw o(),e}}),return(){return pi(this,void 0,void 0,function*(){return o(),{done:!0,value:void 0}})}}}withAbortSignal(e){return this.signal=e,this}readAll(){return pi(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function*(){var n,i,o,s;let a=new Set;const r=t.signal?e.withAbortSignal(t.signal):e;try{for(var c,d=!0,l=gi(r);!(n=(c=yield l.next()).done);d=!0){s=c.value,d=!1;const e=s;a.add(e)}}catch(e){i={error:e}}finally{try{d||n||!(o=l.return)||(yield o.call(l))}finally{if(i)throw i.error}}return Array.from(a)}()})}}class Br extends jr{constructor(e,t,n,i){super(e,t,n,i),this.receivedChunks=new Map}handleChunkReceived(e){var t;const n=Js(e.chunkIndex),i=this.receivedChunks.get(n);if(i&&i.version>e.version)return;this.receivedChunks.set(n,e),this.bytesReceived+=e.content.byteLength,this.validateBytesReceived();const o=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;null===(t=this.onProgress)||void 0===t||t.call(this,o)}[Symbol.asyncIterator](){const e=this.reader.getReader(),t=new TextDecoder("utf-8",{fatal:!0});let n=new Hs,i=null,o=null;if(this.signal){const e=this.signal;o=()=>{var t;null===(t=n.reject)||void 0===t||t.call(n,e.reason)},e.addEventListener("abort",o),i=e}const s=()=>{e.releaseLock(),i&&o&&i.removeEventListener("abort",o),this.signal=void 0};return{next:()=>pi(this,void 0,void 0,function*(){var i,o;try{const{done:s,value:a}=yield Promise.race([e.read(),n.promise,null!==(o=null===(i=this.outOfBandFailureRejectingFuture)||void 0===i?void 0:i.promise)&&void 0!==o?o:new Promise(()=>{})]);if(s)return this.validateBytesReceived(!0),{done:!0,value:void 0};{let e;this.handleChunkReceived(a);try{e=t.decode(a.content)}catch(e){throw new Yo("Cannot decode datastream chunk ".concat(a.chunkIndex," as text: ").concat(e),_o.DecodeFailed)}return{done:!1,value:e}}}catch(e){throw s(),e}}),return(){return pi(this,void 0,void 0,function*(){return s(),{done:!0,value:void 0}})}}}withAbortSignal(e){return this.signal=e,this}readAll(){return pi(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function*(){var n,i,o,s;let a="";const r=t.signal?e.withAbortSignal(t.signal):e;try{for(var c,d=!0,l=gi(r);!(n=(c=yield l.next()).done);d=!0){s=c.value,d=!1;a+=s}}catch(e){i={error:e}}finally{try{d||n||!(o=l.return)||(yield o.call(l))}finally{if(i)throw i.error}}return a}()})}}class qr{constructor(){this.log=ci,this.byteStreamControllers=new Map,this.textStreamControllers=new Map,this.byteStreamHandlers=new Map,this.textStreamHandlers=new Map}registerTextStreamHandler(e,t){if(this.textStreamHandlers.has(e))throw new Yo('A text stream handler for topic "'.concat(e,'" has already been set.'),_o.HandlerAlreadyRegistered);this.textStreamHandlers.set(e,t)}unregisterTextStreamHandler(e){this.textStreamHandlers.delete(e)}registerByteStreamHandler(e,t){if(this.byteStreamHandlers.has(e))throw new Yo('A byte stream handler for topic "'.concat(e,'" has already been set.'),_o.HandlerAlreadyRegistered);this.byteStreamHandlers.set(e,t)}unregisterByteStreamHandler(e){this.byteStreamHandlers.delete(e)}clearHandlersAndControllers(){this.byteStreamControllers.clear(),this.textStreamControllers.clear(),this.byteStreamHandlers.clear(),this.textStreamHandlers.clear()}validateParticipantHasNoActiveDataStreams(e){var t,n,i,o;const s=Array.from(this.textStreamControllers.entries()).filter(t=>t[1].sendingParticipantIdentity===e),a=Array.from(this.byteStreamControllers.entries()).filter(t=>t[1].sendingParticipantIdentity===e);if(s.length>0||a.length>0){const r=new Yo("Participant ".concat(e," unexpectedly disconnected in the middle of sending data"),_o.AbnormalEnd);for(const[e,i]of a)null===(n=(t=i.outOfBandFailureRejectingFuture).reject)||void 0===n||n.call(t,r),this.byteStreamControllers.delete(e);for(const[e,t]of s)null===(o=(i=t.outOfBandFailureRejectingFuture).reject)||void 0===o||o.call(i,r),this.textStreamControllers.delete(e)}}handleDataStreamPacket(e,t){return pi(this,void 0,void 0,function*(){switch(e.value.case){case"streamHeader":return this.handleStreamHeader(e.value.value,e.participantIdentity,t);case"streamChunk":return this.handleStreamChunk(e.value.value,t);case"streamTrailer":return this.handleStreamTrailer(e.value.value,t);default:throw new Error('DataPacket of value "'.concat(e.value.case,'" is not data stream related!'))}})}handleStreamHeader(e,t,n){return pi(this,void 0,void 0,function*(){var i;if("byteHeader"===e.contentHeader.case){const o=this.byteStreamHandlers.get(e.topic);if(!o)return void this.log.debug("ignoring incoming byte stream due to no handler for topic",e.topic);let s;const a=new Hs;a.promise.catch(e=>{this.log.error(e)});const r={id:e.streamId,name:null!==(i=e.contentHeader.value.name)&&void 0!==i?i:"unknown",mimeType:e.mimeType,size:e.totalLength?Number(e.totalLength):void 0,topic:e.topic,timestamp:Js(e.timestamp),attributes:e.attributes,encryptionType:n},c=new ReadableStream({start:n=>{if(s=n,this.textStreamControllers.has(e.streamId))throw new Yo("A data stream read is already in progress for a stream with id ".concat(e.streamId,"."),_o.AlreadyOpened);this.byteStreamControllers.set(e.streamId,{info:r,controller:s,startTime:Date.now(),sendingParticipantIdentity:t,outOfBandFailureRejectingFuture:a})}});o(new Fr(r,c,Js(e.totalLength),a),{identity:t})}else if("textHeader"===e.contentHeader.case){const i=this.textStreamHandlers.get(e.topic);if(!i)return void this.log.debug("ignoring incoming text stream due to no handler for topic",e.topic);let o;const s=new Hs;s.promise.catch(e=>{this.log.error(e)});const a={id:e.streamId,mimeType:e.mimeType,size:e.totalLength?Number(e.totalLength):void 0,topic:e.topic,timestamp:Number(e.timestamp),attributes:e.attributes,encryptionType:n},r=new ReadableStream({start:n=>{if(o=n,this.textStreamControllers.has(e.streamId))throw new Yo("A data stream read is already in progress for a stream with id ".concat(e.streamId,"."),_o.AlreadyOpened);this.textStreamControllers.set(e.streamId,{info:a,controller:o,startTime:Date.now(),sendingParticipantIdentity:t,outOfBandFailureRejectingFuture:s})}});i(new Br(a,r,Js(e.totalLength),s),{identity:t})}})}handleStreamChunk(e,t){const n=this.byteStreamControllers.get(e.streamId);n&&(n.info.encryptionType!==t?(n.controller.error(new Yo("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(n.info.encryptionType),_o.EncryptionTypeMismatch)),this.byteStreamControllers.delete(e.streamId)):e.content.length>0&&n.controller.enqueue(e));const i=this.textStreamControllers.get(e.streamId);i&&(i.info.encryptionType!==t?(i.controller.error(new Yo("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(i.info.encryptionType),_o.EncryptionTypeMismatch)),this.textStreamControllers.delete(e.streamId)):e.content.length>0&&i.controller.enqueue(e))}handleStreamTrailer(e,t){const n=this.textStreamControllers.get(e.streamId);n&&(n.info.encryptionType!==t?n.controller.error(new Yo("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(n.info.encryptionType),_o.EncryptionTypeMismatch)):(n.info.attributes=Object.assign(Object.assign({},n.info.attributes),e.attributes),n.controller.close(),this.textStreamControllers.delete(e.streamId)));const i=this.byteStreamControllers.get(e.streamId);i&&(i.info.encryptionType!==t?i.controller.error(new Yo("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(i.info.encryptionType),_o.EncryptionTypeMismatch)):(i.info.attributes=Object.assign(Object.assign({},i.info.attributes),e.attributes),i.controller.close()),this.byteStreamControllers.delete(e.streamId))}}class Vr{constructor(e,t,n){this.writableStream=e,this.defaultWriter=e.getWriter(),this.onClose=n,this.info=t}write(e){return this.defaultWriter.write(e)}close(){return pi(this,void 0,void 0,function*(){var e;yield this.defaultWriter.close(),this.defaultWriter.releaseLock(),null===(e=this.onClose)||void 0===e||e.call(this)})}}class zr extends Vr{}class Hr extends Vr{}class Wr{constructor(e,t){this.engine=e,this.log=t}setupEngine(e){this.engine=e}sendText(e,t){return pi(this,void 0,void 0,function*(){var n;const i=crypto.randomUUID(),o=(new TextEncoder).encode(e).byteLength,s=null===(n=null==t?void 0:t.attachments)||void 0===n?void 0:n.map(()=>crypto.randomUUID()),a=new Array(s?s.length+1:1).fill(0),r=(e,n)=>{var i;a[n]=e;const o=a.reduce((e,t)=>e+t,0);null===(i=null==t?void 0:t.onProgress)||void 0===i||i.call(t,o)},c=yield this.streamText({streamId:i,totalSize:o,destinationIdentities:null==t?void 0:t.destinationIdentities,topic:null==t?void 0:t.topic,attachedStreamIds:s,attributes:null==t?void 0:t.attributes});return yield c.write(e),r(1,0),yield c.close(),(null==t?void 0:t.attachments)&&s&&(yield Promise.all(t.attachments.map((e,n)=>pi(this,void 0,void 0,function*(){return this._sendFile(s[n],e,{topic:t.topic,mimeType:e.type,onProgress:e=>{r(e,n+1)}})})))),c.info})}streamText(e){return pi(this,void 0,void 0,function*(){var t,n,i;const o=null!==(t=null==e?void 0:e.streamId)&&void 0!==t?t:crypto.randomUUID(),s={id:o,mimeType:"text/plain",timestamp:Date.now(),topic:null!==(n=null==e?void 0:e.topic)&&void 0!==n?n:"",size:null==e?void 0:e.totalSize,attributes:null==e?void 0:e.attributes,encryptionType:(null===(i=this.engine.e2eeManager)||void 0===i?void 0:i.isDataChannelEncryptionEnabled)?gt.GCM:gt.NONE},a=new Kt({streamId:o,mimeType:s.mimeType,topic:s.topic,timestamp:Ys(s.timestamp),totalLength:Ys(null==e?void 0:e.totalSize),attributes:s.attributes,contentHeader:{case:"textHeader",value:new Wt({version:null==e?void 0:e.version,attachedStreamIds:null==e?void 0:e.attachedStreamIds,replyToStreamId:null==e?void 0:e.replyToStreamId,operationType:"update"===(null==e?void 0:e.type)?Ht.UPDATE:Ht.CREATE})}}),r=null==e?void 0:e.destinationIdentities,c=new kt({destinationIdentities:r,value:{case:"streamHeader",value:a}});yield this.engine.sendDataPacket(c,Tt.RELIABLE);let d=0;const l=this.engine,u=new WritableStream({write(e){return pi(this,void 0,void 0,function*(){for(const t of function(e,t){const n=[];let i=(new TextEncoder).encode(e);for(;i.length>t;){let e=t;for(;e>0;){const t=i[e];if(void 0!==t&&128!=(192&t))break;e--}n.push(i.slice(0,e)),i=i.slice(e)}return i.length>0&&n.push(i),n}(e,15e3)){yield l.waitForBufferStatusLow(Tt.RELIABLE);const e=new Jt({content:t,streamId:o,chunkIndex:Ys(d)}),n=new kt({destinationIdentities:r,value:{case:"streamChunk",value:e}});yield l.sendDataPacket(n,Tt.RELIABLE),d+=1}})},close(){return pi(this,void 0,void 0,function*(){const e=new Yt({streamId:o}),t=new kt({destinationIdentities:r,value:{case:"streamTrailer",value:e}});yield l.sendDataPacket(t,Tt.RELIABLE)})},abort(e){console.log("Sink error:",e)}});let h=()=>pi(this,void 0,void 0,function*(){yield p.close()});l.once(Lo.Closing,h);const p=new zr(u,s,()=>this.engine.off(Lo.Closing,h));return p})}sendFile(e,t){return pi(this,void 0,void 0,function*(){const n=crypto.randomUUID();return yield this._sendFile(n,e,t),{id:n}})}_sendFile(e,t,n){return pi(this,void 0,void 0,function*(){var i;const o=yield this.streamBytes({streamId:e,totalSize:t.size,name:t.name,mimeType:null!==(i=null==n?void 0:n.mimeType)&&void 0!==i?i:t.type,topic:null==n?void 0:n.topic,destinationIdentities:null==n?void 0:n.destinationIdentities}),s=t.stream().getReader();for(;;){const{done:e,value:t}=yield s.read();if(e)break;yield o.write(t)}return yield o.close(),o.info})}streamBytes(e){return pi(this,void 0,void 0,function*(){var t,n,i,o,s,a;const r=null!==(t=null==e?void 0:e.streamId)&&void 0!==t?t:crypto.randomUUID(),c=null==e?void 0:e.destinationIdentities,d={id:r,mimeType:null!==(n=null==e?void 0:e.mimeType)&&void 0!==n?n:"application/octet-stream",topic:null!==(i=null==e?void 0:e.topic)&&void 0!==i?i:"",timestamp:Date.now(),attributes:null==e?void 0:e.attributes,size:null==e?void 0:e.totalSize,name:null!==(o=null==e?void 0:e.name)&&void 0!==o?o:"unknown",encryptionType:(null===(s=this.engine.e2eeManager)||void 0===s?void 0:s.isDataChannelEncryptionEnabled)?gt.GCM:gt.NONE},l=new Kt({totalLength:Ys(null!==(a=d.size)&&void 0!==a?a:0),mimeType:d.mimeType,streamId:r,topic:d.topic,timestamp:Ys(Date.now()),attributes:d.attributes,contentHeader:{case:"byteHeader",value:new Gt({name:d.name})}}),u=new kt({destinationIdentities:c,value:{case:"streamHeader",value:l}});yield this.engine.sendDataPacket(u,Tt.RELIABLE);let h=0;const p=new m,g=this.engine,f=this.log,v=new WritableStream({write(e){return pi(this,void 0,void 0,function*(){const t=yield p.lock();let n=0;try{for(;n<e.byteLength;){const t=e.slice(n,n+15e3);yield g.waitForBufferStatusLow(Tt.RELIABLE);const i=new kt({destinationIdentities:c,value:{case:"streamChunk",value:new Jt({content:t,streamId:r,chunkIndex:Ys(h)})}});yield g.sendDataPacket(i,Tt.RELIABLE),h+=1,n+=t.byteLength}}finally{t()}})},close(){return pi(this,void 0,void 0,function*(){const e=new Yt({streamId:r}),t=new kt({destinationIdentities:c,value:{case:"streamTrailer",value:e}});yield g.sendDataPacket(t,Tt.RELIABLE)})},abort(e){f.error("Sink error:",e)}});return new Hr(v,d)})}}class Gr extends ss{constructor(e,t,n,i,o){super(e,n,o),this.sid=t,this.receiver=i}get isLocal(){return!1}setMuted(e){this.isMuted!==e&&(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?Uo.Muted:Uo.Unmuted,this))}setMediaStream(e){this.mediaStream=e;const t=n=>{n.track===this._mediaStreamTrack&&(e.removeEventListener("removetrack",t),this.receiver&&"playoutDelayHint"in this.receiver&&(this.receiver.playoutDelayHint=void 0),this.receiver=void 0,this._currentBitrate=0,this.emit(Uo.Ended,this))};e.addEventListener("removetrack",t)}start(){this.startMonitor(),super.enable()}stop(){this.stopMonitor(),super.disable()}getRTCStatsReport(){return pi(this,void 0,void 0,function*(){var e;if(!(null===(e=this.receiver)||void 0===e?void 0:e.getStats))return;return yield this.receiver.getStats()})}setPlayoutDelay(e){this.receiver?"playoutDelayHint"in this.receiver?this.receiver.playoutDelayHint=e:this.log.warn("Playout delay not supported in this browser"):this.log.warn("Cannot set playout delay, track already ended")}getPlayoutDelay(){if(this.receiver){if("playoutDelayHint"in this.receiver)return this.receiver.playoutDelayHint;this.log.warn("Playout delay not supported in this browser")}else this.log.warn("Cannot get playout delay, track already ended");return 0}startMonitor(){this.monitorInterval||(this.monitorInterval=setInterval(()=>this.monitorReceiver(),cr)),"undefined"!=typeof RTCRtpReceiver&&"getSynchronizationSources"in RTCRtpReceiver&&this.registerTimeSyncUpdate()}registerTimeSyncUpdate(){const e=()=>{var t;this.timeSyncHandle=requestAnimationFrame(()=>e());const n=null===(t=this.receiver)||void 0===t?void 0:t.getSynchronizationSources()[0];if(n){const{timestamp:e,rtpTimestamp:t}=n;t&&this.rtpTimestamp!==t&&(this.emit(Uo.TimeSyncUpdate,{timestamp:e,rtpTimestamp:t}),this.rtpTimestamp=t)}};e()}}class Kr extends Gr{constructor(e,t,n,i,o,s){super(e,t,ss.Kind.Audio,n,s),this.monitorReceiver=()=>pi(this,void 0,void 0,function*(){if(!this.receiver)return void(this._currentBitrate=0);const e=yield this.getReceiverStats();e&&this.prevStats&&this.receiver&&(this._currentBitrate=dr(e,this.prevStats)),this.prevStats=e}),this.audioContext=i,this.webAudioPluginNodes=[],o&&(this.sinkId=o.deviceId)}setVolume(e){var t;for(const n of this.attachedElements)this.audioContext?null===(t=this.gainNode)||void 0===t||t.gain.setTargetAtTime(e,0,.1):n.volume=e;Is()&&this._mediaStreamTrack._setVolume(e),this.elementVolume=e}getVolume(){if(this.elementVolume)return this.elementVolume;if(Is())return 1;let e=0;return this.attachedElements.forEach(t=>{t.volume>e&&(e=t.volume)}),e}setSinkId(e){return pi(this,void 0,void 0,function*(){this.sinkId=e,yield Promise.all(this.attachedElements.map(t=>{if(Cs(t))return t.setSinkId(e)}))})}attach(e){const t=0===this.attachedElements.length;return e?super.attach(e):e=super.attach(),this.sinkId&&Cs(e)&&e.setSinkId(this.sinkId).catch(e=>{this.log.error("Failed to set sink id on remote audio track",e,this.logContext)}),this.audioContext&&t&&(this.log.debug("using audio context mapping",this.logContext),this.connectWebAudio(this.audioContext,e),e.volume=0,e.muted=!0),this.elementVolume&&this.setVolume(this.elementVolume),e}detach(e){let t;return e?(t=super.detach(e),this.audioContext&&(this.attachedElements.length>0?this.connectWebAudio(this.audioContext,this.attachedElements[0]):this.disconnectWebAudio())):(t=super.detach(),this.disconnectWebAudio()),t}setAudioContext(e){this.audioContext=e,e&&this.attachedElements.length>0?this.connectWebAudio(e,this.attachedElements[0]):e||this.disconnectWebAudio()}setWebAudioPlugins(e){this.webAudioPluginNodes=e,this.attachedElements.length>0&&this.audioContext&&this.connectWebAudio(this.audioContext,this.attachedElements[0])}connectWebAudio(e,t){this.disconnectWebAudio(),this.sourceNode=e.createMediaStreamSource(t.srcObject);let n=this.sourceNode;this.webAudioPluginNodes.forEach(e=>{n.connect(e),n=e}),this.gainNode=e.createGain(),n.connect(this.gainNode),this.gainNode.connect(e.destination),this.elementVolume&&this.gainNode.gain.setTargetAtTime(this.elementVolume,0,.1),"running"!==e.state&&e.resume().then(()=>{"running"!==e.state&&this.emit(Uo.AudioPlaybackFailed,new Error("Audio Context couldn't be started automatically"))}).catch(e=>{this.emit(Uo.AudioPlaybackFailed,e)})}disconnectWebAudio(){var e,t;null===(e=this.gainNode)||void 0===e||e.disconnect(),null===(t=this.sourceNode)||void 0===t||t.disconnect(),this.gainNode=void 0,this.sourceNode=void 0}getReceiverStats(){return pi(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;let e;return(yield this.receiver.getStats()).forEach(t=>{"inbound-rtp"===t.type&&(e={type:"audio",streamId:t.id,timestamp:t.timestamp,jitter:t.jitter,bytesReceived:t.bytesReceived,concealedSamples:t.concealedSamples,concealmentEvents:t.concealmentEvents,silentConcealedSamples:t.silentConcealedSamples,silentConcealmentEvents:t.silentConcealmentEvents,totalAudioEnergy:t.totalAudioEnergy,totalSamplesDuration:t.totalSamplesDuration})}),e})}}class Jr extends Gr{constructor(e,t,n,i,o){super(e,t,ss.Kind.Video,n,o),this.elementInfos=[],this.monitorReceiver=()=>pi(this,void 0,void 0,function*(){if(!this.receiver)return void(this._currentBitrate=0);const e=yield this.getReceiverStats();e&&this.prevStats&&this.receiver&&(this._currentBitrate=dr(e,this.prevStats)),this.prevStats=e}),this.debouncedHandleResize=za(()=>{this.updateDimensions()},100),this.adaptiveStreamSettings=i}get isAdaptiveStream(){return void 0!==this.adaptiveStreamSettings}setStreamState(e){super.setStreamState(e),console.log("setStreamState",e),e===ss.StreamState.Active&&this.updateVisibility()}get mediaStreamTrack(){return this._mediaStreamTrack}setMuted(e){super.setMuted(e),this.attachedElements.forEach(t=>{e?rs(this._mediaStreamTrack,t):as(this._mediaStreamTrack,t)})}attach(e){if(e?super.attach(e):e=super.attach(),this.adaptiveStreamSettings&&void 0===this.elementInfos.find(t=>t.element===e)){const t=new Yr(e);this.observeElementInfo(t)}return e}observeElementInfo(e){this.adaptiveStreamSettings&&void 0===this.elementInfos.find(t=>t===e)?(e.handleResize=()=>{this.debouncedHandleResize()},e.handleVisibilityChanged=()=>{this.updateVisibility()},this.elementInfos.push(e),e.observe(),this.debouncedHandleResize(),this.updateVisibility()):this.log.warn("visibility resize observer not triggered",this.logContext)}stopObservingElementInfo(e){if(!this.isAdaptiveStream)return void this.log.warn("stopObservingElementInfo ignored",this.logContext);const t=this.elementInfos.filter(t=>t===e);for(const e of t)e.stopObserving();this.elementInfos=this.elementInfos.filter(t=>t!==e),this.updateVisibility(),this.debouncedHandleResize()}detach(e){let t=[];if(e)return this.stopObservingElement(e),super.detach(e);t=super.detach();for(const e of t)this.stopObservingElement(e);return t}getDecoderImplementation(){var e;return null===(e=this.prevStats)||void 0===e?void 0:e.decoderImplementation}getReceiverStats(){return pi(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let t,n="",i=new Map;return e.forEach(e=>{"inbound-rtp"===e.type?(n=e.codecId,t={type:"video",streamId:e.id,framesDecoded:e.framesDecoded,framesDropped:e.framesDropped,framesReceived:e.framesReceived,packetsReceived:e.packetsReceived,packetsLost:e.packetsLost,frameWidth:e.frameWidth,frameHeight:e.frameHeight,pliCount:e.pliCount,firCount:e.firCount,nackCount:e.nackCount,jitter:e.jitter,timestamp:e.timestamp,bytesReceived:e.bytesReceived,decoderImplementation:e.decoderImplementation}):"codec"===e.type&&i.set(e.id,e)}),t&&""!==n&&i.get(n)&&(t.mimeType=i.get(n).mimeType),t})}stopObservingElement(e){const t=this.elementInfos.filter(t=>t.element===e);for(const e of t)this.stopObservingElementInfo(e)}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return pi(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),this.isAdaptiveStream&&this.updateVisibility()})}updateVisibility(e){var t,n;const i=this.elementInfos.reduce((e,t)=>Math.max(e,t.visibilityChangedAt||0),0),o=!(null!==(n=null===(t=this.adaptiveStreamSettings)||void 0===t?void 0:t.pauseVideoInBackground)&&void 0!==n&&!n)&&this.isInBackground,s=this.elementInfos.some(e=>e.pictureInPicture),a=this.elementInfos.some(e=>e.visible)&&!o||s;(this.lastVisible!==a||e)&&(!a&&Date.now()-i<100?ns.setTimeout(()=>{this.updateVisibility()},100):(this.lastVisible=a,this.emit(Uo.VisibilityChanged,a,this)))}updateDimensions(){var e,t;let n=0,i=0;const o=this.getPixelDensity();for(const e of this.elementInfos){const t=e.width()*o,s=e.height()*o;t+s>n+i&&(n=t,i=s)}(null===(e=this.lastDimensions)||void 0===e?void 0:e.width)===n&&(null===(t=this.lastDimensions)||void 0===t?void 0:t.height)===i||(this.lastDimensions={width:n,height:i},this.emit(Uo.VideoDimensionsChanged,this.lastDimensions,this))}getPixelDensity(){var e;const t=null===(e=this.adaptiveStreamSettings)||void 0===e?void 0:e.pixelDensity;if("screen"===t)return Ms();if(!t){return Ms()>2?2:1}return t}}class Yr{get visible(){return this.isPiP||this.isIntersecting}get pictureInPicture(){return this.isPiP}constructor(e,t){this.onVisibilityChanged=e=>{var t;const{target:n,isIntersecting:i}=e;n===this.element&&(this.isIntersecting=i,this.isPiP=$r(this.element),this.visibilityChangedAt=Date.now(),null===(t=this.handleVisibilityChanged)||void 0===t||t.call(this))},this.onEnterPiP=()=>{var e,t,n;null===(t=null===(e=window.documentPictureInPicture)||void 0===e?void 0:e.window)||void 0===t||t.addEventListener("pagehide",this.onLeavePiP),this.isPiP=$r(this.element),null===(n=this.handleVisibilityChanged)||void 0===n||n.call(this)},this.onLeavePiP=()=>{var e;this.isPiP=$r(this.element),null===(e=this.handleVisibilityChanged)||void 0===e||e.call(this)},this.element=e,this.isIntersecting=null!=t?t:Qr(e),this.isPiP=Rs()&&$r(e),this.visibilityChangedAt=0}width(){return this.element.clientWidth}height(){return this.element.clientHeight}observe(){var e,t,n;this.isIntersecting=Qr(this.element),this.isPiP=$r(this.element),this.element.handleResize=()=>{var e;null===(e=this.handleResize)||void 0===e||e.call(this)},this.element.handleVisibilityChanged=this.onVisibilityChanged,Bs().observe(this.element),js().observe(this.element),this.element.addEventListener("enterpictureinpicture",this.onEnterPiP),this.element.addEventListener("leavepictureinpicture",this.onLeavePiP),null===(e=window.documentPictureInPicture)||void 0===e||e.addEventListener("enter",this.onEnterPiP),null===(n=null===(t=window.documentPictureInPicture)||void 0===t?void 0:t.window)||void 0===n||n.addEventListener("pagehide",this.onLeavePiP)}stopObserving(){var e,t,n,i,o;null===(e=Bs())||void 0===e||e.unobserve(this.element),null===(t=js())||void 0===t||t.unobserve(this.element),this.element.removeEventListener("enterpictureinpicture",this.onEnterPiP),this.element.removeEventListener("leavepictureinpicture",this.onLeavePiP),null===(n=window.documentPictureInPicture)||void 0===n||n.removeEventListener("enter",this.onEnterPiP),null===(o=null===(i=window.documentPictureInPicture)||void 0===i?void 0:i.window)||void 0===o||o.removeEventListener("pagehide",this.onLeavePiP)}}function $r(e){var t,n;return document.pictureInPictureElement===e||!!(null===(t=window.documentPictureInPicture)||void 0===t?void 0:t.window)&&Qr(e,null===(n=window.documentPictureInPicture)||void 0===n?void 0:n.window)}function Qr(e,t){const n=t||window;let i=e.offsetTop,o=e.offsetLeft;const s=e.offsetWidth,a=e.offsetHeight,{hidden:r}=e,{display:c}=getComputedStyle(e);for(;e.offsetParent;)i+=(e=e.offsetParent).offsetTop,o+=e.offsetLeft;return i<n.pageYOffset+n.innerHeight&&o<n.pageXOffset+n.innerWidth&&i+a>n.pageYOffset&&o+s>n.pageXOffset&&!r&&"none"!==c}class Xr extends bi.EventEmitter{constructor(e,t,n,i){var o;super(),this.metadataMuted=!1,this.encryption=gt.NONE,this.log=ci,this.handleMuted=()=>{this.emit(Uo.Muted)},this.handleUnmuted=()=>{this.emit(Uo.Unmuted)},this.log=di(null!==(o=null==i?void 0:i.loggerName)&&void 0!==o?o:ai.Publication),this.loggerContextCb=this.loggerContextCb,this.setMaxListeners(100),this.kind=e,this.trackSid=t,this.trackName=n,this.source=ss.Source.Unknown}setTrack(e){this.track&&(this.track.off(Uo.Muted,this.handleMuted),this.track.off(Uo.Unmuted,this.handleUnmuted)),this.track=e,e&&(e.on(Uo.Muted,this.handleMuted),e.on(Uo.Unmuted,this.handleUnmuted))}get logContext(){var e;return Object.assign(Object.assign({},null===(e=this.loggerContextCb)||void 0===e?void 0:e.call(this)),pa(this))}get isMuted(){return this.metadataMuted}get isEnabled(){return!0}get isSubscribed(){return void 0!==this.track}get isEncrypted(){return this.encryption!==gt.NONE}get audioTrack(){if(Qs(this.track))return this.track}get videoTrack(){if(Xs(this.track))return this.track}updateInfo(e){this.trackSid=e.sid,this.trackName=e.name,this.source=ss.sourceFromProto(e.source),this.mimeType=e.mimeType,this.kind===ss.Kind.Video&&e.width>0&&(this.dimensions={width:e.width,height:e.height},this.simulcasted=e.simulcast),this.encryption=e.encryption,this.trackInfo=e,this.log.debug("update publication info",Object.assign(Object.assign({},this.logContext),{info:e}))}}!function(e){var t,n;(t=e.SubscriptionStatus||(e.SubscriptionStatus={})).Desired="desired",t.Subscribed="subscribed",t.Unsubscribed="unsubscribed",(n=e.PermissionStatus||(e.PermissionStatus={})).Allowed="allowed",n.NotAllowed="not_allowed"}(Xr||(Xr={}));class Zr extends Xr{get isUpstreamPaused(){var e;return null===(e=this.track)||void 0===e?void 0:e.isUpstreamPaused}constructor(e,t,n,i){super(e,t.sid,t.name,i),this.track=void 0,this.handleTrackEnded=()=>{this.emit(Uo.Ended)},this.handleCpuConstrained=()=>{this.track&&Xs(this.track)&&this.emit(Uo.CpuConstrained,this.track)},this.updateInfo(t),this.setTrack(n)}setTrack(e){this.track&&(this.track.off(Uo.Ended,this.handleTrackEnded),this.track.off(Uo.CpuConstrained,this.handleCpuConstrained)),super.setTrack(e),e&&(e.on(Uo.Ended,this.handleTrackEnded),e.on(Uo.CpuConstrained,this.handleCpuConstrained))}get isMuted(){return this.track?this.track.isMuted:super.isMuted}get audioTrack(){return super.audioTrack}get videoTrack(){return super.videoTrack}get isLocal(){return!0}mute(){return pi(this,void 0,void 0,function*(){var e;return null===(e=this.track)||void 0===e?void 0:e.mute()})}unmute(){return pi(this,void 0,void 0,function*(){var e;return null===(e=this.track)||void 0===e?void 0:e.unmute()})}pauseUpstream(){return pi(this,void 0,void 0,function*(){var e;yield null===(e=this.track)||void 0===e?void 0:e.pauseUpstream()})}resumeUpstream(){return pi(this,void 0,void 0,function*(){var e;yield null===(e=this.track)||void 0===e?void 0:e.resumeUpstream()})}getTrackFeatures(){var e;if(Qs(this.track)){const t=this.track.getSourceTrackSettings(),n=new Set;return t.autoGainControl&&n.add(rt.TF_AUTO_GAIN_CONTROL),t.echoCancellation&&n.add(rt.TF_ECHO_CANCELLATION),t.noiseSuppression&&n.add(rt.TF_NOISE_SUPPRESSION),t.channelCount&&t.channelCount>1&&n.add(rt.TF_STEREO),(null===(e=this.options)||void 0===e?void 0:e.dtx)||n.add(rt.TF_NO_DTX),this.track.enhancedNoiseCancellation&&n.add(rt.TF_ENHANCED_NOISE_CANCELLATION),Array.from(n.values())}return[]}}function ec(e,t){return pi(this,void 0,void 0,function*(){null!=e||(e={});let n=!1;const{audioProcessor:i,videoProcessor:o,optionsWithoutProcessor:s}=ma(e);let a=s.audio,r=s.video;if(i&&"object"==typeof s.audio&&(s.audio.processor=i),o&&"object"==typeof s.video&&(s.video.processor=o),e.audio&&"object"==typeof s.audio&&"string"==typeof s.audio.deviceId){const e=s.audio.deviceId;s.audio.deviceId={exact:e},n=!0,a=Object.assign(Object.assign({},s.audio),{deviceId:{ideal:e}})}if(s.video&&"object"==typeof s.video&&"string"==typeof s.video.deviceId){const e=s.video.deviceId;s.video.deviceId={exact:e},n=!0,r=Object.assign(Object.assign({},s.video),{deviceId:{ideal:e}})}(!0===s.audio||"object"==typeof s.audio&&!s.audio.deviceId)&&(s.audio={deviceId:"default"}),!0===s.video?s.video={deviceId:"default"}:"object"!=typeof s.video||s.video.deviceId||(s.video.deviceId="default");const c=oa(s,Za,er),d=aa(c),l=navigator.mediaDevices.getUserMedia(d);s.audio&&(ba.userMediaPromiseMap.set("audioinput",l),l.catch(()=>ba.userMediaPromiseMap.delete("audioinput"))),s.video&&(ba.userMediaPromiseMap.set("videoinput",l),l.catch(()=>ba.userMediaPromiseMap.delete("videoinput")));try{const e=yield l;return yield Promise.all(e.getTracks().map(n=>pi(this,void 0,void 0,function*(){const s="audio"===n.kind;let a,r=s?c.audio:c.video;"boolean"!=typeof r&&r||(r={});const l=s?d.audio:d.video;"boolean"!=typeof l&&(a=l);const u=n.getSettings().deviceId;(null==a?void 0:a.deviceId)&&Ws(a.deviceId)!==u?a.deviceId=u:a||(a={deviceId:u});const h=function(e,t,n){switch(e.kind){case"audio":return new mr(e,t,!1,void 0,n);case"video":return new xr(e,t,!1,n);default:throw new zo("unsupported track type: ".concat(e.kind))}}(n,a,t);return h.kind===ss.Kind.Video?h.source=ss.Source.Camera:h.kind===ss.Kind.Audio&&(h.source=ss.Source.Microphone),h.mediaStream=e,Qs(h)&&i?yield h.setProcessor(i):Xs(h)&&o&&(yield h.setProcessor(o)),h})))}catch(i){if(!n)throw i;return ec(Object.assign(Object.assign({},e),{audio:a,video:r}),t)}})}var tc,nc;!function(e){e.Excellent="excellent",e.Good="good",e.Poor="poor",e.Lost="lost",e.Unknown="unknown"}(tc||(tc={}));class ic extends bi.EventEmitter{get logContext(){var e,t;return Object.assign({},null===(t=null===(e=this.loggerOptions)||void 0===e?void 0:e.loggerContextCb)||void 0===t?void 0:t.call(e))}get isEncrypted(){return this.trackPublications.size>0&&Array.from(this.trackPublications.values()).every(e=>e.isEncrypted)}get isAgent(){var e;return(null===(e=this.permissions)||void 0===e?void 0:e.agent)||this.kind===pt.AGENT}get isActive(){var e;return(null===(e=this.participantInfo)||void 0===e?void 0:e.state)===ht.ACTIVE}get kind(){return this._kind}get attributes(){return Object.freeze(Object.assign({},this._attributes))}constructor(e,t,n,i,o,s){let a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:pt.STANDARD;var r;super(),this.audioLevel=0,this.isSpeaking=!1,this._connectionQuality=tc.Unknown,this.log=ci,this.log=di(null!==(r=null==s?void 0:s.loggerName)&&void 0!==r?r:ai.Participant),this.loggerOptions=s,this.setMaxListeners(100),this.sid=e,this.identity=t,this.name=n,this.metadata=i,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this._kind=a,this._attributes=null!=o?o:{}}getTrackPublications(){return Array.from(this.trackPublications.values())}getTrackPublication(e){for(const[,t]of this.trackPublications)if(t.source===e)return t}getTrackPublicationByName(e){for(const[,t]of this.trackPublications)if(t.trackName===e)return t}waitUntilActive(){return this.isActive?Promise.resolve():(this.activeFuture||(this.activeFuture=new Hs,this.once(No.Active,()=>{var e,t;null===(t=null===(e=this.activeFuture)||void 0===e?void 0:e.resolve)||void 0===t||t.call(e),this.activeFuture=void 0})),this.activeFuture.promise)}get connectionQuality(){return this._connectionQuality}get isCameraEnabled(){var e;const t=this.getTrackPublication(ss.Source.Camera);return!(null===(e=null==t?void 0:t.isMuted)||void 0===e||e)}get isMicrophoneEnabled(){var e;const t=this.getTrackPublication(ss.Source.Microphone);return!(null===(e=null==t?void 0:t.isMuted)||void 0===e||e)}get isScreenShareEnabled(){return!!this.getTrackPublication(ss.Source.ScreenShare)}get isLocal(){return!1}get joinedAt(){return this.participantInfo?new Date(1e3*Number.parseInt(this.participantInfo.joinedAt.toString())):new Date}updateInfo(e){var t;return!(this.participantInfo&&this.participantInfo.sid===e.sid&&this.participantInfo.version>e.version)&&(this.identity=e.identity,this.sid=e.sid,this._setName(e.name),this._setMetadata(e.metadata),this._setAttributes(e.attributes),e.state===ht.ACTIVE&&(null===(t=this.participantInfo)||void 0===t?void 0:t.state)!==ht.ACTIVE&&this.emit(No.Active),e.permission&&this.setPermissions(e.permission),this.participantInfo=e,!0)}_setMetadata(e){const t=this.metadata!==e,n=this.metadata;this.metadata=e,t&&this.emit(No.ParticipantMetadataChanged,n)}_setName(e){const t=this.name!==e;this.name=e,t&&this.emit(No.ParticipantNameChanged,e)}_setAttributes(e){const t=function(e,t){var n;void 0===e&&(e={}),void 0===t&&(t={});const i=[...Object.keys(t),...Object.keys(e)],o={};for(const s of i)e[s]!==t[s]&&(o[s]=null!==(n=t[s])&&void 0!==n?n:"");return o}(this.attributes,e);this._attributes=e,Object.keys(t).length>0&&this.emit(No.AttributesChanged,t)}setPermissions(e){var t,n,i,o,s,a;const r=this.permissions,c=e.canPublish!==(null===(t=this.permissions)||void 0===t?void 0:t.canPublish)||e.canSubscribe!==(null===(n=this.permissions)||void 0===n?void 0:n.canSubscribe)||e.canPublishData!==(null===(i=this.permissions)||void 0===i?void 0:i.canPublishData)||e.hidden!==(null===(o=this.permissions)||void 0===o?void 0:o.hidden)||e.recorder!==(null===(s=this.permissions)||void 0===s?void 0:s.recorder)||e.canPublishSources.length!==this.permissions.canPublishSources.length||e.canPublishSources.some((e,t)=>{var n;return e!==(null===(n=this.permissions)||void 0===n?void 0:n.canPublishSources[t])})||e.canSubscribeMetrics!==(null===(a=this.permissions)||void 0===a?void 0:a.canSubscribeMetrics);return this.permissions=e,c&&this.emit(No.ParticipantPermissionsChanged,r),c}setIsSpeaking(e){e!==this.isSpeaking&&(this.isSpeaking=e,e&&(this.lastSpokeAt=new Date),this.emit(No.IsSpeakingChanged,e))}setConnectionQuality(e){const t=this._connectionQuality;this._connectionQuality=function(e){switch(e){case nt.EXCELLENT:return tc.Excellent;case nt.GOOD:return tc.Good;case nt.POOR:return tc.Poor;case nt.LOST:return tc.Lost;default:return tc.Unknown}}(e),t!==this._connectionQuality&&this.emit(No.ConnectionQualityChanged,this._connectionQuality)}setDisconnected(){var e,t;this.activeFuture&&(null===(t=(e=this.activeFuture).reject)||void 0===t||t.call(e,new Error("Participant disconnected")),this.activeFuture=void 0)}setAudioContext(e){this.audioContext=e,this.audioTrackPublications.forEach(t=>Qs(t.track)&&t.track.setAudioContext(e))}addTrackPublication(e){e.on(Uo.Muted,()=>{this.emit(No.TrackMuted,e)}),e.on(Uo.Unmuted,()=>{this.emit(No.TrackUnmuted,e)});const t=e;switch(t.track&&(t.track.sid=e.trackSid),this.trackPublications.set(e.trackSid,e),e.kind){case ss.Kind.Audio:this.audioTrackPublications.set(e.trackSid,e);break;case ss.Kind.Video:this.videoTrackPublications.set(e.trackSid,e)}}}class oc extends ic{constructor(e,t,n,i,o,s){super(e,t,void 0,void 0,void 0,{loggerName:i.loggerName,loggerContextCb:()=>this.engine.logContext}),this.pendingPublishing=new Set,this.pendingPublishPromises=new Map,this.participantTrackPermissions=[],this.allParticipantsAllowedToSubscribe=!0,this.encryptionType=gt.NONE,this.enabledPublishVideoCodecs=[],this.pendingAcks=new Map,this.pendingResponses=new Map,this.handleReconnecting=()=>{this.reconnectFuture||(this.reconnectFuture=new Hs)},this.handleReconnected=()=>{var e,t;null===(t=null===(e=this.reconnectFuture)||void 0===e?void 0:e.resolve)||void 0===t||t.call(e),this.reconnectFuture=void 0,this.updateTrackSubscriptionPermissions()},this.handleClosing=()=>{var e,t,n,i,o,s;this.reconnectFuture&&(this.reconnectFuture.promise.catch(e=>this.log.warn(e.message,this.logContext)),null===(t=null===(e=this.reconnectFuture)||void 0===e?void 0:e.reject)||void 0===t||t.call(e,"Got disconnected during reconnection attempt"),this.reconnectFuture=void 0),this.signalConnectedFuture&&(null===(i=(n=this.signalConnectedFuture).reject)||void 0===i||i.call(n,"Got disconnected without signal connected"),this.signalConnectedFuture=void 0),null===(s=null===(o=this.activeAgentFuture)||void 0===o?void 0:o.reject)||void 0===s||s.call(o,"Got disconnected without active agent present"),this.activeAgentFuture=void 0,this.firstActiveAgent=void 0},this.handleSignalConnected=e=>{var t,n;e.participant&&this.updateInfo(e.participant),this.signalConnectedFuture||(this.signalConnectedFuture=new Hs),null===(n=(t=this.signalConnectedFuture).resolve)||void 0===n||n.call(t)},this.handleSignalRequestResponse=e=>{const{requestId:t,reason:n,message:i}=e,o=this.pendingSignalRequests.get(t);o&&(n!==Gn.OK&&o.reject(new Jo(i,n)),this.pendingSignalRequests.delete(t))},this.handleDataPacket=e=>{switch(e.value.case){case"rpcResponse":let t=e.value.value,n=null,i=null;"payload"===t.value.case?n=t.value.value:"error"===t.value.case&&(i=sr.fromProto(t.value.value)),this.handleIncomingRpcResponse(t.requestId,n,i);break;case"rpcAck":let o=e.value.value;this.handleIncomingRpcAck(o.requestId)}},this.updateTrackSubscriptionPermissions=()=>{this.log.debug("updating track subscription permissions",Object.assign(Object.assign({},this.logContext),{allParticipantsAllowed:this.allParticipantsAllowedToSubscribe,participantTrackPermissions:this.participantTrackPermissions})),this.engine.client.sendUpdateSubscriptionPermissions(this.allParticipantsAllowedToSubscribe,this.participantTrackPermissions.map(e=>function(e){var t,n,i;if(!e.participantSid&&!e.participantIdentity)throw new Error("Invalid track permission, must provide at least one of participantIdentity and participantSid");return new Dn({participantIdentity:null!==(t=e.participantIdentity)&&void 0!==t?t:"",participantSid:null!==(n=e.participantSid)&&void 0!==n?n:"",allTracks:null!==(i=e.allowAll)&&void 0!==i&&i,trackSids:e.allowedTrackSids||[]})}(e)))},this.onTrackUnmuted=e=>{this.onTrackMuted(e,e.isUpstreamPaused)},this.onTrackMuted=(e,t)=>{void 0===t&&(t=!0),e.sid?this.engine.updateMuteStatus(e.sid,t):this.log.error("could not update mute status for unpublished track",Object.assign(Object.assign({},this.logContext),pa(e)))},this.onTrackUpstreamPaused=e=>{this.log.debug("upstream paused",Object.assign(Object.assign({},this.logContext),pa(e))),this.onTrackMuted(e,!0)},this.onTrackUpstreamResumed=e=>{this.log.debug("upstream resumed",Object.assign(Object.assign({},this.logContext),pa(e))),this.onTrackMuted(e,e.isMuted)},this.onTrackFeatureUpdate=e=>{const t=this.audioTrackPublications.get(e.sid);t?this.engine.client.sendUpdateLocalAudioTrack(t.trackSid,t.getTrackFeatures()):this.log.warn("Could not update local audio track settings, missing publication for track ".concat(e.sid),this.logContext)},this.onTrackCpuConstrained=(e,t)=>{this.log.debug("track cpu constrained",Object.assign(Object.assign({},this.logContext),pa(t))),this.emit(No.LocalTrackCpuConstrained,e,t)},this.handleSubscribedQualityUpdate=e=>pi(this,void 0,void 0,function*(){var t,n,i,o,s;if(!(null===(s=this.roomOptions)||void 0===s?void 0:s.dynacast))return;const a=this.videoTrackPublications.get(e.trackSid);if(!a)return void this.log.warn("received subscribed quality update for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:e.trackSid}));if(!a.videoTrack)return;const r=yield a.videoTrack.setPublishingCodecs(e.subscribedCodecs);try{for(var c,d=!0,l=gi(r);!(t=(c=yield l.next()).done);d=!0){o=c.value,d=!1;const e=o;us(e)&&(this.log.debug("publish ".concat(e," for ").concat(a.videoTrack.sid),Object.assign(Object.assign({},this.logContext),pa(a))),yield this.publishAdditionalCodecForTrack(a.videoTrack,e,a.options))}}catch(e){n={error:e}}finally{try{d||t||!(i=l.return)||(yield i.call(l))}finally{if(n)throw n.error}}}),this.handleLocalTrackUnpublished=e=>{const t=this.trackPublications.get(e.trackSid);t?this.unpublishTrack(t.track):this.log.warn("received unpublished event for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:e.trackSid}))},this.handleTrackEnded=e=>pi(this,void 0,void 0,function*(){if(e.source===ss.Source.ScreenShare||e.source===ss.Source.ScreenShareAudio)this.log.debug("unpublishing local track due to TrackEnded",Object.assign(Object.assign({},this.logContext),pa(e))),this.unpublishTrack(e);else if(e.isUserProvided)yield e.mute();else if(ea(e)||Zs(e))try{if(Rs())try{const t=yield null===navigator||void 0===navigator?void 0:navigator.permissions.query({name:e.source===ss.Source.Camera?"camera":"microphone"});if(t&&"denied"===t.state)throw this.log.warn("user has revoked access to ".concat(e.source),Object.assign(Object.assign({},this.logContext),pa(e))),t.onchange=()=>{"denied"!==t.state&&(e.isMuted||e.restartTrack(),t.onchange=null)},new Error("GetUserMedia Permission denied")}catch(e){}e.isMuted||(this.log.debug("track ended, attempting to use a different device",Object.assign(Object.assign({},this.logContext),pa(e))),ea(e)?yield e.restartTrack({deviceId:"default"}):yield e.restartTrack())}catch(t){this.log.warn("could not restart track, muting instead",Object.assign(Object.assign({},this.logContext),pa(e))),yield e.mute()}}),this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this.engine=n,this.roomOptions=i,this.setupEngine(n),this.activeDeviceMap=new Map([["audioinput","default"],["videoinput","default"],["audiooutput","default"]]),this.pendingSignalRequests=new Map,this.rpcHandlers=o,this.roomOutgoingDataStreamManager=s}get lastCameraError(){return this.cameraError}get lastMicrophoneError(){return this.microphoneError}get isE2EEEnabled(){return this.encryptionType!==gt.NONE}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setupEngine(e){var t;this.engine=e,this.engine.on(Lo.RemoteMute,(e,t)=>{const n=this.trackPublications.get(e);n&&n.track&&(t?n.mute():n.unmute())}),(null===(t=this.signalConnectedFuture)||void 0===t?void 0:t.isResolved)&&(this.signalConnectedFuture=void 0),this.engine.on(Lo.Connected,this.handleReconnected).on(Lo.SignalConnected,this.handleSignalConnected).on(Lo.SignalRestarted,this.handleReconnected).on(Lo.SignalResumed,this.handleReconnected).on(Lo.Restarting,this.handleReconnecting).on(Lo.Resuming,this.handleReconnecting).on(Lo.LocalTrackUnpublished,this.handleLocalTrackUnpublished).on(Lo.SubscribedQualityUpdate,this.handleSubscribedQualityUpdate).on(Lo.Closing,this.handleClosing).on(Lo.SignalRequestResponse,this.handleSignalRequestResponse).on(Lo.DataPacketReceived,this.handleDataPacket)}setMetadata(e){return pi(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({metadata:e})})}setName(e){return pi(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({name:e})})}setAttributes(e){return pi(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({attributes:e})})}requestMetadataUpdate(e){return pi(this,arguments,void 0,function(e){var t=this;let{metadata:n,name:i,attributes:o}=e;return function*(){return new Promise((e,s)=>pi(t,void 0,void 0,function*(){var t,a;try{let r=!1;const c=yield this.engine.client.sendUpdateLocalMetadata(null!==(t=null!=n?n:this.metadata)&&void 0!==t?t:"",null!==(a=null!=i?i:this.name)&&void 0!==a?a:"",o),d=performance.now();for(this.pendingSignalRequests.set(c,{resolve:e,reject:e=>{s(e),r=!0},values:{name:i,metadata:n,attributes:o}});performance.now()-d<5e3&&!r;){if((!i||this.name===i)&&(!n||this.metadata===n)&&(!o||Object.entries(o).every(e=>{let[t,n]=e;return this.attributes[t]===n||""===n&&!this.attributes[t]})))return this.pendingSignalRequests.delete(c),void e();yield bs(50)}s(new Jo("Request to update local metadata timed out","TimeoutError"))}catch(e){e instanceof Error&&s(e)}}))}()})}setCameraEnabled(e,t,n){return this.setTrackEnabled(ss.Source.Camera,e,t,n)}setMicrophoneEnabled(e,t,n){return this.setTrackEnabled(ss.Source.Microphone,e,t,n)}setScreenShareEnabled(e,t,n){return this.setTrackEnabled(ss.Source.ScreenShare,e,t,n)}setE2EEEnabled(e){return pi(this,void 0,void 0,function*(){this.encryptionType=e?gt.GCM:gt.NONE,yield this.republishAllTracks(void 0,!1)})}setTrackEnabled(e,t,n,i){return pi(this,void 0,void 0,function*(){var o,s;this.log.debug("setTrackEnabled",Object.assign(Object.assign({},this.logContext),{source:e,enabled:t})),this.republishPromise&&(yield this.republishPromise);let a=this.getTrackPublication(e);if(t)if(a)yield a.unmute();else{let t;if(this.pendingPublishing.has(e)){const t=yield this.waitForPendingPublicationOfSource(e);return t||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:e})),yield null==t?void 0:t.unmute(),t}this.pendingPublishing.add(e);try{switch(e){case ss.Source.Camera:t=yield this.createTracks({video:null===(o=n)||void 0===o||o});break;case ss.Source.Microphone:t=yield this.createTracks({audio:null===(s=n)||void 0===s||s});break;case ss.Source.ScreenShare:t=yield this.createScreenTracks(Object.assign({},n));break;default:throw new zo(e)}}catch(n){throw null==t||t.forEach(e=>{e.stop()}),n instanceof Error&&this.emit(No.MediaDevicesError,n,la(e)),this.pendingPublishing.delete(e),n}for(const i of t){const t=Object.assign(Object.assign({},this.roomOptions.publishDefaults),n);e===ss.Source.Microphone&&Qs(i)&&t.preConnectBuffer&&(this.log.info("starting preconnect buffer for microphone",Object.assign({},this.logContext)),i.startPreConnectBuffer())}try{const e=[];for(const n of t)this.log.info("publishing track",Object.assign(Object.assign({},this.logContext),pa(n))),e.push(this.publishTrack(n,i));const n=yield Promise.all(e);[a]=n}catch(e){throw null==t||t.forEach(e=>{e.stop()}),e}finally{this.pendingPublishing.delete(e)}}else if(!(null==a?void 0:a.track)&&this.pendingPublishing.has(e)&&(a=yield this.waitForPendingPublicationOfSource(e),a||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:e}))),a&&a.track)if(e===ss.Source.ScreenShare){a=yield this.unpublishTrack(a.track);const e=this.getTrackPublication(ss.Source.ScreenShareAudio);e&&e.track&&this.unpublishTrack(e.track)}else yield a.mute();return a})}enableCameraAndMicrophone(){return pi(this,void 0,void 0,function*(){if(!this.pendingPublishing.has(ss.Source.Camera)&&!this.pendingPublishing.has(ss.Source.Microphone)){this.pendingPublishing.add(ss.Source.Camera),this.pendingPublishing.add(ss.Source.Microphone);try{const e=yield this.createTracks({audio:!0,video:!0});yield Promise.all(e.map(e=>this.publishTrack(e)))}finally{this.pendingPublishing.delete(ss.Source.Camera),this.pendingPublishing.delete(ss.Source.Microphone)}}})}createTracks(e){return pi(this,void 0,void 0,function*(){var t,n;null!=e||(e={});const i=oa(e,null===(t=this.roomOptions)||void 0===t?void 0:t.audioCaptureDefaults,null===(n=this.roomOptions)||void 0===n?void 0:n.videoCaptureDefaults);try{const e=yield ec(i,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});return e.map(e=>(Qs(e)&&(this.microphoneError=void 0,e.setAudioContext(this.audioContext),e.source=ss.Source.Microphone,this.emit(No.AudioStreamAcquired)),Xs(e)&&(this.cameraError=void 0,e.source=ss.Source.Camera),e))}catch(t){throw t instanceof Error&&(e.audio&&(this.microphoneError=t),e.video&&(this.cameraError=t)),t}})}createScreenTracks(e){return pi(this,void 0,void 0,function*(){if(void 0===e&&(e={}),void 0===navigator.mediaDevices.getDisplayMedia)throw new Vo("getDisplayMedia not supported");void 0!==e.resolution||function(){const e=Xo();return"Safari"===(null==e?void 0:e.name)&&e.version.startsWith("17.")||"iOS"===(null==e?void 0:e.os)&&!!(null==e?void 0:e.osVersion)&&As(e.osVersion,"17")>=0}()||(e.resolution=fs.h1080fps30.resolution);const t=function(e){var t,n;let i=null===(t=e.video)||void 0===t||t;return e.resolution&&e.resolution.width>0&&e.resolution.height>0&&(i="boolean"==typeof i?{}:i,i=Es()?Object.assign(Object.assign({},i),{width:{max:e.resolution.width},height:{max:e.resolution.height},frameRate:e.resolution.frameRate}):Object.assign(Object.assign({},i),{width:{ideal:e.resolution.width},height:{ideal:e.resolution.height},frameRate:e.resolution.frameRate})),{audio:null!==(n=e.audio)&&void 0!==n&&n,video:i,controller:e.controller,selfBrowserSurface:e.selfBrowserSurface,surfaceSwitching:e.surfaceSwitching,systemAudio:e.systemAudio,preferCurrentTab:e.preferCurrentTab}}(e),n=yield navigator.mediaDevices.getDisplayMedia(t),i=n.getVideoTracks();if(0===i.length)throw new zo("no video track found");const o=new xr(i[0],void 0,!1,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});o.source=ss.Source.ScreenShare,e.contentHint&&(o.mediaStreamTrack.contentHint=e.contentHint);const s=[o];if(n.getAudioTracks().length>0){this.emit(No.AudioStreamAcquired);const e=new mr(n.getAudioTracks()[0],void 0,!1,this.audioContext,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});e.source=ss.Source.ScreenShareAudio,s.push(e)}return s})}publishTrack(e,t){return pi(this,void 0,void 0,function*(){return this.publishOrRepublishTrack(e,t)})}publishOrRepublishTrack(e,t){return pi(this,arguments,void 0,function(e,t){var n=this;let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return function*(){var o,s,a,r;let c,d;if(ea(e)&&e.setAudioContext(n.audioContext),yield null===(o=n.reconnectFuture)||void 0===o?void 0:o.promise,n.republishPromise&&!i&&(yield n.republishPromise),$s(e)&&n.pendingPublishPromises.has(e)&&(yield n.pendingPublishPromises.get(e)),e instanceof MediaStreamTrack)c=e.getConstraints();else{let t;switch(c=e.constraints,e.source){case ss.Source.Microphone:t="audioinput";break;case ss.Source.Camera:t="videoinput"}t&&n.activeDeviceMap.has(t)&&(c=Object.assign(Object.assign({},c),{deviceId:n.activeDeviceMap.get(t)}))}if(e instanceof MediaStreamTrack)switch(e.kind){case"audio":e=new mr(e,c,!0,n.audioContext,{loggerName:n.roomOptions.loggerName,loggerContextCb:()=>n.logContext});break;case"video":e=new xr(e,c,!0,{loggerName:n.roomOptions.loggerName,loggerContextCb:()=>n.logContext});break;default:throw new zo("unsupported MediaStreamTrack kind ".concat(e.kind))}else e.updateLoggerOptions({loggerName:n.roomOptions.loggerName,loggerContextCb:()=>n.logContext});if(n.trackPublications.forEach(t=>{t.track&&t.track===e&&(d=t)}),d)return n.log.warn("track has already been published, skipping",Object.assign(Object.assign({},n.logContext),pa(d))),d;const l=Object.assign(Object.assign({},n.roomOptions.publishDefaults),t),u="channelCount"in e.mediaStreamTrack.getSettings()&&2===e.mediaStreamTrack.getSettings().channelCount||2===e.mediaStreamTrack.getConstraints().channelCount,h=null!==(s=l.forceStereo)&&void 0!==s?s:u;h&&(void 0===l.dtx&&n.log.info("Opus DTX will be disabled for stereo tracks by default. Enable them explicitly to make it work.",Object.assign(Object.assign({},n.logContext),pa(e))),void 0===l.red&&n.log.info("Opus RED will be disabled for stereo tracks by default. Enable them explicitly to make it work."),null!==(a=l.dtx)&&void 0!==a||(l.dtx=!1),null!==(r=l.red)&&void 0!==r||(l.red=!1)),!function(){const e=Xo(),t="17.2";if(e)return"Safari"!==e.name&&"iOS"!==e.os||!!("iOS"===e.os&&e.osVersion&&As(e.osVersion,t)>=0)||"Safari"===e.name&&As(e.version,t)>=0}()&&n.roomOptions.e2ee&&(n.log.info("End-to-end encryption is set up, simulcast publishing will be disabled on Safari versions and iOS browsers running iOS < v17.2",Object.assign({},n.logContext)),l.simulcast=!1),l.source&&(e.source=l.source);const p=new Promise((t,i)=>pi(n,void 0,void 0,function*(){try{if(this.engine.client.currentState!==Ea.CONNECTED){this.log.debug("deferring track publication until signal is connected",Object.assign(Object.assign({},this.logContext),{track:pa(e)}));const n=setTimeout(()=>{i(new Ko("publishing rejected as engine not connected within timeout",408))},15e3);yield this.waitUntilEngineConnected(),clearTimeout(n);const o=yield this.publish(e,l,h);t(o)}else try{const n=yield this.publish(e,l,h);t(n)}catch(e){i(e)}}catch(e){i(e)}}));n.pendingPublishPromises.set(e,p);try{return yield p}catch(e){throw e}finally{n.pendingPublishPromises.delete(e)}}()})}waitUntilEngineConnected(){return this.signalConnectedFuture||(this.signalConnectedFuture=new Hs),this.signalConnectedFuture.promise}hasPermissionsToPublish(e){if(!this.permissions)return this.log.warn("no permissions present for publishing track",Object.assign(Object.assign({},this.logContext),pa(e))),!1;const{canPublish:t,canPublishSources:n}=this.permissions;return!(!t||0!==n.length&&!n.map(e=>function(e){switch(e){case et.CAMERA:return ss.Source.Camera;case et.MICROPHONE:return ss.Source.Microphone;case et.SCREEN_SHARE:return ss.Source.ScreenShare;case et.SCREEN_SHARE_AUDIO:return ss.Source.ScreenShareAudio;default:return ss.Source.Unknown}}(e)).includes(e.source))||(this.log.warn("insufficient permissions to publish",Object.assign(Object.assign({},this.logContext),pa(e))),!1)}publish(e,t,n){return pi(this,void 0,void 0,function*(){var i,o,s,a,r,c,d,l,u,h;if(!this.hasPermissionsToPublish(e))throw new Ko("failed to publish track, insufficient permissions",403);Array.from(this.trackPublications.values()).find(t=>$s(e)&&t.source===e.source)&&e.source!==ss.Source.Unknown&&this.log.info("publishing a second track with the same source: ".concat(e.source),Object.assign(Object.assign({},this.logContext),pa(e))),t.stopMicTrackOnMute&&Qs(e)&&(e.stopOnMute=!0),e.source===ss.Source.ScreenShare&&Ss()&&(t.simulcast=!1),"av1"!==t.videoCodec||function(){if(!("getCapabilities"in RTCRtpSender))return!1;if(Es()||Ss())return!1;const e=RTCRtpSender.getCapabilities("video");let t=!1;if(e)for(const n of e.codecs)if("video/av1"===n.mimeType.toLowerCase()){t=!0;break}return t}()||(t.videoCodec=void 0),"vp9"!==t.videoCodec||function(){if(!("getCapabilities"in RTCRtpSender))return!1;if(Ss())return!1;if(Es()){const e=Xo();if((null==e?void 0:e.version)&&As(e.version,"16")<0)return!1;if("iOS"===(null==e?void 0:e.os)&&(null==e?void 0:e.osVersion)&&As(e.osVersion,"16")<0)return!1}const e=RTCRtpSender.getCapabilities("video");let t=!1;if(e)for(const n of e.codecs)if("video/vp9"===n.mimeType.toLowerCase()){t=!0;break}return t}()||(t.videoCodec=void 0),void 0===t.videoCodec&&(t.videoCodec=Qa),this.enabledPublishVideoCodecs.length>0&&(this.enabledPublishVideoCodecs.some(e=>t.videoCodec===ua(e.mime))||(t.videoCodec=ua(this.enabledPublishVideoCodecs[0].mime)));const p=t.videoCodec;e.on(Uo.Muted,this.onTrackMuted),e.on(Uo.Unmuted,this.onTrackUnmuted),e.on(Uo.Ended,this.handleTrackEnded),e.on(Uo.UpstreamPaused,this.onTrackUpstreamPaused),e.on(Uo.UpstreamResumed,this.onTrackUpstreamResumed),e.on(Uo.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate);const m=[],g=!(null===(i=t.dtx)||void 0===i||i),f=e.getSourceTrackSettings();f.autoGainControl&&m.push(rt.TF_AUTO_GAIN_CONTROL),f.echoCancellation&&m.push(rt.TF_ECHO_CANCELLATION),f.noiseSuppression&&m.push(rt.TF_NOISE_SUPPRESSION),f.channelCount&&f.channelCount>1&&m.push(rt.TF_STEREO),g&&m.push(rt.TF_NO_DTX),ea(e)&&e.hasPreConnectBuffer&&m.push(rt.TF_PRECONNECT_BUFFER);const v=new on({cid:e.mediaStreamTrack.id,name:t.name,type:ss.kindToProto(e.kind),muted:e.isMuted,source:ss.sourceToProto(e.source),disableDtx:g,encryption:this.encryptionType,stereo:n,disableRed:this.isE2EEEnabled||!(null===(o=t.red)||void 0===o||o),stream:null==t?void 0:t.stream,backupCodecPolicy:null==t?void 0:t.backupCodecPolicy,audioFeatures:m});let b;if(e.kind===ss.Kind.Video){let n={width:0,height:0};try{n=yield e.waitForDimensions()}catch(t){const i=null!==(a=null===(s=this.roomOptions.videoCaptureDefaults)||void 0===s?void 0:s.resolution)&&void 0!==a?a:ms.h720.resolution;n={width:i.width,height:i.height},this.log.error("could not determine track dimensions, using defaults",Object.assign(Object.assign(Object.assign({},this.logContext),pa(e)),{dims:n}))}v.width=n.width,v.height=n.height,Zs(e)&&(Ts(p)&&(e.source===ss.Source.ScreenShare&&(t.scalabilityMode="L1T3","contentHint"in e.mediaStreamTrack&&(e.mediaStreamTrack.contentHint="motion",this.log.info("forcing contentHint to motion for screenshare with SVC codecs",Object.assign(Object.assign({},this.logContext),pa(e))))),t.scalabilityMode=null!==(r=t.scalabilityMode)&&void 0!==r?r:"L3T3_KEY"),v.simulcastCodecs=[new nn({codec:p,cid:e.mediaStreamTrack.id})],!0===t.backupCodec&&(t.backupCodec={codec:Qa}),t.backupCodec&&p!==t.backupCodec.codec&&v.encryption===gt.NONE&&(this.roomOptions.dynacast||(this.roomOptions.dynacast=!0),v.simulcastCodecs.push(new nn({codec:t.backupCodec.codec,cid:""})))),b=Tr(e.source===ss.Source.ScreenShare,v.width,v.height,t),v.layers=Ir(v.width,v.height,b,Ts(t.videoCodec))}else e.kind===ss.Kind.Audio&&(b=[{maxBitrate:null===(c=t.audioPreset)||void 0===c?void 0:c.maxBitrate,priority:null!==(l=null===(d=t.audioPreset)||void 0===d?void 0:d.priority)&&void 0!==l?l:"high",networkPriority:null!==(h=null===(u=t.audioPreset)||void 0===u?void 0:u.priority)&&void 0!==h?h:"high"}]);if(!this.engine||this.engine.isClosed)throw new Wo("cannot publish track when not connected");const y=()=>pi(this,void 0,void 0,function*(){var n,i,o;if(!this.engine.pcManager)throw new Wo("pcManager is not ready");if(e.sender=yield this.engine.createSender(e,t,b),this.emit(No.LocalSenderCreated,e.sender,e),Zs(e)&&(null!==(n=t.degradationPreference)&&void 0!==n||(t.degradationPreference=function(e){return e.source===ss.Source.ScreenShare||e.constraints.height&&Ws(e.constraints.height)>=1080?"maintain-resolution":"balanced"}(e)),e.setDegradationPreference(t.degradationPreference)),b)if(Ss()&&e.kind===ss.Kind.Audio){let t;for(const n of this.engine.pcManager.publisher.getTransceivers())if(n.sender===e.sender){t=n;break}t&&this.engine.pcManager.publisher.setTrackCodecBitrate({transceiver:t,codec:"opus",maxbr:(null===(i=b[0])||void 0===i?void 0:i.maxBitrate)?b[0].maxBitrate/1e3:0})}else e.codec&&Ts(e.codec)&&(null===(o=b[0])||void 0===o?void 0:o.maxBitrate)&&this.engine.pcManager.publisher.setTrackCodecBitrate({cid:v.cid,codec:e.codec,maxbr:b[0].maxBitrate/1e3});yield this.engine.negotiate()});let k;const T=new Promise((t,n)=>pi(this,void 0,void 0,function*(){var i;try{k=yield this.engine.addTrack(v),t(k)}catch(t){e.sender&&(null===(i=this.engine.pcManager)||void 0===i?void 0:i.publisher)&&(this.engine.pcManager.publisher.removeTrack(e.sender),yield this.engine.negotiate().catch(t=>{this.log.error("failed to negotiate after removing track due to failed add track request",Object.assign(Object.assign(Object.assign({},this.logContext),pa(e)),{error:t}))})),n(t)}}));if(this.enabledPublishVideoCodecs.length>0){const e=yield Promise.all([T,y()]);k=e[0]}else{let n;if(k=yield T,k.codecs.forEach(e=>{void 0===n&&(n=e.mimeType)}),n&&e.kind===ss.Kind.Video){const i=ua(n);i!==p&&(this.log.debug("falling back to server selected codec",Object.assign(Object.assign(Object.assign({},this.logContext),pa(e)),{codec:i})),t.videoCodec=i,b=Tr(e.source===ss.Source.ScreenShare,v.width,v.height,t))}yield y()}const C=new Zr(e.kind,k,e,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});if(C.on(Uo.CpuConstrained,e=>this.onTrackCpuConstrained(e,C)),C.options=t,e.sid=k.sid,this.log.debug("publishing ".concat(e.kind," with encodings"),Object.assign(Object.assign({},this.logContext),{encodings:b,trackInfo:k})),Zs(e)?e.startMonitor(this.engine.client):ea(e)&&e.startMonitor(),this.addTrackPublication(C),this.emit(No.LocalTrackPublished,C),ea(e)&&k.audioFeatures.includes(rt.TF_PRECONNECT_BUFFER)){const t=e.getPreConnectBuffer(),n=e.getPreConnectBufferMimeType();if(this.on(No.LocalTrackSubscribed,t=>{if(t.trackSid===k.sid){if(!e.hasPreConnectBuffer)return void this.log.warn("subscribe event came to late, buffer already closed",this.logContext);this.log.debug("finished recording preconnect buffer",Object.assign(Object.assign({},this.logContext),pa(e))),e.stopPreConnectBuffer()}}),t){const i=new Promise((i,o)=>pi(this,void 0,void 0,function*(){var s,a,r,c,d,l;try{this.log.debug("waiting for agent",Object.assign(Object.assign({},this.logContext),pa(e)));const m=setTimeout(()=>{o(new Error("agent not active within 10 seconds"))},1e4),g=yield this.waitUntilActiveAgentPresent();clearTimeout(m),this.log.debug("sending preconnect buffer",Object.assign(Object.assign({},this.logContext),pa(e)));const v=yield this.streamBytes({name:"preconnect-buffer",mimeType:n,topic:"lk.agent.pre-connect-audio-buffer",destinationIdentities:[g.identity],attributes:{trackId:C.trackSid,sampleRate:String(null!==(d=f.sampleRate)&&void 0!==d?d:"48000"),channels:String(null!==(l=f.channelCount)&&void 0!==l?l:"1")}});try{for(var u,h=!0,p=gi(t);!(s=(u=yield p.next()).done);h=!0){c=u.value,h=!1;const e=c;yield v.write(e)}}catch(e){a={error:e}}finally{try{h||s||!(r=p.return)||(yield r.call(p))}finally{if(a)throw a.error}}yield v.close(),i()}catch(e){o(e)}}));i.then(()=>{this.log.debug("preconnect buffer sent successfully",Object.assign(Object.assign({},this.logContext),pa(e)))}).catch(t=>{this.log.error("error sending preconnect buffer",Object.assign(Object.assign(Object.assign({},this.logContext),pa(e)),{error:t}))})}}return C})}get isLocal(){return!0}publishAdditionalCodecForTrack(e,t,n){return pi(this,void 0,void 0,function*(){var i;if(this.encryptionType!==gt.NONE)return;let o;if(this.trackPublications.forEach(t=>{t.track&&t.track===e&&(o=t)}),!o)throw new zo("track is not published");if(!Zs(e))throw new zo("track is not a video track");const s=Object.assign(Object.assign({},null===(i=this.roomOptions)||void 0===i?void 0:i.publishDefaults),n),a=function(e,t,n){var i,o,s,a;if(!n.backupCodec||!0===n.backupCodec||n.backupCodec.codec===n.videoCodec)return;t!==n.backupCodec.codec&&ci.warn("requested a different codec than specified as backup",{serverRequested:t,backup:n.backupCodec.codec}),n.videoCodec=t,n.videoEncoding=n.backupCodec.encoding;const r=e.mediaStreamTrack.getSettings(),c=null!==(i=r.width)&&void 0!==i?i:null===(o=e.dimensions)||void 0===o?void 0:o.width,d=null!==(s=r.height)&&void 0!==s?s:null===(a=e.dimensions)||void 0===a?void 0:a.height;return e.source===ss.Source.ScreenShare&&n.simulcast&&(n.simulcast=!1),Tr(e.source===ss.Source.ScreenShare,c,d,n)}(e,t,s);if(!a)return void this.log.info("backup codec has been disabled, ignoring request to add additional codec for track",Object.assign(Object.assign({},this.logContext),pa(e)));const r=e.addSimulcastTrack(t,a);if(!r)return;const c=new on({cid:r.mediaStreamTrack.id,type:ss.kindToProto(e.kind),muted:e.isMuted,source:ss.sourceToProto(e.source),sid:e.sid,simulcastCodecs:[{codec:s.videoCodec,cid:r.mediaStreamTrack.id}]});if(c.layers=Ir(c.width,c.height,a),!this.engine||this.engine.isClosed)throw new Wo("cannot publish track when not connected");const d=(yield Promise.all([this.engine.addTrack(c),(()=>pi(this,void 0,void 0,function*(){yield this.engine.createSimulcastSender(e,r,s,a),yield this.engine.negotiate()}))()]))[0];this.log.debug("published ".concat(t," for track ").concat(e.sid),Object.assign(Object.assign({},this.logContext),{encodings:a,trackInfo:d}))})}unpublishTrack(e,t){return pi(this,void 0,void 0,function*(){var n,i;if($s(e)){const t=this.pendingPublishPromises.get(e);t&&(this.log.info("awaiting publish promise before attempting to unpublish",Object.assign(Object.assign({},this.logContext),pa(e))),yield t)}const o=this.getPublicationForTrack(e),s=o?pa(o):void 0;if(this.log.debug("unpublishing track",Object.assign(Object.assign({},this.logContext),s)),!o||!o.track)return void this.log.warn("track was not unpublished because no publication was found",Object.assign(Object.assign({},this.logContext),s));(e=o.track).off(Uo.Muted,this.onTrackMuted),e.off(Uo.Unmuted,this.onTrackUnmuted),e.off(Uo.Ended,this.handleTrackEnded),e.off(Uo.UpstreamPaused,this.onTrackUpstreamPaused),e.off(Uo.UpstreamResumed,this.onTrackUpstreamResumed),e.off(Uo.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate),void 0===t&&(t=null===(i=null===(n=this.roomOptions)||void 0===n?void 0:n.stopLocalTrackOnUnpublish)||void 0===i||i),t?e.stop():e.stopMonitor();let a=!1;const r=e.sender;if(e.sender=void 0,this.engine.pcManager&&this.engine.pcManager.currentState<ir.FAILED&&r)try{for(const e of this.engine.pcManager.publisher.getTransceivers())e.sender===r&&(e.direction="inactive",a=!0);if(this.engine.removeTrack(r)&&(a=!0),Zs(e)){for(const[,t]of e.simulcastCodecs)t.sender&&(this.engine.removeTrack(t.sender)&&(a=!0),t.sender=void 0);e.simulcastCodecs.clear()}}catch(e){this.log.warn("failed to unpublish track",Object.assign(Object.assign(Object.assign({},this.logContext),s),{error:e}))}switch(this.trackPublications.delete(o.trackSid),o.kind){case ss.Kind.Audio:this.audioTrackPublications.delete(o.trackSid);break;case ss.Kind.Video:this.videoTrackPublications.delete(o.trackSid)}return this.emit(No.LocalTrackUnpublished,o),o.setTrack(void 0),a&&(yield this.engine.negotiate()),o})}unpublishTracks(e){return pi(this,void 0,void 0,function*(){return(yield Promise.all(e.map(e=>this.unpublishTrack(e)))).filter(e=>!!e)})}republishAllTracks(e){return pi(this,arguments,void 0,function(e){var t=this;let n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return function*(){t.republishPromise&&(yield t.republishPromise),t.republishPromise=new Promise((i,o)=>pi(t,void 0,void 0,function*(){try{const t=[];this.trackPublications.forEach(n=>{n.track&&(e&&(n.options=Object.assign(Object.assign({},n.options),e)),t.push(n))}),yield Promise.all(t.map(e=>pi(this,void 0,void 0,function*(){const t=e.track;yield this.unpublishTrack(t,!1),!n||t.isMuted||t.source===ss.Source.ScreenShare||t.source===ss.Source.ScreenShareAudio||!ea(t)&&!Zs(t)||t.isUserProvided||(this.log.debug("restarting existing track",Object.assign(Object.assign({},this.logContext),{track:e.trackSid})),yield t.restartTrack()),yield this.publishOrRepublishTrack(t,e.options,!0)}))),i()}catch(e){o(e)}finally{this.republishPromise=void 0}})),yield t.republishPromise}()})}publishData(e){return pi(this,arguments,void 0,function(e){var t=this;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return function*(){const i=n.reliable?Tt.RELIABLE:Tt.LOSSY,o=n.destinationIdentities,s=n.topic;let a=new xt({participantIdentity:t.identity,payload:e,destinationIdentities:o,topic:s});const r=new kt({kind:i,value:{case:"user",value:a}});yield t.engine.sendDataPacket(r,i)}()})}publishDtmf(e,t){return pi(this,void 0,void 0,function*(){const n=new kt({kind:Tt.RELIABLE,value:{case:"sipDtmf",value:new Pt({code:e,digit:t})}});yield this.engine.sendDataPacket(n,Tt.RELIABLE)})}sendChatMessage(e,t){return pi(this,void 0,void 0,function*(){const n={id:crypto.randomUUID(),message:e,timestamp:Date.now(),attachedFiles:null==t?void 0:t.attachments},i=new kt({value:{case:"chatMessage",value:new Ot(Object.assign(Object.assign({},n),{timestamp:L.parse(n.timestamp)}))}});return yield this.engine.sendDataPacket(i,Tt.RELIABLE),this.emit(No.ChatMessage,n),n})}editChatMessage(e,t){return pi(this,void 0,void 0,function*(){const n=Object.assign(Object.assign({},t),{message:e,editTimestamp:Date.now()}),i=new kt({value:{case:"chatMessage",value:new Ot(Object.assign(Object.assign({},n),{timestamp:L.parse(n.timestamp),editTimestamp:L.parse(n.editTimestamp)}))}});return yield this.engine.sendDataPacket(i,Tt.RELIABLE),this.emit(No.ChatMessage,n),n})}sendText(e,t){return pi(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.sendText(e,t)})}streamText(e){return pi(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.streamText(e)})}sendFile(e,t){return pi(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.sendFile(e,t)})}streamBytes(e){return pi(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.streamBytes(e)})}performRpc(e){return pi(this,arguments,void 0,function(e){var t=this;let{destinationIdentity:n,method:i,payload:o,responseTimeout:s=15e3}=e;return function*(){return new Promise((e,a)=>pi(t,void 0,void 0,function*(){var t,r,c,d;if(ar(o)>15360)return void a(sr.builtIn("REQUEST_PAYLOAD_TOO_LARGE"));if((null===(r=null===(t=this.engine.latestJoinResponse)||void 0===t?void 0:t.serverInfo)||void 0===r?void 0:r.version)&&As(null===(d=null===(c=this.engine.latestJoinResponse)||void 0===c?void 0:c.serverInfo)||void 0===d?void 0:d.version,"1.8.0")<0)return void a(sr.builtIn("UNSUPPORTED_SERVER"));const l=Math.max(s,8e3),u=crypto.randomUUID();yield this.publishRpcRequest(n,u,i,o,l);const h=setTimeout(()=>{this.pendingAcks.delete(u),a(sr.builtIn("CONNECTION_TIMEOUT")),this.pendingResponses.delete(u),clearTimeout(p)},7e3);this.pendingAcks.set(u,{resolve:()=>{clearTimeout(h)},participantIdentity:n});const p=setTimeout(()=>{this.pendingResponses.delete(u),a(sr.builtIn("RESPONSE_TIMEOUT"))},s);this.pendingResponses.set(u,{resolve:(t,n)=>{clearTimeout(p),this.pendingAcks.has(u)&&(console.warn("RPC response received before ack",u),this.pendingAcks.delete(u),clearTimeout(h)),n?a(n):e(null!=t?t:"")},participantIdentity:n})}))}()})}registerRpcMethod(e,t){this.rpcHandlers.has(e)&&this.log.warn("you're overriding the RPC handler for method ".concat(e,", in the future this will throw an error")),this.rpcHandlers.set(e,t)}unregisterRpcMethod(e){this.rpcHandlers.delete(e)}setTrackSubscriptionPermissions(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];this.participantTrackPermissions=t,this.allParticipantsAllowedToSubscribe=e,this.engine.client.isDisconnected||this.updateTrackSubscriptionPermissions()}handleIncomingRpcAck(e){const t=this.pendingAcks.get(e);t?(t.resolve(),this.pendingAcks.delete(e)):console.error("Ack received for unexpected RPC request",e)}handleIncomingRpcResponse(e,t,n){const i=this.pendingResponses.get(e);i?(i.resolve(t,n),this.pendingResponses.delete(e)):console.error("Response received for unexpected RPC request",e)}publishRpcRequest(e,t,n,i,o){return pi(this,void 0,void 0,function*(){const s=new kt({destinationIdentities:[e],kind:Tt.RELIABLE,value:{case:"rpcRequest",value:new _t({id:t,method:n,payload:i,responseTimeoutMs:o,version:1})}});yield this.engine.sendDataPacket(s,Tt.RELIABLE)})}handleParticipantDisconnected(e){for(const[t,{participantIdentity:n}]of this.pendingAcks)n===e&&this.pendingAcks.delete(t);for(const[t,{participantIdentity:n,resolve:i}]of this.pendingResponses)n===e&&(i(null,sr.builtIn("RECIPIENT_DISCONNECTED")),this.pendingResponses.delete(t))}setEnabledPublishCodecs(e){this.enabledPublishVideoCodecs=e.filter(e=>"video"===e.mime.split("/")[0].toLowerCase())}updateInfo(e){return!!super.updateInfo(e)&&(e.tracks.forEach(e=>{var t,n;const i=this.trackPublications.get(e.sid);if(i){const o=i.isMuted||null!==(n=null===(t=i.track)||void 0===t?void 0:t.isUpstreamPaused)&&void 0!==n&&n;o!==e.muted&&(this.log.debug("updating server mute state after reconcile",Object.assign(Object.assign(Object.assign({},this.logContext),pa(i)),{mutedOnServer:o})),this.engine.client.sendMuteTrack(e.sid,o))}}),!0)}setActiveAgent(e){var t,n,i,o;this.firstActiveAgent=e,e&&!this.firstActiveAgent&&(this.firstActiveAgent=e),e?null===(n=null===(t=this.activeAgentFuture)||void 0===t?void 0:t.resolve)||void 0===n||n.call(t,e):null===(o=null===(i=this.activeAgentFuture)||void 0===i?void 0:i.reject)||void 0===o||o.call(i,"Agent disconnected"),this.activeAgentFuture=void 0}waitUntilActiveAgentPresent(){return this.firstActiveAgent?Promise.resolve(this.firstActiveAgent):(this.activeAgentFuture||(this.activeAgentFuture=new Hs),this.activeAgentFuture.promise)}getPublicationForTrack(e){let t;return this.trackPublications.forEach(n=>{const i=n.track;i&&(e instanceof MediaStreamTrack?(ea(i)||Zs(i))&&i.mediaStreamTrack===e&&(t=n):e===i&&(t=n))}),t}waitForPendingPublicationOfSource(e){return pi(this,void 0,void 0,function*(){const t=Date.now();for(;Date.now()<t+1e4;){const t=Array.from(this.pendingPublishPromises.entries()).find(t=>{let[n]=t;return n.source===e});if(t)return t[1];yield bs(20)}})}}class sc extends Xr{constructor(e,t,n,i){super(e,t.sid,t.name,i),this.track=void 0,this.allowed=!0,this.requestedDisabled=void 0,this.visible=!0,this.handleEnded=e=>{this.setTrack(void 0),this.emit(Uo.Ended,e)},this.handleVisibilityChange=e=>{this.log.debug("adaptivestream video visibility ".concat(this.trackSid,", visible=").concat(e),this.logContext),this.visible=e,this.emitTrackUpdate()},this.handleVideoDimensionsChange=e=>{this.log.debug("adaptivestream video dimensions ".concat(e.width,"x").concat(e.height),this.logContext),this.videoDimensionsAdaptiveStream=e,this.emitTrackUpdate()},this.subscribed=n,this.updateInfo(t)}setSubscribed(e){const t=this.subscriptionStatus,n=this.permissionStatus;this.subscribed=e,e&&(this.allowed=!0);const i=new pn({trackSids:[this.trackSid],subscribe:this.subscribed,participantTracks:[new Nt({participantSid:"",trackSids:[this.trackSid]})]});this.emit(Uo.UpdateSubscription,i),this.emitSubscriptionUpdateIfChanged(t),this.emitPermissionUpdateIfChanged(n)}get subscriptionStatus(){return!1===this.subscribed?Xr.SubscriptionStatus.Unsubscribed:super.isSubscribed?Xr.SubscriptionStatus.Subscribed:Xr.SubscriptionStatus.Desired}get permissionStatus(){return this.allowed?Xr.PermissionStatus.Allowed:Xr.PermissionStatus.NotAllowed}get isSubscribed(){return!1!==this.subscribed&&super.isSubscribed}get isDesired(){return!1!==this.subscribed}get isEnabled(){return void 0!==this.requestedDisabled?!this.requestedDisabled:!this.isAdaptiveStream||this.visible}get isLocal(){return!1}setEnabled(e){this.isManualOperationAllowed()&&this.requestedDisabled!==!e&&(this.requestedDisabled=!e,this.emitTrackUpdate())}setVideoQuality(e){this.isManualOperationAllowed()&&this.requestedMaxQuality!==e&&(this.requestedMaxQuality=e,this.requestedVideoDimensions=void 0,this.emitTrackUpdate())}setVideoDimensions(e){var t,n;this.isManualOperationAllowed()&&((null===(t=this.requestedVideoDimensions)||void 0===t?void 0:t.width)===e.width&&(null===(n=this.requestedVideoDimensions)||void 0===n?void 0:n.height)===e.height||(ia(this.track)&&(this.requestedVideoDimensions=e),this.requestedMaxQuality=void 0,this.emitTrackUpdate()))}setVideoFPS(e){this.isManualOperationAllowed()&&ia(this.track)&&this.fps!==e&&(this.fps=e,this.emitTrackUpdate())}get videoQuality(){var e;return null!==(e=this.requestedMaxQuality)&&void 0!==e?e:os.HIGH}setTrack(e){const t=this.subscriptionStatus,n=this.permissionStatus,i=this.track;i!==e&&(i&&(i.off(Uo.VideoDimensionsChanged,this.handleVideoDimensionsChange),i.off(Uo.VisibilityChanged,this.handleVisibilityChange),i.off(Uo.Ended,this.handleEnded),i.detach(),i.stopMonitor(),this.emit(Uo.Unsubscribed,i)),super.setTrack(e),e&&(e.sid=this.trackSid,e.on(Uo.VideoDimensionsChanged,this.handleVideoDimensionsChange),e.on(Uo.VisibilityChanged,this.handleVisibilityChange),e.on(Uo.Ended,this.handleEnded),this.emit(Uo.Subscribed,e)),this.emitPermissionUpdateIfChanged(n),this.emitSubscriptionUpdateIfChanged(t))}setAllowed(e){const t=this.subscriptionStatus,n=this.permissionStatus;this.allowed=e,this.emitPermissionUpdateIfChanged(n),this.emitSubscriptionUpdateIfChanged(t)}setSubscriptionError(e){this.emit(Uo.SubscriptionFailed,e)}updateInfo(e){super.updateInfo(e);const t=this.metadataMuted;this.metadataMuted=e.muted,this.track?this.track.setMuted(e.muted):t!==e.muted&&this.emit(e.muted?Uo.Muted:Uo.Unmuted)}emitSubscriptionUpdateIfChanged(e){const t=this.subscriptionStatus;e!==t&&this.emit(Uo.SubscriptionStatusChanged,t,e)}emitPermissionUpdateIfChanged(e){this.permissionStatus!==e&&this.emit(Uo.SubscriptionPermissionChanged,this.permissionStatus,e)}isManualOperationAllowed(){return!!this.isDesired||(this.log.warn("cannot update track settings when not subscribed",this.logContext),!1)}get isAdaptiveStream(){return ia(this.track)&&this.track.isAdaptiveStream}emitTrackUpdate(){const e=new mn({trackSids:[this.trackSid],disabled:!this.isEnabled,fps:this.fps});if(this.kind===ss.Kind.Video){let o=this.requestedVideoDimensions;if(void 0!==this.videoDimensionsAdaptiveStream)if(o){ga(this.videoDimensionsAdaptiveStream,o)&&(this.log.debug("using adaptive stream dimensions instead of requested",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),o=this.videoDimensionsAdaptiveStream)}else if(void 0!==this.requestedMaxQuality&&this.trackInfo){const e=(t=this.trackInfo,n=this.requestedMaxQuality,null===(i=t.layers)||void 0===i?void 0:i.find(e=>e.quality===n));e&&ga(this.videoDimensionsAdaptiveStream,e)&&(this.log.debug("using adaptive stream dimensions instead of max quality layer",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),o=this.videoDimensionsAdaptiveStream)}else this.log.debug("using adaptive stream dimensions",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),o=this.videoDimensionsAdaptiveStream;o?(e.width=Math.ceil(o.width),e.height=Math.ceil(o.height)):void 0!==this.requestedMaxQuality?(this.log.debug("using requested max quality",Object.assign(Object.assign({},this.logContext),{quality:this.requestedMaxQuality})),e.quality=this.requestedMaxQuality):(this.log.debug("using default quality",Object.assign(Object.assign({},this.logContext),{quality:os.HIGH})),e.quality=os.HIGH)}var t,n,i;this.emit(Uo.UpdateSettings,e)}}class ac extends ic{static fromParticipantInfo(e,t,n){return new ac(e,t.sid,t.identity,t.name,t.metadata,t.attributes,n,t.kind)}get logContext(){return Object.assign(Object.assign({},super.logContext),{rpID:this.sid,remoteParticipant:this.identity})}constructor(e,t,n,i,o,s,a){super(t,n||"",i,o,s,a,arguments.length>7&&void 0!==arguments[7]?arguments[7]:pt.STANDARD),this.signalClient=e,this.trackPublications=new Map,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.volumeMap=new Map}addTrackPublication(e){super.addTrackPublication(e),e.on(Uo.UpdateSettings,t=>{this.log.debug("send update settings",Object.assign(Object.assign(Object.assign({},this.logContext),pa(e)),{settings:t})),this.signalClient.sendUpdateTrackSettings(t)}),e.on(Uo.UpdateSubscription,e=>{e.participantTracks.forEach(e=>{e.participantSid=this.sid}),this.signalClient.sendUpdateSubscription(e)}),e.on(Uo.SubscriptionPermissionChanged,t=>{this.emit(No.TrackSubscriptionPermissionChanged,e,t)}),e.on(Uo.SubscriptionStatusChanged,t=>{this.emit(No.TrackSubscriptionStatusChanged,e,t)}),e.on(Uo.Subscribed,t=>{this.emit(No.TrackSubscribed,t,e)}),e.on(Uo.Unsubscribed,t=>{this.emit(No.TrackUnsubscribed,t,e)}),e.on(Uo.SubscriptionFailed,t=>{this.emit(No.TrackSubscriptionFailed,e.trackSid,t)})}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setVolume(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ss.Source.Microphone;this.volumeMap.set(t,e);const n=this.getTrackPublication(t);n&&n.track&&n.track.setVolume(e)}getVolume(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ss.Source.Microphone;const t=this.getTrackPublication(e);return t&&t.track?t.track.getVolume():this.volumeMap.get(e)}addSubscribedMediaTrack(e,t,n,i,o,s){let a=this.getTrackPublicationBySid(t);if(a||t.startsWith("TR")||this.trackPublications.forEach(t=>{a||e.kind!==t.kind.toString()||(a=t)}),!a)return 0===s?(this.log.error("could not find published track",Object.assign(Object.assign({},this.logContext),{trackSid:t})),void this.emit(No.TrackSubscriptionFailed,t)):(void 0===s&&(s=20),void setTimeout(()=>{this.addSubscribedMediaTrack(e,t,n,i,o,s-1)},150));if("ended"===e.readyState)return this.log.error("unable to subscribe because MediaStreamTrack is ended. Do not call MediaStreamTrack.stop()",Object.assign(Object.assign({},this.logContext),pa(a))),void this.emit(No.TrackSubscriptionFailed,t);let r;return r="video"===e.kind?new Jr(e,t,i,o):new Kr(e,t,i,this.audioContext,this.audioOutput),r.source=a.source,r.isMuted=a.isMuted,r.setMediaStream(n),r.start(),a.setTrack(r),this.volumeMap.has(a.source)&&ta(r)&&Qs(r)&&r.setVolume(this.volumeMap.get(a.source)),a}get hasMetadata(){return!!this.participantInfo}getTrackPublicationBySid(e){return this.trackPublications.get(e)}updateInfo(e){if(!super.updateInfo(e))return!1;const t=new Map,n=new Map;return e.tracks.forEach(e=>{var i,o;let s=this.getTrackPublicationBySid(e.sid);if(s)s.updateInfo(e);else{const t=ss.kindFromProto(e.type);if(!t)return;s=new sc(t,e,null===(i=this.signalClient.connectOptions)||void 0===i?void 0:i.autoSubscribe,{loggerContextCb:()=>this.logContext,loggerName:null===(o=this.loggerOptions)||void 0===o?void 0:o.loggerName}),s.updateInfo(e),n.set(e.sid,s);const a=Array.from(this.trackPublications.values()).find(e=>e.source===(null==s?void 0:s.source));a&&s.source!==ss.Source.Unknown&&this.log.debug("received a second track publication for ".concat(this.identity," with the same source: ").concat(s.source),Object.assign(Object.assign({},this.logContext),{oldTrack:pa(a),newTrack:pa(s)})),this.addTrackPublication(s)}t.set(e.sid,s)}),this.trackPublications.forEach(e=>{t.has(e.trackSid)||(this.log.trace("detected removed track on remote participant, unpublishing",Object.assign(Object.assign({},this.logContext),pa(e))),this.unpublishTrack(e.trackSid,!0))}),n.forEach(e=>{this.emit(No.TrackPublished,e)}),!0}unpublishTrack(e,t){const n=this.trackPublications.get(e);if(!n)return;const{track:i}=n;switch(i&&(i.stop(),n.setTrack(void 0)),this.trackPublications.delete(e),n.kind){case ss.Kind.Audio:this.audioTrackPublications.delete(e);break;case ss.Kind.Video:this.videoTrackPublications.delete(e)}t&&this.emit(No.TrackUnpublished,n)}setAudioOutput(e){return pi(this,void 0,void 0,function*(){this.audioOutput=e;const t=[];this.audioTrackPublications.forEach(n=>{var i;Qs(n.track)&&ta(n.track)&&t.push(n.track.setSinkId(null!==(i=e.deviceId)&&void 0!==i?i:"default"))}),yield Promise.all(t)})}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return this.log.trace("participant event",Object.assign(Object.assign({},this.logContext),{event:e,args:n})),super.emit(e,...n)}}!function(e){e.Disconnected="disconnected",e.Connecting="connecting",e.Connected="connected",e.Reconnecting="reconnecting",e.SignalReconnecting="signalReconnecting"}(nc||(nc={}));class rc extends bi.EventEmitter{get hasE2EESetup(){return void 0!==this.e2eeManager}constructor(e){var t,n,i,o;if(super(),t=this,this.state=nc.Disconnected,this.activeSpeakers=[],this.isE2EEEnabled=!1,this.audioEnabled=!0,this.isVideoPlaybackBlocked=!1,this.log=ci,this.bufferedEvents=[],this.isResuming=!1,this.rpcHandlers=new Map,this.connect=(e,t,n)=>pi(this,void 0,void 0,function*(){var i;if("undefined"==typeof RTCPeerConnection||!ys()&&!ks())throw Is()?Error("WebRTC isn't detected, have you called registerGlobals?"):Error("LiveKit doesn't seem to be supported on this browser. Try to update your browser and make sure no browser extensions are disabling webRTC.");const o=yield this.disconnectLock.lock();if(this.state===nc.Connected)return this.log.info("already connected to room ".concat(this.name),this.logContext),o(),Promise.resolve();if(this.connectFuture)return o(),this.connectFuture.promise;this.setAndEmitConnectionState(nc.Connecting),(null===(i=this.regionUrlProvider)||void 0===i?void 0:i.getServerUrl().toString())!==e&&(this.regionUrl=void 0,this.regionUrlProvider=void 0),Os(new URL(e))&&(void 0===this.regionUrlProvider?this.regionUrlProvider=new Ur(e,t):this.regionUrlProvider.updateToken(t),this.regionUrlProvider.fetchRegionSettings().then(e=>{var t;null===(t=this.regionUrlProvider)||void 0===t||t.setServerReportedRegions(e)}).catch(e=>{this.log.warn("could not fetch region settings",Object.assign(Object.assign({},this.logContext),{error:e}))}));const s=(i,a,r)=>pi(this,void 0,void 0,function*(){var c,d;this.abortController&&this.abortController.abort();const l=new AbortController;this.abortController=l,null==o||o();try{yield this.attemptConnection(null!=r?r:e,t,n,l),this.abortController=void 0,i()}catch(e){if(this.regionUrlProvider&&e instanceof qo&&e.reason!==Oo.Cancelled&&e.reason!==Oo.NotAllowed){let t=null;try{t=yield this.regionUrlProvider.getNextBestRegionUrl(null===(c=this.abortController)||void 0===c?void 0:c.signal)}catch(e){if(e instanceof qo&&(401===e.status||e.reason===Oo.Cancelled))return this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),void a(e)}t&&!(null===(d=this.abortController)||void 0===d?void 0:d.signal.aborted)?(this.log.info("Initial connection failed with ConnectionError: ".concat(e.message,". Retrying with another region: ").concat(t),this.logContext),this.recreateEngine(),yield s(i,a,t)):(this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,Ks(e)),a(e))}else{let t=ot.UNKNOWN_REASON;e instanceof qo&&(t=Ks(e)),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,t),a(e)}}}),a=this.regionUrl;return this.regionUrl=void 0,this.connectFuture=new Hs((e,t)=>{s(e,t,a)},()=>{this.clearConnectionFutures()}),this.connectFuture.promise}),this.connectSignal=(e,t,n,i,o,s)=>pi(this,void 0,void 0,function*(){var a,r,c;const d=yield n.join(e,t,{autoSubscribe:i.autoSubscribe,adaptiveStream:"object"==typeof o.adaptiveStream||o.adaptiveStream,maxRetries:i.maxRetries,e2eeEnabled:!!this.e2eeManager,websocketTimeout:i.websocketTimeout,singlePeerConnection:o.singlePeerConnection},s.signal);let l=d.serverInfo;if(l||(l={version:d.serverVersion,region:d.serverRegion}),this.serverInfo=l,this.log.debug("connected to Livekit Server ".concat(Object.entries(l).map(e=>{let[t,n]=e;return"".concat(t,": ").concat(n)}).join(", ")),{room:null===(a=d.room)||void 0===a?void 0:a.name,roomSid:null===(r=d.room)||void 0===r?void 0:r.sid,identity:null===(c=d.participant)||void 0===c?void 0:c.identity}),!l.version)throw new Ho("unknown server version");return"0.15.1"===l.version&&this.options.dynacast&&(this.log.debug("disabling dynacast due to server version",this.logContext),o.dynacast=!1),d}),this.applyJoinResponse=e=>{const t=e.participant;if(this.localParticipant.sid=t.sid,this.localParticipant.identity=t.identity,this.localParticipant.setEnabledPublishCodecs(e.enabledPublishCodecs),this.e2eeManager)try{this.e2eeManager.setSifTrailer(e.sifTrailer)}catch(e){this.log.error(e instanceof Error?e.message:"Could not set SifTrailer",Object.assign(Object.assign({},this.logContext),{error:e}))}this.handleParticipantUpdates([t,...e.otherParticipants]),e.room&&this.handleRoomUpdate(e.room)},this.attemptConnection=(e,t,n,i)=>pi(this,void 0,void 0,function*(){var o,s;this.state===nc.Reconnecting||this.isResuming||(null===(o=this.engine)||void 0===o?void 0:o.pendingReconnect)?(this.log.info("Reconnection attempt replaced by new connection attempt",this.logContext),this.recreateEngine()):this.maybeCreateEngine(),(null===(s=this.regionUrlProvider)||void 0===s?void 0:s.isCloud())&&this.engine.setRegionUrlProvider(this.regionUrlProvider),this.acquireAudioContext(),this.connOptions=Object.assign(Object.assign({},nr),n),this.connOptions.rtcConfig&&(this.engine.rtcConfig=this.connOptions.rtcConfig),this.connOptions.peerConnectionTimeout&&(this.engine.peerConnectionTimeout=this.connOptions.peerConnectionTimeout);try{const n=yield this.connectSignal(e,t,this.engine,this.connOptions,this.options,i);this.applyJoinResponse(n),this.setupLocalParticipantEvents(),this.emit(Ao.SignalConnected)}catch(e){yield this.engine.close(),this.recreateEngine();const t=new qo("could not establish signal connection",Oo.ServerUnreachable);throw e instanceof Error&&(t.message="".concat(t.message,": ").concat(e.message)),e instanceof qo&&(t.reason=e.reason,t.status=e.status),this.log.debug("error trying to establish signal connection",Object.assign(Object.assign({},this.logContext),{error:e})),t}if(i.signal.aborted)throw yield this.engine.close(),this.recreateEngine(),new qo("Connection attempt aborted",Oo.Cancelled);try{yield this.engine.waitForPCInitialConnection(this.connOptions.peerConnectionTimeout,i)}catch(e){throw yield this.engine.close(),this.recreateEngine(),e}Rs()&&this.options.disconnectOnPageLeave&&(window.addEventListener("pagehide",this.onPageLeave),window.addEventListener("beforeunload",this.onPageLeave)),Rs()&&document.addEventListener("freeze",this.onPageLeave),this.setAndEmitConnectionState(nc.Connected),this.emit(Ao.Connected),this.registerConnectionReconcile()}),this.disconnect=function(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];return pi(t,[...n],void 0,function(){var e=this;let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return function*(){var n,i,o,s;const a=yield e.disconnectLock.lock();try{if(e.state===nc.Disconnected)return void e.log.debug("already disconnected",e.logContext);if(e.log.info("disconnect from room",Object.assign({},e.logContext)),e.state===nc.Connecting||e.state===nc.Reconnecting||e.isResuming){const t="Abort connection attempt due to user initiated disconnect";e.log.warn(t,e.logContext),null===(n=e.abortController)||void 0===n||n.abort(t),null===(o=null===(i=e.connectFuture)||void 0===i?void 0:i.reject)||void 0===o||o.call(i,new qo("Client initiated disconnect",Oo.Cancelled)),e.connectFuture=void 0}(null===(s=e.engine)||void 0===s?void 0:s.client.isDisconnected)||(yield e.engine.client.sendLeave()),e.engine&&(yield e.engine.close()),e.handleDisconnect(t,ot.CLIENT_INITIATED),e.engine=void 0}finally{a()}}()})},this.onPageLeave=()=>pi(this,void 0,void 0,function*(){this.log.info("Page leave detected, disconnecting",this.logContext),yield this.disconnect()}),this.startAudio=()=>pi(this,void 0,void 0,function*(){const e=[],t=Xo();if(t&&"iOS"===t.os){const t="livekit-dummy-audio-el";let n=document.getElementById(t);if(!n){n=document.createElement("audio"),n.id=t,n.autoplay=!0,n.hidden=!0;const e=zs();e.enabled=!0;const i=new MediaStream([e]);n.srcObject=i,document.addEventListener("visibilitychange",()=>{n&&(n.srcObject=document.hidden?null:i,document.hidden||(this.log.debug("page visible again, triggering startAudio to resume playback and update playback status",this.logContext),this.startAudio()))}),document.body.append(n),this.once(Ao.Disconnected,()=>{null==n||n.remove(),n=null})}e.push(n)}this.remoteParticipants.forEach(t=>{t.audioTrackPublications.forEach(t=>{t.track&&t.track.attachedElements.forEach(t=>{e.push(t)})})});try{yield Promise.all([this.acquireAudioContext(),...e.map(e=>(e.muted=!1,e.play()))]),this.handleAudioPlaybackStarted()}catch(e){throw this.handleAudioPlaybackFailed(e),e}}),this.startVideo=()=>pi(this,void 0,void 0,function*(){const e=[];for(const t of this.remoteParticipants.values())t.videoTrackPublications.forEach(t=>{var n;null===(n=t.track)||void 0===n||n.attachedElements.forEach(t=>{e.includes(t)||e.push(t)})});yield Promise.all(e.map(e=>e.play())).then(()=>{this.handleVideoPlaybackStarted()}).catch(e=>{"NotAllowedError"===e.name?this.handleVideoPlaybackFailed():this.log.warn("Resuming video playback failed, make sure you call `startVideo` directly in a user gesture handler",this.logContext)})}),this.handleRestarting=()=>{this.clearConnectionReconcile(),this.isResuming=!1;for(const e of this.remoteParticipants.values())this.handleParticipantDisconnected(e.identity,e);this.setAndEmitConnectionState(nc.Reconnecting)&&this.emit(Ao.Reconnecting)},this.handleSignalRestarted=e=>pi(this,void 0,void 0,function*(){this.log.debug("signal reconnected to server, region ".concat(e.serverRegion),Object.assign(Object.assign({},this.logContext),{region:e.serverRegion})),this.bufferedEvents=[],this.applyJoinResponse(e);try{yield this.localParticipant.republishAllTracks(void 0,!0)}catch(e){this.log.error("error trying to re-publish tracks after reconnection",Object.assign(Object.assign({},this.logContext),{error:e}))}try{yield this.engine.waitForRestarted(),this.log.debug("fully reconnected to server",Object.assign(Object.assign({},this.logContext),{region:e.serverRegion}))}catch(e){return}this.setAndEmitConnectionState(nc.Connected),this.emit(Ao.Reconnected),this.registerConnectionReconcile(),this.emitBufferedEvents()}),this.handleParticipantUpdates=e=>{e.forEach(e=>{var t;if(e.identity===this.localParticipant.identity)return void this.localParticipant.updateInfo(e);""===e.identity&&(e.identity=null!==(t=this.sidToIdentity.get(e.sid))&&void 0!==t?t:"");let n=this.remoteParticipants.get(e.identity);e.state===ht.DISCONNECTED?this.handleParticipantDisconnected(e.identity,n):n=this.getOrCreateParticipant(e.identity,e)})},this.handleActiveSpeakersUpdate=e=>{const t=[],n={};e.forEach(e=>{if(n[e.sid]=!0,e.sid===this.localParticipant.sid)this.localParticipant.audioLevel=e.level,this.localParticipant.setIsSpeaking(!0),t.push(this.localParticipant);else{const n=this.getRemoteParticipantBySid(e.sid);n&&(n.audioLevel=e.level,n.setIsSpeaking(!0),t.push(n))}}),n[this.localParticipant.sid]||(this.localParticipant.audioLevel=0,this.localParticipant.setIsSpeaking(!1)),this.remoteParticipants.forEach(e=>{n[e.sid]||(e.audioLevel=0,e.setIsSpeaking(!1))}),this.activeSpeakers=t,this.emitWhenConnected(Ao.ActiveSpeakersChanged,t)},this.handleSpeakersChanged=e=>{const t=new Map;this.activeSpeakers.forEach(e=>{const n=this.remoteParticipants.get(e.identity);n&&n.sid!==e.sid||t.set(e.sid,e)}),e.forEach(e=>{let n=this.getRemoteParticipantBySid(e.sid);e.sid===this.localParticipant.sid&&(n=this.localParticipant),n&&(n.audioLevel=e.level,n.setIsSpeaking(e.active),e.active?t.set(e.sid,n):t.delete(e.sid))});const n=Array.from(t.values());n.sort((e,t)=>t.audioLevel-e.audioLevel),this.activeSpeakers=n,this.emitWhenConnected(Ao.ActiveSpeakersChanged,n)},this.handleStreamStateUpdate=e=>{e.streamStates.forEach(e=>{const t=this.getRemoteParticipantBySid(e.participantSid);if(!t)return;const n=t.getTrackPublicationBySid(e.trackSid);if(!n||!n.track)return;const i=ss.streamStateFromProto(e.state);n.track.setStreamState(i),i!==n.track.streamState&&(t.emit(No.TrackStreamStateChanged,n,n.track.streamState),this.emitWhenConnected(Ao.TrackStreamStateChanged,n,n.track.streamState,t))})},this.handleSubscriptionPermissionUpdate=e=>{const t=this.getRemoteParticipantBySid(e.participantSid);if(!t)return;const n=t.getTrackPublicationBySid(e.trackSid);n&&n.setAllowed(e.allowed)},this.handleSubscriptionError=e=>{const t=Array.from(this.remoteParticipants.values()).find(t=>t.trackPublications.has(e.trackSid));if(!t)return;const n=t.getTrackPublicationBySid(e.trackSid);n&&n.setSubscriptionError(e.err)},this.handleDataPacket=(e,t)=>{const n=this.remoteParticipants.get(e.participantIdentity);if("user"===e.value.case)this.handleUserPacket(n,e.value.value,e.kind,t);else if("transcription"===e.value.case)this.handleTranscription(n,e.value.value);else if("sipDtmf"===e.value.case)this.handleSipDtmf(n,e.value.value);else if("chatMessage"===e.value.case)this.handleChatMessage(n,e.value.value);else if("metrics"===e.value.case)this.handleMetrics(e.value.value,n);else if("streamHeader"===e.value.case||"streamChunk"===e.value.case||"streamTrailer"===e.value.case)this.handleDataStream(e,t);else if("rpcRequest"===e.value.case){const t=e.value.value;this.handleIncomingRpcRequest(e.participantIdentity,t.id,t.method,t.payload,t.responseTimeoutMs,t.version)}},this.handleUserPacket=(e,t,n,i)=>{this.emit(Ao.DataReceived,t.payload,e,n,t.topic,i),null==e||e.emit(No.DataReceived,t.payload,n,i)},this.handleSipDtmf=(e,t)=>{this.emit(Ao.SipDTMFReceived,t,e),null==e||e.emit(No.SipDTMFReceived,t)},this.handleTranscription=(e,t)=>{const n=t.transcribedParticipantIdentity===this.localParticipant.identity?this.localParticipant:this.getParticipantByIdentity(t.transcribedParticipantIdentity),i=null==n?void 0:n.trackPublications.get(t.trackId),o=function(e,t){return e.segments.map(e=>{let{id:n,text:i,language:o,startTime:s,endTime:a,final:r}=e;var c;const d=null!==(c=t.get(n))&&void 0!==c?c:Date.now(),l=Date.now();return r?t.delete(n):t.set(n,d),{id:n,text:i,startTime:Number.parseInt(s.toString()),endTime:Number.parseInt(a.toString()),final:r,language:o,firstReceivedTime:d,lastReceivedTime:l}})}(t,this.transcriptionReceivedTimes);null==i||i.emit(Uo.TranscriptionReceived,o),null==n||n.emit(No.TranscriptionReceived,o,i),this.emit(Ao.TranscriptionReceived,o,n,i)},this.handleChatMessage=(e,t)=>{const n=function(e){const{id:t,timestamp:n,message:i,editTimestamp:o}=e;return{id:t,timestamp:Number.parseInt(n.toString()),editTimestamp:o?Number.parseInt(o.toString()):void 0,message:i}}(t);this.emit(Ao.ChatMessage,n,e)},this.handleMetrics=(e,t)=>{this.emit(Ao.MetricsReceived,e,t)},this.handleDataStream=(e,t)=>{this.incomingDataStreamManager.handleDataStreamPacket(e,t)},this.bufferedSegments=new Map,this.handleAudioPlaybackStarted=()=>{this.canPlaybackAudio||(this.audioEnabled=!0,this.emit(Ao.AudioPlaybackStatusChanged,!0))},this.handleAudioPlaybackFailed=e=>{this.log.warn("could not playback audio",Object.assign(Object.assign({},this.logContext),{error:e})),this.canPlaybackAudio&&(this.audioEnabled=!1,this.emit(Ao.AudioPlaybackStatusChanged,!1))},this.handleVideoPlaybackStarted=()=>{this.isVideoPlaybackBlocked&&(this.isVideoPlaybackBlocked=!1,this.emit(Ao.VideoPlaybackStatusChanged,!0))},this.handleVideoPlaybackFailed=()=>{this.isVideoPlaybackBlocked||(this.isVideoPlaybackBlocked=!0,this.emit(Ao.VideoPlaybackStatusChanged,!1))},this.handleDeviceChange=()=>pi(this,void 0,void 0,function*(){var e;"iOS"!==(null===(e=Xo())||void 0===e?void 0:e.os)&&(yield this.selectDefaultDevices()),this.emit(Ao.MediaDevicesChanged)}),this.handleRoomUpdate=e=>{const t=this.roomInfo;this.roomInfo=e,t&&t.metadata!==e.metadata&&this.emitWhenConnected(Ao.RoomMetadataChanged,e.metadata),(null==t?void 0:t.activeRecording)!==e.activeRecording&&this.emitWhenConnected(Ao.RecordingStatusChanged,e.activeRecording)},this.handleConnectionQualityUpdate=e=>{e.updates.forEach(e=>{if(e.participantSid===this.localParticipant.sid)return void this.localParticipant.setConnectionQuality(e.quality);const t=this.getRemoteParticipantBySid(e.participantSid);t&&t.setConnectionQuality(e.quality)})},this.onLocalParticipantMetadataChanged=e=>{this.emit(Ao.ParticipantMetadataChanged,e,this.localParticipant)},this.onLocalParticipantNameChanged=e=>{this.emit(Ao.ParticipantNameChanged,e,this.localParticipant)},this.onLocalAttributesChanged=e=>{this.emit(Ao.ParticipantAttributesChanged,e,this.localParticipant)},this.onLocalTrackMuted=e=>{this.emit(Ao.TrackMuted,e,this.localParticipant)},this.onLocalTrackUnmuted=e=>{this.emit(Ao.TrackUnmuted,e,this.localParticipant)},this.onTrackProcessorUpdate=e=>{var t;null===(t=null==e?void 0:e.onPublish)||void 0===t||t.call(e,this)},this.onLocalTrackPublished=e=>pi(this,void 0,void 0,function*(){var t,n,i,o,s,a;if(null===(t=e.track)||void 0===t||t.on(Uo.TrackProcessorUpdate,this.onTrackProcessorUpdate),null===(n=e.track)||void 0===n||n.on(Uo.Restarted,this.onLocalTrackRestarted),null===(s=null===(o=null===(i=e.track)||void 0===i?void 0:i.getProcessor())||void 0===o?void 0:o.onPublish)||void 0===s||s.call(o,this),this.emit(Ao.LocalTrackPublished,e,this.localParticipant),ea(e.track)){(yield e.track.checkForSilence())&&this.emit(Ao.LocalAudioSilenceDetected,e)}const r=yield null===(a=e.track)||void 0===a?void 0:a.getDeviceId(!1),c=la(e.source);c&&r&&r!==this.localParticipant.activeDeviceMap.get(c)&&(this.localParticipant.activeDeviceMap.set(c,r),this.emit(Ao.ActiveDeviceChanged,c,r))}),this.onLocalTrackUnpublished=e=>{var t,n;null===(t=e.track)||void 0===t||t.off(Uo.TrackProcessorUpdate,this.onTrackProcessorUpdate),null===(n=e.track)||void 0===n||n.off(Uo.Restarted,this.onLocalTrackRestarted),this.emit(Ao.LocalTrackUnpublished,e,this.localParticipant)},this.onLocalTrackRestarted=e=>pi(this,void 0,void 0,function*(){const t=yield e.getDeviceId(!1),n=la(e.source);n&&t&&t!==this.localParticipant.activeDeviceMap.get(n)&&(this.log.debug("local track restarted, setting ".concat(n," ").concat(t," active"),this.logContext),this.localParticipant.activeDeviceMap.set(n,t),this.emit(Ao.ActiveDeviceChanged,n,t))}),this.onLocalConnectionQualityChanged=e=>{this.emit(Ao.ConnectionQualityChanged,e,this.localParticipant)},this.onMediaDevicesError=(e,t)=>{this.emit(Ao.MediaDevicesError,e,t)},this.onLocalParticipantPermissionsChanged=e=>{this.emit(Ao.ParticipantPermissionsChanged,e,this.localParticipant)},this.onLocalChatMessageSent=e=>{this.emit(Ao.ChatMessage,e,this.localParticipant)},this.setMaxListeners(100),this.remoteParticipants=new Map,this.sidToIdentity=new Map,this.options=Object.assign(Object.assign({},tr),e),this.log=di(null!==(n=this.options.loggerName)&&void 0!==n?n:ai.Room),this.transcriptionReceivedTimes=new Map,this.options.audioCaptureDefaults=Object.assign(Object.assign({},Za),null==e?void 0:e.audioCaptureDefaults),this.options.videoCaptureDefaults=Object.assign(Object.assign({},er),null==e?void 0:e.videoCaptureDefaults),this.options.publishDefaults=Object.assign(Object.assign({},Xa),null==e?void 0:e.publishDefaults),this.maybeCreateEngine(),this.incomingDataStreamManager=new qr,this.outgoingDataStreamManager=new Wr(this.engine,this.log),this.disconnectLock=new m,this.localParticipant=new oc("","",this.engine,this.options,this.rpcHandlers,this.outgoingDataStreamManager),(this.options.e2ee||this.options.encryption)&&this.setupE2EE(),this.engine.e2eeManager=this.e2eeManager,this.options.videoCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("videoinput",Ws(this.options.videoCaptureDefaults.deviceId)),this.options.audioCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("audioinput",Ws(this.options.audioCaptureDefaults.deviceId)),(null===(i=this.options.audioOutput)||void 0===i?void 0:i.deviceId)&&this.switchActiveDevice("audiooutput",Ws(this.options.audioOutput.deviceId)).catch(e=>this.log.warn("Could not set audio output: ".concat(e.message),this.logContext)),Rs()){const e=new AbortController;null===(o=navigator.mediaDevices)||void 0===o||o.addEventListener("devicechange",this.handleDeviceChange,{signal:e.signal}),rc.cleanupRegistry&&rc.cleanupRegistry.register(this,()=>{e.abort()})}}registerTextStreamHandler(e,t){return this.incomingDataStreamManager.registerTextStreamHandler(e,t)}unregisterTextStreamHandler(e){return this.incomingDataStreamManager.unregisterTextStreamHandler(e)}registerByteStreamHandler(e,t){return this.incomingDataStreamManager.registerByteStreamHandler(e,t)}unregisterByteStreamHandler(e){return this.incomingDataStreamManager.unregisterByteStreamHandler(e)}registerRpcMethod(e,t){if(this.rpcHandlers.has(e))throw Error("RPC handler already registered for method ".concat(e,", unregisterRpcMethod before trying to register again"));this.rpcHandlers.set(e,t)}unregisterRpcMethod(e){this.rpcHandlers.delete(e)}setE2EEEnabled(e){return pi(this,void 0,void 0,function*(){if(!this.e2eeManager)throw Error("e2ee not configured, please set e2ee settings within the room options");yield Promise.all([this.localParticipant.setE2EEEnabled(e)]),""!==this.localParticipant.identity&&this.e2eeManager.setParticipantCryptorEnabled(e,this.localParticipant.identity)})}setupE2EE(){var e;const t=!!this.options.encryption,n=this.options.encryption||this.options.e2ee;n&&("e2eeManager"in n?(this.e2eeManager=n.e2eeManager,this.e2eeManager.isDataChannelEncryptionEnabled=t):this.e2eeManager=new fa(n,t),this.e2eeManager.on(Ro.ParticipantEncryptionStatusChanged,(e,t)=>{t.isLocal&&(this.isE2EEEnabled=e),this.emit(Ao.ParticipantEncryptionStatusChanged,e,t)}),this.e2eeManager.on(Ro.EncryptionError,e=>this.emit(Ao.EncryptionError,e)),null===(e=this.e2eeManager)||void 0===e||e.setup(this))}get logContext(){var e;return{room:this.name,roomID:null===(e=this.roomInfo)||void 0===e?void 0:e.sid,participant:this.localParticipant.identity,pID:this.localParticipant.sid}}get isRecording(){var e,t;return null!==(t=null===(e=this.roomInfo)||void 0===e?void 0:e.activeRecording)&&void 0!==t&&t}getSid(){return pi(this,void 0,void 0,function*(){return this.state===nc.Disconnected?"":this.roomInfo&&""!==this.roomInfo.sid?this.roomInfo.sid:new Promise((e,t)=>{const n=t=>{""!==t.sid&&(this.engine.off(Lo.RoomUpdate,n),e(t.sid))};this.engine.on(Lo.RoomUpdate,n),this.once(Ao.Disconnected,()=>{this.engine.off(Lo.RoomUpdate,n),t("Room disconnected before room server id was available")})})})}get name(){var e,t;return null!==(t=null===(e=this.roomInfo)||void 0===e?void 0:e.name)&&void 0!==t?t:""}get metadata(){var e;return null===(e=this.roomInfo)||void 0===e?void 0:e.metadata}get numParticipants(){var e,t;return null!==(t=null===(e=this.roomInfo)||void 0===e?void 0:e.numParticipants)&&void 0!==t?t:0}get numPublishers(){var e,t;return null!==(t=null===(e=this.roomInfo)||void 0===e?void 0:e.numPublishers)&&void 0!==t?t:0}maybeCreateEngine(){this.engine&&!this.engine.isClosed||(this.engine=new Ar(this.options),this.engine.e2eeManager=this.e2eeManager,this.engine.on(Lo.ParticipantUpdate,this.handleParticipantUpdates).on(Lo.RoomUpdate,this.handleRoomUpdate).on(Lo.SpeakersChanged,this.handleSpeakersChanged).on(Lo.StreamStateChanged,this.handleStreamStateUpdate).on(Lo.ConnectionQualityUpdate,this.handleConnectionQualityUpdate).on(Lo.SubscriptionError,this.handleSubscriptionError).on(Lo.SubscriptionPermissionUpdate,this.handleSubscriptionPermissionUpdate).on(Lo.MediaTrackAdded,(e,t,n)=>{this.onTrackAdded(e,t,n)}).on(Lo.Disconnected,e=>{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,e)}).on(Lo.ActiveSpeakersUpdate,this.handleActiveSpeakersUpdate).on(Lo.DataPacketReceived,this.handleDataPacket).on(Lo.Resuming,()=>{this.clearConnectionReconcile(),this.isResuming=!0,this.log.info("Resuming signal connection",this.logContext),this.setAndEmitConnectionState(nc.SignalReconnecting)&&this.emit(Ao.SignalReconnecting)}).on(Lo.Resumed,()=>{this.registerConnectionReconcile(),this.isResuming=!1,this.log.info("Resumed signal connection",this.logContext),this.updateSubscriptions(),this.emitBufferedEvents(),this.setAndEmitConnectionState(nc.Connected)&&this.emit(Ao.Reconnected)}).on(Lo.SignalResumed,()=>{this.bufferedEvents=[],(this.state===nc.Reconnecting||this.isResuming)&&this.sendSyncState()}).on(Lo.Restarting,this.handleRestarting).on(Lo.SignalRestarted,this.handleSignalRestarted).on(Lo.Offline,()=>{this.setAndEmitConnectionState(nc.Reconnecting)&&this.emit(Ao.Reconnecting)}).on(Lo.DCBufferStatusChanged,(e,t)=>{this.emit(Ao.DCBufferStatusChanged,e,t)}).on(Lo.LocalTrackSubscribed,e=>{const t=this.localParticipant.getTrackPublications().find(t=>{let{trackSid:n}=t;return n===e});t?(this.localParticipant.emit(No.LocalTrackSubscribed,t),this.emitWhenConnected(Ao.LocalTrackSubscribed,t,this.localParticipant)):this.log.warn("could not find local track subscription for subscribed event",this.logContext)}).on(Lo.RoomMoved,e=>{this.log.debug("room moved",e),e.room&&this.handleRoomUpdate(e.room),this.remoteParticipants.forEach((e,t)=>{this.handleParticipantDisconnected(t,e)}),this.emit(Ao.Moved,e.room.name),e.participant?this.handleParticipantUpdates([e.participant,...e.otherParticipants]):this.handleParticipantUpdates(e.otherParticipants)}),this.localParticipant&&this.localParticipant.setupEngine(this.engine),this.e2eeManager&&this.e2eeManager.setupEngine(this.engine),this.outgoingDataStreamManager&&this.outgoingDataStreamManager.setupEngine(this.engine))}static getLocalDevices(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return ba.getInstance().getDevices(e,t)}prepareConnection(e,t){return pi(this,void 0,void 0,function*(){if(this.state===nc.Disconnected){this.log.debug("prepareConnection to ".concat(e),this.logContext);try{if(Os(new URL(e))&&t){this.regionUrlProvider=new Ur(e,t);const n=yield this.regionUrlProvider.getNextBestRegionUrl();n&&this.state===nc.Disconnected&&(this.regionUrl=n,yield fetch(Gs(n),{method:"HEAD"}),this.log.debug("prepared connection to ".concat(n),this.logContext))}else yield fetch(Gs(e),{method:"HEAD"})}catch(e){this.log.warn("could not prepare connection",Object.assign(Object.assign({},this.logContext),{error:e}))}}})}getParticipantByIdentity(e){return this.localParticipant.identity===e?this.localParticipant:this.remoteParticipants.get(e)}clearConnectionFutures(){this.connectFuture=void 0}simulateScenario(e,t){return pi(this,void 0,void 0,function*(){let n,i=()=>pi(this,void 0,void 0,function*(){});switch(e){case"signal-reconnect":yield this.engine.client.handleOnClose("simulate disconnect");break;case"speaker":n=new Fn({scenario:{case:"speakerUpdate",value:3}});break;case"node-failure":n=new Fn({scenario:{case:"nodeFailure",value:!0}});break;case"server-leave":n=new Fn({scenario:{case:"serverLeave",value:!0}});break;case"migration":n=new Fn({scenario:{case:"migration",value:!0}});break;case"resume-reconnect":this.engine.failNext(),yield this.engine.client.handleOnClose("simulate resume-disconnect");break;case"disconnect-signal-on-resume":i=()=>pi(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),n=new Fn({scenario:{case:"disconnectSignalOnResume",value:!0}});break;case"disconnect-signal-on-resume-no-messages":i=()=>pi(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),n=new Fn({scenario:{case:"disconnectSignalOnResumeNoMessages",value:!0}});break;case"full-reconnect":this.engine.fullReconnectOnNext=!0,yield this.engine.client.handleOnClose("simulate full-reconnect");break;case"force-tcp":case"force-tls":n=new Fn({scenario:{case:"switchCandidateProtocol",value:"force-tls"===e?2:1}}),i=()=>pi(this,void 0,void 0,function*(){const e=this.engine.client.onLeave;e&&e(new vn({reason:ot.CLIENT_INITIATED,action:bn.RECONNECT}))});break;case"subscriber-bandwidth":if(void 0===t||"number"!=typeof t)throw new Error("subscriber-bandwidth requires a number as argument");n=new Fn({scenario:{case:"subscriberBandwidth",value:Ys(t)}});break;case"leave-full-reconnect":n=new Fn({scenario:{case:"leaveRequestFullReconnect",value:!0}})}n&&(yield this.engine.client.sendSimulateScenario(n),yield i())})}get canPlaybackAudio(){return this.audioEnabled}get canPlaybackVideo(){return!this.isVideoPlaybackBlocked}getActiveDevice(e){return this.localParticipant.activeDeviceMap.get(e)}switchActiveDevice(e,t){return pi(this,arguments,void 0,function(e,t){var n=this;let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return function*(){var o,s,a,r,c,d,l;let u=!0,h=!1;const p=i?{exact:t}:t;if("audioinput"===e){h=0===n.localParticipant.audioTrackPublications.size;const t=null!==(o=n.getActiveDevice(e))&&void 0!==o?o:n.options.audioCaptureDefaults.deviceId;n.options.audioCaptureDefaults.deviceId=p;const i=Array.from(n.localParticipant.audioTrackPublications.values()).filter(e=>e.source===ss.Source.Microphone);try{u=(yield Promise.all(i.map(e=>{var t;return null===(t=e.audioTrack)||void 0===t?void 0:t.setDeviceId(p)}))).every(e=>!0===e)}catch(e){throw n.options.audioCaptureDefaults.deviceId=t,e}const s=i.some(e=>{var t,n;return null!==(n=null===(t=e.track)||void 0===t?void 0:t.isMuted)&&void 0!==n&&n});u&&s&&(h=!0)}else if("videoinput"===e){h=0===n.localParticipant.videoTrackPublications.size;const t=null!==(s=n.getActiveDevice(e))&&void 0!==s?s:n.options.videoCaptureDefaults.deviceId;n.options.videoCaptureDefaults.deviceId=p;const i=Array.from(n.localParticipant.videoTrackPublications.values()).filter(e=>e.source===ss.Source.Camera);try{u=(yield Promise.all(i.map(e=>{var t;return null===(t=e.videoTrack)||void 0===t?void 0:t.setDeviceId(p)}))).every(e=>!0===e)}catch(e){throw n.options.videoCaptureDefaults.deviceId=t,e}const o=i.some(e=>{var t,n;return null!==(n=null===(t=e.track)||void 0===t?void 0:t.isMuted)&&void 0!==n&&n});u&&o&&(h=!0)}else if("audiooutput"===e){if(h=!0,!Cs()&&!n.options.webAudioMix||n.options.webAudioMix&&n.audioContext&&!("setSinkId"in n.audioContext))throw new Error("cannot switch audio output, the current browser does not support it");n.options.webAudioMix&&(t=null!==(a=yield ba.getInstance().normalizeDeviceId("audiooutput",t))&&void 0!==a?a:""),null!==(r=(l=n.options).audioOutput)&&void 0!==r||(l.audioOutput={});const i=null!==(c=n.getActiveDevice(e))&&void 0!==c?c:n.options.audioOutput.deviceId;n.options.audioOutput.deviceId=t;try{n.options.webAudioMix&&(null===(d=n.audioContext)||void 0===d||d.setSinkId(t)),yield Promise.all(Array.from(n.remoteParticipants.values()).map(e=>e.setAudioOutput({deviceId:t})))}catch(e){throw n.options.audioOutput.deviceId=i,e}}return h&&(n.localParticipant.activeDeviceMap.set(e,t),n.emit(Ao.ActiveDeviceChanged,e,t)),u}()})}setupLocalParticipantEvents(){this.localParticipant.on(No.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).on(No.ParticipantNameChanged,this.onLocalParticipantNameChanged).on(No.AttributesChanged,this.onLocalAttributesChanged).on(No.TrackMuted,this.onLocalTrackMuted).on(No.TrackUnmuted,this.onLocalTrackUnmuted).on(No.LocalTrackPublished,this.onLocalTrackPublished).on(No.LocalTrackUnpublished,this.onLocalTrackUnpublished).on(No.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).on(No.MediaDevicesError,this.onMediaDevicesError).on(No.AudioStreamAcquired,this.startAudio).on(No.ChatMessage,this.onLocalChatMessageSent).on(No.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged)}recreateEngine(){var e;null===(e=this.engine)||void 0===e||e.close(),this.engine=void 0,this.isResuming=!1,this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.bufferedEvents=[],this.maybeCreateEngine()}onTrackAdded(e,t,n){if(this.state===nc.Connecting||this.state===nc.Reconnecting){const i=()=>{this.log.debug("deferring on track for later",{mediaTrackId:e.id,mediaStreamId:t.id,tracksInStream:t.getTracks().map(e=>e.id)}),this.onTrackAdded(e,t,n),o()},o=()=>{this.off(Ao.Reconnected,i),this.off(Ao.Connected,i),this.off(Ao.Disconnected,o)};return this.once(Ao.Reconnected,i),this.once(Ao.Connected,i),void this.once(Ao.Disconnected,o)}if(this.state===nc.Disconnected)return void this.log.warn("skipping incoming track after Room disconnected",this.logContext);if("ended"===e.readyState)return void this.log.info("skipping incoming track as it already ended",this.logContext);const i=function(e){const t=e.split("|");return t.length>1?[t[0],e.substr(t[0].length+1)]:[e,""]}(t.id),o=i[0];let s=i[1],a=e.id;if(s&&s.startsWith("TR")&&(a=s),o===this.localParticipant.sid)return void this.log.warn("tried to create RemoteParticipant for local participant",this.logContext);const r=Array.from(this.remoteParticipants.values()).find(e=>e.sid===o);if(!r)return void this.log.error("Tried to add a track for a participant, that's not present. Sid: ".concat(o),this.logContext);if(!a.startsWith("TR")){const e=this.engine.getTrackIdForReceiver(n);if(!e)return void this.log.error("Tried to add a track whose 'sid' could not be found for a participant, that's not present. Sid: ".concat(o),this.logContext);a=e}let c;a.startsWith("TR")||this.log.warn("Tried to add a track whose 'sid' could not be determined for a participant, that's not present. Sid: ".concat(o,", streamId: ").concat(s,", trackId: ").concat(a),Object.assign(Object.assign({},this.logContext),{rpID:o,streamId:s,trackId:a})),this.options.adaptiveStream&&(c="object"==typeof this.options.adaptiveStream?this.options.adaptiveStream:{});const d=r.addSubscribedMediaTrack(e,a,t,n,c);(null==d?void 0:d.isEncrypted)&&!this.e2eeManager&&this.emit(Ao.EncryptionError,new Error("Encrypted ".concat(d.source," track received from participant ").concat(r.sid,", but room does not have encryption enabled!")))}handleDisconnect(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1?arguments[1]:void 0;var n;if(this.clearConnectionReconcile(),this.isResuming=!1,this.bufferedEvents=[],this.transcriptionReceivedTimes.clear(),this.incomingDataStreamManager.clearHandlersAndControllers(),this.state!==nc.Disconnected){this.regionUrl=void 0;try{this.remoteParticipants.forEach(e=>{e.trackPublications.forEach(t=>{e.unpublishTrack(t.trackSid)})}),this.localParticipant.trackPublications.forEach(t=>{var n,i,o;t.track&&this.localParticipant.unpublishTrack(t.track,e),e?(null===(n=t.track)||void 0===n||n.detach(),null===(i=t.track)||void 0===i||i.stop()):null===(o=t.track)||void 0===o||o.stopMonitor()}),this.localParticipant.off(No.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).off(No.ParticipantNameChanged,this.onLocalParticipantNameChanged).off(No.AttributesChanged,this.onLocalAttributesChanged).off(No.TrackMuted,this.onLocalTrackMuted).off(No.TrackUnmuted,this.onLocalTrackUnmuted).off(No.LocalTrackPublished,this.onLocalTrackPublished).off(No.LocalTrackUnpublished,this.onLocalTrackUnpublished).off(No.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).off(No.MediaDevicesError,this.onMediaDevicesError).off(No.AudioStreamAcquired,this.startAudio).off(No.ChatMessage,this.onLocalChatMessageSent).off(No.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged),this.localParticipant.trackPublications.clear(),this.localParticipant.videoTrackPublications.clear(),this.localParticipant.audioTrackPublications.clear(),this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.activeSpeakers=[],this.audioContext&&"boolean"==typeof this.options.webAudioMix&&(this.audioContext.close(),this.audioContext=void 0),Rs()&&(window.removeEventListener("beforeunload",this.onPageLeave),window.removeEventListener("pagehide",this.onPageLeave),window.removeEventListener("freeze",this.onPageLeave),null===(n=navigator.mediaDevices)||void 0===n||n.removeEventListener("devicechange",this.handleDeviceChange))}finally{this.setAndEmitConnectionState(nc.Disconnected),this.emit(Ao.Disconnected,t)}}}handleParticipantDisconnected(e,t){var n;this.remoteParticipants.delete(e),t&&(this.incomingDataStreamManager.validateParticipantHasNoActiveDataStreams(e),t.trackPublications.forEach(e=>{t.unpublishTrack(e.trackSid,!0)}),this.emit(Ao.ParticipantDisconnected,t),t.setDisconnected(),null===(n=this.localParticipant)||void 0===n||n.handleParticipantDisconnected(t.identity))}handleIncomingRpcRequest(e,t,n,i,o,s){return pi(this,void 0,void 0,function*(){if(yield this.engine.publishRpcAck(e,t),1!==s)return void(yield this.engine.publishRpcResponse(e,t,null,sr.builtIn("UNSUPPORTED_VERSION")));const a=this.rpcHandlers.get(n);if(!a)return void(yield this.engine.publishRpcResponse(e,t,null,sr.builtIn("UNSUPPORTED_METHOD")));let r=null,c=null;try{const s=yield a({requestId:t,callerIdentity:e,payload:i,responseTimeout:o});ar(s)>15360?(r=sr.builtIn("RESPONSE_PAYLOAD_TOO_LARGE"),console.warn("RPC Response payload too large for ".concat(n))):c=s}catch(e){e instanceof sr?r=e:(console.warn("Uncaught error returned by RPC handler for ".concat(n,". Returning APPLICATION_ERROR instead."),e),r=sr.builtIn("APPLICATION_ERROR"))}yield this.engine.publishRpcResponse(e,t,c,r)})}selectDefaultDevices(){return pi(this,void 0,void 0,function*(){var e,t,n;const i=ba.getInstance().previousDevices,o=yield ba.getInstance().getDevices(void 0,!1),s=Xo();if("Chrome"===(null==s?void 0:s.name)&&"iOS"!==s.os)for(let e of o){const t=i.find(t=>t.deviceId===e.deviceId);t&&""!==t.label&&t.kind===e.kind&&t.label!==e.label&&"default"===this.getActiveDevice(e.kind)&&this.emit(Ao.ActiveDeviceChanged,e.kind,e.deviceId)}const a=["audiooutput","audioinput","videoinput"];for(let s of a){const a=da(s),r=this.localParticipant.getTrackPublication(a);if(r&&(null===(e=r.track)||void 0===e?void 0:e.isUserProvided))continue;const c=o.filter(e=>e.kind===s),d=this.getActiveDevice(s);d===(null===(t=i.filter(e=>e.kind===s)[0])||void 0===t?void 0:t.deviceId)&&c.length>0&&(null===(n=c[0])||void 0===n?void 0:n.deviceId)!==d?yield this.switchActiveDevice(s,c[0].deviceId):"audioinput"===s&&!xs()||"videoinput"===s||!(c.length>0)||c.find(e=>e.deviceId===this.getActiveDevice(s))||"audiooutput"===s&&xs()||(yield this.switchActiveDevice(s,c[0].deviceId))}})}acquireAudioContext(){return pi(this,void 0,void 0,function*(){var e,t;if("boolean"!=typeof this.options.webAudioMix&&this.options.webAudioMix.audioContext?this.audioContext=this.options.webAudioMix.audioContext:this.audioContext&&"closed"!==this.audioContext.state||(this.audioContext=null!==(e=ca())&&void 0!==e?e:void 0),this.options.webAudioMix&&this.remoteParticipants.forEach(e=>e.setAudioContext(this.audioContext)),this.localParticipant.setAudioContext(this.audioContext),this.audioContext&&"suspended"===this.audioContext.state)try{yield Promise.race([this.audioContext.resume(),bs(200)])}catch(e){this.log.warn("Could not resume audio context",Object.assign(Object.assign({},this.logContext),{error:e}))}const n="running"===(null===(t=this.audioContext)||void 0===t?void 0:t.state);n!==this.canPlaybackAudio&&(this.audioEnabled=n,this.emit(Ao.AudioPlaybackStatusChanged,n))})}createParticipant(e,t){var n;let i;return i=t?ac.fromParticipantInfo(this.engine.client,t,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}):new ac(this.engine.client,"",e,void 0,void 0,void 0,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}),this.options.webAudioMix&&i.setAudioContext(this.audioContext),(null===(n=this.options.audioOutput)||void 0===n?void 0:n.deviceId)&&i.setAudioOutput(this.options.audioOutput).catch(e=>this.log.warn("Could not set audio output: ".concat(e.message),this.logContext)),i}getOrCreateParticipant(e,t){if(this.remoteParticipants.has(e)){const n=this.remoteParticipants.get(e);if(t){n.updateInfo(t)&&this.sidToIdentity.set(t.sid,t.identity)}return n}const n=this.createParticipant(e,t);return this.remoteParticipants.set(e,n),this.sidToIdentity.set(t.sid,t.identity),this.emitWhenConnected(Ao.ParticipantConnected,n),n.on(No.TrackPublished,e=>{this.emitWhenConnected(Ao.TrackPublished,e,n)}).on(No.TrackSubscribed,(e,t)=>{e.kind===ss.Kind.Audio?(e.on(Uo.AudioPlaybackStarted,this.handleAudioPlaybackStarted),e.on(Uo.AudioPlaybackFailed,this.handleAudioPlaybackFailed)):e.kind===ss.Kind.Video&&(e.on(Uo.VideoPlaybackFailed,this.handleVideoPlaybackFailed),e.on(Uo.VideoPlaybackStarted,this.handleVideoPlaybackStarted)),this.emit(Ao.TrackSubscribed,e,t,n)}).on(No.TrackUnpublished,e=>{this.emit(Ao.TrackUnpublished,e,n)}).on(No.TrackUnsubscribed,(e,t)=>{this.emit(Ao.TrackUnsubscribed,e,t,n)}).on(No.TrackMuted,e=>{this.emitWhenConnected(Ao.TrackMuted,e,n)}).on(No.TrackUnmuted,e=>{this.emitWhenConnected(Ao.TrackUnmuted,e,n)}).on(No.ParticipantMetadataChanged,e=>{this.emitWhenConnected(Ao.ParticipantMetadataChanged,e,n)}).on(No.ParticipantNameChanged,e=>{this.emitWhenConnected(Ao.ParticipantNameChanged,e,n)}).on(No.AttributesChanged,e=>{this.emitWhenConnected(Ao.ParticipantAttributesChanged,e,n)}).on(No.ConnectionQualityChanged,e=>{this.emitWhenConnected(Ao.ConnectionQualityChanged,e,n)}).on(No.ParticipantPermissionsChanged,e=>{this.emitWhenConnected(Ao.ParticipantPermissionsChanged,e,n)}).on(No.TrackSubscriptionStatusChanged,(e,t)=>{this.emitWhenConnected(Ao.TrackSubscriptionStatusChanged,e,t,n)}).on(No.TrackSubscriptionFailed,(e,t)=>{this.emit(Ao.TrackSubscriptionFailed,e,n,t)}).on(No.TrackSubscriptionPermissionChanged,(e,t)=>{this.emitWhenConnected(Ao.TrackSubscriptionPermissionChanged,e,t,n)}).on(No.Active,()=>{this.emitWhenConnected(Ao.ParticipantActive,n),n.kind===pt.AGENT&&this.localParticipant.setActiveAgent(n)}),t&&n.updateInfo(t),n}sendSyncState(){const e=Array.from(this.remoteParticipants.values()).reduce((e,t)=>(e.push(...t.getTrackPublications()),e),[]),t=this.localParticipant.getTrackPublications();this.engine.sendSyncState(e,t)}updateSubscriptions(){for(const e of this.remoteParticipants.values())for(const t of e.videoTrackPublications.values())t.isSubscribed&&na(t)&&t.emitTrackUpdate()}getRemoteParticipantBySid(e){const t=this.sidToIdentity.get(e);if(t)return this.remoteParticipants.get(t)}registerConnectionReconcile(){this.clearConnectionReconcile();let e=0;this.connectionReconcileInterval=ns.setInterval(()=>{this.engine&&!this.engine.isClosed&&this.engine.verifyTransport()?e=0:(e++,this.log.warn("detected connection state mismatch",Object.assign(Object.assign({},this.logContext),{numFailures:e,engine:this.engine?{closed:this.engine.isClosed,transportsConnected:this.engine.verifyTransport()}:void 0})),e>=3&&(this.recreateEngine(),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,ot.STATE_MISMATCH)))},4e3)}clearConnectionReconcile(){this.connectionReconcileInterval&&ns.clearInterval(this.connectionReconcileInterval)}setAndEmitConnectionState(e){return e!==this.state&&(this.state=e,this.emit(Ao.ConnectionStateChanged,this.state),!0)}emitBufferedEvents(){this.bufferedEvents.forEach(e=>{let[t,n]=e;this.emit(t,...n)}),this.bufferedEvents=[]}emitWhenConnected(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(this.state===nc.Reconnecting||this.isResuming||!this.engine||this.engine.pendingReconnect)this.bufferedEvents.push([e,n]);else if(this.state===nc.Connected)return this.emit(e,...n);return!1}simulateParticipants(e){return pi(this,void 0,void 0,function*(){var t,n;const i=Object.assign({audio:!0,video:!0,useRealTracks:!1},e.publish),o=Object.assign({count:9,audio:!1,video:!0,aspectRatios:[1.66,1.7,1.3]},e.participants);if(this.handleDisconnect(),this.roomInfo=new ct({sid:"RM_SIMULATED",name:"simulated-room",emptyTimeout:0,maxParticipants:0,creationTime:L.parse((new Date).getTime()),metadata:"",numParticipants:1,numPublishers:1,turnPassword:"",enabledCodecs:[],activeRecording:!1}),this.localParticipant.updateInfo(new ut({identity:"simulated-local",name:"local-name"})),this.setupLocalParticipantEvents(),this.emit(Ao.SignalConnected),this.emit(Ao.Connected),this.setAndEmitConnectionState(nc.Connected),i.video){const e=new Zr(ss.Kind.Video,new vt({source:et.CAMERA,sid:Math.floor(1e4*Math.random()).toString(),type:Ze.AUDIO,name:"video-dummy"}),new xr(i.useRealTracks?(yield window.navigator.mediaDevices.getUserMedia({video:!0})).getVideoTracks()[0]:qs(160*(null!==(t=o.aspectRatios[0])&&void 0!==t?t:1),160,!0,!0),void 0,!1,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(e),this.localParticipant.emit(No.LocalTrackPublished,e)}if(i.audio){const e=new Zr(ss.Kind.Audio,new vt({source:et.MICROPHONE,sid:Math.floor(1e4*Math.random()).toString(),type:Ze.AUDIO}),new mr(i.useRealTracks?(yield navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0]:zs(),void 0,!1,this.audioContext,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(e),this.localParticipant.emit(No.LocalTrackPublished,e)}for(let e=0;e<o.count-1;e+=1){let t=new ut({sid:Math.floor(1e4*Math.random()).toString(),identity:"simulated-".concat(e),state:ht.ACTIVE,tracks:[],joinedAt:L.parse(Date.now())});const i=this.getOrCreateParticipant(t.identity,t);if(o.video){const s=qs(160*(null!==(n=o.aspectRatios[e%o.aspectRatios.length])&&void 0!==n?n:1),160,!1,!0),a=new vt({source:et.CAMERA,sid:Math.floor(1e4*Math.random()).toString(),type:Ze.AUDIO});i.addSubscribedMediaTrack(s,a.sid,new MediaStream([s]),new RTCRtpReceiver),t.tracks=[...t.tracks,a]}if(o.audio){const e=zs(),n=new vt({source:et.MICROPHONE,sid:Math.floor(1e4*Math.random()).toString(),type:Ze.AUDIO});i.addSubscribedMediaTrack(e,n.sid,new MediaStream([e]),new RTCRtpReceiver),t.tracks=[...t.tracks,n]}i.updateInfo(t)}})}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(e!==Ao.ActiveSpeakersChanged&&e!==Ao.TranscriptionReceived){const t=cc(n).filter(e=>void 0!==e);e!==Ao.TrackSubscribed&&e!==Ao.TrackUnsubscribed||this.log.trace("subscribe trace: ".concat(e),Object.assign(Object.assign({},this.logContext),{event:e,args:t})),this.log.debug("room event ".concat(e),Object.assign(Object.assign({},this.logContext),{event:e,args:t}))}return super.emit(e,...n)}}function cc(e){return e.map(e=>{if(e)return Array.isArray(e)?cc(e):"object"==typeof e?"logContext"in e?e.logContext:void 0:e})}var dc;rc.cleanupRegistry="undefined"!=typeof FinalizationRegistry&&new FinalizationRegistry(e=>{e()}),function(e){e[e.IDLE=0]="IDLE",e[e.RUNNING=1]="RUNNING",e[e.SKIPPED=2]="SKIPPED",e[e.SUCCESS=3]="SUCCESS",e[e.FAILED=4]="FAILED"}(dc||(dc={}));bi.EventEmitter;bi.EventEmitter;function lc(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t);if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}new TextEncoder,new TextDecoder;class uc extends Error{constructor(e,t){var n;super(e,t),lc(this,"code","ERR_JOSE_GENERIC"),this.name=this.constructor.name,null===(n=Error.captureStackTrace)||void 0===n||n.call(Error,this,this.constructor)}}lc(uc,"code","ERR_JOSE_GENERIC");lc(class extends uc{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"unspecified",i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"unspecified";super(e,{cause:{claim:n,reason:i,payload:t}}),lc(this,"code","ERR_JWT_CLAIM_VALIDATION_FAILED"),lc(this,"claim",void 0),lc(this,"reason",void 0),lc(this,"payload",void 0),this.claim=n,this.reason=i,this.payload=t}},"code","ERR_JWT_CLAIM_VALIDATION_FAILED");lc(class extends uc{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"unspecified",i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"unspecified";super(e,{cause:{claim:n,reason:i,payload:t}}),lc(this,"code","ERR_JWT_EXPIRED"),lc(this,"claim",void 0),lc(this,"reason",void 0),lc(this,"payload",void 0),this.claim=n,this.reason=i,this.payload=t}},"code","ERR_JWT_EXPIRED");lc(class extends uc{constructor(){super(...arguments),lc(this,"code","ERR_JOSE_ALG_NOT_ALLOWED")}},"code","ERR_JOSE_ALG_NOT_ALLOWED");lc(class extends uc{constructor(){super(...arguments),lc(this,"code","ERR_JOSE_NOT_SUPPORTED")}},"code","ERR_JOSE_NOT_SUPPORTED");lc(class extends uc{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"decryption operation failed",arguments.length>1?arguments[1]:void 0),lc(this,"code","ERR_JWE_DECRYPTION_FAILED")}},"code","ERR_JWE_DECRYPTION_FAILED");lc(class extends uc{constructor(){super(...arguments),lc(this,"code","ERR_JWE_INVALID")}},"code","ERR_JWE_INVALID");lc(class extends uc{constructor(){super(...arguments),lc(this,"code","ERR_JWS_INVALID")}},"code","ERR_JWS_INVALID");lc(class extends uc{constructor(){super(...arguments),lc(this,"code","ERR_JWT_INVALID")}},"code","ERR_JWT_INVALID");lc(class extends uc{constructor(){super(...arguments),lc(this,"code","ERR_JWK_INVALID")}},"code","ERR_JWK_INVALID");lc(class extends uc{constructor(){super(...arguments),lc(this,"code","ERR_JWKS_INVALID")}},"code","ERR_JWKS_INVALID");lc(class extends uc{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"no applicable key found in the JSON Web Key Set",arguments.length>1?arguments[1]:void 0),lc(this,"code","ERR_JWKS_NO_MATCHING_KEY")}},"code","ERR_JWKS_NO_MATCHING_KEY");lc(class extends uc{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"multiple matching keys found in the JSON Web Key Set",arguments.length>1?arguments[1]:void 0),lc(this,Symbol.asyncIterator,void 0),lc(this,"code","ERR_JWKS_MULTIPLE_MATCHING_KEYS")}},"code","ERR_JWKS_MULTIPLE_MATCHING_KEYS");lc(class extends uc{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"request timed out",arguments.length>1?arguments[1]:void 0),lc(this,"code","ERR_JWKS_TIMEOUT")}},"code","ERR_JWKS_TIMEOUT");lc(class extends uc{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"signature verification failed",arguments.length>1?arguments[1]:void 0),lc(this,"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED")}},"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED");let hc=null,pc=!0;window.ChatbotSDK=new class{constructor(){this.config={},this.isOpen=!1,this.sessionId=null,this.messages=[],this.elements={},this.refreshInterval=null,this.debug=!0,this.currentTab="home",this.termsAccepted=!1,this.announcements=[],this.userNotifications=[],this.notifications=["ðŸ‘‹ !Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ","ðŸ›ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙƒØ´Ø§Ù Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©ØŸ","ðŸ¤” Ù‡Ù„ ØªØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø£ÙŠ Ø´ÙŠØ¡ØŸ","ðŸ’¬ !Ø£Ù†Ø§ Ù‡Ù†Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ Ø£Ø³Ø¦Ù„Ø©","ðŸ”¥ !Ø§Ø·Ù„Ø¹ Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø« Ø¹Ø±ÙˆØ¶Ù†Ø§"]}async init(){this.initConfig(),await this.loadConfig(),this.initSession(),"complete"===document.readyState||"interactive"===document.readyState?this.createWidgetUI():document.addEventListener("DOMContentLoaded",()=>{console.log("DOM fully loaded, creating UI"),this.createWidgetUI()}),setTimeout(()=>{this.elements.container||(console.warn("Fallback UI creation"),this.createWidgetUI())},1e3),console.log("Loading announcements..."),await this.loadAnnouncements()}initConfig(e={}){const t=document.querySelector('script[src*="chatbot.bundle.js"]');let n={};if(t){const e=t.getAttribute("chatbot-config");if(e)try{n=JSON.parse(e)}catch(e){console.error("Chatbot SDK: Invalid JSON in chatbot-config attribute",e)}}this.config={...n,...e},this.config.botUrl=l.chatbot.chat,this.config.startingUrl=l.chatbot.start,this.config.announcementsUrl=l.chatbot.news,this.config.themeColor=this.config.themeColor||"#020c15ff",this.config.position=this.config.position||"bottom-right",this.config.botName=this.config.botName||"Chatbot",console.log("botName:",this.config.botName),this.config.inputPlaceholder=this.config.inputPlaceholder||"Type your message...",this.config.sendButtonText=this.config.sendButtonText||"Send"}async loadConfig(){if(l.chatbot.config)try{this.log("Loading initial config from API");const e=await fetch(`${l.chatbot.config}?t=${Date.now()}`),t=await e.json();this.mergeConfigs(t),this.applyDynamicStyles()}catch(e){this.log("Initial config load failed:",e)}}mergeConfigs(e){this.config={...this.config,...e,style:{...this.config.style||{},...e.style||{}},features:{...this.config.features||{},...e.features||{}}},this.log("Merged config:",this.config)}applyDynamicStyles(){if(!this.config.style)return void this.log("No style configuration found");const e=document.documentElement,{style:t}=this.config;t.themeColor&&(console.log("Applying theme color:",t.themeColor),e.style.setProperty("--chatbot-theme-color",t.themeColor),e.style.setProperty("--chatbot-theme-color-hover",this.adjustColor(t.themeColor,-20))),t.header?.backgroundColor&&(console.log("Applying theme color:",t.backgroundColor),e.style.setProperty("--chatbot-header-bg",t.header.backgroundColor)),t.header?.textColor&&e.style.setProperty("--chatbot-header-text",t.header.textColor),t.bubble?.color&&e.style.setProperty("--chatbot-bubble-color",t.bubble.color),t.messages?.userBubbleColor&&e.style.setProperty("--chatbot-user-bubble",t.messages.userBubbleColor),t.messages?.botBubbleColor&&e.style.setProperty("--chatbot-bot-bubble",t.messages.botBubbleColor)}async refreshConfig(){try{this.log("Refreshing configuration...");const e=await fetch(`${this.config.configApiUrl}?t=${Date.now()}`),t=await e.json();return this.mergeConfigs(t),this.applyDynamicStyles(),this.updateUIElements(),this.log("Configuration refreshed successfully"),!0}catch(e){return this.log("Failed to refresh config:",e),!1}}initSession(){this.sessionId=t("chatbot_session_id"),this.sessionId||(this.sessionId="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),e("chatbot_session_id",this.sessionId)),this.messages=t(`chatbot_conversation_${this.sessionId}`)||[]}startMessageCycle(){this.messageInterval&&(clearInterval(this.messageInterval),this.messageInterval=null),this.isOpen||(this.currentMessageIndex=0,this.showNextMessage(),this.messageInterval=setInterval(()=>{this.isOpen?this.stopMessageCycle():this.showNextMessage()},5e3))}showNextMessage(){this.elements.messageBubble&&(this.elements.messageBubble.style.opacity="0",this.elements.messageBubble.style.transform="translateY(-50%) translateX(20px) scale(0.8)",setTimeout(()=>{this.elements.messageBubble.innerHTML=`\n        <span>${this.notifications[this.currentMessageIndex]}</span>\n        <div style="position: absolute; top: 50%; right: -8px; transform: translateY(-50%); width: 0; height: 0; border-left: 8px solid white; border-top: 8px solid transparent; border-bottom: 8px solid transparent;"></div>\n      `,this.elements.messageBubble.style.opacity="1",this.elements.messageBubble.style.transform="translateY(-50%) translateX(0) scale(1)",this.currentMessageIndex=(this.currentMessageIndex+1)%this.notifications.length,console.log("Showing message:",this.currentMessageIndex-1<0?this.notifications.length-1:this.currentMessageIndex-1)},400))}stopMessageCycle(){this.messageInterval&&(clearInterval(this.messageInterval),this.messageInterval=null),this.elements.messageBubble&&(this.elements.messageBubble.style.opacity="0",this.elements.messageBubble.style.transform="translateY(-50%) translateX(20px) scale(0.8)")}log(...e){this.debug&&console.log("[Chatbot]",...e)}async loadAnnouncements(){try{const e=await fetch(this.config.announcementsUrl,{method:"GET",headers:{"Content-Type":"application/json"}});if(e.ok){const t=await e.json();this.announcements=t.sort((e,t)=>new Date(t.date)-new Date(e.date)),this.renderAnnouncements()}}catch(e){console.error("Failed to load announcements:",e)}}renderAnnouncements(){const e=this.elements.announcementsContent;if(!e)return;const t=e.querySelector(".chatbot-announcements-list");t&&(t.innerHTML="",t.classList.add("scroll-stack-list"),0!==this.announcements.length?this.announcements.forEach((e,n)=>{const i=document.createElement("div");i.className="chatbot-announcement-card",i.style.animationDelay=.1*n+"s";const o=e.image?`<div class="chatbot-announcement-image" style="background-image: url('${e.image}')"></div>`:'<div class="chatbot-announcement-image chatbot-announcement-default-icon">ðŸ“¢</div>';i.innerHTML=`\n    \n      ${o}\n      <div class="chatbot-announcement-content">\n        <div class="chatbot-announcement-title">${e.text||"Announcement"}</div>\n        <div class="chatbot-announcement-description">${e.description||""}</div>\n        <div class="chatbot-announcement-date">${this.formatDate(e.date)}</div>\n      </div>\n    `,t.appendChild(i)}):t.innerHTML='\n      <div class="chatbot-announcements-empty">\n        <div class="chatbot-announcements-empty-icon">ðŸ“¢</div>\n        <p>No announcements available at the moment.</p>\n      </div>\n    ')}formatDate(e){if(!e)return"";try{return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}catch(t){return e}}adjustColor(e,t){return"#"+e.replace(/^#/,"").replace(/../g,e=>("0"+Math.min(255,Math.max(0,parseInt(e,16)+t)).toString(16)).slice(-6))}async getVoiceToken(e,t){try{const n=await fetch(l.chatbot.voice_agent_token,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({identity:e,name:t})});if(n.ok){const{room:e,token:t}=await n.json();return{room:e,token:t}}return console.error("Server returned an error:",n.status),null}catch(e){return console.error("Failed to load user token:",e),null}}async createWidgetUI(){console.log("Creating widget UI..."),console.log("Config:",this.config);const e=document.createElement("div");e.id="chatbot-widget-container",console.log("Container created:",e),e.classList.add(`chatbot-position-${this.config.position}`),e.style.display="none",e.style.opacity="0",document.body.appendChild(e),this.elements.container=e,this.voiceCallState={room:null,isConnected:!1,isConnecting:!1,localParticipant:null,audioContext:null,oscillator:null,selectedLanguage:"en"},this.createLoadingSound=()=>{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.type="sine",t.frequency.setValueAtTime(440,e.currentTime);const i=()=>{if(!this.voiceCallState.isConnecting)return;const t=e.currentTime;n.gain.cancelScheduledValues(t),n.gain.setValueAtTime(0,t),n.gain.linearRampToValueAtTime(.4,t+.1),n.gain.linearRampToValueAtTime(.4,t+1.2-.2),n.gain.linearRampToValueAtTime(0,t+1.2),setTimeout(i,3200)};return i(),t.start(),{audioContext:e,oscillator:t,gainNode:n}},this.stopLoadingSound=e=>{e&&(e.oscillator.stop(),e.audioContext.close())},this.initializeVoiceCall=async()=>{if(this.voiceCallState.room)return;await this.getVoiceToken("user1","Hazem");const t=new rc({adaptiveStream:!0,dynacast:!0});return t.on(Ao.TrackSubscribed,(t,n,i)=>{if(t.kind===ss.Kind.Audio){const n=t.attach();n.autoplay=!0,console.log("Track subscribed:",t.kind,i.identity),e.appendChild(n),this.voiceCallState.loadingSoundObjects&&"user1"!==i.identity&&(this.stopLoadingSound(this.voiceCallState.loadingSoundObjects),this.voiceCallState.loadingSoundObjects=null,this.voiceCallState.isConnecting=!1,this.updateCallButton())}if(t.kind===ss.Kind.Video){const n=t.attach();n.autoplay=!0,console.log("Video track subscribed:",i.identity),e.appendChild(n)}}).on(Ao.TrackUnsubscribed,function(e){e.detach()}).on(Ao.ActiveSpeakersChanged,function(e){}).on(Ao.Disconnected,()=>{console.log("disconnected from room"),this.voiceCallState.isConnected=!1,this.voiceCallState.isConnecting=!1,this.updateCallButton()}).on(Ao.LocalTrackUnpublished,function(e){e.track.detach()}),this.voiceCallState.room=t,t},this.startVoiceCall=async()=>{if(this.voiceCallState.isConnected||this.voiceCallState.isConnecting)return;this.voiceCallState.isConnecting=!0,this.updateCallButton();const e=this.createLoadingSound();this.voiceCallState.loadingSoundObjects=e;try{this.voiceCallState.room||(console.log("Initializing voice call room..."),await this.initializeVoiceCall());let{room:e,token:t}=await this.getVoiceToken("user1","Hazem");await this.voiceCallState.room.connect("wss://finovax.duckdns.org",t),console.log("Connected to room",this.voiceCallState.room.name),console.log("language selected:",this.voiceCallState.selectedLanguage),await fetch(l.chatbot.start_agent,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({room_name:e,language:this.voiceCallState.selectedLanguage})});const n=(await navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0];this.voiceCallState.localParticipant=this.voiceCallState.room.localParticipant;const i=await this.voiceCallState.localParticipant.publishTrack(n,{name:"microphone",source:ss.Source.Microphone});console.log("Microphone published:",i),this.voiceCallState.isConnected=!0}catch(t){console.error("Error starting voice call:",t),this.stopLoadingSound(e),this.voiceCallState.loadingSoundObjects=null,this.voiceCallState.isConnecting=!1,this.updateCallButton(),alert("Failed to start call. Please check your microphone permissions.")}},this.endVoiceCall=async()=>{if(this.voiceCallState.room&&this.voiceCallState.isConnected)try{await this.voiceCallState.room.disconnect(),this.voiceCallState.isConnected=!1,this.voiceCallState.isConnecting=!1,this.voiceCallState.room=null,this.voiceCallState.localParticipant=null,this.updateCallButton(),console.log("Voice call ended")}catch(e){console.error("Error ending voice call:",e)}},this.updateCallButton=()=>{const e=document.querySelector('.chatbot-action-card[data-action="voice-call"]'),t=e?.querySelector(".chatbot-action-icon"),n=e?.querySelector(".chatbot-action-title"),i=e?.querySelector(".chatbot-action-desc");e&&(this.voiceCallState.isConnecting?(e.style.background="linear-gradient(135deg, #FFA726 0%, #FB8C00 100%)",e.style.animation="pulse 1.5s infinite",t.textContent="â³",n.textContent="Connecting...",i.textContent="Please wait while we connect you"):this.voiceCallState.isConnected?(e.style.background="linear-gradient(135deg, #EF5350 0%, #E53935 100%)",e.style.animation="none",t.textContent="ðŸ“ž",n.textContent="End Call",i.textContent="Tap to disconnect the call"):(e.style.background="",e.style.animation="none",t.textContent="ðŸ“ž",n.textContent="Call Us",i.textContent="Start a voice conversation with us"))},setTimeout(()=>{const e=window.getComputedStyle(this.elements.container);console.log("Computed styles:",{display:e.display,opacity:e.opacity,zIndex:e.zIndex,visibility:e.visibility})},500);const t=this.config.style?.animation||{type:"fade-in",duration:300};t.type&&(e.style.transition=`all ${t.duration}ms ease`);const n=document.createElement("div");n.className="chatbot-bubble";const i=this.config.style?.bubble||{};n.style.width=i.size||"60px",n.style.height=i.size||"60px",n.style.backgroundColor=i.color||"var(--chatbot-theme-color)",i.icon?n.innerHTML=i.icon.startsWith("http")?`<img src="${i.icon}" alt="Chat" style="width: 70%; height: 70%;">`:i.icon:n.innerHTML='\n      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">\n        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>\n      </svg>\n    ';const o=document.createElement("div");o.className="chatbot-message",o.style.cssText="\n    position: absolute;\n    right: 90px;\n    top: 50%;\n    transform: translateY(-50%) translateX(20px) scale(0.8);\n    background: white;\n    padding: 12px 16px;\n    border-radius: 20px;\n    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);\n    max-width: 250px;\n    opacity: 0;\n    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);\n    font-size: 14px;\n    color: #333;\n    border: 1px solid #e0e0e0;\n    white-space: nowrap;\n    pointer-events: none;\n    z-index: 999;\n  ",o.innerHTML='<div style="position: absolute; top: 50%; right: -8px; transform: translateY(-50%); width: 0; height: 0; border-left: 8px solid white; border-top: 8px solid transparent; border-bottom: 8px solid transparent;"></div>',n.addEventListener("click",()=>this.toggleChatWindow()),e.appendChild(o),e.appendChild(n),this.elements.bubble=n,this.elements.messageBubble=o,setTimeout(()=>this.startMessageCycle(),3e3);const s=document.createElement("div");s.className="chatbot-window";const a=this.config.style?.header||{};s.innerHTML=`\n    <style>\n      @keyframes pulse {\n        0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(255, 167, 38, 0.3); }\n        50% { transform: scale(1.05); box-shadow: 0 6px 20px rgba(255, 167, 38, 0.5); }\n      }\n    </style>\n    <div class="chatbot-header" style="\n      ${a.backgroundColor?`background-color: ${a.backgroundColor};`:""}\n      ${a.textColor?`color: ${a.textColor};`:""}\n    ">\n      <div class="chatbot-header-top">\n        ${a.icon?`<img src="${a.icon}" class="chatbot-header-icon" \n            style="width: ${a.iconSize||"30px"}; height: ${a.iconSize||"30px"};">`:""}\n        <span class="chatbot-header-title">${this.config.botName}</span>\n        <button class="chatbot-header-close" style="\n          ${a.textColor?`color: ${a.textColor};`:""}\n        ">&times;</button>\n      </div>\n    </div>\n    \n    <div class="chatbot-content">\n      \x3c!-- Home Tab --\x3e\n      <div class="chatbot-tab-content active" data-content="home">\n        <div class="chatbot-home-content">\n          <div class="chatbot-home-welcome">\n            <h2>Welcome!</h2>\n            <p>How can we help you today?</p>\n          </div>\n          \n          <div class="chatbot-actions-grid">\n            <div class="chatbot-action-card" data-action="voice-call">\n              <span class="chatbot-action-icon">ðŸ“ž</span>\n              <div class="chatbot-action-title">Call Us</div>\n              <div class="chatbot-action-desc">Start a voice conversation with us</div>\n              <div class="chatbot-language-switch">\n                <span>ðŸŒ</span>\n                <button class="lang-btn active" data-lang="en">EN</button>\n                <button class="lang-btn" data-lang="ar">AR</button>\n              </div>\n            </div>\n            <div class="chatbot-action-card" data-action="start-chat">\n              <span class="chatbot-action-icon">ðŸ’¬</span>\n              <div class="chatbot-action-title">Start Chat</div>\n              <div class="chatbot-action-desc">Begin a conversation with our assistant</div>\n            </div>\n            <div class="chatbot-action-card" data-action="check-products">\n              <span class="chatbot-action-icon">ðŸª</span>\n              <div class="chatbot-action-title">Our Products</div>\n              <div class="chatbot-action-desc">Explore our product offerings</div>\n            </div>\n            <div class="chatbot-action-card" data-action="contact-us">\n              <span class="chatbot-action-icon">âœ‰ï¸</span>\n              <div class="chatbot-action-title">Contact Us</div>\n              <div class="chatbot-action-desc">Get in touch with support</div>\n            </div>\n            <div class="chatbot-action-card" data-action="faq">\n              <span class="chatbot-action-icon">â“</span>\n              <div class="chatbot-action-title">FAQ</div>\n              <div class="chatbot-action-desc">Find answers to common questions</div>\n            </div>\n          </div>\n          \n          <div class="chatbot-user-actions" style="display: none;">\n            <h3>Your Account</h3>\n            <div class="chatbot-user-notifications"></div>\n          </div>\n        </div>\n      </div>\n      \n      \x3c!-- Chat Tab --\x3e\n      <div class="chatbot-tab-content" data-content="chat">\n        <div class="chatbot-chat-content">\n          <div class="chatbot-messages"></div>\n          <div class="chatbot-input-area">\n            <input type="text" placeholder="${this.config.inputPlaceholder}" />\n            <button class="chatbot-send-button">${this.config.sendButtonText}</button>\n          </div>\n        </div>\n        \n        \x3c!-- Terms Overlay --\x3e\n        <div class="chatbot-terms-overlay">\n          <div class="chatbot-terms-content">\n            <div class="chatbot-terms-title">Terms & Conditions</div>\n            <div class="chatbot-terms-text">\n              Before we start, and for your protection, please don't type any account or card numbers on the screen or any of your PINs. Please also note that we will be keeping a record of this conversation for service quality purposes. I am here to help you with general inquiries about the Bank, its products and services. If you need to access your bank accounts or cards,\n            </div>\n            <div class="chatbot-terms-text">\n              Dear customer, in order to ensure the confidentiality of your data, please do not share the three numbers on the back of the credit or debit card, the OTP or the password for the smart wallet service or the Internet banking with anyone, whether by phone, text message or e-mail and in case that this data is requested by any means of communication, please contact 19666 as soon as possible.\n            </div>\n            <div class="chatbot-terms-buttons">\n              <button class="chatbot-terms-accept">I Agree</button>\n              <button class="chatbot-terms-decline">Decline</button>\n            </div>\n          </div>\n        </div>\n      </div>\n      \n      \x3c!-- Announcements Tab --\x3e\n      <div class="chatbot-tab-content" data-content="announcements">\n        <div class="chatbot-announcements-content">\n          <div class="chatbot-announcements-list"></div>\n        </div>\n      </div>\n    </div>\n    \n    <div class="chatbot-footer" style="\n      text-align: center;\n      padding: 10px;\n      font-size: 12px;\n      font-family: 'Segoe UI', sans-serif;\n      background: #fdfdfd;\n    ">\n      <div class="chatbot-tabs">\n        <button class="chatbot-tab active" data-tab="home">Home</button>\n        <button class="chatbot-tab" data-tab="chat">Chat</button>\n        <button class="chatbot-tab" data-tab="announcements">News</button>\n      </div>\n      <span style="\n          background: linear-gradient(90deg, #4a90e2, #9013fe, #ff4081);\n          -webkit-background-clip: text;\n          -webkit-text-fill-color: transparent;\n          font-weight: bold;\n          font-style: italic;\n          font-size: 1.1em;\n          animation: shimmer 3s infinite;\n          background-size: 200% auto;\n          display:inline-block;\n      ">Powered by FinovaX âœ¨</span>\n    </div>\n  `,e.appendChild(s),this.elements.window=s,this.elements.messagesContainer=s.querySelector(".chatbot-messages"),this.elements.inputField=s.querySelector(".chatbot-input-area input"),this.elements.sendButton=s.querySelector(".chatbot-input-area button"),this.elements.closeButton=s.querySelector(".chatbot-header-close"),this.elements.headerTitle=s.querySelector(".chatbot-header-title"),this.elements.homeContent=s.querySelector('[data-content="home"]'),this.elements.chatContent=s.querySelector('[data-content="chat"]'),this.elements.announcementsContent=s.querySelector('[data-content="announcements"]'),this.elements.termsOverlay=s.querySelector(".chatbot-terms-overlay"),this.elements.userActions=s.querySelector(".chatbot-user-actions"),this.elements.userNotifications=s.querySelector(".chatbot-user-notifications");const r=s.querySelector('.chatbot-action-card[data-action="voice-call"]');r&&r.addEventListener("click",async()=>{this.voiceCallState.isConnected?await this.endVoiceCall():this.voiceCallState.isConnecting||await this.startVoiceCall()});const c=s.querySelectorAll(".lang-btn");c.forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation(),c.forEach(e=>e.classList.remove("active")),e.classList.add("active"),this.voiceCallState.selectedLanguage=e.dataset.lang,console.log("Language selected:",this.voiceCallState.selectedLanguage)})}),this.setupEventListeners(),this.messages.forEach(e=>this.displayMessage(e,!1)),this.scrollToBottom(),this.showWidget(),this.config.autoRefresh&&this.startAutoRefresh(this.config.autoRefreshInterval||3e5)}setupEventListeners(){this.elements.closeButton.addEventListener("click",()=>this.toggleChatWindow()),this.elements.sendButton.addEventListener("click",()=>this.sendMessage()),this.elements.inputField.addEventListener("keypress",e=>{"Enter"===e.key&&this.sendMessage()});this.elements.window.querySelectorAll(".chatbot-tab").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tab;this.switchTab(t)})});this.elements.window.querySelectorAll(".chatbot-action-card").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.action;this.handleHomeAction(t)})});const e=this.elements.window.querySelector(".chatbot-terms-accept"),t=this.elements.window.querySelector(".chatbot-terms-decline");e.addEventListener("click",()=>{this.termsAccepted=!0,this.elements.termsOverlay.style.display="none"}),t.addEventListener("click",()=>{this.switchTab("home")})}switchTab(e){this.elements.window.querySelectorAll(".chatbot-tab").forEach(t=>{t.classList.toggle("active",t.dataset.tab===e)});this.elements.window.querySelectorAll(".chatbot-tab-content").forEach(t=>{t.classList.toggle("active",t.dataset.content===e)}),this.currentTab=e,"chat"===e&&(this.termsAccepted||(this.elements.termsOverlay.style.display="flex"),setTimeout(()=>{this.scrollToBottom()},100)),"announcements"===e&&0===this.announcements.length&&this.loadAnnouncements()}handleHomeAction(e){switch(e){case"start-chat":this.switchTab("chat");break;case"check-products":this.switchTab("chat"),this.termsAccepted&&setTimeout(()=>{this.sendMessage("Show me your products","/list_product_list")},500);break;case"contact-us":this.switchTab("chat"),this.termsAccepted&&setTimeout(()=>{this.sendMessage("I need to contact support","/contact_support")},500);break;case"faq":this.switchTab("chat"),this.termsAccepted&&setTimeout(()=>{this.sendMessage("Show me frequently asked questions","/show_faq")},500)}}async loadUserNotifications(){if(hc)try{const e=await fetch(this.config.startingUrl,{method:"GET",headers:{"Content-Type":"application/json",authorization:`Bearer ${hc}`}});if(e.ok){const t=await e.json();this.userNotifications=t,this.renderUserNotifications()}}catch(e){console.error("Failed to load user notifications:",e)}}renderUserNotifications(){if(!this.elements.userActions||!this.elements.userNotifications)return;this.elements.userNotifications.innerHTML="";const e=[];this.userNotifications.forEach(t=>{t.text&&e.push({text:t.text,url:null}),t.buttons&&t.buttons.forEach(t=>{e.push({text:t.title,url:t.url})})}),0!==e.length?(this.elements.userActions.style.display="block",e.forEach(e=>{const t=document.createElement("div");t.className="chatbot-notification-card";const n=document.createElement("div");if(n.className="chatbot-notification-text",n.textContent=e.text,t.appendChild(n),e.url){const n=document.createElement("button");n.className="chatbot-notification-button",n.textContent="View Details",n.onclick=()=>window.open(e.url,"_blank"),t.appendChild(n)}this.elements.userNotifications.appendChild(t)})):this.elements.userActions.style.display="none"}updateUIElements(){this.elements.headerTitle&&(this.elements.headerTitle.textContent=this.config.botName),this.elements.inputField&&(this.elements.inputField.placeholder=this.config.inputPlaceholder),this.elements.sendButton&&(this.elements.sendButton.textContent=this.config.sendButtonText)}showWidget(){console.log("Attempting to show widget..."),this.elements.container.style.display="block",this.elements.container.style.opacity="1",this.elements.container.style.zIndex="99999";const e=this.config.style?.animation||{type:"fade-in",duration:300};console.log("Using animation:",e),this.elements.container.style.display="block","fade-in"===e.type?setTimeout(()=>{this.elements.container.style.opacity="1"},50):"slide-up"===e.type?(this.elements.container.style.transform="translateY(20px)",setTimeout(()=>{this.elements.container.style.transition=`all ${e.duration}ms ease`,this.elements.container.style.opacity="1",this.elements.container.style.transform="translateY(0)"},50)):this.elements.container.style.opacity="1"}startAutoRefresh(e=3e5){this.stopAutoRefresh(),this.refreshInterval=setInterval(()=>this.refreshConfig(),e),this.log(`Started auto-refresh every ${e/1e3} seconds`)}stopAutoRefresh(){this.refreshInterval&&(clearInterval(this.refreshInterval),this.refreshInterval=null)}displayMessage(t,n=!0){const i=document.createElement("div");if(i.classList.add("chatbot-message","user"===t.sender?"user":"bot"),t.text){const e=document.createElement("div");e.innerHTML=function(e){if(!e)return"";let t=e;return t=t.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__(.*?)__/g,"<strong>$1</strong>"),t=t.replace(/\*(.*?)\*/g,"<em>$1</em>"),t=t.replace(/_(.*?)_/g,"<em>$1</em>"),t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'),t=t.replace(/\n/g,"<br/>"),t}(t.text),i.appendChild(e)}if(t.buttons?.length>0){const e=s(t,"buttons",this.sendMessage.bind(this));e&&i.appendChild(e)}if(t.image){const e=s(t,"image");e&&i.appendChild(e)}if(t.video){const e=s(t,"video");e&&i.appendChild(e)}if(t.carousel?.length>0){const e=s(t,"carousel",this.sendMessage.bind(this));e&&i.appendChild(e)}if(t.custom){const e=a(t.custom,this.sendMessage.bind(this));e&&i.appendChild(e)}this.elements.messagesContainer.appendChild(i),n&&(this.messages.push(t),e(`chatbot_conversation_${this.sessionId}`,this.messages)),this.scrollToBottom()}async sendSuggestions(){try{const e=await fetch(this.config.startingUrl,{method:"GET",headers:{"Content-Type":"application/json",authorization:`Bearer ${hc}`}});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();t?.length>0?(console.log(hc+" --- IGNORE ---"),t.forEach(e=>this.displayMessage({sender:"bot",...e}))):this.displayMessage({sender:"bot",text:"Sorry, I didn't get a response."})}catch(e){console.error("Chatbot error:",e),this.displayMessage({sender:"bot",text:"I'm having trouble connecting. Please try again later."})}}async sendMessage(e=null,t=null){let n=e||this.elements.inputField.value.trim();if(!n&&!t)return;const i={sender:"user",text:n};this.displayMessage(i),this.elements.inputField.value="";const o={sender:this.sessionId,message:n,...t&&{customData:{payload:t}}};try{const e=await fetch(this.config.botUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();t?.length>0?(console.log(hc+" --- IGNORE ---"),t.forEach(e=>this.displayMessage({sender:"bot",...e}))):this.displayMessage({sender:"bot",text:"Sorry, I didn't get a response."})}catch(e){console.error("Chatbot error:",e),this.displayMessage({sender:"bot",text:"I'm having trouble connecting. Please try again later."})}}toggleChatWindow(){this.isOpen=!this.isOpen,this.elements.window.classList.toggle("open",this.isOpen),this.elements.bubble.classList.toggle("hidden",this.isOpen),this.isOpen?(pc&&hc&&(pc=!1,this.sendSuggestions()),this.stopMessageCycle(),this.elements.inputField.focus(),this.scrollToBottom()):setTimeout(()=>{this.isOpen||this.startMessageCycle()},2e3)}scrollToBottom(){this.elements.messagesContainer&&(this.elements.messagesContainer.scrollTop=this.elements.messagesContainer.scrollHeight)}},window.ChatbotSDK.init(),document.getElementById("chatbotContainer"),window.setChatbotAuthToken=function(e){hc=e,console.log("Chatbot SDK received a token. Saved locally."),console.log("Simulated Chatbot Auth Token:",hc),window.ChatbotSDK&&window.ChatbotSDK.isOpen&&hc&&pc&&(pc=!1,window.ChatbotSDK.sendSuggestions())},console.log("Chatbot SDK loaded. Chatbot is running but currently unauthenticated.")}();
//# sourceMappingURL=chatbot.bundle.js.map
